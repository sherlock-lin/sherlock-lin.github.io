[{"content":"å¼•è¨€ Pulsar Functionä¸­æœ€é‡è¦çš„è§’è‰²æ˜¯Workerï¼Œè€ŒWorkerä¸­æœ€æ ¸å¿ƒçš„ç±»å°±æ˜¯è°ƒåº¦ç®¡ç†å™¨SchedulerManagerï¼Œæœ¬ç¯‡åšå®¢å°±ä¸“é—¨å¯¹å®ƒè¿›è¡Œå‰–æ\nä¸€ã€æ­£æ–‡ SchedulerManagerèŒè´£æœ‰ä»¥ä¸‹ä¸¤ç‚¹\nä»»åŠ¡è°ƒåº¦ é‡å¹³è¡¡ ä»»åŠ¡è°ƒåº¦æ˜¯SchedulerManageræœ€é‡è¦çš„é€»è¾‘ï¼Œå’±ä»¬é€šè¿‡ pulsar-admin functions create xxx å¯åŠ¨ä¸€ä¸ªfunctionå®ä¾‹æ—¶ï¼ŒPulsar å¦‚ä½•å†³å®šåœ¨å“ªå°workeræ‰€åœ¨èŠ‚ç‚¹å¯åŠ¨è¿™ä¸ªfunctionå®ä¾‹ï¼Œè¿™å°±æ˜¯ä»»åŠ¡è°ƒåº¦è¦åšçš„äº‹æƒ…ï¼Œé™¤æ­¤ä¹‹å¤–ä»»åŠ¡è°ƒåº¦è¿˜åŒ…å«functionæ›´æ–°ã€åˆ é™¤ä»¥åŠä»»åŠ¡çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚è€Œé‡å¹³è¡¡æ˜¯ç¨³å®šæ€§ç›¸å…³çš„ï¼Œå½“å’±ä»¬çš„functionå®ä¾‹åˆ†å¸ƒä¸å‡è¡¡æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ¶çš„æ¶æ­»ï¼Œæ—±çš„æ—±æ­»ï¼Œå› æ­¤éœ€è¦å’±ä»¬åšfunctionå®ä¾‹çš„é‡æ–°åˆ†é…ï¼Œè¿™ä¹Ÿæ˜¯SchedulerManagerè¦åšçš„äº‹æƒ…\näºŒã€ä»»åŠ¡è°ƒåº¦ åœ¨å¼€å§‹è®²è§£ä»»åŠ¡è°ƒåº¦ä¹‹å‰ï¼Œå’±ä»¬å…ˆçœ‹çœ‹ä¸‹é¢è¿™å¼ å›¾\nå›¾ä¸­çš„ä¸Šä¸‹æ–¹åˆ†åˆ«æ˜¯ä¸¤ä¸ªworkerè¿›ç¨‹å®ä¾‹ï¼Œåœ¨å’±ä»¬é€šè¿‡ bin/pulsar functions-worker å¯åŠ¨workerè¿›ç¨‹æ—¶æœåŠ¡å†…éƒ¨ä¼šå¯åŠ¨consumerå¹¶ä»¥failoveræ–¹å¼æ¥åœ¨Brokerè¿›è¡Œæ¶ˆæ¯è®¢é˜…æ¶ˆè´¹ï¼Œfailoveræœºåˆ¶ä¿è¯åŒä¸€æ—¶é—´å†…åªæœ‰ä¸€ä¸ªConsumerèƒ½è¿›è¡Œè®¢é˜…ï¼Œå› æ­¤Workeré€šè¿‡è¿™ä¸ªæœºåˆ¶æ¥è¿›è¡Œé€‰ä¸»ï¼ŒæˆåŠŸè®¢é˜…çš„workeræ™‹å‡ä¸ºleaderè´Ÿè´£ä»»åŠ¡çš„æ´¾å‘ï¼ŒæœªæˆåŠŸè®¢é˜…çš„workerå˜ä¸ºfollwerå¹¶é€šè¿‡Readerç›‘å¬Brokerä¸­çš„ä»»åŠ¡ã€‚å…¶ä¸­Leaderå’ŒFollwerçš„ä¸»è¦é€»è¾‘åˆ†åˆ«å¦‚ä¸‹\nworker-leader é€šè¿‡Consumer-failveræœºåˆ¶æˆä¸ºleaderåï¼Œä¼šç«‹é©¬å¯åŠ¨ä¸€ä¸ªProducerè´Ÿè´£å¾€Brokerä¸­å‘é€ä»»åŠ¡æ¶ˆæ¯ï¼Œæ¯å½“æœ‰æ–°å»ºå¯åŠ¨functionè¯·æ±‚è¿›æ¥ï¼Œå°±ä¼šå¾€Brokerä¸­å†™å…¥ä¸€æ¡å¯¹åº”çš„ä»»åŠ¡æ¶ˆæ¯ã€‚é™¤æ­¤ä¹‹å¤–Leaderè¿˜ä¼šé€šè¿‡Consumeræ¶ˆè´¹Brokerä¸­ä¿å­˜çš„å…ƒæ•°æ®ï¼Œå¹¶ä»¥Mapæ•°æ®ç»“æ„å­˜åœ¨å†…å­˜ä¸­ä½œä¸ºLeaderçš„å…ƒæ•°æ®ç®¡ç†çš„æ•°æ®æ¥æºï¼Œè¿™é‡Œçš„æ•°æ®æœ‰Functionä¿¡æ¯ã€Instanceä¿¡æ¯ç­‰ï¼Œåœ¨æ¥å—åˆ°æˆ‘ä¸è¯·æ±‚æ˜¯ä¹Ÿä¼šåŒæ­¥æ›´æ–°è¿™é‡Œï¼ŒåŒæ—¶ä¹Ÿä¼šå®šæœŸçš„æ ¹æ®å…ƒæ•°æ®æ£€æŸ¥æ¥æ’æŸ¥å‡ºå¼‚å¸¸çš„Functionã€Instanceç­‰ã€‚\nworker-follwer åœ¨workeræˆä¸ºfolloweråï¼Œä¼šå¯åŠ¨Readerç›‘å¬Brokerä¸­çš„ä»»åŠ¡ï¼Œå½“ç›‘å¬åˆ°æœ‰æ–°ä»»åŠ¡æ—¶ä¼šè°ƒç”¨ä»»åŠ¡ç®¡ç†å™¨è¿›è¡Œå¤„ç†ï¼Œä¾‹å¦‚åœ¨æœ‰æ–°å¢å¯åŠ¨Functionæ—¶ï¼Œå¦‚æœæ˜¯é…ç½®çš„çº¿ç¨‹çº§åˆ«åˆ™ä»¥çº¿ç¨‹æ–¹å¼å¯åŠ¨Instanceï¼Œå¦‚æœæ˜¯é…ç½®çš„è¿›ç¨‹çº§åˆ«åˆ™ä¼šæ‹‰èµ·ä¸€ä¸ªç‹¬ç«‹çš„Instanceè¿›ç¨‹è¿›è¡ŒFunctionä»»åŠ¡çš„æ‰§è¡Œã€‚\næºç è§£æ è°ƒåº¦é€»è¾‘çš„ä¸»è¦å…¥å£åœ¨SchedulerManagerçš„invokeScheduleræ–¹æ³•\nè·å–æ‰€æœ‰Function ä»¥åŠInstance åˆ é™¤æ‰€æœ‰ä¸å­˜åœ¨çš„Function/Instanceçš„åˆ†é…å™¨ï¼ŒåŒæ—¶æ›´æ–°åˆ†é…å™¨çš„ä¿¡æ¯ å¦‚æœå…ƒæ•°æ®ç®¡ç†å™¨ä¸­å­˜æœ‰Functionï¼Œä½†æ˜¯è¿™ä¸ªFunctionå¯¹åº”çš„InstanceIDä¸å­˜åœ¨äºRuntimeç®¡ç†å™¨çš„Runtimeåˆ—è¡¨ åˆ™ä»Masterå…ƒæ•°æ®ä¸­åˆ é™¤ï¼Œå¹¶é€šè¿‡å†…éƒ¨Topicå‘é€ä¸€æ¡æ¸…é™¤è¿™ä¸ªInstanceç»™Worker é€šè¿‡å…ƒæ•°æ®æ¯”è¾ƒè·å–éœ€è¦æ–°å¢çš„Instanceå¹¶åŒ…è£…æˆAssignmentï¼Œé€šè¿‡å†…éƒ¨Topicå‘é€è¿™æ¡æ–°å¢Instanceç»™Worker è·å–è¿˜æœªå¯åŠ¨çš„Instanceå®ä¾‹ï¼Œå¹¶é€šè¿‡RoundRobinSchedulerçš„scheduleæ–¹æ³•æ´¾å‘åˆ°å¯¹åº”çš„WorkerèŠ‚ç‚¹è¿›è¡Œå¯åŠ¨ å¾ªç¯é€šè¿‡FunctionRuntimeManager.processAssignmentå¯åŠ¨Instance 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 void invokeScheduler() { long startTime = System.nanoTime(); //è·å–å½“å‰workeré›†ç¾¤ä¸­å¯ç”¨çš„workerèŠ‚ç‚¹ä¿¡æ¯ Set\u0026lt;String\u0026gt; availableWorkers = getCurrentAvailableWorkers(); //è·å–æ‰€æœ‰Function List\u0026lt;FunctionMetaData\u0026gt; allFunctions = functionMetaDataManager.getAllFunctionMetaData(); //è·å–æ‰€æœ‰Instance Map\u0026lt;String, Function.Instance\u0026gt; allInstances = computeAllInstances(allFunctions, functionRuntimeManager.getRuntimeFactory().externallyManaged()); //è·å–å½“å‰æ¯ä¸ª workerId-\u0026gt;(InstanceIdâ€”\u0026gt;ä»»åŠ¡) Map\u0026lt;String, Map\u0026lt;String, Assignment\u0026gt;\u0026gt; workerIdToAssignments = functionRuntimeManager .getCurrentAssignments(); // åˆå§‹åŒ–è°ƒåº¦çŠ¶æ€è®°å½•å™¨ SchedulerStats schedulerStats = new SchedulerStats(workerIdToAssignments, availableWorkers); //delete assignments of functions and instances that don\u0026#39;t exist anymore Iterator\u0026lt;Map.Entry\u0026lt;String, Map\u0026lt;String, Assignment\u0026gt;\u0026gt;\u0026gt; it = workerIdToAssignments.entrySet().iterator(); while (it.hasNext()) { Map.Entry\u0026lt;String, Map\u0026lt;String, Assignment\u0026gt;\u0026gt; workerIdToAssignmentEntry = it.next(); Map\u0026lt;String, Assignment\u0026gt; functionMap = workerIdToAssignmentEntry.getValue(); // remove instances that don\u0026#39;t exist anymore functionMap.entrySet().removeIf(entry -\u0026gt; { String fullyQualifiedInstanceId = entry.getKey(); boolean deleted = !allInstances.containsKey(fullyQualifiedInstanceId); if (deleted) { Assignment assignment = entry.getValue(); MessageId messageId = publishNewAssignment(assignment.toBuilder().build(), true); // Directly update in memory assignment cache since I am leader log.info(\u0026#34;Deleting assignment: {}\u0026#34;, assignment); functionRuntimeManager.deleteAssignment(fullyQualifiedInstanceId); // update message id associated with current view of assignments map lastMessageProduced = messageId; // æ›´æ–°çŠ¶æ€ schedulerStats.removedAssignment(assignment); } return deleted; }); // update assignment instances in case attributes of a function gets updated for (Map.Entry\u0026lt;String, Assignment\u0026gt; entry : functionMap.entrySet()) { String fullyQualifiedInstanceId = entry.getKey(); Assignment assignment = entry.getValue(); Function.Instance instance = allInstances.get(fullyQualifiedInstanceId); if (!assignment.getInstance().equals(instance)) { functionMap.put(fullyQualifiedInstanceId, assignment.toBuilder().setInstance(instance).build()); Assignment newAssignment = assignment.toBuilder().setInstance(instance).build().toBuilder().build(); MessageId messageId = publishNewAssignment(newAssignment, false); // Directly update in memory assignment cache since I am leader log.info(\u0026#34;Updating assignment: {}\u0026#34;, newAssignment); functionRuntimeManager.processAssignment(newAssignment); // update message id associated with current view of assignments map lastMessageProduced = messageId; //update stats schedulerStats.updatedAssignment(newAssignment); } if (functionMap.isEmpty()) { it.remove(); } } } List\u0026lt;Assignment\u0026gt; currentAssignments = workerIdToAssignments .entrySet() .stream() .filter(workerIdToAssignmentEntry -\u0026gt; { String workerId = workerIdToAssignmentEntry.getKey(); // remove assignments to workers that don\u0026#39;t exist / died for now. // wait for failure detector to unassign them in the future for re-scheduling return availableWorkers.contains(workerId); }) .flatMap(stringMapEntry -\u0026gt; stringMapEntry.getValue().values().stream()) .collect(Collectors.toList()); //è·å–æœªåˆ†é…çš„Functionä»»åŠ¡ Pair\u0026lt;List\u0026lt;Function.Instance\u0026gt;, List\u0026lt;Assignment\u0026gt;\u0026gt; unassignedInstances = getUnassignedFunctionInstances(workerIdToAssignments, allInstances); workerStatsManager.scheduleStrategyExecTimeStartStart(); //è§¦å‘ä»»åŠ¡çœŸæ­£è°ƒåº¦æ´¾å‘çš„å…¥å£ List\u0026lt;Assignment\u0026gt; assignments = scheduler.schedule(unassignedInstances.getLeft(), currentAssignments, availableWorkers); workerStatsManager.scheduleStrategyExecTimeStartEnd(); assignments.addAll(unassignedInstances.getRight()); if (log.isDebugEnabled()) { log.debug(\u0026#34;New assignments computed: {}\u0026#34;, assignments); } isCompactionNeeded.set(!assignments.isEmpty()); //æ›´æ–°åˆ°Leaderå†…å­˜ä¸­çš„å…ƒæ•°æ® for (Assignment assignment : assignments) { MessageId messageId = publishNewAssignment(assignment, false); // Directly update in memory assignment cache since I am leader log.info(\u0026#34;Adding assignment: {}\u0026#34;, assignment); functionRuntimeManager.processAssignment(assignment); // update message id associated with current view of assignments map lastMessageProduced = messageId; // update stats schedulerStats.newAssignment(assignment); } log.info(\u0026#34;Schedule summary - execution time: {} sec | total unassigned: {} | stats: {}\\n{}\u0026#34;, (System.nanoTime() - startTime) / Math.pow(10, 9), unassignedInstances.getLeft().size(), schedulerStats.getSummary(), schedulerStats); } ä¸‰ã€æ€»ç»“ ä»¥ä¸Šå°±æ˜¯Pulsarä¸­Workerçš„è°ƒåº¦è¿‡ç¨‹ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä»¥Workerç‹¬ç«‹éƒ¨ç½²çš„æ–¹å¼è¿›è¡Œè®²è§£çš„ï¼ŒåŸºäºBrokerå¯åŠ¨çš„Workeræ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥è‡ªè¡Œè·Ÿè¸ªä¸‹ä»£ç ã€‚\n","date":"2024-09-20T10:34:57+08:00","image":"https://sherlock-lin.github.io/p/worker%E8%B0%83%E5%BA%A6%E7%AE%A1%E7%90%86%E5%99%A8%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20240305140605827-9618768_hu15216224640484705908.png","permalink":"https://sherlock-lin.github.io/p/worker%E8%B0%83%E5%BA%A6%E7%AE%A1%E7%90%86%E5%99%A8%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/","title":"Workerè°ƒåº¦ç®¡ç†å™¨åŸç†è§£æ"},{"content":"å¼•è¨€ ä»»ä½•ä¸œè¥¿éƒ½æœ‰ç”Ÿå‘½å‘¨æœŸï¼Œå°±åƒæ²™ä¸é±¼ç½å¤´ğŸ¥«ä¹Ÿä¼šè¿‡æœŸä¸€æ ·ï¼Œå’±ä»¬çš„æ¶ˆæ¯æœ¬èº«ä¹Ÿæ˜¯æœ‰ç”Ÿå‘½å‘¨æœŸçš„ï¼Œå› æ­¤åƒPulsarè¿™æ ·çš„æµå¹³å°/æ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿæä¾›äº†Retentionã€Backlogå’ŒTTLæœºåˆ¶ã€‚\né»˜è®¤æ¸…ç†æœºåˆ¶ ä»»ä½•æœºåˆ¶çš„å‡ºç°éƒ½æ˜¯æœ‰èƒŒæ™¯çš„ï¼Œå› æ­¤æˆ‘ä»¬è¦å…ˆäº†è§£è¿™ä¸‰ä¸ªæœºåˆ¶å‡ºç°ä¹‹å‰çš„æƒ…å†µï¼Œæ‰èƒ½åˆ†æå‡ºå®ƒä»¬å…·ä½“åˆ†åˆ«è§£å†³çš„äº‹ä»€ä¹ˆé—®é¢˜ã€‚é¦–å…ˆçœ‹ä¸‹å›¾ï¼Œç”Ÿäº§è€…å¾€Brokerä¸æ–­å¾€Brokerä¸­å†™å…¥æ¶ˆæ¯ï¼Œè¿™äº›æ¶ˆæ¯åœ¨Brokerä¸­ä¼šæŒ‰ç…§é¡ºåºä»å·¦åˆ°å³è¿›è¡Œå­˜å‚¨çš„ï¼Œæ–°å†™å…¥çš„æ¶ˆæ¯æ˜¯ä¸æ–­çš„åœ¨å·¦è¾¹è¿›è¡Œæ–°å¢ã€‚æ¶ˆè´¹è€…ä¹Ÿæ˜¯ä»å³å¾€å·¦è¿›è¡Œæ¶ˆè´¹çš„ï¼Œåœ¨Brokerä¸­ä¼šç»´æŒä¸€ä¸ªæ¸¸æ ‡è®°å½•æ¶ˆè´¹çš„æƒ…å†µï¼Œé€šè¿‡æ­¤æ¸¸æ ‡Brokeræ‰å¯ä»¥å¯¹æ¶ˆæ¯è¿›å»åŒºåˆ†ï¼Œå“ªäº›æ¶ˆæ¯æ˜¯å¯æ¸…ç†å›æ”¶çš„ï¼Œå“ªäº›æ¶ˆæ¯æ˜¯ç›®å‰è¿˜ä¸èƒ½æ¸…ç†å›æ”¶çš„ã€‚è¿™ä¸ªé»˜è®¤æ¸…ç†æœºåˆ¶ç¬¦åˆæˆ‘ä»¬ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸€éƒ¨åˆ†ä¸šåŠ¡åœºæ™¯\nRetentionæœºåˆ¶ åœ¨å’±ä»¬ç†è§£äº†é»˜è®¤æ¸…ç†æœºåˆ¶æ—¶ï¼Œæˆ‘ä»¬ä¼šæœ‰ä¸ªç–‘é—®ğŸ¤”ï¸ï¼Œå¦‚æœæ¶ˆæ¯ä¸€è¢«æˆåŠŸæ¶ˆè´¹å°±è¢«åˆ é™¤ï¼Œé‚£ä¹ˆå¦‚æœBrokerçš„ä¸‹æ¸¸å¤„ç†æœ‰é—®é¢˜éœ€è¦ä»å¤´æ¶ˆè´¹æˆ–è€…ä»æŒ‡å®šçš„æŸä¸ªä½ç½®æ¶ˆè´¹çš„è¯ï¼Œç›®å‰çš„æ¸…ç†æœºåˆ¶æ˜¯å®Œæˆæ²¡åŠæ³•æ”¯æŒçš„ã€‚è€ŒPulsarè®¾è®¡çš„ç›®æ ‡æ˜¯ä¸€ä¸ªå¤§ä¸€ç»Ÿçš„æµå¹³å°/æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè‚¯å®šæ˜¯ä¸å…è®¸è¿™ç§æƒ…å†µçš„å‡ºç°ï¼Œå› æ­¤å¼•å…¥äº†Retentionæœºåˆ¶ã€‚\né€šè¿‡ä¸‹å›¾å¯ä»¥çœ‹åˆ°æ¶ˆæ¯å‘å¸ƒè®¢é˜…è¿‡ç¨‹ï¼Œåœ¨é»˜è®¤çš„æ¸…ç†æœºåˆ¶ä¸­æ¸¸æ ‡å³ä¾§çš„æ¶ˆæ¯æ˜¯å…è®¸è¢«åˆ é™¤çš„ï¼Œä½†æ˜¯é…ç½®Retentionçš„æƒ…å†µåˆ™ä¼šæŒ‰ç…§æœºåˆ¶è¿›è¡Œä¿å­˜ä¸€æ®µæ—¶é—´ã€‚è€ŒCursoræ¸¸æ ‡å·¦è¾¹çš„è¿™äº›æ¶ˆæ¯è¡¨ç¤ºè¿˜æ²¡è¢«æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œå› æ­¤å³ä¾¿æ²¡æœ‰é…ç½® Retentionæœºåˆ¶è¿™äº›æ¶ˆæ¯ä¹Ÿä¸ä¼šè¢«åˆ é™¤ã€‚Retention æ”¯æŒæ•°æ®å¤§å°ç»´åº¦ä»¥åŠæ—¶é—´ç»´åº¦ä¸¤ç§æ–¹å¼è¿›è¡Œé…ç½®ï¼Œä¸è¿‡å®ƒç›®å‰ä»…æ”¯æŒé’ˆå¯¹Namespaceçº§åˆ«è¿›è¡Œç”Ÿæ•ˆã€‚\nåœ¨è®¾ç½®Retentioæœºåˆ¶æ—¶å¯ä»¥é€šè¿‡defaultRetentionSizeInMBå’ŒdefaultRetentionTimeInMinutesåŒæ—¶è¿›è¡Œé…ç½®ï¼Œæ­¤æ—¶ä¼šæœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µ\næ—¶é—´ç»´åº¦ æ–‡ä»¶å¤§å°ä¸ºåº¦ æ¶ˆæ¯ä¿ç•™æ•ˆæœ -1 -1 æ°¸ä¹…ä¿å­˜ -1 \u0026gt;0 åŸºäºæ•°æ®å¤§å°è¿›è¡Œä¿ç•™ \u0026gt;0 -1 åŸºäºæ—¶é—´è¿›è¡Œä¿ç•™ 0 0 é»˜è®¤é…ç½®ï¼Œå½“æ¶ˆæ¯è¢«æ¶ˆè´¹åä¸ä¼šè¢«ä¿ç•™ 0 \u0026gt;0 æ— æ•ˆé…ç½® \u0026gt;0 0 æ— æ•ˆé…ç½® \u0026gt;0 \u0026gt;0 å½“æ¶ˆæ¯å·²ç»è¢«æ¶ˆè´¹æˆ–è€…æ²¡æœ‰æ¶ˆè´¹è€…è®¢é˜…æ—¶ï¼Œæ»¡è¶³å…¶ä¸­ä¸€ä¸ªæ¡ä»¶çš„åˆ™ä¸è¢«ä¿ç•™ Backlog é™é¢æœºåˆ¶ Retentionæœºåˆ¶è§£å†³äº†æ¶ˆæ¯â€œæå‰â€åˆ é™¤çš„é—®é¢˜ï¼Œé‚£ä¹ˆå¯ä»¥é«˜æ•æ— å¿§äº†å—ï¼Ÿè®©æˆ‘ä»¬æ¥æƒ³æƒ³ä¸‹é¢è¿™ç§åœºæ™¯ï¼Œå°±æ˜¯æœªè¢«æˆåŠŸæ¶ˆè´¹çš„æ¶ˆæ¯æ˜¯ä¼šä¸€ç›´ä¿ç•™åœ¨Pulsarä¸­çš„ï¼Œé‚£ä¹ˆå¦‚æœå†™å…¥é€Ÿåº¦ä¸€ç›´è¿œå¤§äºæ¶ˆè´¹é€Ÿåº¦ï¼Œæ˜¯ä¸æ˜¯å°±ç›¸å½“äºä¸€ä¸ªè“„æ°´æ± å…¥æ°´é€Ÿåº¦è¿œå¤§äºå‡ºæ°´é€Ÿåº¦ï¼Œæœ€ç»ˆè¿™ä¸ªæ± å­ä¼šæ»¡ä¸€æ ·ï¼ŒPulsarçš„ç£ç›˜ä¹Ÿä¼šè¢«æ‰“æ»¡ä»è€Œå½±å“æœåŠ¡çš„ç¨³å®šæ€§ã€‚\nBacklogçš„åŸç†å…¶å®ä¸å¤æ‚ï¼Œç›¸å½“äºåœ¨è“„æ°´æ± ä¸­æ ‡è®°ä¸€ä¸ªæ°´ä½çº¿ï¼Œå½“è“„æ°´æ± çš„é«˜åº¦åˆ°è¾¾è¿™æ¡æ°´ä½çº¿æ—¶åˆ™è§¦å‘æŠ¥è­¦ï¼Œå·¥ä½œäººå‘˜æ ¹æ®è¿™ä¸ªæŠ¥è­¦æ¥åšå‡ºç›¸å¯¹åº”çš„å¤„ç†ã€‚Pulsarå…¶å®ä¹Ÿæ˜¯ä¸€æ ·ï¼Œå‡å¦‚æˆ‘ä»¬é…ç½®Backlogé™é¢çš„å¤§å°æ˜¯ä¸¤æ¡æ¶ˆæ¯çš„å¤§å°ï¼Œé‚£ä¹ˆå¦‚ä¸‹å›¾ï¼Œæ­¤æ—¶å¦‚æœå·²ç»æœ‰ä¸¤æ¡æ¶ˆæ¯æœªè¢«æ¶ˆè´¹ï¼Œå†æœ‰ä¸€æ¡æ–°çš„æ¶ˆæ¯è¿›è¡Œå°è¯•å†™å…¥ï¼Œå°±ä¼šè§¦å‘Pulsarçš„æŠ¥è­¦ç­–ç•¥è¿›è¡Œå¤„ç†ã€‚\nç§¯å‹è­¦æŠ¥ç­–ç•¥æœ‰ä»¥ä¸‹ä¸‰ç§\nproducer_request_holdï¼šç”Ÿäº§è€…ä¼šæš‚æ—¶ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œå¹¶åœ¨ä¹‹åé‡æ–°è¿›è¡Œæ¶ˆæ¯å‘é€ producer_exceptionï¼šå‘ç”Ÿäº§è€…æŠ›å‡ºå¼‚å¸¸ï¼Œè®©ç”Ÿäº§è€…è¿›è¡Œå¤„ç†å¦‚åœæ­¢æˆ–æš‚åœå¾€Pulsarè¿›è¡Œæ¶ˆæ¯çš„å†™å…¥ consumer_backlog_evictionï¼šBrokerä¼šæ¸…ç†ä¸€äº›ç§¯å‹çš„æ•°æ® Backlog æœºåˆ¶æ˜¯é’ˆå¯¹Namespaceçº§åˆ«é™é¢ï¼ŒåŒæ ·æ˜¯æ”¯æŒé€šè¿‡æ•°æ®å¤§å°ä»¥åŠæ—¶é—´ä¸¤ç§ç»´åº¦é…ç½®ã€‚\nTime to live (TTL) çœ‹èµ·æ¥Retentionå’ŒBacklogæœºåˆ¶å·²ç»åŸºæœ¬æ»¡è¶³æˆ‘ä»¬çš„ä½¿ç”¨äº†ï¼Œé‚£ä¹ˆä¸ºå•¥è¿˜è¦åŠ ä¸€ä¸ªTTLå‘¢ï¼Ÿæ˜¯ç¤¾åŒºé—²ç€æ²¡äº‹å¹²æ•´é‚£ä¹ˆå¤šä¸œè¥¿å—ï¼Œç­”æ¡ˆæ˜¾ç„¶ä¸æ˜¯çš„ã€‚æˆ‘ä»¬å†æ¥æƒ³æƒ³ç”Ÿæ´»ä¸­çš„æŸäº›åœºæ™¯ï¼Œå¦‚æœåœ¨æˆ‘ä»¬çš„ä¸šåŠ¡åœºæ™¯ä¸­æ¶ˆæ¯æ˜¯æœ‰æ—¶æ•ˆæ€§çš„ï¼Œä¾‹å¦‚è‚¡ç¥¨æœ€æ–°çš„ä»·æ ¼ï¼Œå¦‚æœè¿™ä¸ªä»·æ ¼ä¿¡æ¯æ˜¯é€šè¿‡Pulsarè¿›è¡Œä¼ é€’çš„ï¼Œé‚£ä¹ˆå¦‚æœè¿™æ¡æ¶ˆæ¯åŠæ—¶æ²¡æœ‰è¢«æ¶ˆè´¹ï¼Œåœ¨10åˆ†é’Ÿåå®ƒçš„ä»·å€¼ç†è®ºä¸Šå°±æ²¡æœ‰é‚£ä¹ˆé«˜äº†ï¼Œå› ä¸ºè¿˜ä¼šæœ‰æºæºä¸æ–­çš„æœ€æ–°ä»·æ ¼ä¿¡æ¯å†™å…¥Pulsarï¼Œè€Œç”¨æˆ·æ›´åŠ å…³å¿ƒçš„æ˜¯æœ€æ–°çš„ä»·æ ¼ã€‚å› æ­¤æ ¹æ®ä¸šåŠ¡åœºæ™¯ç»™æ¶ˆæ¯é…ç½®ä¸ŠTTLï¼Œå¯ä»¥æ›´æœ‰åˆ©äºPulsarè¿›è¡Œæ¶ˆæ¯çš„å›æ”¶ä»¥åŠèµ„æºçš„é‡Šæ”¾ã€‚é€šè¿‡ä¸‹å›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸€æ¡æ¶ˆæ¯éƒ½æœ‰ä¸€ä¸ªâ€œèœ¡çƒ›â€æ ‡è®°å®ƒçš„ç”Ÿå‘½å‘¨æœŸ\nå½“è¿™æ¡æ¶ˆæ¯ä¸Šé¢çš„èœ¡çƒ›ç‡ƒå°½æ—¶ï¼Œå³ä¾¿è¿™æ¡æ¶ˆæ¯è¿˜æ²¡æœ‰è¢«æ¶ˆè´¹ï¼Œæ¸¸æ ‡ä¾ç„¶ä¼šç§»åŠ¨åˆ°å®ƒå·¦è¾¹å°†å…¶æ ‡è®°ä¸ºå…è®¸è¢«åˆ é™¤ï¼Œå› ä¸ºæ­¤æ—¶å¯¹äºä¸šåŠ¡æ¥è¯´è¿™æ¡æ¶ˆæ¯å·²ç»å±äºæ²¡æœ‰ä»·å€¼ï¼Œæ²¡æœ‰åœ¨Pulsarç»§ç»­ä¿ç•™çš„å¿…è¦ã€‚å¯ä»¥çœ‹åˆ°è¿™ç§æ–¹å¼ç›¸æ¯”Backlogçš„æ–¹å¼æ›´åŠ ç¨³å¦¥ï¼Œå› ä¸ºè¿™ä¸ä¾èµ–äºæ¶ˆè´¹è€…çš„æ¶ˆè´¹æƒ…å†µ\nç»¼åˆ å¯¹äºPulsarå­˜å‚¨è€Œè¨€ï¼ŒBacklogå’ŒTTLæœºåˆ¶å¯ä»¥é˜²æ­¢ç£ç›˜è¢«è€—å°½ï¼›è€ŒRetentionæœºåˆ¶ä¼šå ç”¨ç£ç›˜æ¥ä¿ç•™æœªæ¥å¯èƒ½è¿˜ä¼šç”¨åˆ°çš„æ¶ˆæ¯ã€‚ å¯¹äºå½±å“èŒƒå›´è€Œè¨€ï¼ŒRetentionæœºåˆ¶ä»…é’ˆå¯¹å·²ç»æˆåŠŸæ¶ˆè´¹çš„æ¶ˆæ¯ï¼ŒBacklogå’ŒTTLä»…é’ˆå¯¹æœªè¢«æˆåŠŸæ¶ˆè´¹çš„æ¶ˆæ¯ã€‚ æ•´ä½“æµç¨‹å°±æ˜¯ï¼Œåœ¨è¿‡äº†Retentioné…ç½®çš„æ—¶é—´ï¼Œå·²è¢«æˆåŠŸæ¶ˆè´¹çš„æ¶ˆæ¯å°±ä¼šè¢«åˆ é™¤ï¼›å¦‚æœPulsarçš„æ¶ˆæ¯è¶…è¿‡äº†Backlogé™é¢åˆ™Pulsarä¼šåœæ­¢æ¥æ”¶æ¥è‡ªç”Ÿäº§è€…çš„æ¶ˆæ¯ç›´åˆ°æœ‰æ›´å¤šå¯ç”¨çš„ç©ºé—´ï¼Œå› æ­¤é’ˆå¯¹æ¶ˆæ¯æ•°æ®é…ç½®TTLæ˜¯å¯ä»¥éå¸¸å¥½çš„ä¿æŠ¤Backlogé™é¢çš„ã€‚ Pulsarç‰©ç†å­˜å‚¨çš„å¤§å°åº”è¯¥æ»¡è¶³Retentionå’ŒBacklogçš„æ€»å’Œï¼Œåœ¨è®¾è®¡é›†ç¾¤æ—¶åº”è¯¥æŠŠæ¶ˆæ¯éœ€è¦ä¿ç•™å¤šä¹…ã€å…è®¸å¤šå°‘ç§¯å‹ç­‰è€ƒè™‘è¿›å»ã€‚ é™¤æ­¤ä¹‹å¤–Pulsaræ”¯æŒåˆ†å±‚å­˜å‚¨ï¼Œä¼šå°†å†·æ•°æ®è¿ç§»åˆ°æ›´åŠ å»‰ä»·çš„å¤–éƒ¨ç³»ç»Ÿä¸­å­˜å‚¨ï¼Œæ­¤æ—¶é…ç½®çš„ç­–ç•¥ä¼šä¾ç„¶æœ‰æ•ˆï¼Œå› æ­¤åº”è¯¥è€ƒè™‘å…¨é¢ã€‚ ä»¥ä¸Šå°±æ˜¯Pulsar Retentionã€Backlogå’ŒTTLæœºåˆ¶çš„æ ¸å¿ƒï¼Œå¯ä»¥æ»¡è¶³æµå¹³å°/æ¶ˆæ¯é˜Ÿåˆ—çš„ä½¿ç”¨åœºæ™¯\nå‚è€ƒèµ„æ–™ å®˜æ–¹æ–‡æ¡£\nUnderstanding Pulsar Message TTL, Backlog, and Retention\nApache Pulsar ä¹‹ TTL ä¸ Retention ç­–ç•¥\n","date":"2024-09-20T10:34:57+08:00","image":"https://sherlock-lin.github.io/p/%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3pulsar%E7%9A%84%E6%B6%88%E6%81%AF%E4%BF%9D%E7%95%99%E7%A7%AF%E5%8E%8Bttl%E7%AD%96%E7%95%A5%E5%90%97/image-20240331085922332_hu13280254660255972346.png","permalink":"https://sherlock-lin.github.io/p/%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3pulsar%E7%9A%84%E6%B6%88%E6%81%AF%E4%BF%9D%E7%95%99%E7%A7%AF%E5%8E%8Bttl%E7%AD%96%E7%95%A5%E5%90%97/","title":"ä½ çœŸçš„äº†è§£Pulsarçš„æ¶ˆæ¯ä¿ç•™ã€ç§¯å‹ã€TTLç­–ç•¥å—"},{"content":"ä¸€ã€ç®€æ Brokerçš„å¯åŠ¨æµç¨‹æ¡†æ¶åŸºæœ¬å¦‚ä¸‹\nè§¦å‘å¯åŠ¨ åˆå§‹åŒ– è¯»å–é…ç½®ã€æ£€æµ‹ã€èµ‹å€¼ å¯åŠ¨ Bookieå¯åŠ¨ Brokerå¯åŠ¨ å¯åŠ¨Netty å¯åŠ¨åå°ç›‘æ§ä»»åŠ¡ äºŒã€ä½•æ—¶ã€å¦‚ä½•è§¦å‘å¯åŠ¨ Brokerçš„å¯åŠ¨åŸºæœ¬éƒ½æ˜¯é ç»´æŠ¤äººå‘˜ä¸»åŠ¨è§¦å‘çš„ï¼Œå…¥å£æ˜¯Brokeræä¾›çš„è„šæœ¬ bin/pulsarã€bin/pulsar-daemonã€‚å¸¸è§çš„å¯åŠ¨æŒ‡ä»¤æœ‰ bin/pulsar standaloneã€ bin/pulsar brokerã€bin/pulsar-daemon start brokerç­‰ï¼Œä»Šå¤©å°±ä»bin/pulsar brokeræµç¨‹è¿›è¡Œæ¢è®¨ã€‚å…ˆæ¥çœ‹çœ‹bin/pulsarçš„è„šæœ¬é€»è¾‘\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 pulsar_help() { cat \u0026lt;\u0026lt;EOF //åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°pulsaræ”¯æŒçš„æ“ä½œï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡bin/pulsar help æŒ‡ä»¤è¿›è¡ŒæŸ¥çœ‹ Usage: pulsar \u0026lt;command\u0026gt; where command is one of: //å¯åŠ¨BrokeræœåŠ¡ broker Run a broker server //å¯åŠ¨bookieæœåŠ¡ bookie Run a bookie server zookeeper Run a zookeeper server configuration-store Run a configuration-store server discovery Run a discovery server proxy Run a pulsar proxy websocket Run a web socket proxy server functions-worker Run a functions worker server sql-worker Run a sql worker server sql Run sql CLI standalone Run a broker server with local bookies and local zookeeper autorecovery Run an autorecovery service .... } //å¦‚æœæ‰§è¡Œçš„æ˜¯bin/pulsar brokeråˆ™ä¼šèµ°åˆ°è¿™é‡Œï¼Œå¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°æœ€ç»ˆä¼šè°ƒç”¨PulsarBrokerStarterç±»è¿›è¡Œå¯åŠ¨ if [ $COMMAND == \u0026#34;broker\u0026#34; ]; then PULSAR_LOG_FILE=${PULSAR_LOG_FILE:-\u0026#34;pulsar-broker.log\u0026#34;} exec $JAVA $LOG4J2_SHUTDOWN_HOOK_DISABLED $OPTS -Dpulsar.log.file=$PULSAR_LOG_FILE org.apache.pulsar.PulsarBrokerStarter --broker-conf $PULSAR_BROKER_CONF $@ elif [ $COMMAND == \u0026#34;bookie\u0026#34; ]; then PULSAR_LOG_FILE=${PULSAR_LOG_FILE:-\u0026#34;bookkeeper.log\u0026#34;} exec $JAVA $OPTS -Dpulsar.log.file=$PULSAR_LOG_FILE org.apache.bookkeeper.server.Main --conf $PULSAR_BOOKKEEPER_CONF $@ ä¸‰ã€Brokerå¯åŠ¨æµç¨‹ é€šè¿‡è„šæœ¬èƒ½å¤Ÿçœ‹åˆ°æ˜¯é€šè¿‡PulsarBrokerStarterè¿›è¡Œå¯åŠ¨ï¼Œå› æ­¤ç°åœ¨å°±ç›´æ¥ä»å®ƒçš„mainæ–¹æ³•è¿›è¡Œè·Ÿè¸ªå§\nè¿™é‡Œçš„åˆå§‹åŒ–å’Œå¯åŠ¨ä¸¤æ¡é“¾è·¯éƒ½å€¼å¾—çœ‹ï¼Œé¦–å…ˆè·Ÿè¸ªä¸‹åˆå§‹åŒ–Brokerçš„é“¾è·¯\nå¯ä»¥çœ‹åˆ°åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­åˆ†åˆ«åšäº† é…ç½®åŠ è½½ã€åˆå§‹åŒ–Brokerã€åˆå§‹åŒ–Bookkeeperä»¥åŠAutoRecoveryMainæœåŠ¡ç­‰ã€‚æ¥ä¸‹æ¥å°±å°±çœ‹æœåŠ¡å¯åŠ¨é“¾è·¯ã€‚\nå¯ä»¥çœ‹åˆ°å¯åŠ¨å…¥å£å¾ˆç®€æ´ï¼Œå°±æ˜¯å¯åŠ¨ä¸Šé¢åˆå§‹åŒ–å¥½çš„Brokerã€Bookkeeperã€AutoRecoveryMainï¼Œè¿™é‡Œå…ˆçœ‹Brokerçš„å¯åŠ¨æµç¨‹ä¹Ÿå°±æ˜¯276è¡Œ\nå¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•éå¸¸å¤§ï¼Œé‡Œé¢å†…å®¹éå¸¸ä¸°å¯Œï¼Œä¸€èµ·æ¥è¯¦ç»†çœ‹çœ‹\nç®€å•æ€»ç»“ä¸‹è¿™ä¸ªæ–¹æ³•ï¼Œå®ƒä¸»è¦åˆ›å»ºäº†ä»¥ä¸‹å‡ ä¸ªå¯¹è±¡\nCoordinationServiceImplå¯¹è±¡ï¼Œç”¨äºåè°ƒBrokeré€‰ä¸»\nBrokerServiceå¯¹è±¡ï¼Œè¿™ä¸ªæ˜¯å¯åŠ¨Brokerå¯¹è±¡çš„æ ¸å¿ƒ\nLoadManagerå¯¹è±¡ï¼Œç”¨äºç®¡ç†Brokerå¯¹è±¡çš„è´Ÿè½½å‡è¡¡\nSchemaStorageå¯¹è±¡ï¼Œè´Ÿè´£å¤„ç†è¯»å†™schemaçš„è¯·æ±‚\nOffloadPoliciesImplï¼Œè´Ÿè´£åˆ†å±‚å­˜å‚¨æ“ä½œ\nå¹¶å¯åŠ¨WebServiceæœåŠ¡ï¼Œè´Ÿè´£å¯¹å¤–æä¾›httpæœåŠ¡\nWorkerServiceæœåŠ¡ï¼Œè´Ÿè´£å¤„ç†functionè®¡ç®—æ“ä½œ\nè¿™é‡Œé¢çš„BrokerServiceæ˜¯æœ€æ ¸å¿ƒçš„ï¼Œåœ¨è¿™é‡Œè¿›å»çœ‹ä¸‹å®ƒåˆ›å»ºçš„é€»è¾‘\næ­¤æ–¹æ³•ä¸»è¦åšäº†ä¸‹é¢å‡ ä»¶äº‹\nåˆ›å»ºNettyæœåŠ¡ç«¯ï¼Œç”¨äºå¤„ç†ç”Ÿäº§è€…/æ¶ˆè´¹è€…/ä»£ç†çš„TCPè¯·æ±‚ åˆ›å»ºå®šæœŸæ£€æµ‹æœåŠ¡ ä¸æ´»è·ƒçš„æ£€æµ‹ æ¶ˆæ¯è¿‡æœŸæ£€æµ‹ å‹ç¼©æ£€æµ‹ æ¶ˆè´¹è€…æ£€æµ‹ åˆå§‹åŒ–äº”ä¸ªMapå®¹å™¨ ç»´æŠ¤Topicå¯¹è±¡ ç»´æŠ¤é›†ç¾¤å‰¯æœ¬å¤åˆ¶çš„å®¢æˆ·ç«¯ ç»´æŠ¤è¿æ¥å½“å‰Brokerçš„ç®¡ç†æµ ç»´æŠ¤Topicå½’å±ä¿¡æ¯ ç»´æŠ¤å¤šå±‚çº§çš„Topicä¿¡æ¯ï¼Ÿ å¯åŠ¨DelayedDeliveryTrackerLoaderè·Ÿè¸ªå»¶è¿Ÿæ¶ˆæ¯ å¯åŠ¨Brokeræ‹¦æˆªå™¨BrokerEntryMetadataInterceptors å¯åŠ¨é™é¢ç®¡ç†å¯¹è±¡BundlesQuotas å¯åŠ¨NettyæœåŠ¡ç«¯(æ­¤æ—¶PulsaræœåŠ¡å…·å¤‡å¤„ç†æ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚èƒ½åŠ›) å¯åŠ¨å®šæœŸæ£€æµ‹æœåŠ¡ ä¸æ´»è·ƒçš„æ£€æµ‹ æ¶ˆæ¯è¿‡æœŸæ£€æµ‹ å‹ç¼©æ£€æµ‹ æ¶ˆè´¹è€…æ£€æµ‹ æ¶ˆæ¯ç§¯å‹æ£€æµ‹ å››ã€æ€»ç»“ PulsarServiceæ˜¯PulsaræœåŠ¡å¯åŠ¨çš„æ ¸å¿ƒç±»ï¼Œå…¶å†…ç½®äº†ä¸ƒå¤§é‡è¦çš„å¯¹è±¡å¦‚ä¸‹å›¾\nBrokerService: æ ¸å¿ƒæ˜¯å¯åŠ¨Nettyï¼Œå¤„ç†å®¢æˆ·ç«¯çš„TCPè¿æ¥ï¼ŒåŒæ—¶é€šè¿‡å¤šä¸ªMapå®¹å™¨ç»´æŠ¤ä¾‹å¦‚Topicä¿¡æ¯ã€Topicå½’å±ä¿¡æ¯ç­‰ç­‰ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜å¯åŠ¨ä¸€æ‰¹å®šæ—¶çº¿ç¨‹å®šæœŸæ£€æµ‹(æ¶ˆæ¯è¿‡æœŸã€å‹ç¼©ã€å®¢æˆ·ç«¯æ´»è·ƒç­‰) LoadManager: è´Ÿè´£å¤„ç†BrokeræœåŠ¡çš„è´Ÿè½½å‡è¡¡ WebService: å¯¹å¤–æä¾›HTTPæœåŠ¡ï¼Œä¾‹å¦‚ç®¡ç†æµçš„æ“ä½œ(å…ƒæ•°æ®)ç­‰ CoordinationService: ç»™Brokeræä¾›åè°ƒæœåŠ¡ï¼Œä¾‹å¦‚Brokeré€‰ä¸»æ“ä½œ SchemaStorage: æä¾›schemaç›¸å…³çš„ä¸€åˆ‡æœåŠ¡ï¼Œå¸¸è§çš„å°±æ˜¯schemaçš„è¯»å†™ OffloadPolicies: æä¾›åˆ†å±‚å­˜å‚¨ï¼Œå†·æ•°æ®è‡ªåŠ¨è¿ç§»åˆ°å¤–éƒ¨æœåŠ¡ä¸­ WorkerService: ç®¡ç†Workerå®ä¾‹ï¼Œç”¨æ¥æ‰§è¡ŒFunctionè®¡ç®—ä»»åŠ¡ ä»¥ä¸Šå°±æ˜¯Pulsarå¯åŠ¨æµç¨‹æ‰€åšçš„äº‹æƒ…ï¼Œå…¶ä¸­Bookkeeperçš„å¯åŠ¨ä»¥åŠå…¶ä½™çš„åŠŸèƒ½ä¾‹å¦‚CoordinationServiceã€SchemaStorageç­‰ç­‰éƒ½å€¼å¾—å•ç‹¬æ–°å¼€ä¸€ç¯‡æ–‡ç« è¿›è¡Œè®²è§£ï¼Œè¿™é‡Œå°±ä¸æ··åœ¨ä¸€èµ·è®²äº†ã€‚\n","date":"2024-09-20T10:34:57+08:00","image":"https://sherlock-lin.github.io/p/%E5%90%AF%E7%A8%8Bpulsar%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E9%AB%98%E9%80%9F%E5%90%AF%E5%8A%A8%E5%BC%95%E6%93%8E%E6%8F%AD%E7%A7%98%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%B7%A8%E5%85%BD%E7%9A%84%E8%AF%9E%E7%94%9F/image-20240913141630196_hu5121917752973153749.png","permalink":"https://sherlock-lin.github.io/p/%E5%90%AF%E7%A8%8Bpulsar%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E9%AB%98%E9%80%9F%E5%90%AF%E5%8A%A8%E5%BC%95%E6%93%8E%E6%8F%AD%E7%A7%98%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%B7%A8%E5%85%BD%E7%9A%84%E8%AF%9E%E7%94%9F/","title":"å¯ç¨‹Pulsarï¼šæ·±å…¥å‰–æé«˜é€Ÿå¯åŠ¨å¼•æ“ï¼Œæ­ç§˜æ¶ˆæ¯ä¸­é—´ä»¶å·¨å…½çš„è¯ç”Ÿ"},{"content":"ä¸€ã€å¼•è¨€ æ— è®ºä½ æ˜¯åˆšæ¥è§¦Pulsarè¿˜æ˜¯ä½¿ç”¨Pulsarå¤šå¹´ï¼Œç›¸ä¿¡ä½ å¯¹ä¸‹é¢è¿™æ®µä»£ç éƒ½å¾ˆç†Ÿæ‚‰ï¼Œè¿™å°±æ˜¯ç”Ÿäº§è€…ç«¯æœ€å¸¸å†™çš„ä»£ç æ²¡æœ‰ä¹‹ä¸€ï¼Œå…¶ä¸­æœ€æ ¸å¿ƒçš„å…¶å®å°±ä¸‰è¡Œä»£ç ï¼Œåˆ†åˆ«ç”¨çº¢è‰²æ•°å­—æ ‡è¯†å‡ºæ¥äº†ï¼Œå…¶ä¸­å¯¹åº”çš„å°±æ˜¯1ã€å®¢æˆ·ç«¯å¯¹è±¡åˆ›å»º 2ã€ç”Ÿäº§è€…å¯¹è±¡åˆ›å»º 3ã€æ¶ˆæ¯å‘é€ã€‚ä»Šå¤©å°±åˆ†åˆ«é’ˆå¯¹è¿™ä¸‰ä¸ªæ­¥éª¤è¿›è¡Œæ·±å…¥çš„æ¢ç´¢ã€‚\näºŒã€åˆ›å»ºå®¢æˆ·ç«¯å¯¹è±¡ æ— è®ºæ˜¯å†™ç”Ÿäº§è€…è¿˜æ˜¯æ¶ˆè´¹è€…ç«¯ä»£ç ï¼Œç¬¬ä¸€æ­¥éƒ½æ˜¯è¦åˆ›å»ºå®¢æˆ·ç«¯å¯¹è±¡ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å¯¹è±¡éƒ½åšäº†äº›ä»€ä¹ˆäº‹æƒ…å‘¢ï¼Ÿè¿™é‡Œå°†å®¢æˆ·ç«¯å¯¹è±¡åˆ›å»ºçš„æ­¥éª¤ç»˜åˆ¶æˆä»¥ä¸‹å›¾\nå®¢æˆ·ç«¯å¯¹è±¡çš„åˆ›å»ºä»¥ä¸‹å‡ ä¸ªä¸œè¥¿ï¼Œå…¶ä¸­æœ€é‡è¦çš„æ˜¯å‰ä¸¤ä¸ª\nLookupæœåŠ¡ è¿æ¥æ±  çº¿ç¨‹æ±  å†…å­˜æ§åˆ¶å™¨MemoryLimitController åˆ›å»ºå®¢æˆ·ç«¯è®¡æ•°å™¨HashedWheelTimer 1. LookupæœåŠ¡ LookupæœåŠ¡è´Ÿè´£è·å–Topicçš„å½’å±Brokeråœ°å€ä»¥åŠSchemaä¿¡æ¯ç­‰ï¼Œéå¸¸é‡è¦ã€‚é»˜è®¤æœ‰HTTPå’ŒäºŒè¿›åˆ¶ä¼ è¾“ä¸¤ç§å®ç°ï¼Œå¦‚æœåˆ›å»ºå®¢æˆ·ç«¯å¯¹è±¡æ—¶.serviceUrlæ–¹æ³•ä¼ å…¥çš„åœ°å€æ˜¯httpå¼€å¤´åˆ™ä½¿ç”¨HTTPå®ç°ï¼Œå¦åˆ™å°±æ˜¯äºŒè¿›åˆ¶ä¼ è¾“å®ç°ã€‚\nLookupæœåŠ¡çš„åˆ›å»ºå¦‚ä¸‹\n1 2 3 4 5 6 7 //åˆå§‹åŒ–LookupServiceæœåŠ¡ if (conf.getServiceUrl().startsWith(\u0026#34;http\u0026#34;)) { lookup = new HttpLookupService(conf, this.eventLoopGroup); } else { lookup = new BinaryProtoLookupService(this, conf.getServiceUrl(), conf.getListenerName(), conf.isUseTls(), this.scheduledExecutorProvider.getExecutor()); } è¿›å…¥çœ‹çœ‹HttpLookupServiceçš„æ„é€ æ–¹æ³•å¯ä»¥çœ‹åˆ°å®ƒæ˜¯å†…éƒ¨å¥—äº†ä¸€ä¸ªHttpClientå¯¹è±¡æ¥å¯¹å¤–è¿›è¡ŒHTTPé€šä¿¡ï¼Œåœ¨ç»§ç»­çœ‹HttpClientçš„æ„é€ å‡½æ•°å¯ä»¥å®ƒå†…éƒ¨å®é™…ä¸Šæ˜¯è°ƒç”¨çš„DefaultAsyncHttpClientæ„é€ å‡½æ•°æ¥åˆ›å»ºï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯å¤–éƒ¨åŒ… async-http-client-2.12.1.jarçš„å®ç°ï¼Œè·Ÿäº†ä¸€ä¸‹ä»£ç ï¼Œåº•å±‚ä¹Ÿæ˜¯åŸºäºNettyæ¥è¿›è¡Œå®ç°çš„HTTPé•¿è¿æ¥é€šä¿¡\n1 2 3 4 5 6 7 8 9 10 11 public HttpLookupService(ClientConfigurationData conf, EventLoopGroup eventLoopGroup) throws PulsarClientException { this.httpClient = new HttpClient(conf, eventLoopGroup); this.useTls = conf.isUseTls(); this.listenerName = conf.getListenerName(); } protected HttpClient(ClientConfigurationData conf, EventLoopGroup eventLoopGroup) throws PulsarClientException { .... httpClient = new DefaultAsyncHttpClient(config); } è·Ÿåˆ°è¿™é‡Œå°±å·®ä¸å¤šäº†ï¼Œæˆ‘ä»¬çŸ¥é“åˆ›å»ºå®¢æˆ·ç«¯å¯¹è±¡çš„æ—¶å€™ä¼šåˆå§‹åŒ–LookupæœåŠ¡ï¼Œè€ŒLookupæœåŠ¡åˆå§‹åŒ–çš„æ—¶å€™ä¼šåˆ›å»ºè·Ÿå¤–éƒ¨è¿›è¡Œé€šä¿¡çš„å¼‚æ­¥HTTPå®¢æˆ·ç«¯ï¼Œç”¨äºåœ¨åˆ›å»ºç”Ÿäº§è€…æ—¶å»æŸ¥è¯¢Topicçš„å½’å±Brokerçš„IPåœ°å€ï¼Œè¿™æ ·ç”Ÿäº§è€…æ‰çŸ¥é“å…·ä½“å»è·Ÿå“ªå°Brokeråˆ›å»ºTCPè¿æ¥\n2. è¿æ¥æ± ConnectionPool è¿æ¥æ± æ˜¯æ± åŒ–æŠ€æœ¯åœ¨ç½‘ç»œè¿æ¥è¿™ä¸ªåœºæ™¯çš„ä½¿ç”¨ï¼Œä½¿ç”¨è¿æ¥æ± å¯ä»¥é¿å…é‡å¤åˆ›å»ºå…³é—­TCPè¿æ¥é€ æˆèµ„æºæµªè´¹ä»¥åŠæå‡æ€§èƒ½ã€‚åœ¨åˆ›å»ºå®¢æˆ·ç«¯å¯¹è±¡çš„æ„é€ æ–¹æ³•ä¸­ï¼ŒConnectionPoolçš„åˆ›å»ºå¦‚ä¸‹ï¼Œå¯ä»¥æ˜¯é€šè¿‡newæ–¹å¼è¿›è¡Œåˆ›å»ºï¼Œå› æ­¤æˆ‘ä»¬çœ‹ä¸‹å®ƒçš„æ„é€ æ–¹æ³•\n1 2 connectionPoolReference = connectionPool != null ? connectionPool : new ConnectionPool(conf, this.eventLoopGroup); ConnectionPoolçš„æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°æ ¸å¿ƒé€»è¾‘å…¶å®å°±æ˜¯é€šè¿‡Bootstrapåˆ›å»ºNettyå®¢æˆ·ç«¯å¯¹è±¡ï¼Œé€šè¿‡ pool = new ConcurrentHashMap\u0026lt;\u0026gt;(); è¿™è¡Œä»£ç ä¹Ÿå¾ˆé‡è¦ï¼Œè¿™ä¸ªHashMapå°±æ˜¯å­˜å‚¨å’±ä»¬çš„ç½‘ç»œè¿æ¥\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 public ConnectionPool(ClientConfigurationData conf, EventLoopGroup eventLoopGroup, Supplier\u0026lt;ClientCnx\u0026gt; clientCnxSupplier, Optional\u0026lt;AddressResolver\u0026lt;InetSocketAddress\u0026gt;\u0026gt; addressResolver) throws PulsarClientException { .... //å¯åŠ¨Nettyå®¢æˆ·ç«¯ pool = new ConcurrentHashMap\u0026lt;\u0026gt;(); bootstrap = new Bootstrap(); bootstrap.group(eventLoopGroup); bootstrap.channel(EventLoopUtil.getClientSocketChannelClass(eventLoopGroup)); //Nettyç›¸å…³é…ç½® bootstrap.option(ChannelOption.CONNECT_TIMEOUT_MILLIS, conf.getConnectionTimeoutMs()); bootstrap.option(ChannelOption.TCP_NODELAY, conf.isUseTcpNoDelay()); bootstrap.option(ChannelOption.ALLOCATOR, PulsarByteBufAllocator.DEFAULT); try { channelInitializerHandler = new PulsarChannelInitializer(conf, clientCnxSupplier); bootstrap.handler(channelInitializerHandler); } catch (Exception e) { log.error(\u0026#34;Failed to create channel initializer\u0026#34;); throw new PulsarClientException(e); } .... } ä¸‰ã€ç”Ÿäº§è€…å¯¹è±¡åˆ›å»º çœ‹å®Œäº†å®¢æˆ·ç«¯å¯¹è±¡åˆ›å»ºï¼Œå†æ¥çœ‹çœ‹ç”Ÿäº§è€…å¯¹è±¡çš„åˆ›å»ºï¼Œä»è¿™æ¡è¯­å¥è¿›è¡Œåˆ‡å…¥ Producer\u0026lt;String\u0026gt; producer = pulsarClient.newProducer(...).create(); åœ¨åˆ›å»ºç”Ÿäº§è€…å¯¹è±¡æ—¶ä¼šè¿›è¡Œä¸€ä¸‹å‡ æ­¥\n1. æŒ‡å®šè·¯ç”±ç­–ç•¥ è¿™ä¸ªä¸»è¦å°±æ˜¯æ ¹æ®åˆ›å»ºç”Ÿäº§è€…å¯¹è±¡æ—¶æŒ‡å®šçš„ï¼Œå¦‚æœæ²¡æœ‰é…ç½®çš„è¯é»˜è®¤ä½¿ç”¨çš„è½®è¯¢è·¯ç”±ç­–ç•¥ã€‚setMessageRoutingMode è¿™ä¸ªæ–¹æ³•å°±æ˜¯æŒ‡å®šè·¯ç”±ç­–ç•¥çš„ï¼Œç„¶åæŒ‡å®šå®Œåä¸‹é¢çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæœ‰é…ç½®æ‹¦æˆªå™¨çš„è¯åœ¨åˆ›å»ºç”Ÿäº§è€…å¯¹è±¡æ—¶ä¹Ÿä¼šæŠŠå®ƒç»™æ‹¦æˆªé€»è¾‘åŠ è½½è¿›å»ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 public CompletableFuture\u0026lt;Producer\u0026lt;T\u0026gt;\u0026gt; createAsync() { .... try { setMessageRoutingMode(); } catch (PulsarClientException pce) { return FutureUtil.failedFuture(pce); } return interceptorList == null || interceptorList.size() == 0 ? client.createProducerAsync(conf, schema, null) : client.createProducerAsync(conf, schema, new ProducerInterceptors(interceptorList)); } setMessageRoutingMode é€»è¾‘å¦‚ä¸‹ï¼Œé»˜è®¤ç”¨è½®è¯¢è·¯ç”±ï¼Œå¦‚æœé…ç½®å…¶ä»–çš„å°±ç”¨å…¶ä»–çš„ï¼Œå…¶æ¬¡å°±æ˜¯åšè·¯ç”±è§„åˆ™çš„æ ¡éªŒï¼Œçœ‹çœ‹ç”¨æˆ·æ˜¯å¦é…ç½®çš„ä¿¡æ¯æœ‰å†²çªçš„æå‰æ„ŸçŸ¥å¹¶æŠ›å‡ºå»ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 private void setMessageRoutingMode() throws PulsarClientException { if (conf.getMessageRoutingMode() == null \u0026amp;\u0026amp; conf.getCustomMessageRouter() == null) { messageRoutingMode(MessageRoutingMode.RoundRobinPartition); } else if (conf.getMessageRoutingMode() == null \u0026amp;\u0026amp; conf.getCustomMessageRouter() != null) { messageRoutingMode(MessageRoutingMode.CustomPartition); } else if (conf.getMessageRoutingMode() == MessageRoutingMode.CustomPartition \u0026amp;\u0026amp; conf.getCustomMessageRouter() == null) { throw new PulsarClientException(\u0026#34;When \u0026#39;messageRoutingMode\u0026#39; is \u0026#34; + MessageRoutingMode.CustomPartition + \u0026#34;, \u0026#39;messageRouter\u0026#39; should be set\u0026#34;); } else if (conf.getMessageRoutingMode() != MessageRoutingMode.CustomPartition \u0026amp;\u0026amp; conf.getCustomMessageRouter() != null) { throw new PulsarClientException(\u0026#34;When \u0026#39;messageRouter\u0026#39; is set, \u0026#39;messageRoutingMode\u0026#39; \u0026#34; + \u0026#34;should be set as \u0026#34; + MessageRoutingMode.CustomPartition); } } 2. è·å–Topicåˆ†åŒºæ•°å’ŒSchema é€šè¿‡Lookupæœºåˆ¶å»Brokerä¸­æŸ¥è¯¢è¿™ä¸ªTopicçš„Schemaä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°å¦‚æœæœåŠ¡ç«¯æ²¡æœ‰é…ç½®Schemaä¿¡æ¯çš„è¯åˆ™é»˜è®¤ç”¨ Schema.BYTES\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 return lookup.getSchema(TopicName.get(conf.getTopicName())) .thenCompose(schemaInfoOptional -\u0026gt; { if (schemaInfoOptional.isPresent()) { SchemaInfo schemaInfo = schemaInfoOptional.get(); if (schemaInfo.getType() == SchemaType.PROTOBUF) { autoProduceBytesSchema.setSchema(new GenericAvroSchema(schemaInfo)); } else { autoProduceBytesSchema.setSchema(Schema.getSchema(schemaInfo)); } } else { autoProduceBytesSchema.setSchema(Schema.BYTES); } return createProducerAsync(topic, conf, schema, interceptors); }); å’±ä»¬è¿›å»çœ‹çœ‹ getSchema çš„å®ç°ï¼Œå¯ä»¥çœ‹åˆ°æ„é€ çš„æ˜¯HTTPåœ°å€å¹¶é€šè¿‡GETæ–¹å¼è¯·æ±‚Brokerè¿›è¡Œè·å–\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 public CompletableFuture\u0026lt;Optional\u0026lt;SchemaInfo\u0026gt;\u0026gt; getSchema(TopicName topicName, byte[] version) { CompletableFuture\u0026lt;Optional\u0026lt;SchemaInfo\u0026gt;\u0026gt; future = new CompletableFuture\u0026lt;\u0026gt;(); String schemaName = topicName.getSchemaName(); String path = String.format(\u0026#34;admin/v2/schemas/%s/schema\u0026#34;, schemaName); if (version != null) { if (version.length == 0) { future.completeExceptionally(new SchemaSerializationException(\u0026#34;Empty schema version\u0026#34;)); return future; } path = String.format(\u0026#34;admin/v2/schemas/%s/schema/%s\u0026#34;, schemaName, ByteBuffer.wrap(version).getLong()); } httpClient.get(path, GetSchemaResponse.class).thenAccept(response -\u0026gt; { if (response.getType() == SchemaType.KEY_VALUE) { SchemaData data = SchemaData .builder() .data(SchemaUtils.convertKeyValueDataStringToSchemaInfoSchema( response.getData().getBytes(StandardCharsets.UTF_8))) .type(response.getType()) .props(response.getProperties()) .build(); future.complete(Optional.of(SchemaInfoUtil.newSchemaInfo(schemaName, data))); } else { future.complete(Optional.of(SchemaInfoUtil.newSchemaInfo(schemaName, response))); } }).exceptionally(ex -\u0026gt; { .... }); return future; } é™¤äº†è¯»å–Schemaï¼Œè¿˜ä¼šè¯»å–Topicçš„åˆ†åŒºä¿¡æ¯ï¼Œä»ä¸‹é¢åˆ›å»ºçš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœå­˜åœ¨åˆ†åŒºåˆ™åˆ›å»ºPartitionedProducerImplå¯¹è±¡ï¼Œä¸å­˜åœ¨åˆ†åŒºåˆ™åˆ›å»ºProducerImplå¯¹è±¡ã€‚è·å–åˆ†åŒºçš„æ–¹æ³•æ˜¯ getPartitionedTopicMetadataï¼Œå’±ä»¬è¿›å»çœ‹çœ‹å®ƒçš„å®ç°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 private \u0026lt;T\u0026gt; CompletableFuture\u0026lt;Producer\u0026lt;T\u0026gt;\u0026gt; createProducerAsync(String topic, ProducerConfigurationData conf, Schema\u0026lt;T\u0026gt; schema, ProducerInterceptors interceptors) { CompletableFuture\u0026lt;Producer\u0026lt;T\u0026gt;\u0026gt; producerCreatedFuture = new CompletableFuture\u0026lt;\u0026gt;(); getPartitionedTopicMetadata(topic).thenAccept(metadata -\u0026gt; { .... ProducerBase\u0026lt;T\u0026gt; producer; if (metadata.partitions \u0026gt; 0) { producer = newPartitionedProducerImpl(topic, conf, schema, interceptors, producerCreatedFuture, metadata); } else { producer = newProducerImpl(topic, -1, conf, schema, interceptors, producerCreatedFuture, Optional.empty()); } producers.add(producer); }).exceptionally(ex -\u0026gt; { .... }); return producerCreatedFuture; } getPartitionedTopicMetadataæ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ï¼Œé€šè¿‡ä¸€è·¯è·Ÿè¸ªä¸‹å»å‘ç°ä¹Ÿæ˜¯é€šè¿‡LookupæœåŠ¡è¿›è¡ŒHTTPè¿›è¡ŒæŸ¥è¯¢è¯»å–åˆ†åŒºä¿¡æ¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 public CompletableFuture\u0026lt;PartitionedTopicMetadata\u0026gt; getPartitionedTopicMetadata(String topic) { CompletableFuture\u0026lt;PartitionedTopicMetadata\u0026gt; metadataFuture = new CompletableFuture\u0026lt;\u0026gt;(); try { TopicName topicName = TopicName.get(topic); AtomicLong opTimeoutMs = new AtomicLong(conf.getLookupTimeoutMs()); .... getPartitionedTopicMetadata(topicName, backoff, opTimeoutMs, metadataFuture, new ArrayList\u0026lt;\u0026gt;()); } catch (IllegalArgumentException e) { .... } return metadataFuture; } private void getPartitionedTopicMetadata(TopicName topicName, Backoff backoff, AtomicLong remainingTime, CompletableFuture\u0026lt;PartitionedTopicMetadata\u0026gt; future, List\u0026lt;Throwable\u0026gt; previousExceptions) { long startTime = System.nanoTime(); lookup.getPartitionedTopicMetadata(topicName).thenAccept(future::complete).exceptionally(e -\u0026gt; { remainingTime.addAndGet(-1 * TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - startTime)); long nextDelay = Math.min(backoff.next(), remainingTime.get()); // skip retry scheduler when set lookup throttle in client or server side which will lead to // `TooManyRequestsException` boolean isLookupThrottling = !PulsarClientException.isRetriableError(e.getCause()) || e.getCause() instanceof PulsarClientException.AuthenticationException; if (nextDelay \u0026lt;= 0 || isLookupThrottling) { PulsarClientException.setPreviousExceptions(e, previousExceptions); future.completeExceptionally(e); return null; } .... }); } public CompletableFuture\u0026lt;PartitionedTopicMetadata\u0026gt; getPartitionedTopicMetadata(TopicName topicName) { String format = topicName.isV2() ? \u0026#34;admin/v2/%s/partitions\u0026#34; : \u0026#34;admin/%s/partitions\u0026#34;; return httpClient.get(String.format(format, topicName.getLookupName()) + \u0026#34;?checkAllowAutoCreation=true\u0026#34;, PartitionedTopicMetadata.class); } 3. åˆ›å»ºç”Ÿäº§è€…å¯¹è±¡ åœ¨ä¸Šä¸€å°ç»“å¯ä»¥çœ‹åˆ°å·²ç»æŸ¥åˆ°åˆ†åŒºä¿¡æ¯ï¼Œåœ¨æœ‰åˆ†åŒºçš„æƒ…å†µæ˜¯ä¼šè°ƒç”¨ newPartitionedProducerImpl æ–¹æ³•è¿›è¡Œç”Ÿäº§è€…å¯¹è±¡çš„åˆå§‹åŒ–ï¼Œç°åœ¨å°±ä»è¿™é‡Œå¼€å§‹è¿›è¡Œè·Ÿè¸ªï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•åªæ˜¯å°è£…äº†new PartitionedProducerImplå¯¹è±¡çš„æ“ä½œï¼Œäºæ˜¯ç»§ç»­çœ‹PartitionedProducerImplçš„æ„é€ å‡½æ•°çš„é€»è¾‘\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 protected \u0026lt;T\u0026gt; PartitionedProducerImpl\u0026lt;T\u0026gt; newPartitionedProducerImpl(String topic, ProducerConfigurationData conf, Schema\u0026lt;T\u0026gt; schema, ProducerInterceptors interceptors, CompletableFuture\u0026lt;Producer\u0026lt;T\u0026gt;\u0026gt; producerCreatedFuture, PartitionedTopicMetadata metadata) { return new PartitionedProducerImpl\u0026lt;\u0026gt;(PulsarClientImpl.this, topic, conf, metadata.partitions, producerCreatedFuture, schema, interceptors); } public PartitionedProducerImpl(PulsarClientImpl client, String topic, ProducerConfigurationData conf, int numPartitions, CompletableFuture\u0026lt;Producer\u0026lt;T\u0026gt;\u0026gt; producerCreatedFuture, Schema\u0026lt;T\u0026gt; schema, ProducerInterceptors interceptors) { super(client, topic, conf, producerCreatedFuture, schema, interceptors); this.producers = ConcurrentOpenHashMap.\u0026lt;Integer, ProducerImpl\u0026lt;T\u0026gt;\u0026gt;newBuilder().build(); this.topicMetadata = new TopicMetadataImpl(numPartitions); //é…ç½®è·¯ç”±ç­–ç•¥ this.routerPolicy = getMessageRouter(); stats = client.getConfiguration().getStatsIntervalSeconds() \u0026gt; 0 ? new PartitionedTopicProducerStatsRecorderImpl() : null; //é…ç½®æœ€å¤§åŒæ—¶ç­‰å¾…çš„æ¶ˆæ¯æ•° int maxPendingMessages = Math.min(conf.getMaxPendingMessages(), conf.getMaxPendingMessagesAcrossPartitions() / numPartitions); conf.setMaxPendingMessages(maxPendingMessages); final List\u0026lt;Integer\u0026gt; indexList; if (conf.isLazyStartPartitionedProducers() \u0026amp;\u0026amp; conf.getAccessMode() == ProducerAccessMode.Shared) { // try to create producer at least one partition indexList = Collections.singletonList(routerPolicy .choosePartition(((TypedMessageBuilderImpl\u0026lt;T\u0026gt;) newMessage()).getMessage(), topicMetadata)); } else { // try to create producer for all partitions indexList = IntStream.range(0, topicMetadata.numPartitions()).boxed().collect(Collectors.toList()); } firstPartitionIndex = indexList.get(0); //è¿™é‡Œæ˜¯æ ¸å¿ƒé€»è¾‘ï¼Œä»è¿™é‡Œè¿›å» start(indexList); // start track and auto subscribe partition increasement if (conf.isAutoUpdatePartitions()) { topicsPartitionChangedListener = new TopicsPartitionChangedListener(); partitionsAutoUpdateTimeout = client.timer() .newTimeout(partitionsAutoUpdateTimerTask, conf.getAutoUpdatePartitionsIntervalSeconds(), TimeUnit.SECONDS); } } private void start(List\u0026lt;Integer\u0026gt; indexList) { .... final ProducerImpl\u0026lt;T\u0026gt; firstProducer = createProducer(indexList.get(0)); firstProducer.producerCreatedFuture().handle((prod, createException) -\u0026gt; { .... }).thenApply(name -\u0026gt; { for (int i = 1; i \u0026lt; indexList.size(); i++) { //å¾ªç¯åˆ†åŒºæ•°åˆ›å»ºä¸ä¹‹å¯¹åº”çš„ProducerImplå¯¹è±¡ createProducer(indexList.get(i), name).producerCreatedFuture().handle((prod, createException) -\u0026gt; { afterCreatingProducer.accept(false, createException); return null; }); } return null; }); } ç»§ç»­ä» createProducer æ–¹æ³•è¿›è¡Œè·Ÿè¸ª\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 private ProducerImpl\u0026lt;T\u0026gt; createProducer(final int partitionIndex, final Optional\u0026lt;String\u0026gt; overrideProducerName) { //åˆ›å»ºProducerImplåä¼šç»Ÿä¸€æ”¾åˆ°producersè¿™ä¸ªMapä¸­ï¼Œkeyæ˜¯åˆ†åŒºå·ï¼Œvalueå°±æ˜¯ProducerImplå¯¹è±¡ return producers.computeIfAbsent(partitionIndex, (idx) -\u0026gt; { String partitionName = TopicName.get(topic).getPartition(idx).toString(); //ç»§ç»­è¿›å…¥çœ‹çœ‹ProducerImplåˆ›å»ºçš„é€»è¾‘ return client.newProducerImpl(partitionName, idx, conf, schema, interceptors, new CompletableFuture\u0026lt;\u0026gt;(), overrideProducerName); }); } public ProducerImpl(PulsarClientImpl client, String topic, ProducerConfigurationData conf, CompletableFuture\u0026lt;Producer\u0026lt;T\u0026gt;\u0026gt; producerCreatedFuture, int partitionIndex, Schema\u0026lt;T\u0026gt; schema, ProducerInterceptors interceptors, Optional\u0026lt;String\u0026gt; overrideProducerName) { .... this.compressor = CompressionCodecProvider.getCompressionCodec(conf.getCompressionType()); .... //è¿™é‡Œæ˜¯æ ¸å¿ƒé€»è¾‘ï¼Œç”¨äºåˆ›å»ºProducerImplå¯¹è±¡è·Ÿå¯¹åº”çš„Brokerçš„TCPç½‘ç»œè¿æ¥ grabCnx(); } 4. åˆ›å»ºè¿æ¥ ä»ä¸Šä¸€å°èŠ‚å¯ä»¥çœ‹åˆ°ä»£ç é€»è¾‘è·Ÿåˆ°äº†grabCnx æ–¹æ³•ï¼Œç»§ç»­ä¸€è·¯è·Ÿè¸ªä¸‹å»ï¼Œå¯ä»¥çœ‹åˆ°æœ€åéƒ½ä¼šè°ƒç”¨ state.client.getConnection, ç»§ç»­å¾€é‡Œé¢çœ‹çœ‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 void grabCnx() { this.connectionHandler.grabCnx(); } protected void grabCnx() { grabCnx(Optional.empty()); } protected void grabCnx(Optional\u0026lt;URI\u0026gt; hostURI) { .... cnxFuture = state.client.getConnection(address, address, randomKeyForSelectConnection); .... } public CompletableFuture\u0026lt;ClientCnx\u0026gt; getConnection(final InetSocketAddress logicalAddress, final InetSocketAddress physicalAddress, final int randomKeyForSelectConnection) { //å¯ä»¥çœ‹åˆ°è°ƒç”¨è¿æ¥æ± è¿›è¡Œç½‘ç»œè¿æ¥çš„è·å–ï¼Œç»§ç»­è¿›å»çœ‹çœ‹å®ç°ç»†èŠ‚ return cnxPool.getConnection(logicalAddress, physicalAddress, randomKeyForSelectConnection); } public CompletableFuture\u0026lt;ClientCnx\u0026gt; getConnection(InetSocketAddress logicalAddress, InetSocketAddress physicalAddress, final int randomKey) { if (maxConnectionsPerHosts == 0) { // å¦‚æœé…ç½®æ²¡å¼€å¯è¿æ¥æ± ï¼Œåˆ™æ¯ä¸€æ¬¡éƒ½é‡æ–°æ–°å»ºä¸€ä¸ªTCPè¿æ¥ return createConnection(logicalAddress, physicalAddress, -1); } final ConcurrentMap\u0026lt;Integer, CompletableFuture\u0026lt;ClientCnx\u0026gt;\u0026gt; innerPool = pool.computeIfAbsent(logicalAddress, a -\u0026gt; new ConcurrentHashMap\u0026lt;\u0026gt;()); // æ–°å»ºTCPç½‘ç»œè¿æ¥å¹¶æ”¾åœ¨è¿æ¥æ± ä¸­ä»¥å¤‡ä¹‹åçš„å¤ç”¨,ç»§ç»­è¿›å»çœ‹createConnectionçš„é€»è¾‘ CompletableFuture\u0026lt;ClientCnx\u0026gt; completableFuture = innerPool .computeIfAbsent(randomKey, k -\u0026gt; createConnection(logicalAddress, physicalAddress, randomKey)); .... } private CompletableFuture\u0026lt;ClientCnx\u0026gt; createConnection(InetSocketAddress logicalAddress, InetSocketAddress physicalAddress, int connectionKey) { .... // ç»§ç»­è¿›å»çœ‹createConnectionçš„é€»è¾‘ createConnection(logicalAddress, physicalAddress).thenAccept(channel -\u0026gt; { .... }).exceptionally(exception -\u0026gt; { .... }); return cnxFuture; } private CompletableFuture\u0026lt;Channel\u0026gt; createConnection(InetSocketAddress logicalAddress, InetSocketAddress unresolvedPhysicalAddress) { CompletableFuture\u0026lt;List\u0026lt;InetSocketAddress\u0026gt;\u0026gt; resolvedAddress; try { .... return resolvedAddress.thenCompose( inetAddresses -\u0026gt; connectToResolvedAddresses( logicalAddress, unresolvedPhysicalAddress, inetAddresses.iterator(), isSniProxy ? unresolvedPhysicalAddress : null) ); } catch (URISyntaxException e) { .... } } private CompletableFuture\u0026lt;Channel\u0026gt; connectToResolvedAddresses(...) { CompletableFuture\u0026lt;Channel\u0026gt; future = new CompletableFuture\u0026lt;\u0026gt;(); // ç»§ç»­å¾€ä¸‹è·Ÿè¸ª connectToAddress(logicalAddress, resolvedPhysicalAddress.next(), unresolvedPhysicalAddress, sniHost) .... return null; }); return future; } private CompletableFuture\u0026lt;Channel\u0026gt; connectToAddress(InetSocketAddress logicalAddress, InetSocketAddress physicalAddress, InetSocketAddress unresolvedPhysicalAddress, InetSocketAddress sniHost) { .... //ç»ˆäºè·Ÿè¸ªåˆ°äº†ï¼Œå°±æ˜¯bootstrap.register() è¿™ä¸ªæ–¹æ³•ï¼Œå¯ä»¥å°è¯•å¾€é‡Œé¢çœ‹çœ‹å®ç°ï¼Œä»è¿™é‡Œå¼€å§‹å°±æ˜¯Nettyçš„ä»£ç äº† return toCompletableFuture(bootstrap.register()) .thenCompose(channelInitializerHandler::initSocks5IfConfig) .thenCompose(ch -\u0026gt; channelInitializerHandler.initializeClientCnx(ch, logicalAddress, unresolvedPhysicalAddress)) .thenCompose(channel -\u0026gt; toCompletableFuture(channel.connect(physicalAddress))); } public ChannelFuture register() { validate(); //ç»§ç»­å¾€ä¸‹ return initAndRegister(); } final ChannelFuture initAndRegister() { Channel channel = null; try { //æ–°å»ºä¸€æ¡ç½‘ç»œé€šé“åˆ°Broker channel = channelFactory.newChannel(); init(channel); } catch (Throwable t) { .... } .... return regFuture; } ä»ä¸Šé¢çš„ä»£ç è·Ÿè¸ªå¯ä»¥çœ‹åˆ°ï¼Œç”Ÿäº§è€…å¯¹è±¡åœ¨åˆ›å»ºçš„æ—¶å€™ä¼šé€šè¿‡Nettyå®¢æˆ·ç«¯è·ŸTopicæ‰€åœ¨çš„Brokerå»ºç«‹TCPç½‘ç»œè¿æ¥ï¼Œæ–¹ä¾¿åç»­çš„é€šä¿¡\nå››ã€æ¶ˆæ¯å‘é€ æ¶ˆæ¯å‘é€æµç¨‹å¤§è‡´å¦‚ä¸‹å›¾\nåœ¨é€‰æ‹©æ¶ˆæ¯å‘é€æ˜¯ï¼Œç”Ÿäº§è€…å¯¹è±¡ä¼šæ ¹æ®è·¯ç”±ç­–ç•¥æ¥å†³å®šç”¨ç›®æ ‡åˆ†åŒºæ‰€å¯¹åº”çš„ProducerImplå¯¹è±¡è¿›è¡Œå¤„ç† å‘é€å‰ä¼šæŒ‰ç…§é¡ºåºå¯¹æ•°æ®è¿›è¡Œæ‹¦æˆªå™¨é“¾é€»è¾‘å¤„ç†(å¦‚æœæœ‰é…ç½®çš„è¯)ï¼Œç„¶åè¿›è¡Œå‹ç¼©æœ€åå†è¿›è¡Œåºåˆ—åŒ–æ“ä½œ(æ¶ˆæ¯ä¼ è¾“/å­˜å‚¨å¿…é¡»åºåˆ—åŒ–) æ¶ˆæ¯å‘é€å‰ä¼šæ”¾åˆ°å¾…ç¡®è®¤é˜Ÿåˆ—ä¸­è¿›è¡Œç»´æŠ¤ï¼Œæ¯ä¸ªåˆ†åŒºéƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ç¡®è®¤é˜Ÿåˆ—ï¼Œåœ¨æ¶ˆæ¯å†™å…¥æˆåŠŸåä¼šä»å¯¹åº”çš„ç¡®è®¤é˜Ÿåˆ—ä¸­å°†è‡ªå·±åˆ é™¤ï¼Œå¦åˆ™è¿™æ¡æ¶ˆæ¯ä¸ç®—å†™å…¥æˆåŠŸã€‚ å°†æ¶ˆæ¯å‘é€æ“ä½œå°è£…æˆä¸€ä¸ªä»»åŠ¡äº¤ç»™çº¿ç¨‹æ± ä¸­çš„ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œæœ€åçš„å‘é€æ“ä½œ Brokerå°†æ•°æ®å†™å…¥æˆåŠŸåå‘å®¢æˆ·ç«¯è¿”å›ackï¼Œå®¢æˆ·ç«¯é€šè¿‡ackä¸­æºå¸¦çš„æ¶ˆæ¯ä¿¡æ¯åˆ°å¾…ç¡®è®¤é˜Ÿåˆ—ä¸­è¿›è¡Œæ¶ˆæ¯çš„åˆ é™¤ é‚£ä¹ˆè€è§„çŸ©ï¼Œç»§ç»­ä¸€èµ·çœ‹ä¸‹ä»£ç å®ç°å§\n1. å‘é€æµç¨‹å‰ç½®æ“ä½œ å°±ä»å¸¸è§çš„è¿™æ¡è¯­å¥è¿›è¡Œåˆ‡å…¥ producer.sendAsync(\u0026quot;hello java API pulsar:\u0026quot;+i+\u0026quot;, å½“å‰æ—¶é—´ä¸ºï¼š\u0026quot;+new Date()); ã€‚é€šè¿‡ä»£ç ä¸­å¯ä»¥çœ‹åˆ°sendAsync æ–¹æ³•æ˜¯ä»å…¶çˆ¶ç±»ProducerBaseä¸­ç»§æ‰¿çš„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 public CompletableFuture\u0026lt;MessageId\u0026gt; sendAsync(Message\u0026lt;?\u0026gt; message) { //ç»§ç»­è·Ÿè¸ªè¿›å» return internalSendAsync(message); } //è¿™æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œæœ‰åˆ†åŒºç”Ÿäº§è€…å’Œéåˆ†åŒºç”Ÿäº§è€…ä¸¤ç§å®ç°ï¼Œè·Ÿè¸ªåˆ†åŒºç”Ÿäº§è€…çš„å®ç°é€»è¾‘ abstract CompletableFuture\u0026lt;MessageId\u0026gt; internalSendAsync(Message\u0026lt;?\u0026gt; message); CompletableFuture\u0026lt;MessageId\u0026gt; internalSendAsync(Message\u0026lt;?\u0026gt; message) { //ç»§ç»­å¾€é‡Œé¢è·Ÿè¸ª return internalSendWithTxnAsync(message, null); } CompletableFuture\u0026lt;MessageId\u0026gt; internalSendWithTxnAsync(Message\u0026lt;?\u0026gt; message, Transaction txn) { .... //è¿˜æœ‰å°è±¡å—ï¼Œåœ¨ç”Ÿäº§è€…åˆ›å»ºæ—¶ä¼šç»´æŠ¤ä¸€ä¸ªä»¥åˆ†åŒºå·ä¸ºkeyï¼ŒProducerImplä¸ºvalueçš„Mapï¼Œç°åœ¨ä»é‡Œé¢è·å–ç›¸å¯¹åº”çš„å¯¹è±¡è¿›è¡Œå¤„ç† return producers.get(partition).internalSendWithTxnAsync(message, txn); } 2. æ¶ˆæ¯å¤„ç†ä»¥åŠåŒ…è£… åˆå›åˆ°ProducerImplå¯¹è±¡çš„é€»è¾‘äº†ï¼Œç›¸å½“äºåˆ†åŒºç”Ÿäº§è€…å¯¹è±¡åªæ˜¯ä¸ªå£³ï¼Œæ— è®ºåˆ†åŒºè¿˜æ˜¯éåˆ†åŒºæœ€ç»ˆéƒ½æ˜¯è°ƒç”¨çš„ProducerImplè¿›è¡Œæ¶ˆæ¯å‘é€çš„çœŸæ­£é€»è¾‘ï¼Œä¸åºŸè¯ç»§ç»­å¾€ä¸‹çœ‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 CompletableFuture\u0026lt;MessageId\u0026gt; internalSendWithTxnAsync(Message\u0026lt;?\u0026gt; message, Transaction txn) { .... return internalSendAsync(message); } CompletableFuture\u0026lt;MessageId\u0026gt; internalSendAsync(Message\u0026lt;?\u0026gt; message) { .... //æ‹¦æˆªå™¨çš„é€»è¾‘å°±æ˜¯åœ¨è¿™é‡Œç”Ÿæ•ˆ MessageImpl\u0026lt;?\u0026gt; interceptorMessage = (MessageImpl) beforeSend(message); .... //æ ¸å¿ƒé€»è¾‘ï¼Œç»§ç»­åˆ‡å…¥ sendAsync(interceptorMessage, new SendCallback() { .... }); return future; } public void sendAsync(Message\u0026lt;?\u0026gt; message, SendCallback callback) { checkArgument(message instanceof MessageImpl); .... //æ ¸å¿ƒé€»è¾‘ï¼Œä»åå­—å¯ä»¥çœ‹åˆ°å°±æ˜¯å¯¹æ¶ˆæ¯è¿›è¡Œåºåˆ—åŒ–å¹¶è¿›è¡Œå‘é€é€»è¾‘ï¼Œç»§ç»­è·Ÿè¿›å» serializeAndSendMessage(msg, payload, sequenceId, uuid, chunkId, totalChunks, readStartIndex, payloadChunkSize, compressedPayload, compressed, compressedPayload.readableBytes(), callback, chunkedMessageCtx, messageId); } catch (PulsarClientException e) { .... } } private void serializeAndSendMessage(....) throws IOException { //æ ¸å¿ƒé€»è¾‘ï¼Œopæ˜¯OpSendMsgå¯¹è±¡ï¼Œå°è£…äº†è¦å‘é€çš„æ¶ˆæ¯å†…å®¹ï¼Œç»§ç»­å¾€ä¸‹è·Ÿ processOpSendMsg(op); } } 3. æ¶ˆæ¯å‘é€ æ•°æ®å·²ç»å¤„ç†åŒ…è£…å¾—å·®ä¸å¤šäº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å‘é€çš„é€»è¾‘ï¼Œå’±ä»¬é¡ºç€ processOpSendMsg æ–¹æ³•ç»§ç»­å¾€ä¸‹çœ‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 protected void processOpSendMsg(OpSendMsg op) { .... //å°†æ¶ˆæ¯åŠ åˆ°OpSendMsgQueueé˜Ÿåˆ—ä¸­ï¼Œè¿™å°±æ˜¯â€œç­‰å¾…ç¡®è®¤é˜Ÿåˆ—â€ pendingMessages.add(op); .... //ClientCnxå¯¹è±¡ç»´æŠ¤ç€Nettyå®ç°è·ŸBrokerçš„TCPè¿æ¥ final ClientCnx cnx = getCnxIfReady(); if (cnx != null) { .... //WriteInEventLoopCallbackæ–¹æ³•çš„runæ–¹æ³•æ‰§è¡Œä¼šå°†æ•°æ®å‘é€å‡ºå»ï¼Œç„¶åé˜Ÿåˆ—ä¸­ç»´æŠ¤æ¶ˆæ¯çš„çŠ¶æ€ cnx.ctx().channel().eventLoop().execute(WriteInEventLoopCallback.create(this, cnx, op)); stats.updateNumMsgsSent(op.numMessagesInBatch, op.batchSizeByte); } else { .... } } catch (Throwable t) { .... } } //WriteInEventLoopCallbackæ˜¯ä¸€ä¸ªçº¿ç¨‹ç±»ï¼Œè¢«æ”¾åˆ°çº¿ç¨‹æ± é‡Œé¢æ‰§è¡Œï¼Œå› æ­¤ç›´æ¥çœ‹å®ƒçš„runæ–¹æ³• private static final class WriteInEventLoopCallback implements Runnable { public void run() { .... try { //ç†Ÿæ‚‰Nettyçš„æœ‹å‹ç›¸ä¿¡å¯¹writeAndFlushæ–¹æ³•ä¸é»˜è®¤ï¼Œå°±æ˜¯é€šè¿‡ä¹‹é—´å»ºç«‹å¥½çš„TCPè¿æ¥å°†æ•°æ®å‘é€åˆ°Brokerå» cnx.ctx().writeAndFlush(cmd, cnx.ctx().voidPromise()); op.updateSentTimestamp(); } finally { recycle(); } } } è·Ÿè¸ªåˆ°è¿™é‡ŒåŸºæœ¬å°±ç»“æŸäº†ï¼Œå¯¹Nettyæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥å†ç»§ç»­å¾€ä¸‹è·Ÿï¼Œè¿™é‡Œå¯ä»¥ç®€å•è¯´ä¸€ä¸‹ï¼Œå…¶å®å®ƒå†…éƒ¨æ˜¯å¯¹JDKçš„NIOåšäº†åŒ…è£…å’Œä¼˜åŒ–ï¼Œæœ€åº•å±‚ä¹Ÿæ˜¯é€šè¿‡Javaçš„Socketè¿æ¥ç½‘ç»œç«¯å£è¿›è¡Œçš„æ•°æ®å‘é€ã€‚ä¸çŸ¥é“æœ‰æ²¡æœ‰å°ä¼™ä¼´å‘ç°ï¼Œå’¦ï¼Œæ€ä¹ˆæ²¡æœ‰å¯¹è¿”å›ç»“æœè¿›è¡Œå¤„ç†çš„é€»è¾‘å‘¢ï¼Ÿè¿™å°±æ˜¯æ‰€è°“çš„å¼‚æ­¥è®¾è®¡ï¼ŒNettyä¸å°±æ˜¯ä¸€ä¸ªå¼‚æ­¥é€šä¿¡æ¡†æ¶å—ï¼Œå®¢æˆ·ç«¯å‘é€çš„é€»è¾‘åˆ°è¿™é‡Œå°±æ˜¯å½»åº•ç»“æŸäº†ï¼Œè€Œæ¶ˆæ¯çš„å¤„ç†ç»“æŸå°±æ˜¯è¦ç­‰æœåŠ¡ç«¯Brokerå‘å®¢æˆ·ç«¯å‘èµ·æ¶ˆæ¯ackè¯·æ±‚äº†ï¼Œæƒ³çŸ¥é“Pulsaræ€ä¹ˆå®ç°çš„å—ï¼Ÿé‚£å°±è·Ÿç€æˆ‘ä¸€èµ·ç…ç…å§ï½\n4. æ¶ˆæ¯ç¡®è®¤ æ¶ˆæ¯ç¡®è®¤æµç¨‹æ˜¯ç”±Brokerç«¯å‘èµ·çš„ï¼Œé‚£ä¹ˆç”Ÿäº§è€…å¯¹è±¡è‚¯å®šæ˜¯é€šè¿‡Nettyå®¢æˆ·ç«¯æ¥æ”¶çš„ï¼Œæ‰€ä»¥ç›´æ¥çœ‹Pulsarå®ç°çš„ChannelInboundHandlerAdapterç±»çš„channelReadçš„é€»è¾‘å³å¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 public abstract class PulsarDecoder extends ChannelInboundHandlerAdapter { public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception { .... switch (cmd.getType()) { .... //å¯ä»¥çœ‹å¾—åˆ°æ¶ˆæ¯æœ‰å†™æˆåŠŸçš„åç»­å¤„ç†åŠ¨ä½œï¼Œé‚£å°±ä»è¿™é‡Œçœ‹çœ‹ case PRODUCER_SUCCESS: checkArgument(cmd.hasProducerSuccess()); handleProducerSuccess(cmd.getProducerSuccess()); break; case UNSUBSCRIBE: checkArgument(cmd.hasUnsubscribe()); safeInterceptCommand(cmd); handleUnsubscribe(cmd.getUnsubscribe()); break; } } } handleProducerSuccessè¿™ä¸ªæ–¹æ³•çš„æ˜¯ç”±ClientCnxå¯¹è±¡è¿›è¡Œå®ç°çš„ï¼Œé‚£å°±è·Ÿè¿›æ¥çœ‹çœ‹å§\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 protected void handleProducerSuccess(CommandProducerSuccess success) { checkArgument(state == State.Ready); if (log.isDebugEnabled()) { log.debug(\u0026#34;{} Received producer success response from server: {} - producer-name: {}\u0026#34;, ctx.channel(), success.getRequestId(), success.getProducerName()); } long requestId = success.getRequestId(); if (!success.isProducerReady()) { //è¿˜è®°å¾—pendingRequests è¿™ä¸ªâ€œå¾…ç¡®è®¤é˜Ÿåˆ—â€å—ï¼Œç°åœ¨ä¼šä»é‡Œé¢æŸ¥è¯¢å¯¹åº”çš„æ¶ˆæ¯ TimedCompletableFuture\u0026lt;?\u0026gt; requestFuture = pendingRequests.get(requestId); if (requestFuture != null) { //æ—¥å¿—è¿›è¡Œæ‰“å° log.info(\u0026#34;{} Producer {} has been queued up at broker. request: {}\u0026#34;, ctx.channel(), success.getProducerName(), requestId); //æ ‡è®°ä¸ºæˆåŠŸ requestFuture.markAsResponded(); } return; } //å®¢æˆ·ç«¯å¤„ç†çš„ä¸»è¦é€»è¾‘å°±æ˜¯ä»é˜Ÿåˆ—ä¸­ç§»é™¤æ­¤æ¶ˆæ¯ CompletableFuture\u0026lt;ProducerResponse\u0026gt; requestFuture = (CompletableFuture\u0026lt;ProducerResponse\u0026gt;) pendingRequests.remove(requestId); .... } äº”ã€æ€»ç»“ ç”Ÿäº§è€…å†™æ•°æ®çš„æµç¨‹åˆ°è¿™é‡ŒåŸºæœ¬å°±ç»“æŸäº†ï¼Œæ€ä¹ˆæ ·ï¼Œæ˜¯ä¸æ˜¯æ²¡æƒ³è±¡ä¸­é‚£ä¹ˆå¯æ€•ï¼Ÿä¹Ÿè®¸ä½ å¯¹1ã€å®¢æˆ·ç«¯å¯¹è±¡åˆ›å»º 2ã€ç”Ÿäº§è€…å¯¹è±¡åˆ›å»º 3ã€æ¶ˆæ¯å‘é€ è¿™ä¸‰æ­¥ä¹‹é—´çš„å…³ç³»è¿˜æœ‰ç‚¹è¿·è¿·ç³Šç³Šï¼Œé‚£å°±è¯·å…è®¸æˆ‘ç»™ä½ ä¸¾ä¸ªä¾‹å­ï¼Œ1ã€å®¢æˆ·ç«¯å¯¹è±¡åˆ›å»ºç›¸å½“äºä¸€åº§æ–°åŸå¸‚çš„åˆ›å»ºï¼Œæ‰“å¥½åŸå¸‚çš„åœ°åŸºï¼Œ2ã€ç”Ÿäº§è€…å¯¹è±¡åˆ›å»º ç›¸å½“äºåœ¨è¿™ä¸ªåœ°åŸºçš„åŸºç¡€ä¸Šå»ºèµ·äº†åŸå¸‚ï¼Œå‘ç”µå‚ç­‰ç­‰ï¼Œæœ€é‡è¦çš„æ˜¯ä¿®å»ºå…¶é€šå¾€å…¶ä»–å„ä¸ªåŸå¸‚çš„äº¤é€šè¦é“ï¼Œæœ€åçš„3ã€æ¶ˆæ¯å‘é€ ç›¸å½“äºè¿™ä¸ªæ–°åŸå¸‚çš„å±…æ°‘ä»¬ä¹˜åé«˜é“å»å…¶ä»–çš„åŸå¸‚ã€‚è¿™ä¹ˆè¯´ç›¸ä¿¡ä½ ä¸€å®šå·²ç»æ˜ç™½äº†ï½å¦‚æœè¿˜æœ‰å…¶ä»–ç–‘é—®æ¬¢è¿åœ¨ä¸‹é¢çš„è¯„è®ºåŒºä¸€èµ·è®¨è®º\n","date":"2024-09-20T10:34:57+08:00","image":"https://sherlock-lin.github.io/p/%E4%B8%80%E6%96%87%E5%BD%BB%E5%BA%95%E6%90%9E%E6%87%82producer%E7%AB%AF%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8A%E5%8E%9F%E7%90%86/image-20240321153410330_hu2501804792718174333.png","permalink":"https://sherlock-lin.github.io/p/%E4%B8%80%E6%96%87%E5%BD%BB%E5%BA%95%E6%90%9E%E6%87%82producer%E7%AB%AF%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8A%E5%8E%9F%E7%90%86/","title":"ä¸€æ–‡å½»åº•ææ‡‚Producerç«¯æµç¨‹ä»¥åŠåŸç†"},{"content":"ä¸€ã€æ­£æ–‡ Namespaceä¸‹çš„Topicæ˜¯åˆ†Bundleè¿›è¡Œç®¡ç†çš„ï¼Œæ¯ä¸ªNamespaceéƒ½æ˜¯ä¸€ä¸ªå“ˆå¸Œç¯ï¼Œè€ŒBundleè´Ÿè´£ç®¡ç†ç¯ä¸ŠæŸä¸ªèŒƒå›´ä¸Šçš„Topicã€‚é€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥æ›´å¥½çš„è¿›è¡ŒTopicçš„ç®¡ç†ã€‚å½“æŸä¸ªBundleä¸Šè´Ÿè´£çš„Topicè¶Šæ¥è¶Šå¤šæ—¶ï¼Œä¼šå¯¼è‡´è´Ÿè´£è¯¥Bundleçš„BrokerèŠ‚ç‚¹å‹åŠ›å˜å¤§ã€‚å› æ­¤Pulsarè¿˜æä¾›äº†Bundleåˆ†è£‚çš„æœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶æ”¯æŒè‡ªåŠ¨è§¦å‘ä»¥åŠæ‰‹åŠ¨è§¦å‘ï¼Œä»Šå¤©è¿™ç¯‡æ–‡ç« å°±ä»æºç çš„è§’åº¦åˆ†ææ‰‹åŠ¨è§¦å‘Bundleåˆ†è£‚æ—¶æœåŠ¡ç«¯ä¼šå‘ç”Ÿä»€ä¹ˆ\nä¸»åŠ¨è§¦å‘Bundleåˆ†è£‚æ“ä½œæ–¹å¼\n1 2 3 4 5 6 7 8 9 10 bin/pulsar-admin namespaces bundles public/default //è¾“å‡ºå¦‚ä¸‹ { \u0026#34;boundaries\u0026#34; : [ \u0026#34;0x00000000\u0026#34;, \u0026#34;0x08000000\u0026#34;, \u0026#34;0x10000000\u0026#34;, \u0026#34;0x20000000\u0026#34;, \u0026#34;0x30000000\u0026#34;, \u0026#34;0x40000000\u0026#34;, \u0026#34;0x50000000\u0026#34;, \u0026#34;0x60000000\u0026#34;, \u0026#34;0x70000000\u0026#34;, \u0026#34;0x80000000\u0026#34;, \u0026#34;0x90000000\u0026#34;, \u0026#34;0xa0000000\u0026#34;, \u0026#34;0xb0000000\u0026#34;, \u0026#34;0xc0000000\u0026#34;, \u0026#34;0xd0000000\u0026#34;, \u0026#34;0xe0000000\u0026#34;, \u0026#34;0xf0000000\u0026#34;, \u0026#34;0xffffffff\u0026#34; ], \u0026#34;numBundles\u0026#34; : 17 } //æŒ‡å®šæŸä¸ªbundleè¿›è¡Œåˆ†è£‚ bin/pulsar-admin namespaces split-bundle --bundle 0x00000000_0x10000000 public/default äºŒã€æºç è§£æ Pulsarç®¡ç†æµç›¸å…³çš„æ“ä½œéƒ½æ˜¯é€šè¿‡HTTPçš„æ–¹å¼ï¼Œå› ä¸ºéœ€è¦æ”¯æŒå¤šç§å®¢æˆ·ç«¯ç±»å‹(httpã€clientã€cli)ã€‚æœåŠ¡ç«¯å¤„ç†è¿™äº›æ“ä½œéƒ½åœ¨adminæ¨¡å—ä¸‹ï¼Œå¦‚ä¸‹å›¾ï¼Œæœ¬æ¬¡è¦èŠçš„bundleåˆ†è£‚å°±åœ¨Namespacesæ–¹æ³•ä¸­\né¦–å…ˆä»Namespacesçš„splitNamespaceBundleè¿›è¡Œè·Ÿè¸ª\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 public void splitNamespaceBundle( .... @QueryParam(\u0026#34;splitAlgorithmName\u0026#34;) String splitAlgorithmName, //æŒ‡å®šbundleåˆ†è£‚ç®—æ³• @ApiParam(\u0026#34;splitBoundaries\u0026#34;) List\u0026lt;Long\u0026gt; splitBoundaries) { //æ ¡éªŒå‚æ•°æ ¼å¼ä»¥åŠæ˜¯å¦å­˜åœ¨å¯¹åº”çš„namespace validateNamespaceName(tenant, namespace); //å¼‚æ­¥è¿›è¡Œåˆ†è£‚æ“ä½œ internalSplitNamespaceBundleAsync(bundleRange, authoritative, unload, splitAlgorithmName, splitBoundaries) .thenAccept(__ -\u0026gt; { .... }) .exceptionally(ex -\u0026gt; { .... }); } å¯ä»¥çœ‹åˆ°æœ€å¤–å±‚åªæ˜¯åšäº›å‚æ•°æ ¡éªŒï¼Œé‚£ä¹ˆå°±ç»§ç»­è·Ÿè¸ªinternalSplitNamespaceBundleAsyncæ–¹æ³•ï¼Œå¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 protected CompletableFuture\u0026lt;Void\u0026gt; internalSplitNamespaceBundleAsync(String bundleName, boolean authoritative, boolean unload, String splitAlgorithmName, List\u0026lt;Long\u0026gt; splitBoundaries) { return validateSuperUserAccessAsync() //æƒé™æ ¡éªŒ .thenAccept(__ -\u0026gt; { checkNotNull(bundleName, \u0026#34;BundleRange should not be null\u0026#34;); log.info(\u0026#34;[{}] Split namespace bundle {}/{}\u0026#34;, clientAppId(), namespaceName, bundleName); //è·å–å½“å‰é›†ç¾¤æ‰€æ”¯æŒçš„bundleåˆ†è£‚ç®—æ³•ï¼Œè¿™é‡Œæ˜¯ç¡¬ç¼–ç çš„å›ºå®šå››ç§ List\u0026lt;String\u0026gt; supportedNamespaceBundleSplitAlgorithms = pulsar().getConfig().getSupportedNamespaceBundleSplitAlgorithms(); //æ­¤å¤„çœå»å‚æ•°æ£€æŸ¥é€»è¾‘ .... } }) .thenCompose(__ -\u0026gt; { //æ­¤å¤„çœå»å‚æ•°æ£€æŸ¥é€»è¾‘ .... }) .thenCompose(__ -\u0026gt; validatePoliciesReadOnlyAccessAsync()) //æƒé™æ ¡éªŒ .thenCompose(__ -\u0026gt; getBundleRangeAsync(bundleName)) //è·å–è¦åˆ†è£‚çš„bundleçš„èŒƒå›´ .thenCompose(bundleRange -\u0026gt; { return getNamespacePoliciesAsync(namespaceName) .thenCompose(policies -\u0026gt; //1. æ ¡éªŒBundleçš„èŒƒå›´æ˜¯å¦æœ‰æ•ˆ //2.åˆ¤æ–­å½“å‰BrokerèŠ‚ç‚¹æ˜¯å¦è´Ÿè´£è¿™ä¸ªbundleçš„ç®¡ç†ï¼Œå¦‚æœä¸æ˜¯åˆ™é‡å®šå‘ validateNamespaceBundleOwnershipAsync(namespaceName, policies.bundles, bundleRange,authoritative, false)) //æ ¸å¿ƒæ–¹æ³•å°±æ˜¯è¿™é‡Œçš„ NamespaceService.splitAndOwnBundle .thenCompose(nsBundle -\u0026gt; pulsar().getNamespaceService().splitAndOwnBundle(nsBundle, unload, pulsar().getNamespaceService() .getNamespaceBundleSplitAlgorithmByName(splitAlgorithmName), splitBoundaries)); }); } æ¥ä¸‹æ¥å°±æ˜¯è¿›å…¥NamespaceServiceç±»çš„splitAndOwnBundleæ–¹æ³•ï¼ŒNamespaceServiceä¹Ÿæ˜¯Pulsaræ¯”è¾ƒé‡è¦çš„ä¸€ä¸ªç±»ï¼Œè¿™é‡Œå…ˆç»§ç»­è·Ÿè¸ªåˆ†å‰²bundleçš„é€»è¾‘\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 public CompletableFuture\u0026lt;Void\u0026gt; splitAndOwnBundle(NamespaceBundle bundle, boolean unload, NamespaceBundleSplitAlgorithm splitAlgorithm, List\u0026lt;Long\u0026gt; boundaries) { //å¦‚æœå®ç°äº†è‡ªå®šä¹‰çš„åˆ†å‰²é€»è¾‘åˆ™ä½¿ç”¨è‡ªå®šä¹‰çš„ if (ExtensibleLoadManagerImpl.isLoadManagerExtensionEnabled(config)) { return ExtensibleLoadManagerImpl.get(loadManager.get()) .splitNamespaceBundleAsync(bundle, splitAlgorithm, boundaries); } final CompletableFuture\u0026lt;Void\u0026gt; unloadFuture = new CompletableFuture\u0026lt;\u0026gt;(); final AtomicInteger counter = new AtomicInteger(BUNDLE_SPLIT_RETRY_LIMIT); //æ ¸å¿ƒæµç¨‹æµç¨‹ splitAndOwnBundleOnceAndRetry(bundle, unload, counter, unloadFuture, splitAlgorithm, boundaries); return unloadFuture; } void splitAndOwnBundleOnceAndRetry(NamespaceBundle bundle, boolean unload, AtomicInteger counter, CompletableFuture\u0026lt;Void\u0026gt; completionFuture, NamespaceBundleSplitAlgorithm splitAlgorithm, List\u0026lt;Long\u0026gt; boundaries) { //è·å–bundleåˆ†å‰²é…ç½® BundleSplitOption bundleSplitOption = getBundleSplitOption(bundle, boundaries, config); //æ ¹æ®é…ç½®æ¥é€‰æ‹©å¯¹åº”çš„åˆ†å‰²ç®—æ³•è¿›è¡Œåˆ†å‰² splitAlgorithm.getSplitBoundary(bundleSplitOption).whenComplete((splitBoundaries, ex) -\u0026gt; { CompletableFuture\u0026lt;List\u0026lt;NamespaceBundle\u0026gt;\u0026gt; updateFuture = new CompletableFuture\u0026lt;\u0026gt;(); if (ex == null) { .... try { //è¿›è¡Œbundleåˆ†å‰²æ“ä½œ bundleFactory.splitBundles(bundle, splitBoundaries.size() + 1, splitBoundaries) .thenAccept(splitBundles -\u0026gt; { .... Objects.requireNonNull(splitBundles.getLeft()); Objects.requireNonNull(splitBundles.getRight()); checkArgument(splitBundles.getRight().size() == splitBoundaries.size() + 1, \u0026#34;bundle has to be split in \u0026#34; + (splitBoundaries.size() + 1) + \u0026#34; bundles\u0026#34;); NamespaceName nsname = bundle.getNamespaceObject(); .... try { // æ£€æŸ¥ç¡®ä¿æ¯ä¸ªBundleéƒ½æœ‰å¯¹åº”çš„Brokerè´Ÿè´£ for (NamespaceBundle sBundle : splitBundles.getRight()) { Objects.requireNonNull(ownershipCache.tryAcquiringOwnership(sBundle)); } //æ›´æ–°Bundleä¿¡æ¯ï¼Œæ¯•ç«ŸBundleå·²ç»åˆ†è£‚å¥½äº†ï¼Œç›¸å…³çš„ä¸€äº›å…ƒæ•°æ®è¦åŒæ­¥æ›´æ–° updateNamespaceBundles(nsname, splitBundles.getLeft()).thenCompose(__ -\u0026gt; updateNamespaceBundlesForPolicies(nsname, splitBundles.getLeft())) .thenRun(() -\u0026gt; { bundleFactory.invalidateBundleCache(bundle.getNamespaceObject()); updateFuture.complete(splitBundles.getRight()); }).exceptionally(ex1 -\u0026gt; { .... }); } catch (Exception e) { .... } }); } catch (Exception e) { .... } } else { updateFuture.completeExceptionally(ex); } updateFuture.whenCompleteAsync((r, t)-\u0026gt; { if (t != null) { // å¤±è´¥åˆ™é‡è¯•å‡ æ¬¡ if ((t.getCause() instanceof MetadataStoreException.BadVersionException) \u0026amp;\u0026amp; (counter.decrementAndGet() \u0026gt;= 0)) { pulsar.getExecutor().schedule(() -\u0026gt; pulsar.getOrderedExecutor() .execute(() -\u0026gt; splitAndOwnBundleOnceAndRetry( bundle, unload, counter, completionFuture, splitAlgorithm, boundaries)), 100, MILLISECONDS); } else if (t instanceof IllegalArgumentException) { completionFuture.completeExceptionally(t); } else { // Retry enough, or meet other exception String msg2 = format(\u0026#34; %s not success update nsBundles, counter %d, reason %s\u0026#34;, bundle.toString(), counter.get(), t.getMessage()); LOG.warn(msg2); completionFuture.completeExceptionally(new ServiceUnitNotReadyException(msg2)); } return; } //æ›´æ–°bundleçš„çŠ¶æ€ getOwnershipCache().updateBundleState(bundle, false) .thenRun(() -\u0026gt; { // update bundled_topic cache for load-report-generation pulsar.getBrokerService().refreshTopicToStatsMaps(bundle); loadManager.get().setLoadReportForceUpdateFlag(); // release old bundle from ownership cache pulsar.getNamespaceService().getOwnershipCache().removeOwnership(bundle); completionFuture.complete(null); if (unload) { // Unload new split bundles, in background. This will not // affect the split operation which is already safely completed r.forEach(this::unloadNamespaceBundle); } onNamespaceBundleSplit(bundle); }) .exceptionally(e -\u0026gt; { .... }); }, pulsar.getOrderedExecutor()); }); } ä¸Šé¢è¿™ä¸ªæ–¹æ³•çš„é€»è¾‘æ¯”è¾ƒä¸°å¯Œï¼Œä½†æ ¸å¿ƒçš„åˆ†å‰²æµç¨‹å®é™…ä¸Šæ˜¯è°ƒç”¨çš„NamespaceBundleFactoryçš„splitBundlesè¿›è¡Œçš„ï¼Œè¿™é‡Œå°±ç»§ç»­è·Ÿè¸ªNamespaceBundleFactoryçš„é€»è¾‘\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 public CompletableFuture\u0026lt;Pair\u0026lt;NamespaceBundles, List\u0026lt;NamespaceBundle\u0026gt;\u0026gt;\u0026gt; splitBundles( NamespaceBundle targetBundle, int argNumBundles, List\u0026lt;Long\u0026gt; splitBoundaries) { //åˆ¤æ–­å½“å‰bundleæ˜¯å¦æ”¯æŒåˆ†è£‚ checkArgument(canSplitBundle(targetBundle), \u0026#34;%s bundle can\u0026#39;t be split further since range not larger than 1\u0026#34;, targetBundle); .... NamespaceName nsname = targetBundle.getNamespaceObject(); final int numBundles = argNumBundles; return bundlesCache.get(nsname).thenApply(sourceBundle -\u0026gt; { final int lastIndex = sourceBundle.partitions.length - 1; //é‡æ–°åˆ›å»ºæ•°ç»„ä¿å­˜å“ˆå¸Œç¯çš„èŠ‚ç‚¹ï¼Œå› ä¸ºbundleåˆ†è£‚åç¯ä¸Šçš„èŠ‚ç‚¹ä¼šå¢å¤š final long[] partitions = new long[sourceBundle.partitions.length + (numBundles - 1)]; int pos = 0; int splitPartition = -1; final Range\u0026lt;Long\u0026gt; range = targetBundle.getKeyRange(); for (int i = 0; i \u0026lt; lastIndex; i++) { //éå†å½“å‰Namespaceçš„æ‰€æœ‰Bundleæ¥æ‰¾åˆ°éœ€è¦è¿›è¡Œåˆ†è£‚çš„ç›®æ ‡Bundle if (sourceBundle.partitions[i] == range.lowerEndpoint() \u0026amp;\u0026amp; (range.upperEndpoint() == sourceBundle.partitions[i + 1])) { splitPartition = i; long minVal = sourceBundle.partitions[i]; partitions[pos++] = minVal; if (splitBoundaries == null || splitBoundaries.size() == 0) { long maxVal = sourceBundle.partitions[i + 1]; //numBundleså°±æ˜¯è¦åˆ†å‰²æˆçš„ä»½æ•°ï¼Œè¿™é‡Œç›¸å½“äºå°†åŸå…ˆBundleè´Ÿè´£çš„èŒƒå›´å¹³å‡åˆ†ç»™å¤šä¸ªæ–°çš„Bundle long segSize = (maxVal - minVal) / numBundles; long curPartition = minVal + segSize; for (int j = 0; j \u0026lt; numBundles - 1; j++) { partitions[pos++] = curPartition; curPartition += segSize; } } else { for (long splitBoundary : splitBoundaries) { partitions[pos++] = splitBoundary; } } } else { partitions[pos++] = sourceBundle.partitions[i]; } } partitions[pos] = sourceBundle.partitions[lastIndex]; if (splitPartition != -1) { // keep version of sourceBundle //æ ¹æ®ä¸Šé¢æ—§çš„BundleèŒƒå›´åˆ’åˆ†æ¥åˆ†è£‚å‡ºå¤šä¸ªæ–°çš„bundle NamespaceBundles splitNsBundles = new NamespaceBundles(nsname, this, sourceBundle.getLocalPolicies(), partitions); List\u0026lt;NamespaceBundle\u0026gt; splitBundles = splitNsBundles.getBundles().subList(splitPartition, (splitPartition + numBundles)); return new ImmutablePair\u0026lt;\u0026gt;(splitNsBundles, splitBundles); } return null; }); } åˆ°è¿™é‡ŒåŸºæœ¬å°±ç»“æŸï¼Œè¿™æ¡é“¾è·¯ä¸»è¦æ˜¯Brokerå°†åŸå…ˆçš„å“ˆå¸Œç¯ä¸­çš„æŸä¸€ä¸ªèŒƒå›´æ‹†åˆ†æˆå¤šä¸ªèŒƒå›´çš„é€»è¾‘ï¼Œè¿™é‡Œä¿ç•™å‡ ä¸ªé—®é¢˜ç»™è¯»è€…æ€è€ƒ\nBundleåˆ†è£‚åæ˜¯å¦ä¼šæ¶‰åŠåˆ°æ•°æ®çš„è¿ç§»ï¼Ÿ Bundleåˆ†è£‚ç®—æ³•æœ‰å››ç§ï¼ŒåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ ä¸‰ã€å‚è€ƒæ–‡çŒ® å®˜æ–¹æ–‡æ¡£ ","date":"2024-09-20T10:34:57+08:00","image":"https://sherlock-lin.github.io/p/%E4%B8%BB%E5%8A%A8%E8%A7%A6%E5%8F%91bundle%E5%88%86%E8%A3%82%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20240416181912380_hu8808141309202124509.png","permalink":"https://sherlock-lin.github.io/p/%E4%B8%BB%E5%8A%A8%E8%A7%A6%E5%8F%91bundle%E5%88%86%E8%A3%82%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/","title":"ä¸»åŠ¨è§¦å‘Bundleåˆ†è£‚æœåŠ¡ç«¯æµç¨‹æºç è§£æ"},{"content":"ä¸€ã€å¼•è¨€ ç³»ç»Ÿå­¦ä¹ Pulsarçš„å¤§çº²\näºŒã€æ­£æ–‡ ä¸‹å›¾æ˜¯æˆ‘ç»˜åˆ¶çš„Pulsarå¤§çº² (ç”±äºæ—¶é—´ç¼˜æ•…èŠ±çš„æ¯”è¾ƒç²—ç³™ï¼Œè¿™å¼ å›¾ä¼šä¸å®šæœŸæ›´æ–°)\nä¸‰ã€å­¦ä¹ å¤§çº² ä¸€ã€Pulsar Client äºŒã€ç”Ÿäº§è€… Pulsaræ¶ˆæ¯è·¯ç”±æ·±å…¥å‰–æ ä¸‰ã€æ¶ˆè´¹è€… å››ã€Topic pulsaråŸæ¥æ˜¯è¿™æ ·æ“ä½œtopicçš„ äº”ã€Function Pulsar3.2 Functionçš„ä»‹ç»ä¸ä½¿ç”¨ Pulsar IOå®æˆ˜ Workerè°ƒåº¦ç®¡ç†å™¨åŸç†è§£æ å…­ã€Schema Registry Pulsar Schemaä½¿ç”¨åŸç†ä»‹ç» ä¸ƒã€å­˜å‚¨ç®¡ç† è¯¦è§£bookkeeper AutoRecoveryæœºåˆ¶ å…«ã€ç»¼åˆ ä¹ã€é«˜å¯ç”¨ å››ã€å­¦ä¹ èµ„æ–™ å®˜æ–¹æ–‡æ¡£\nPulsarä¸‰æœ¬ä¹¦ç±\nã€ŠMastering Apache Pulsarã€‹ï¼šä¸ªäººè®¤ä¸ºæ˜¯Pulsarç³»ç»Ÿèµ„æ–™æœ€å¥½çš„ï¼Œå–œæ¬¢Pulsarçš„ä¼™ä¼´åŠ¡å¿…é˜…è¯»æ­¤ç»å…¸\nã€Šæ·±å…¥è§£æApace Pulsarã€‹ï¼šæ—ç³å¤§ä½¬çš„ä½œå“ï¼Œå…¼å¤‡ä½¿ç”¨ã€è°ƒä¼˜ä»¥åŠåŸç†çš„ä»‹ç»\nã€ŠApache Pulsar in Actionã€‹ï¼šç›®å½•å¸ƒå±€ä¸å¤ªå¥½ï¼Œä½†é’ˆå¯¹ä¸ªåˆ«çŸ¥è¯†ç‚¹è®²å¾—æ¯”è¾ƒç²¾ç»†ï¼Œå¯ä½œä¸ºè¡¥å……è¯»ç‰©\nPulsarå®˜æ–¹æ•´ç†èµ„æ–™å¤§å…¨ï¼šæ”¶å½•äº†å¤§é‡Pulsarä½¿ç”¨ã€åŸç†ã€ä¸šåŠ¡åœºæ™¯ç­‰ç²¾å½©çš„æ–‡ç« èµ„æ–™\näº”ã€æƒ³å¯¹æœ¬ç³»åˆ—æ–‡ç« è¯»è€…è¯´çš„è¯ å¦ç™½äº†è¯´ï¼Œç°å¦‚ä»Šçš„ç½‘ç»œç¯å¢ƒä¸åƒè¿‡å»é‚£ä¹ˆå‹å¥½(è¿™ä¸ªè§‚ç‚¹ä¸åšä»»ä½•è®¨è®ºï¼Œå¦‚æœä½ è§‰å¾—ä¸å¯¹ï¼Œé‚£ä¹ˆä½ æ˜¯å¯¹çš„)ï¼Œå¦‚ä»Šè¿˜èƒ½åšæŒåœ¨ç½‘ç»œä¸Šè¾“å‡ºé«˜è´¨é‡çš„ä½œè€…éƒ½æ˜¯å€¼å¾—å°Šæ•¬çš„ã€‚æˆ‘ä¹‹æ‰€ä»¥å†™è¿™ç³»åˆ—æ–‡ç« çš„ç›®çš„æœ‰ä»¥ä¸‹ä¸‰ç‚¹ï¼š1. æ¥è§¦æŠ€æœ¯è¿™äº›å¹´ï¼Œå—åˆ°ä¸å°‘å¤§ä½¬æ–‡ç« çš„ç†é™¶ï¼ŒæŠ€æœ¯å’Œæ€ç»´éƒ½æœ‰äº†ä¸å°‘çš„æå‡ï¼Œå› æ­¤ä¹Ÿæƒ³åšäº›å›é¦ˆäºæŠ€æœ¯ç¤¾åŒºçš„äº‹æƒ… 2. æˆ‘çŸ¥é“ä¸€å®šæœ‰ä¸å°‘å¯¹æŠ€æœ¯å……æ»¡çƒ­æƒ…çš„å°ç™½ï¼Œæˆ‘å¸Œæœ›èƒ½å¤Ÿä»¥Pulsarä¸ºåˆ‡å…¥ç‚¹ç»™ä½ å¸¦æ¥æŠ€æœ¯çš„ä¹è¶£ 3. é€šè¿‡è¾“å‡ºæ–‡ç« æ¥å€’æ¨è‡ªå·±æŒç»­é˜…è¯»ã€æå‡è‡ªå·±æç‚¼æŠ½è±¡èƒ½åŠ›ã€‚\næˆ‘èƒ½ä¿è¯çš„æ˜¯ä»¥ä¸‹å‡ ç‚¹\nè¿™ä¸ªç³»åˆ—çš„æ–‡ç« æ°¸ä¸æ”¶è´¹(é™ä½å¤§å®¶é˜…è¯»æˆæœ¬) è¾“å‡ºçš„å†…å®¹éƒ½æ˜¯ç»è¿‡æ€è€ƒçš„ï¼Œæ‹’ç»å¤åˆ¶å¼ è´´ä»¥åŠä½ä»·å€¼çš„ä¸œè¥¿ å°½å¯èƒ½ä»¥å›¾ã€ç²¾ç®€çš„è¯æ¥ååŠ©å¤§å®¶ä¼™å¯¹æŸä¸ªçŸ¥è¯†ç‚¹çš„ç†è§£ ä¸åšæ¨¡å‡Œä¸¤å¯çš„è§£é‡Šï¼Œå®å¯åæ¿€çš„ç»™ä¸ªé”™è¯¯çš„ç­”æ¡ˆï¼Œæˆ‘ç›¸ä¿¡æœ‰ä¸€å®šä¾æ®æ”¯æ’‘çš„é”™è¯¯ç­”æ¡ˆä»·å€¼å¤§äºæ¨¡ç³Šä¸æ¸…çš„æ¦‚å¿µ é™¤æ­¤ä¹‹å¤–ï¼Œç”±äºæœ¬äººçš„çŸ¥è¯†é‡ä»¥åŠè®¤çŸ¥æœ‰é™ï¼Œå¦‚æœæœ‰æŸä¸ªçŸ¥è¯†è¡¨è¿°ä¸æ¸…æ¥šæˆ–è€…è¡¨è¾¾æœ‰è¯¯çš„åœ°æ–¹ï¼Œæ³è¯·æŒ‡å‡ºï¼Œå¤§å®¶ä¸€èµ·å­¦ä¹ å…±åŒè¿›æ­¥ï½\n","date":"2024-09-20T10:34:56+08:00","image":"https://sherlock-lin.github.io/p/pulsar%E4%BB%8E%E5%85%A5%E8%BF%B7%E5%88%B0%E5%85%A5%E9%AD%94%E4%B9%8B%E8%B7%AF/image-20240316103554735_hu8487334652089443369.png","permalink":"https://sherlock-lin.github.io/p/pulsar%E4%BB%8E%E5%85%A5%E8%BF%B7%E5%88%B0%E5%85%A5%E9%AD%94%E4%B9%8B%E8%B7%AF/","title":"Pulsarä»å…¥è¿·åˆ°å…¥é­”ä¹‹è·¯"},{"content":"ä¸€ã€æ¦‚è¿° å¤§æ•°æ®èƒŒæ™¯ä¸‹ï¼Œåˆ†åŒºåº”è¯¥æ˜¯æ‰€æœ‰ç»„ä»¶å¿…å¤‡çš„åŸºæœ¬æ¡ä»¶ï¼Œå¦åˆ™é¢å¯¹æµ·é‡æ•°æ®æ—¶æ— è®ºæ˜¯è®¡ç®—è¿˜æ˜¯å­˜å‚¨éƒ½å®¹æ˜“é‡åˆ°ç“¶é¢ˆã€‚è·Ÿå…¶ä»–æ¶ˆæ¯ç³»ç»Ÿä¸€æ ·ï¼ŒPulsaré€šè¿‡Topicå°†æ¶ˆæ¯æ•°æ®è¿›è¡Œä¸šåŠ¡å±‚é¢åˆ’åˆ†ç®¡ç†ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒTopicåˆ†åŒºï¼Œé€šè¿‡å°†å¤šä¸ªåˆ†åŒºåˆ†å¸ƒåœ¨å¤šå°Broker/æœºå™¨ä¸Šä»è€Œå¸¦æ¥æ€§èƒ½ä¸Šçš„å·¨å¤§æå‡ä»¥åŠæ— é™çš„æ¨ªå‘æ‹“å±•èƒ½åŠ›ã€‚è€Œä¸€æ—¦æœ‰äº†åˆ†åŒºä¹‹åå°±ä¼šé¢ä¸´ä¸€ä¸ªé—®é¢˜ï¼Œä½†ä¸€æ¡æ•°æ®è¯·æ±‚æ—¶åº”è¯¥å°†å…¶å‘å¾€å“ªä¸ªåˆ†åŒºï¼Ÿç›®å‰Pulsarè·Ÿå…¶ä»–æ¶ˆæ¯ç³»ç»Ÿä¸€æ ·æ”¯æŒä»¥ä¸‹ä¸‰ç§è·¯ç”±æ¨¡å¼ã€‚\nè½®è¯¢è·¯ç”± ç”Ÿäº§è€…ä¼šæŒ‰å°†æ¶ˆæ¯æŒ‰æ‰¹ä¸ºå•ä½è½®è¯¢å‘é€åˆ°ä¸åŒçš„åˆ†åŒºï¼Œè¿™æ˜¯ä¸€ç§å¸¸è§çš„è·¯ç”±ç­–ç•¥ï¼Œå…·æœ‰ç®€å•çš„ä¼˜åŠ¿ï¼Œç”±äºå®ƒä¸éœ€è¦è¿‡å¤šçš„é…ç½®ä»¥åŠè€ƒè™‘ä½†å´å¯ä»¥è¡¨ç°ä¸é”™çš„æ€§èƒ½ã€‚å¦‚æœæ¶ˆæ¯å¸¦æœ‰keyçš„è¯ä¼šæ ¹æ®keyè¿›è¡Œå“ˆå¸Œè¿ç®—åå†å¯¹åˆ†åŒºè¿›è¡Œå–æ¨¡æ¥å†³å®šæ¶ˆæ¯æŠ•æ”¾çš„ç›®æ ‡åˆ†åŒºã€‚ å•åˆ†åŒºè·¯ç”± å•åˆ†åŒºè·¯ç”±æä¾›ä¸€ç§æ›´ç®€å•çš„æœºåˆ¶ï¼Œå®ƒä¼šå°†æ‰€æœ‰æ¶ˆæ¯è·¯ç”±åˆ°åŒä¸€ä¸ªåˆ†åŒºã€‚è¿™ç§æ¨¡å¼ç±»ä¼¼éåˆ†åŒºTopicï¼Œå¦‚æœæ¶ˆæ¯æä¾›keyçš„è¯å°†æ¢å¤åˆ°è½®è¯¢å“ˆå¸Œè·¯ç”±æ–¹å¼ è‡ªå®šä¹‰åˆ†åŒºè·¯ç”± è‡ªå®šä¹‰åˆ†åŒºè·¯ç”±æ”¯æŒä½ é€šè¿‡å®ç°MessageRouteræ¥å£æ¥è‡ªå®šä¹‰è·¯ç”±é€»è¾‘ï¼Œä¾‹å¦‚å°†ç‰¹å®škeyçš„æ¶ˆæ¯å‘åˆ°æŒ‡å®šçš„åˆ†åŒºç­‰ äºŒã€å®æˆ˜ æ¶ˆæ¯è·¯ç”±å‘ç”Ÿåœ¨ç”Ÿäº§è€…ç«¯ï¼Œåœ¨åˆ›å»ºç”Ÿäº§è€…æ˜¯é€šè¿‡ .messageRoutingMode() è¿›è¡ŒæŒ‡å®šï¼Œä¸‹é¢å°±åˆ†åˆ«å®æˆ˜å¯¹æ¯”ä¸‹è¿™ä¸‰ç§çš„è·¯ç”±æ•ˆæœ\n1. è½®è¯¢è·¯ç”± å…ˆè¯•è¯•è½®è¯¢è·¯ç”±çš„ç­–ç•¥ï¼Œè¿™æ˜¯æœ€å¸¸è§ä¹Ÿæ˜¯é»˜è®¤çš„è·¯ç”±ç­–ç•¥ï¼Œé€šè¿‡ .messageRoutingMode(MessageRoutingMode.RoundRobinPartition) è¿›è¡ŒæŒ‡å®šï¼Œç„¶åå¾€é‡Œé¢é€šè¿‡åŒæ­¥æ–¹å¼å¾€åˆ†åŒºTopicé‡Œé¢å†™å…¥æ•°æ®\n1 2 3 4 5 6 7 8 9 10 11 12 String serverUrl = \u0026#34;http://localhost:8080\u0026#34;; PulsarClient pulsarClient = PulsarClient.builder().serviceUrl(serverUrl).build(); Producer\u0026lt;String\u0026gt; producer = pulsarClient.newProducer(Schema.STRING) .topic(\u0026#34;sherlock-api-tenant-1/sherlock-namespace-1/partition_partition_topic_2\u0026#34;) .messageRoutingMode(MessageRoutingMode.RoundRobinPartition) //.messageRoutingMode(MessageRoutingMode.SinglePartition) .create(); for (int i = 0; i \u0026lt; 20000; i++) { producer.send(\u0026#34;hello java API pulsar:\u0026#34;+i+\u0026#34;, å½“å‰æ—¶é—´ä¸ºï¼š\u0026#34;+new Date()); } é€šè¿‡ç®¡ç†é¡µé¢å¯ä»¥çœ‹åˆ°æ•°æ®åŸºæœ¬å‡åŒ€çš„è½åœ¨å„ä¸ªåˆ†åŒºï¼Œä»è¿™ä¸ªç»“æœæ˜¯èƒ½å¤Ÿåå‘éªŒè¯æ•°æ®æ˜¯ç¬¦åˆè½®è¯¢å‘é€åçš„æ•ˆæœ\n2. å•åˆ†åŒºè·¯ç”± ç°åœ¨è¯•è¯•å•åˆ†åŒºè·¯ç”±çš„ç­–ç•¥ï¼Œé€šè¿‡ .messageRoutingMode(MessageRoutingMode.SinglePartition) è¿›è¡ŒæŒ‡å®šï¼Œå¹¶å¾€åˆ†åŒºTopicé‡Œé¢å†™å…¥ä¸€æ‰¹æ•°æ®\n1 2 3 4 5 6 7 8 9 10 11 String serverUrl = \u0026#34;http://localhost:8080\u0026#34;; PulsarClient pulsarClient = PulsarClient.builder().serviceUrl(serverUrl).build(); Producer\u0026lt;String\u0026gt; producer = pulsarClient.newProducer(Schema.STRING) .topic(\u0026#34;sherlock-api-tenant-1/sherlock-namespace-1/partition_partition_topic_2\u0026#34;) .messageRoutingMode(MessageRoutingMode.SinglePartition) .create(); for (int i = 0; i \u0026lt; 20000; i++) { producer.send(\u0026#34;hello java API pulsar:\u0026#34;+i+\u0026#34;, å½“å‰æ—¶é—´ä¸ºï¼š\u0026#34;+new Date()); } é€šè¿‡ç®¡ç†é¡µé¢å¯ä»¥çœ‹åˆ°æ•°æ®éƒ½è½åœ¨ç¬¬ä¸€ä¸ªåˆ†åŒºï¼Œè¯´æ˜è¿™ä¹Ÿç¬¦åˆå®˜ç½‘ä¸­å¯¹å•åˆ†åŒºè·¯ç”±çš„æè¿°ã€‚åŒæ—¶ç»è¿‡åå¤è¯•éªŒå¤šæ¬¡å‘ç°ï¼Œç”Ÿäº§è€…ä¼šéšæœºé€‰æ‹©ä¸€ä¸ªåˆ†åŒºå¹¶å°†æ‰€æœ‰æ•°æ®å‘é€åˆ°è¿™ä¸ªåˆ†åŒºã€‚\n3. è‡ªå®šä¹‰è·¯ç”± åœ¨æœ‰äº›ä¸šåŠ¡åœºæ™¯ï¼Œæˆ‘ä»¬éœ€è¦å°†è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘â€œèå…¥â€è·¯ç”±ç­–ç•¥ï¼Œå› æ­¤åƒPulsarã€Kafkaç­‰æ¶ˆæ¯ä¸­é—´ä»¶éƒ½æ˜¯æ”¯æŒç”¨æˆ·è¿›è¡Œè·¯ç”±è§„åˆ™çš„è‡ªå®šä¹‰çš„ã€‚è¿™é‡Œä¸ºäº†å¥½ç©ï¼Œå’±ä»¬å°è¯•å°†æ•°æ®æŒ‰ç…§ 1:2:3:4 ç­‰æ¯”ä¾‹åˆ†åˆ«è½åœ¨å››ä¸ªåˆ†åŒºå¦‚ä½•ï¼Ÿè¯´å¹²å°±å¹²ï¼Œè‡ªå®šä¹‰è·¯ç”±ä¹Ÿæ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œåªéœ€è¦å®ç°Pulsar MessageRouteræ¥å£çš„choosePartitionæ–¹æ³•å³å¯ï¼Œå®ç°é€»è¾‘å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 public class SherlockRouter implements MessageRouter { Long count = 0L; public int choosePartition(Message\u0026lt;?\u0026gt; msg, TopicMetadata metadata) { count++; count = count % 10; if (count == 0) return 0; if (count \u0026lt; 3) return 1; if (count \u0026lt; 6) return 2; return 3; } } é€šè¿‡ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œå‚æ•°msgå°±æ˜¯ç”Ÿäº§è€…ä¸­å›½å‘¢å‘é€çš„æ¶ˆæ¯å¯¹è±¡ï¼Œmetadataæ˜¯è¿™æ¡æ¶ˆæ¯çš„å…ƒæ•°æ®å¦‚ç§Ÿæˆ·ã€å‘½åç©ºé—´ç­‰ç­‰ï¼Œè€Œè¿”å›å€¼å…¶å®å°±æ˜¯è¿™ä¸ªTopicåˆ†åŒºçš„ä¸‹æ ‡ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ä¸è¦è¶…è¿‡Topicçš„åˆ†åŒºæ•°ï¼ŒåŒæ—¶ä¸€äº›æ¯”è¾ƒå¤æ‚çš„æ•°æ®å¤„ç†é€»è¾‘ä»£ç å°½é‡ä¸è¦å†™åœ¨è¿™é‡Œå½±å“æ¶ˆæ¯å‘é€æ€§èƒ½ä»¥åŠä¸è§„èŒƒã€‚\nå†™å®Œåé€šè¿‡ .messageRouter() æ–¹æ³•è¿›è¡ŒæŒ‡å®šå³å¯ä½¿ç”¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 public static void customRoundSchemaProducer() throws Exception { String serverUrl = \u0026#34;http://localhost:8080\u0026#34;; PulsarClient pulsarClient = PulsarClient.builder().serviceUrl(serverUrl).build(); Producer\u0026lt;String\u0026gt; producer = pulsarClient.newProducer(Schema.STRING) .topic(\u0026#34;sherlock-api-tenant-1/sherlock-namespace-1/partition_partition_topic_3\u0026#34;) .messageRouter(new SherlockRouter()) .create(); for (int i = 0; i \u0026lt; 20000; i++) { producer.send(\u0026#34;hello java API pulsar:\u0026#34;+i+\u0026#34;, å½“å‰æ—¶é—´ä¸ºï¼š\u0026#34;+new Date()); } producer.close(); pulsarClient.close(); } åœ¨ç®¡ç†é¡µé¢å¯ä»¥çœ‹åˆ°ï¼Œæ•°æ®æ˜¯æŒ‰ç…§å’±ä»¬é¢„æœŸçš„é€»è¾‘ 1:2:3:4ç­‰æ¯”è½åœ¨åˆ†åŒºé‡Œé¢ï¼Œå˜¿å˜¿ï½\nä¸‰ã€æºç åˆ†æ 1. æ¥å£ä»¥åŠçˆ¶ç±» Pulsarä¸­æ‰€æœ‰è·¯ç”±è§„åˆ™éƒ½æ˜¯åŸºäºMessageRouteræ¥å£è¿›è¡Œå®ç°çš„ï¼Œè¿™ä¸ªæ¥å£ä¸»è¦æä¾›äº†choosePartitionæ–¹æ³•ï¼Œåªè¦é‡å†™è¿™ä¸ªæ–¹æ³•å³å¯è‡ªå®šä¹‰ä»»æ„è‡ªå·±é¢„æœŸçš„é€»è¾‘\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 @InterfaceAudience.Public @InterfaceStability.Stable public interface MessageRouter extends Serializable { /** * * @param msg * Message object * @return The index of the partition to use for the message * @deprecated since 1.22.0. Please use {@link #choosePartition(Message, TopicMetadata)} instead. */ @Deprecated default int choosePartition(Message\u0026lt;?\u0026gt; msg) { throw new UnsupportedOperationException(\u0026#34;Use #choosePartition(Message, TopicMetadata) instead\u0026#34;); } /** * Choose a partition based on msg and the topic metadata. * * @param msg message to route * @param metadata topic metadata * @return the partition to route the message. * @since 1.22.0 */ default int choosePartition(Message\u0026lt;?\u0026gt; msg, TopicMetadata metadata) { return choosePartition(msg); } } MessageRouterBaseæ˜¯è·¯ç”±ç­–ç•¥çš„æŠ½è±¡ç±»ï¼Œä¸»è¦å®šä¹‰äº†æ¶ˆæ¯æœ‰keyæ—¶çš„å“ˆå¸Œç®—æ³•ï¼Œåƒä¸Šé¢æçš„è½®è¯¢è·¯ç”±å’Œå•åˆ†åŒºè·¯ç”±ç»§æ‰¿äº†è¿™ä¸ªæŠ½è±¡ç±»ã€‚JavaStringHashå’ŒMurmur3Hash32ä¸¤ä¸ªéƒ½æ˜¯Pulsaræä¾›çš„å“ˆå¸Œç®—æ³•çš„å®ç°ç±»ï¼Œä¸¤è€…çš„å·®å¼‚åé¢å†å•ç‹¬è¿›è¡Œåˆ†æ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 public abstract class MessageRouterBase implements MessageRouter { private static final long serialVersionUID = 1L; protected final Hash hash; MessageRouterBase(HashingScheme hashingScheme) { switch (hashingScheme) { case JavaStringHash: this.hash = JavaStringHash.getInstance(); break; case Murmur3_32Hash: default: this.hash = Murmur3Hash32.getInstance(); } } } 2. è½®è¯¢è·¯ç”±çš„å®ç° ä¸»è¦çœ‹choosePartition æ–¹æ³•çš„é€»è¾‘ï¼Œé¦–å…ˆå¦‚æœæ¶ˆæ¯å¸¦æœ‰keyåˆ™é’ˆå¯¹keyè¿›è¡Œå“ˆå¸Œç„¶åå–æ¨¡ï¼Œè¿™æ ·å¯ä»¥ä¿è¯ç›¸åŒkeyçš„æ¶ˆæ¯è½åœ¨åŒä¸€ä¸ªåˆ†åŒºã€‚ç„¶åå°±æ˜¯åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦æŒ‰æ‰¹æ¬¡è¿›è¡Œå‘é€çš„ï¼Œå¦‚æœæ˜¯å•æ¡æ¶ˆæ¯å‘é€çš„è¯åˆ™é€šè¿‡ä¸€ä¸ªç´¯åŠ è®¡æ•°å™¨è¿›è¡Œè½®è¯¢åˆ†åŒºï¼Œå³å¯è¾¾åˆ°æ¶ˆæ¯æŒ‰ç…§åˆ†åŒºé¡ºåºé€ä¸ªå‘é€çš„æ•ˆæœï¼›å¦‚æœæ˜¯æŒ‰æ‰¹æ¬¡å‘é€çš„è¯ï¼Œåˆ™æ˜¯æ ¹æ®æ—¶é—´æˆ³è¿›è¡Œå–æ¨¡ï¼Œè¿™æ ·è¾¾åˆ°çš„æ•ˆæœå°±æ˜¯æ¯æ‰¹æ•°æ®éƒ½ä¼šéšæœºå‘é€åˆ°æŸä¸€ä¸ªåˆ†åŒº\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 public class RoundRobinPartitionMessageRouterImpl extends MessageRouterBase { @SuppressWarnings(\u0026#34;unused\u0026#34;) private volatile int partitionIndex = 0; private final int startPtnIdx; private final boolean isBatchingEnabled; private final long partitionSwitchMs; .... @Override public int choosePartition(Message\u0026lt;?\u0026gt; msg, TopicMetadata topicMetadata) { // If the message has a key, it supersedes the round robin routing policy if (msg.hasKey()) { return signSafeMod(hash.makeHash(msg.getKey()), topicMetadata.numPartitions()); } if (isBatchingEnabled) { // if batching is enabled, choose partition on `partitionSwitchMs` boundary. long currentMs = clock.millis(); return signSafeMod(currentMs / partitionSwitchMs + startPtnIdx, topicMetadata.numPartitions()); } else { return signSafeMod(PARTITION_INDEX_UPDATER.getAndIncrement(this), topicMetadata.numPartitions()); } } } 3. å•åˆ†åŒºè·¯ç”± å¯ä»¥çœ‹åˆ°å•åˆ†åŒºçš„é€»è¾‘æ˜¯æ¯”è¾ƒç®€å•ä¸”æ¸…æ™°çš„ï¼Œå¦‚æœæœ‰keyå°±è¿›è¡Œå“ˆå¸Œå–æ¨¡ï¼Œå¦åˆ™å°±å‘é€åˆ°partitionIndexè¿™ä¸ªæˆå‘˜å˜é‡æŒ‡å®šçš„åˆ†åŒºå»ï¼Œé‚£ä¹ˆè¿™ä¸ªpartitionIndexæŒ‡å®šçš„æ˜¯å“ªä¸ªåˆ†åŒºå‘¢ï¼Ÿé€šè¿‡ä»£ç èƒ½çœ‹åˆ°æ˜¯ä»æ„é€ å‡½æ•°é‡Œé¢ä¼ è¿›æ¥çš„ï¼Œå› æ­¤è·Ÿè¸ªä¸‹ä»£ç çœ‹çœ‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 public class SinglePartitionMessageRouterImpl extends MessageRouterBase { private final int partitionIndex; public SinglePartitionMessageRouterImpl(int partitionIndex, HashingScheme hashingScheme) { super(hashingScheme); this.partitionIndex = partitionIndex; } @Override public int choosePartition(Message\u0026lt;?\u0026gt; msg, TopicMetadata metadata) { // If the message has a key, it supersedes the single partition routing policy if (msg.hasKey()) { return signSafeMod(hash.makeHash(msg.getKey()), metadata.numPartitions()); } return partitionIndex; } } é€šè¿‡è·Ÿè¸ªå¯ä»¥çœ‹åˆ°æ˜¯åœ¨PartitionedProducerImplç±»çš„getMessageRouteræ–¹æ³•ä¸­è¿›è¡ŒSinglePartitionMessageRouterImplç±»çš„åˆå§‹åŒ–ï¼ŒåŒæ—¶æ˜¯é€šè¿‡ThreadLocalRandom.current().nextInt(topicMetadata.numPartitions()) æ¥ç”Ÿæˆä¸€ä¸ªå°äºåˆ†åŒºæ•°çš„éšæœºæ•°ï¼Œå› æ­¤å•åˆ†åŒºè·¯ç”±çš„åˆ†åŒºæ˜¯éšæœºæŒ‡å®šçš„ä¸€ä¸ªï¼Œè¿™ä¸ªç»“æœè·Ÿå’±ä»¬å®æˆ˜ä¸­æµ‹è¯•çš„æ•ˆæœæ˜¯å»åˆçš„ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå’±ä»¬è¿˜çœ‹åˆ° getMessageRouteræ–¹æ³•ä¸­ä¼šæ ¹æ®å’±ä»¬åœ¨åˆ›å»ºç”Ÿäº§è€…æ—¶ .messageRoutingMode æ–¹æ³•æŒ‡å®šçš„è·¯ç”±æ¨¡å¼æ¥åˆ›å»ºå¯¹åº”çš„è·¯ç”±å®ç°ç±»ï¼Œåœ¨è¿™é‡Œå¯ä»¥æ˜ç¡®çš„çœ‹åˆ°æ²¡æœ‰æŒ‡å®šçš„è¯é»˜è®¤å°±æ˜¯é‡‡ç”¨çš„è½®è¯¢è·¯ç”±è§„åˆ™\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 private MessageRouter getMessageRouter() { MessageRouter messageRouter; MessageRoutingMode messageRouteMode = conf.getMessageRoutingMode(); switch (messageRouteMode) { case CustomPartition: messageRouter = Objects.requireNonNull(conf.getCustomMessageRouter()); break; case SinglePartition: messageRouter = new SinglePartitionMessageRouterImpl( ThreadLocalRandom.current().nextInt(topicMetadata.numPartitions()), conf.getHashingScheme()); break; case RoundRobinPartition: default: messageRouter = new RoundRobinPartitionMessageRouterImpl( conf.getHashingScheme(), ThreadLocalRandom.current().nextInt(topicMetadata.numPartitions()), conf.isBatchingEnabled(), TimeUnit.MICROSECONDS.toMillis(conf.batchingPartitionSwitchFrequencyIntervalMicros())); } return messageRouter; } å››ã€æ€»ç»“ é€šè¿‡ä»¥ä¸Šå†…å®¹ç›¸ä¿¡ä½ å¯¹Pulsarçš„è·¯ç”±è§„åˆ™æœ‰ä¸€å®šçš„äº†è§£äº†ï¼Œå¦‚æœæƒ³è¿›ä¸€æ­¥äº†è§£å¯ä»¥å°è¯•æŒ‰ç…§è‡ªå·±å–œå¥½å®ç°ä¸‹è·¯ç”±è§„åˆ™å¹¶è§‚æµ‹æ˜¯å¦æŒ‰ç…§é¢„æœŸè¿è¡Œï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥è·Ÿè¸ªPulsarçš„æºç çœ‹çœ‹å®ç°æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚å¦‚æœæƒ³å½»åº•æŒæ¡Pulsarï¼Œæœ€å¥½è‡ªå·±è·Ÿè¸ªä¸‹Pulsarçš„ä¸€äº›æ ¸å¿ƒé€»è¾‘ï¼Œè¿™æ ·ä¸ä»…äº†è§£å…¶åº•å±‚æ˜¯å¦‚ä½•è¿ä½œçš„ï¼Œä¹Ÿèƒ½åŠ æ·±ä½ å¯¹ä¸€äº›è®¾è®¡/ç‰¹æ€§çš„å°è±¡ã€‚\n","date":"2024-09-20T10:34:56+08:00","image":"https://sherlock-lin.github.io/p/pulsar%E6%B6%88%E6%81%AF%E8%B7%AF%E7%94%B1%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/image-20240306152645225_hu5442259153227018439.png","permalink":"https://sherlock-lin.github.io/p/pulsar%E6%B6%88%E6%81%AF%E8%B7%AF%E7%94%B1%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90/","title":"Pulsaræ¶ˆæ¯è·¯ç”±æ·±å…¥å‰–æ"},{"content":"å¼•è¨€ åœ¨çœ‹äº† ä½ çœŸçš„äº†è§£Pulsarçš„æ¶ˆæ¯ä¿ç•™ã€ç§¯å‹ã€TTLç­–ç•¥å— åï¼Œç›¸ä¿¡æœ‰ä¸å°‘å¯¹æŠ€æœ¯å……æ»¡çƒ­æƒ…çš„å°ä¼™ä¼´ä¼šç–‘æƒ‘ï¼ŒPulsarçš„TTLåˆæ˜¯æ€ä¹ˆå»å¤±ä¿¡çš„å‘¢ï¼Ÿä»Šå¤©å°±è®©æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹å§\nåœ¨çœ‹ä¸‹é¢çš„æ–‡ç« æ—¶æˆ‘ä»¬è¦å¸¦ç€ä»¥ä¸‹å‡ ä¸ªé—®é¢˜\nTTLæ˜¯ä»€ä¹ˆæ—¶å€™è§¦å‘çš„ TTLæœºåˆ¶è¢«è§¦å‘åä¼šå‘ç”Ÿä»€ä¹ˆ è¿‡æœŸçš„æ¶ˆæ¯ä¼šç«‹é©¬è¢«åˆ é™¤å— æ•´ä½“æµç¨‹ åœ¨è·Ÿè¸ªæºç å‰å…ˆçœ‹çœ‹è¿™å¼ å›¾ï¼Œæ¯ä¸ªBrokerå†…éƒ¨éƒ½ä¼šæœ‰ä¸€ä¸ªå‘¨æœŸå®šæ—¶çº¿ç¨‹ä»»åŠ¡ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´éƒ½ä¼šè§¦å‘TTLä»»åŠ¡ã€‚TTLä»»åŠ¡ä¼šè½®è¯¢å½“å‰Brokeræ‰€ç®¡ç†çš„æ‰€æœ‰Topicä¸­çš„æ‰€æœ‰è®¢é˜…è€…ï¼Œå› ä¸ºæ¯ä¸ªè®¢é˜…è€…éƒ½ä¼šåœ¨Brokerç»´æŠ¤ä¸€ä¸ªæ¶ˆè´¹æ¸¸æ ‡ï¼Œå› æ­¤Brokerä¼šæ ¹æ®ç”¨æˆ·é…ç½®çš„è¿‡æœŸæ—¶é—´åˆ°è½®è¯¢æ£€æŸ¥æ¸¸æ ‡ï¼Œçœ‹çœ‹æœ‰å“ªäº›æ¶ˆæ¯æ˜¯æ²¡è¢«æ¶ˆè´¹ä½†æ˜¯å·²ç»è¿‡äº†TTLçš„å¹¶ä¼šå°†æ¸¸æ ‡ç§»åŠ¨åˆ°å…¶çš„å·¦ä¾§(ä»å®ç°çš„å±‚é¢ç›¸å½“äºè¡¨ç¤ºå®ƒå·²ç»è¢«æ¶ˆè´¹äº†)ï¼Œä»è€Œè¾¾åˆ°è¿™äº›è¿‡äº†TTLçš„æ¶ˆæ¯å…è®¸è¢«åˆ é™¤çš„æ•ˆæœï¼Œæœ€ç»ˆå†å°†æ¸¸æ ‡çš„ä¿¡æ¯æŒä¹…åŒ–åˆ°Bookkeeperä¸­è¿›è¡Œä¿å­˜ã€‚\nè§¦å‘TTLæµç¨‹ é‚£ä¹ˆç›´æ¥æ¥è·Ÿè¸ªä¸‹è§¦å‘TTLçš„æµç¨‹å§ï¼Œå…ˆä»Brokerçš„å¯åŠ¨æ–¹æ³•startå¼€å§‹çœ‹ã€‚å¯ä»¥çœ‹åˆ°å¯åŠ¨çš„æ—¶å€™è¿˜ä¼šå¼€å¯ä¸€ç³»åˆ—å®šæ—¶ä»»åŠ¡ï¼Œè¿™é‡Œåªçœ‹TTLç›¸å…³çš„ï¼Œè·Ÿè¸ªè¿›å»startMessageExpiryMonitoræ–¹æ³•å¯ä»¥çœ‹åˆ°messageExpiryMonitorå…¶å®æ˜¯JDKæä¾›çš„çº¿ç¨‹æ± ScheduledExecutorServiceç±»ï¼Œåœ¨è¿™é‡Œé€šè¿‡scheduleAtFixedRateæ–¹æ³•å‘¨æœŸæ€§çš„æ‰§è¡Œè¿‡æœŸä»»åŠ¡æ£€æµ‹ï¼Œé—´éš”ä»Brokeré…ç½®ä¸­è¿›è¡Œè¯»å–çš„ï¼Œé»˜è®¤æ˜¯æ¯éš”5åˆ†é’Ÿä¸€æ¬¡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 public void start() throws Exception { .... this.startInactivityMonitor(); //å¯åŠ¨å®šæ—¶æ¶ˆæ¯è¿‡æœŸæ£€æµ‹ä»»åŠ¡(TTL) this.startMessageExpiryMonitor(); this.startCompactionMonitor(); this.startConsumedLedgersMonitor(); this.startBacklogQuotaChecker(); this.updateBrokerPublisherThrottlingMaxRate(); this.updateBrokerDispatchThrottlingMaxRate(); this.startCheckReplicationPolicies(); this.startDeduplicationSnapshotMonitor(); } protected void startMessageExpiryMonitor() { int interval = pulsar().getConfiguration().getMessageExpiryCheckIntervalInMinutes(); messageExpiryMonitor.scheduleAtFixedRate(this::checkMessageExpiry, interval, interval, TimeUnit.MINUTES); } TTLå¯åŠ¨æµç¨‹ é€šè¿‡ä¸Šä¸€èŠ‚å¯ä»¥çœ‹åˆ°Pulsarçš„TTLè§¦å‘å°±æ˜¯é€šè¿‡JDKçš„å®šæ—¶çº¿ç¨‹æ± æ¥å®ç°çš„ï¼ŒBrokerä¼šå‘¨æœŸæ€§çš„è°ƒç”¨checkMessageExpiryæ–¹æ³•è¿›è¡Œå¤„ç†ï¼Œå› æ­¤ç°åœ¨å°±ä»è¿™ä¸ªæ–¹æ³•è¿›è¡Œè·Ÿè¸ªï¼Œå¯ä»¥çœ‹åˆ°æœ€ç»ˆä¼šè°ƒç”¨åˆ°Topicçš„checkMessageExpiryæ–¹æ³•\n1 2 3 4 5 6 7 8 9 10 11 12 13 public void checkMessageExpiry() { //è¿›å»çœ‹çœ‹forEachTopicçš„å®ç° forEachTopic(Topic::checkMessageExpiry); } public void forEachTopic(Consumer\u0026lt;Topic\u0026gt; consumer) { //topicsæ˜¯Brokerç»´æŠ¤çš„ä¸€ä¸ªMapç»“æ„ï¼Œç”¨äºè®°å½•å½“å‰Brokeræ‰€ç»´æŠ¤çš„Topicä¿¡æ¯ //è¿™é‡Œä½¿ç”¨äº†Java8çš„Consumerï¼Œç›¸å½“äºé—­åŒ…çš„è®¾è®¡ï¼Œè®©å†…éƒ¨çš„æ‰€æœ‰Topicéƒ½æ‰§è¡ŒcheckMessageExpiryæ–¹æ³• topics.forEach((n, t) -\u0026gt; { Optional\u0026lt;Topic\u0026gt; topic = extractTopic(t); topic.ifPresent(consumer::accept); }); } ç”±äºTopicåªæ˜¯æ¥å£ï¼Œå› æ­¤æˆ‘ä»¬çœ‹å®ƒæœ€å¸¸ç”¨çš„å®ç°ç±»ä¹Ÿå°±æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„PersistentTopicç±»çš„å®ç°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 public void checkMessageExpiry() { //ä»topicé…ç½®ä¸­è·å–æ¶ˆæ¯çš„TTLé…ç½®ï¼Œè¿™ä¸ªè·Ÿä¸Šé¢çš„é…ç½®æ˜¯æœ‰åŒºåˆ«çš„ï¼Œè¿™é‡Œä»£è¡¨çš„æ˜¯æ¶ˆæ¯çš„æœ‰æ•ˆæœŸ int messageTtlInSeconds = topicPolicies.getMessageTTLInSeconds().get(); //é€šè¿‡è¿™é‡Œçš„é€»è¾‘å¯ä»¥çŸ¥é“å¦‚æœé…ç½®æˆ0å°±ä¸ä¼šè¿‡æœŸ if (messageTtlInSeconds != 0) { //å¾ªç¯è°ƒç”¨å½“å‰Topicè®¢é˜…è€…æ£€æµ‹è¿‡æœŸ subscriptions.forEach((__, sub) -\u0026gt; { if (!isCompactionSubscription(sub.getName())) { //è¿›è¡Œå…·ä½“çš„æ£€æµ‹åŠ¨ä½œï¼Œä»è¿™é‡Œç»§ç»­è·Ÿè¸ª sub.expireMessages(messageTtlInSeconds); } }); } } public boolean expireMessages(int messageTTLInSeconds) { //è·å–å½“å‰ç§¯å‹æ¶ˆæ¯çš„æ¡æ•°(æŒ‡çš„å°±æ˜¯æœªè¢«æ¶ˆè´¹çš„æ¶ˆæ¯æ¡æ•°) long backlog = getNumberOfEntriesInBacklog(false); //å¦‚æœæ²¡æœ‰æ¶ˆæ¯ç§¯å‹å°±ä»£è¡¨æ‰€æœ‰æ¶ˆæ¯éƒ½è¢«æˆåŠŸæ¶ˆè´¹å¹¶ä¸”æ¸¸æ ‡æ­¤æ—¶å·²ç»å¤„äºæœ€å·¦ç«¯ï¼Œå› æ­¤æ²¡å¿…è¦å†åšTTLçš„æ£€æµ‹äº† if (backlog == 0 || (dispatcher != null \u0026amp;\u0026amp; dispatcher.isConsumerConnected() \u0026amp;\u0026amp; backlog \u0026lt; MINIMUM_BACKLOG_FOR_EXPIRY_CHECK \u0026amp;\u0026amp; !topic.isOldestMessageExpired(cursor, messageTTLInSeconds))) { // don\u0026#39;t do anything for almost caught-up connected subscriptions return false; } this.lastExpireTimestamp = System.currentTimeMillis(); //æ›´æ–°è¿‡æœŸæ¶ˆæ¯çš„ä¸‹æ ‡ï¼Œä»è¿™é‡Œç»§ç»­è·Ÿè¸ª return expiryMonitor.expireMessages(messageTTLInSeconds); } public boolean expireMessages(int messageTTLInSeconds) { .... // è¿™é‡Œè¿›å»è¿›è¡Œè¿‡æœŸæ£€æŸ¥ checkExpiryByLedgerClosureTime(cursor, messageTTLInSeconds); .... } private void checkExpiryByLedgerClosureTime(ManagedCursor cursor, int messageTTLInSeconds) { //å‚æ•°æ ¡éªŒï¼Œå¯æ˜¯è¿™é‡Œä¸ºä»€ä¹ˆåˆåšäº†å°äº0çš„åˆ¤æ–­ï¼Œè€Œå¤–å±‚åªåˆ¤æ–­äº†ç­‰äº0ï¼Œå¯å¦ç”¨ç»Ÿä¸€çš„å‚æ•°æ ¡éªŒå·¥å…·è¿›è¡Œæ ¡éªŒå‘¢ï¼Ÿ if (messageTTLInSeconds \u0026lt;= 0) { return; } if (cursor instanceof ManagedCursorImpl managedCursor) { ManagedLedgerImpl managedLedger = (ManagedLedgerImpl) managedCursor.getManagedLedger(); //è·å¾—æ¸¸æ ‡å½“å‰æ ‡è®°çš„å¯åˆ é™¤ä½ç½® Position deletedPosition = managedCursor.getMarkDeletedPosition(); //è·å–å½“å‰æœªè¢«æˆåŠŸæ¶ˆè´¹çš„ç§¯å‹æ—¥å¿—ä¿¡æ¯ï¼ŒæŒ‰Ledgerè¿›è¡Œæ’åº SortedMap\u0026lt;Long, MLDataFormats.ManagedLedgerInfo.LedgerInfo\u0026gt; ledgerInfoSortedMap = managedLedger.getLedgersInfo().subMap(deletedPosition.getLedgerId(), true, managedLedger.getLedgersInfo().lastKey(), true); MLDataFormats.ManagedLedgerInfo.LedgerInfo info = null; // æŸ¥è¯¢æœ€æ¥è¿‘ç°åœ¨çš„ç¬¬ä¸€ä¸ªæœªè¿‡æœŸLedgerï¼Œé‚£ä¹ˆå…¶ä¸Šä¸€ä¸ªLedgerä¸€å®šæ˜¯è¿‡æœŸçš„å¹¶ä¸”å…¶ä¹‹å‰çš„éƒ½æ˜¯è¿‡æœŸçš„ for (MLDataFormats.ManagedLedgerInfo.LedgerInfo ledgerInfo : ledgerInfoSortedMap.values()) { if (!ledgerInfo.hasTimestamp() || !MessageImpl.isEntryExpired(messageTTLInSeconds, ledgerInfo.getTimestamp())) { break; } info = ledgerInfo; } //å¦‚æœinfoä¸ä¸ºç©ºè¯´æ˜ä¸€å®šå­˜åœ¨å·²ç»å¤„äºè¿‡æœŸçš„Ledgerä¹Ÿå°±æ˜¯è¿‡æœŸçš„æ¶ˆæ¯é›†åˆä½“ if (info != null \u0026amp;\u0026amp; info.getLedgerId() \u0026gt; -1) { //è·å–å…·ä½“è¿‡æœŸçš„ä½ç½® PositionImpl position = PositionImpl.get(info.getLedgerId(), info.getEntries() - 1); if (((PositionImpl) managedLedger.getLastConfirmedEntry()).compareTo(position) \u0026lt; 0) { findEntryComplete(managedLedger.getLastConfirmedEntry(), null); } else { //è¿™é‡Œè¿›å»æ£€æŸ¥è¿‡æœŸä½ç½® findEntryComplete(position, null); } } } } é€šè¿‡ä¸Šé¢çš„ä»£ç è·Ÿè¸ªå¯ä»¥çœ‹åˆ°åœ¨è·å–åˆ°è¿‡æœŸçš„æ¶ˆæ¯ä½ç½®åï¼Œæœ€ç»ˆè°ƒç”¨äº†PersistentMessageExpiryMonitorç±»çš„findEntryCompleteæ–¹æ³•ï¼Œé‚£ä¹ˆå’±ä»¬æ¥ä¸‹æ¥è·Ÿç€è¿›å»çœ‹çœ‹éƒ½å‘ç”Ÿäº†å“ªäº›æœ‰æ„æ€çš„äº‹æƒ…å§\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 public void findEntryComplete(Position position, Object ctx) { ....\t//é€šè¿‡æ–¹æ³•å‘½åå¯ä»¥æ¨æµ‹æ˜¯é€šè¿‡æ ‡è®°æ¸¸æ ‡çš„åˆ é™¤ä½ç½®åˆ°è¾¾åˆ°TTLçš„æ•ˆæœï¼Œç»§ç»­è·Ÿè¸ªè¿›å»çœ‹çœ‹ cursor.asyncMarkDelete(position, cursor.getProperties(), markDeleteCallback, cursor.getNumberOfEntriesInBacklog(false)); .... } public void asyncMarkDelete(final Position position, Map\u0026lt;String, Long\u0026gt; properties, final MarkDeleteCallback callback, final Object ctx) { .... //å¼‚æ­¥æ ‡è®°åˆ é™¤ä½ç½® internalAsyncMarkDelete(newPosition, properties, callback, ctx); } protected void internalAsyncMarkDelete(final PositionImpl newPosition, Map\u0026lt;String, Long\u0026gt; properties, final MarkDeleteCallback callback, final Object ctx) { .... synchronized (pendingMarkDeleteOps) { switch (STATE_UPDATER.get(this)) { .... case Open: if (PENDING_READ_OPS_UPDATER.get(this) \u0026gt; 0) { pendingMarkDeleteOps.add(mdEntry); } else { //è¿›è¡Œæ ‡è®°åˆ é™¤ internalMarkDelete(mdEntry); } break; .... } } } void internalMarkDelete(final MarkDeleteEntry mdEntry) { .... //æŒä¹…åŒ–æ¸¸æ ‡ä¿¡æ¯åˆ°Bookkeeper persistPositionToLedger(cursorLedger, mdEntry, cb); } void persistPositionToLedger(final LedgerHandle lh, MarkDeleteEntry mdEntry, final VoidCallback callback) { PositionImpl position = mdEntry.newPosition; PositionInfo pi = PositionInfo.newBuilder().setLedgerId(position.getLedgerId()) .setEntryId(position.getEntryId()) .addAllIndividualDeletedMessages(buildIndividualDeletedMessageRanges()) .addAllBatchedEntryDeletionIndexInfo(buildBatchEntryDeletionIndexInfoList()) .addAllProperties(buildPropertiesMap(mdEntry.properties)).build(); .... requireNonNull(lh); byte[] data = pi.toByteArray(); //è°ƒç”¨Bookkeeperå®¢æˆ·ç«¯å°†æ¸¸æ ‡ä¿¡æ¯å†™å…¥ lh.asyncAddEntry(data, (rc, lh1, entryId, ctx) -\u0026gt; { .... }, null); } é€šè¿‡ä¸Šé¢çš„è·Ÿè¸ªå¯ä»¥çœ‹å¾—åˆ°æœ€ç»ˆæ˜¯é€šè¿‡Bookkeeperçš„å®¢æˆ·ç«¯å¯¹è±¡LedgerHandleçš„asyncAddEntryæ–¹æ³•å°†æ¸¸æ ‡ä¿¡æ¯æŒä¹…åŒ–åˆ°äº†Bookkeeperï¼Œè¿™é‡Œå°±ä¸ç»§ç»­è·Ÿè¸ªä¸‹å»äº†ï¼Œå› ä¸ºå·²ç»åˆ°äº†TTLå·¦å³èŒƒå›´çš„å°½å¤´äº†ã€‚\næ€»ç»“ ä»¥ä¸Šå°±æ˜¯Pulsarä¸­TTLçš„å®ç°æºç æµç¨‹ï¼Œæˆ‘åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å°½é‡çœç•¥äº†ä¸€äº›éå¿…è¦çš„é€»è¾‘ï¼Œä¸»è¦æ˜¯è·Ÿè¸ªäº†ä¸»çº¿ï¼Œåƒä¸€äº›åœ°æ–¹ä¹Ÿæ˜¯å€¼å¾—è·Ÿè¸ªçš„ï¼Œæ„Ÿå…´è¶£çš„ä¼™ä¼´å¯ä»¥è‡ªè¡Œè·Ÿè¸ªã€‚åŒæ—¶åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒTTLè¿‡ç¨‹åªç§»åŠ¨äº†æ¸¸æ ‡ä½ç½®å¹¶ä¸æ¶‰åŠåˆ°æ•°æ®çš„åˆ é™¤ï¼Œè¯´æ˜åœ¨Pulsarçš„è®¾è®¡ä¸­å°†ä¸¤è€…è¿›è¡Œäº†åˆ†ç¦»ï¼Œè¿™æ˜¯ä¸€ç§å¾ˆå¥½çš„èŒè´£è®¾è®¡æ€è·¯ï¼Œå„è‡ªè´Ÿè´£è‡ªå·±çš„ä¸€é‚£éƒ¨åˆ†ã€‚ä¸€æ–¹é¢åœ¨ç¨‹åºç»´æŠ¤æ—¶å¯ä»¥é¿å…æ”¹åŠ¨å¼•èµ·ä¸€äº›ç›¸å…³æ€§ä¸é‚£ä¹ˆå¤§çš„å½±å“ï¼Œå¦ä¸€æ–¹é¢å¯¹äºç¨‹åºæ‰§è¡Œçš„æ•´ä½“æ€§èƒ½æ¥è¯´ä¹Ÿæ˜¯æ¯”è¾ƒé«˜æ•ˆçš„ã€‚\n","date":"2024-09-20T10:34:56+08:00","image":"https://sherlock-lin.github.io/p/pulsar%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B9%8Bttl/image-20240331111412370_hu135517140155982200.png","permalink":"https://sherlock-lin.github.io/p/pulsar%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B9%8Bttl/","title":"Pulsaræºç è§£æä¹‹TTL"},{"content":"ä¸€ã€å¼•è¨€ å…³äºPulsar Schemaï¼Œå’±ä»¬è¦æƒ³æƒ³ä»¥ä¸‹å‡ ä¸ªé—®é¢˜\nPulsar ä¸­çš„ Schema æ˜¯ä»€ä¹ˆï¼Ÿ Pulsar Schema Registryçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ æ€ä¹ˆä½¿ç”¨ï¼Ÿ åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ äºŒã€Schema æ˜¯ä»€ä¹ˆ Schemaæ˜¯å®šä¹‰ç»“æ„åŒ–æ•°æ®å’ŒäºŒè¿›åˆ¶å­—èŠ‚æ•°ç»„ä¹‹é—´è½¬æ¢çš„é€»è¾‘ï¼ŒPulsarçš„æ¶ˆæ¯æ˜¯ä»¥éç»“æ„åŒ–çš„äºŒè¿›åˆ¶æ•°ç»„è¿›è¡Œå­˜å‚¨çš„ï¼ŒSchemaåªæœ‰åœ¨è¯»å†™æ—¶æ‰ä¼šè¢«åº”ç”¨äºæ•°æ®ä¸Šï¼Œå› æ­¤ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éœ€è¦å¯¹Schemaè¾¾æˆä¸€è‡´ã€‚Pulsaré€šè¿‡Schema Registryä½œä¸ºä¸€ä¸ªä¸­å¤®ä»“åº“å­˜å‚¨Schemaä¿¡æ¯ï¼Œå®ƒå¯ä»¥åè°ƒç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¿è¯ç›¸åŒçš„Schemaï¼Œå®ƒå¯ä»¥å­˜å‚¨å¤šä¸ªç‰ˆæœ¬çš„Schemaï¼Œæ”¯æŒä¸åŒçš„å…¼å®¹æ€§é…ç½®ä»¥åŠæ ¹æ®å…¼å®¹æ€§çš„è¦æ±‚è¿›è¡ŒSchemaçš„æ¼”è¿›ã€‚Pulsarå°†Schemaå­˜å‚¨åœ¨Bookieä¸Šï¼ŒSchemaçš„å†™å…¥ã€è¯»å–éƒ½é€šè¿‡Brokerå’ŒBookieäº¤äº’ï¼Œè¿™ä¸ªé€»è¾‘è·Ÿæ¶ˆæ¯çš„è¯»å†™æ“ä½œæ˜¯ä¸€åªçš„ï¼Œå› æ­¤ä¸éœ€è¦é¢å¤–è€ƒè™‘Schemaçš„å¯ç”¨æ€§å’Œå¯é æ€§é—®é¢˜ï¼Œå› æ­¤æ•´ä½“çœ‹Pulsarå®ç°Schema Registryçš„æ–¹å¼éå¸¸ä¼˜é›…\nç±»å‹å®‰å…¨åœ¨æ‰€æœ‰æ•°æ®åº”ç”¨ä¸­éƒ½éå¸¸é‡è¦ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éœ€è¦æŸç§æœºåˆ¶åè°ƒæ•°æ®ç±»å‹æ¥é¿å…å„ç§æ½œåœ¨çš„é—®é¢˜ï¼Œæ¯”å¦‚åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ–¹å¼ä¸ä¸€è‡´ã€‚æ•°æ®å®‰å…¨é€šå¸¸æœ‰ä¸¤ç§å¤„ç†æ–¹å¼client-sideå’Œservice-sideï¼Œæœ¬è´¨ä¸Šå°±æ˜¯å®¢æˆ·ç«¯ç”¨æ—¶å†³å®šå’ŒæœåŠ¡ç«¯æå‰ä¿è¯\nclient-sideï¼šå°†ä¸€åˆ‡äº¤ç»™ç”¨æˆ·ï¼Œå®¢æˆ·ç«¯è‡ªè¡Œè´Ÿè´£æ¶ˆæ¯çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–å¹¶ä¸”ä¿è¯ç”Ÿäº§æ¶ˆè´¹æ—¶æ¶ˆæ¯çš„ç±»å‹å®‰å…¨ï¼Œè¿™ç§æ–¹å¼çš„æœ€å¤§é—®é¢˜å°±æ˜¯ç±»å‹æ˜¯é€šè¿‡çº¦å®šçš„ï¼Œä¸€æ—¦ç”Ÿäº§è€…å†™å…¥éçº¦å®šçš„æ•°æ®ï¼Œä¸‹æ¸¸çš„æ¶ˆè´¹è€…å°†æ²¡æœ‰åŠæ³•è§£ææ•°æ®\nserver-sideï¼šæ•°æ®å®‰å…¨ç”±æœåŠ¡ç«¯ä¿è¯ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ½éœ€è¦è·ŸæœåŠ¡ç«¯æå‰ç¡®å®šæ•°æ®ç±»å‹ã€‚è¿™ç§æ–¹å¼çœŸæ­£æ„ä¹‰ä¸Šä¿è¯äº†æ•°æ®çš„ç±»å‹å®‰å…¨ï¼Œé¿å…äº†ç”Ÿäº§è€…å†™å…¥éæ³•æ•°æ®çš„é—®é¢˜\nä¸¤ç§å·®å¼‚å¦‚ä¸‹å›¾\nä¸‰ã€æ€ä¹ˆä½¿ç”¨ 1. client-side ç”Ÿäº§è€…ä»£ç é€»è¾‘\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 //schemaåœ¨ç¬¬ä¸€æ¬¡å†™å…¥çš„æ—¶å€™å°±å·²ç»å†³å®šå¥½äº†ï¼Œåç»­ç”¨å…¶ä»–çš„schemaæ¶ˆæ¯ç±»å‹ä¼šå†™å…¥å¤±è´¥ public static void customSchemaProducer() { try { String serverUrl = \u0026#34;http://localhost:8080\u0026#34;; PulsarClient pulsarClient = PulsarClient.builder().serviceUrl(serverUrl).build(); Producer\u0026lt;byte[]\u0026gt; producer = pulsarClient.newProducer() .topic(\u0026#34;persistent://sherlock-api-tenant-1/sherlock-namespace-1/topic_8\u0026#34;) .create(); User user = new User(); user.setName(\u0026#34;è€å…­\u0026#34;); user.setAge(21); user.setAddress(\u0026#34;æµ·å—\u0026#34;); //ç”±ç”¨æˆ·è‡ªè¡Œåšåºåˆ—åŒ–é€»è¾‘ producer.send(JSON.toJSONString(user).getBytes()); producer.close(); pulsarClient.close(); } catch (Exception e) { } } æ¶ˆè´¹è€…é€»è¾‘ä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 public static void customSchemaConsumer() { try { String serverUrl = \u0026#34;http://localhost:8080\u0026#34;; PulsarClient pulsarClient = PulsarClient.builder().serviceUrl(serverUrl).build(); Consumer\u0026lt;byte[]\u0026gt; consumer = pulsarClient.newConsumer() .topic(\u0026#34;persistent://sherlock-api-tenant-1/sherlock-namespace-1/topic_8\u0026#34;) .subscriptionName(\u0026#34;sub_03\u0026#34;) .subscribe(); while(true) { Message\u0026lt;byte[]\u0026gt; message = consumer.receive(); //ç”±ç”¨æˆ·è‡ªè¡Œåšåºåˆ—åŒ–é€»è¾‘ byte[] user = message.getValue(); System.out.println(\u0026#34;æ¶ˆæ¯æ•°æ®ä¸ºï¼š\u0026#34;+JSON.parseObject(user, User.class).toString()); consumer.acknowledge(message); //consumer.negativeAcknowledge(message); } } catch (Exception e) { } } æ‰§è¡Œæ•ˆæœå¦‚ä¸‹\n1 æ¶ˆæ¯æ•°æ®ä¸ºï¼šUser{name=\u0026#39;è€å…­\u0026#39;, age=21, address=\u0026#39;æµ·å—\u0026#39;} 2. server-side ç”Ÿäº§è€…ä»£ç é€»è¾‘\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 //schemaåœ¨ç¬¬ä¸€æ¬¡å†™å…¥çš„æ—¶å€™å°±å·²ç»å†³å®šå¥½äº†ï¼Œåç»­ç”¨å…¶ä»–çš„schemaæ¶ˆæ¯ç±»å‹ä¼šå†™å…¥å¤±è´¥ public static void customSchemaProducer() { try { String serverUrl = \u0026#34;http://localhost:8080\u0026#34;; PulsarClient pulsarClient = PulsarClient.builder().serviceUrl(serverUrl).build(); //ç”±Pulsaråšåºåˆ—åŒ–é€»è¾‘ Producer\u0026lt;User\u0026gt; producer = pulsarClient.newProducer(AvroSchema.of(User.class)) .topic(\u0026#34;persistent://sherlock-api-tenant-1/sherlock-namespace-1/topic_7\u0026#34;) .create(); User user = new User(); user.setName(\u0026#34;ç‹æ­¦\u0026#34;); user.setAge(36); user.setAddress(\u0026#34;æµ·å—\u0026#34;); producer.send(user); producer.close(); pulsarClient.close(); } catch (Exception e) { } } æ¶ˆè´¹è€…é€»è¾‘ä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 public static void customSchemaConsumer() { try { String serverUrl = \u0026#34;http://localhost:8080\u0026#34;; PulsarClient pulsarClient = PulsarClient.builder().serviceUrl(serverUrl).build(); //ç”±Pulsaråšåºåˆ—åŒ–é€»è¾‘ Consumer\u0026lt;User\u0026gt; consumer = pulsarClient.newConsumer(AvroSchema.of(User.class)) .topic(\u0026#34;persistent://sherlock-api-tenant-1/sherlock-namespace-1/topic_7\u0026#34;) .subscriptionName(\u0026#34;sub_03\u0026#34;) .subscribe(); while(true) { Message\u0026lt;User\u0026gt; message = consumer.receive(); User user = message.getValue(); System.out.println(\u0026#34;æ¶ˆæ¯æ•°æ®ä¸ºï¼š\u0026#34;+user); consumer.acknowledge(message); //consumer.negativeAcknowledge(message); } } catch (Exception e) { } } æ‰§è¡Œæ•ˆæœå¦‚ä¸‹\n1 æ¶ˆæ¯æ•°æ®ä¸ºï¼šUser{name=\u0026#39;ç‹æ­¦\u0026#39;, age=36, address=\u0026#39;æµ·å—\u0026#39;} 3. å°ç»“ åˆ†åˆ«æŸ¥çœ‹ä¸¤ä¸ªTopicçš„Schemaä¿¡æ¯å¦‚ä¸‹å›¾\né€šè¿‡æŸ¥è¯¢client-sideçš„Schemaä¿¡æ¯ï¼Œä¼šå‘ç°PulsaræœåŠ¡ç«¯å…¶å®å¹¶æ²¡æœ‰è¿›è¡Œå­˜å‚¨ï¼Œç›¸å½“äºä¸æŒ‡å®šSchemaçš„è¯Pulsaré»˜è®¤éƒ½ç”¨byteæ•°ç»„\nå†æ¥çœ‹çœ‹server-sideçš„Schemaä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°æ‰“å°å¦‚ä¸‹ï¼Œnamespaceæ˜¯pojoç±»çš„åŒ…è·¯å¾„ï¼Œnameæ˜¯pojoç±»åï¼Œç„¶åfieldså°±æ˜¯pojoç±»çš„å„ä¸ªå­—æ®µçš„å±æ€§(åƒä¸åƒmysqlé‡Œé¢çš„è¡¨ç»“æ„ï¼Œä¸å°‘åœºæ™¯Topicå°±æ˜¯å½“ä½œè¡¨æ¥ç”¨çš„)ï¼Œç„¶åtypeæ˜¯AVROæ˜¯ç”±äºå’±ä»¬æ˜¯ç”¨çš„avroè¿›è¡Œåºåˆ—åŒ–çš„ã€‚\né™¤äº†åœ¨è¯»å†™æ•°æ®æ—¶æŒ‡å®šSchemaï¼ŒPulsarè¿˜æ”¯æŒé€šè¿‡adminç®¡ç†æµæå‰æŒ‡å®šå¥½ï¼Œå…·ä½“æŒ‡ä»¤åœ¨è¿™é‡Œã€‚å¦‚æœæ˜¯ç”¨Pulsaræ¥ä½œä¸ºå®æ—¶æ•°ä»“åœºæ™¯ï¼Œå¼ºçƒˆå»ºè®®æå‰é€šè¿‡adminç®¡ç†æµè¿›è¡ŒæŒ‡å®šå¥½ï¼Œé…ç½®isSchemaValidationEnforcedå¯ä»¥è€ƒè™‘å¼€å¯ã€‚å¦‚æœæ¡ä»¶å…è®¸å¯ä»¥è€ƒè™‘åšæˆæœåŠ¡åŒ–ï¼Œä¾‹å¦‚é€šè¿‡Webé¡µé¢æä¾›æ–°å»ºSchemaã€ä¿®æ”¹Schemaæ“ä½œå¹¶æ¥å…¥å…¬å¸å†…éƒ¨çš„å®¡æ‰¹æµç­‰\n1 2 3 pulsar-admin schemas upload --filename POST /admin/v2/schemas/:tenant/:namespace/:topic/schema pulsar-admin schemas get sherlock-api-tenant-1/sherlock-namespace-1/partition_partition_topic_3 å››ã€åŸç†è§£æ Schemaç›¸å…³çš„æµç¨‹å’±ä»¬éœ€è¦å…³æ³¨ä»¥ä¸‹å‡ ä¸ª\næ³¨å†ŒSchemaæµç¨‹ ç”Ÿäº§è€…ç«¯ä¾§ æ¶ˆè´¹è€…ç«¯ä¾§ æŒ‡å®šæœåŠ¡å™¨ Schemaç”Ÿæ•ˆæµç¨‹ æ›´æ–°Schemaæµç¨‹ 1. æ³¨å†ŒSchemaæµç¨‹ ç”Ÿäº§è€…ç«¯ä¾§\nç”Ÿäº§è€…å®ä¾‹ä¼šåœ¨å†…éƒ¨æ„é€ schemaå®ä¾‹ï¼Œç”Ÿäº§è€…ä¼šé€šè¿‡å®ƒå¯¹æ•°æ®è¿›è¡Œè½¬æ¢ ç”Ÿäº§è€…ä¼šè¯·æ±‚è¿æ¥Brokerï¼Œå¹¶ä¼ é€’schemaä¿¡æ¯ SchemaInfo Brokerä¼šåœ¨schema registryä¸­æŸ¥æ‰¾è¿™ä¸ªschemaæ˜¯å¦è¢«æ³¨å†Œï¼Œå¦‚æœå·²ç»æ³¨å†Œäº†å°±å°†æ³¨å†Œçš„schemaç‰ˆæœ¬è¿”å›ç»™ç”Ÿäº§è€… Brokeræ£€æŸ¥æ˜¯å¦æ”¯æŒè‡ªåŠ¨æ›´æ–°schemaï¼Œå¦‚æœé…ç½®ä¸å…è®¸è‡ªåŠ¨æ›´æ–°ï¼Œåˆ™è¿™ä¸ªschemaä¸èƒ½è¢«æ³¨å†Œå¹¶ä¸”æ‹’ç»ç”Ÿäº§è€… Brokerè¿›è¡Œschemaå…¼å®¹æ€§æ£€æŸ¥ï¼Œå¦‚æœé€šè¿‡æ£€æŸ¥åˆ™å°†æ­¤schemaå­˜å‚¨åœ¨schema registryå¹¶è¿”å›ç‰ˆæœ¬ç»™ç”Ÿäº§è€…ï¼Œç”Ÿäº§è€…æ‰€æœ‰æ¶ˆæ¯ä»¥è¿™ä¸ªschemaæ ¼å¼è¿›è¡Œå‘é€ï¼›è‹¥æ˜¯æ£€æŸ¥æ²¡é€šè¿‡åˆ™æ‹’ç»ç”Ÿäº§è€… æ¶ˆè´¹è€…ç«¯\næ¶ˆè´¹è€…å®ä¾‹ä¼šåœ¨å†…éƒ¨æ„é€ schemaå®ä¾‹ æ¶ˆè´¹è€…è¯·æ±‚è¿æ¥Brokerï¼Œå¹¶ä¼ é€’schemaä¿¡æ¯ SchemaInfo Brokeræ£€æŸ¥è¿™ä¸ªTopicæ˜¯å¦å·²ç»åœ¨ä½¿ç”¨ï¼Œæœ‰çš„è¯è·³åˆ°ç¬¬äº”æ­¥ï¼Œå¦åˆ™è·³åˆ°ç¬¬å››æ­¥ Brokeræ£€æŸ¥æ˜¯å¦æ”¯æŒè‡ªåŠ¨æ›´æ–°schemaï¼Œå¦‚æœæ”¯æŒåˆ™æ³¨å†Œè¿™ä¸ªschemaï¼Œå¦åˆ™æ‹’ç»å®¢æˆ·ç«¯ Brokerè¿›è¡Œschemaå…¼å®¹æ€§æ£€æŸ¥ï¼Œé€šè¿‡åˆ™è¿æ¥å¦åˆ™æ‹’ç»å®¢æˆ·ç«¯ äº”ã€æºç è§£æ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 public static void customSchemaProducer() { try { String serverUrl = \u0026#34;http://localhost:8080\u0026#34;; PulsarClient pulsarClient = PulsarClient.builder().serviceUrl(serverUrl).build(); Producer\u0026lt;User\u0026gt; producer = pulsarClient.newProducer(AvroSchema.of(User.class)) .topic(\u0026#34;persistent://sherlock-api-tenant-1/sherlock-namespace-1/topic_7\u0026#34;) .create(); User user = new User(); user.setName(\u0026#34;ç‹æ­¦\u0026#34;); user.setAge(36); user.setAddress(\u0026#34;æµ·å—\u0026#34;); producer.send(user); producer.close(); pulsarClient.close(); } catch (Exception e) { } } æ–‡çŒ® Pulsarï¼šSchema Registryä»‹ç» å®˜æ–¹æ–‡æ¡£ æ·±åº¦è§£è¯» Pulsar Schema ","date":"2024-09-20T10:34:56+08:00","image":"https://sherlock-lin.github.io/p/schema%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/image-20240308104136110_hu13493609005795593452.png","permalink":"https://sherlock-lin.github.io/p/schema%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/","title":"Schemaæ·±åº¦è§£æ"},{"content":"ä¸€ã€å¼•è¨€ ä»Šå¤©è·Ÿç€ å®˜æ–¹æ–‡æ¡£ åŸºäºdockerç©ä¸€æŠŠPulsar IOå§\näºŒã€æ¦‚è¦ åœ¨ç”¨æˆ·èƒ½å¤Ÿè½»æ¾çš„å°†æ¶ˆæ¯é˜Ÿåˆ—è·Ÿå…¶ä»–ç³»ç»Ÿ(æ•°æ®åº“ã€å…¶ä»–æ¶ˆæ¯ç³»ç»Ÿ)ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—çš„ä½œç”¨æ‰æ˜¯æœ€å¼ºå¤§çš„ã€‚è€ŒPulsar IO connectorså¯ä»¥è®©ä½ å¾ˆè½»æ¾çš„åˆ›å»ºã€éƒ¨ç½²ä»¥åŠç®¡ç†è¿™äº›è·Ÿå¤–éƒ¨ç³»ç»Ÿçš„è¿æ¥ï¼Œä¾‹å¦‚mysqlã€kafkaã€cassandraç­‰ã€‚\nPulsar connectoråˆ†ä¸ºSourceå’ŒSinkä¸¤ç§ï¼ŒSource connectorä¼šå°†æ•°æ®ä»å¤–éƒ¨ç³»ç»Ÿå–‚ç»™Pulsarï¼Œè€ŒSink connectorè´Ÿè´£å°†æ•°æ®ä»Pulsarå–‚ç»™å¤–éƒ¨ç³»ç»Ÿã€‚\nPulsar connectoræ˜¯ä¸€ç§ç‰¹æ®Šçš„Functionï¼Œåªä¸è¿‡è¿™ä¸ªFunctionæŒæœ‰å…¶ä»–ç³»ç»Ÿçš„å®¢æˆ·ç«¯ä½œä¸ºpulsarä¸å…¶ä»–ç³»ç»Ÿçš„æ¡¥æ¢ï¼Œå®ƒåœ¨å¤„ç†ä¿è¯ä¸Šè·ŸFunctionæ˜¯ä¸€è‡´çš„ï¼Œåˆ†åˆ«æ˜¯æœ€å¤šä¸€æ¬¡ã€è‡³å°‘ä¸€æ¬¡ã€ç²¾å‡†ä¸€æ¬¡ã€‚å¤„ç†ä¿è¯ä¸ä»…ä¾é Pulsarï¼Œè¿˜è·Ÿå¤–éƒ¨ç³»ç»Ÿç›¸å…³ä»¥åŠå®ç°é€»è¾‘ç›¸å…³ã€‚\næœ€å¤šä¸€æ¬¡ï¼šå‘ç»™connectorçš„æ¶ˆæ¯æœ€å¤šå¤„ç†ä¸€æ¬¡æˆ–è€…ä¸åšå¤„ç† è‡³å°‘ä¸€æ¬¡ï¼šå‘ç»™connectorçš„æ¶ˆæ¯å¤„ç†ä¸€æ¬¡æˆ–è€…å¤šæ¬¡ ç²¾å‡†ä¸€æ¬¡ï¼šå‘ç»™connectorçš„æ¶ˆæ¯åªå¤„ç†ä¸€æ¬¡ ä¸‰ã€å®æˆ˜ 1.å®‰è£…connector åœ¨ è¿™é‡Œ ä¸‹è½½å¯¹åº”çš„connectorï¼Œå…ˆé€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬ï¼Œåœ¨ç‚¹è¿› connectors ç›®å½•é€‰æ‹©å¯¹åº”çš„sourceæˆ–è€…sink\nå°†ä¸‹è½½çš„naræ–‡ä»¶æ”¾åˆ°pulsarå®‰è£…åœ°å€çš„connectors ç›®å½•ä¸‹(æ²¡æœ‰éœ€è¦åˆ›å»º)\nå¯åŠ¨Pulsar\né€šè¿‡æŒ‡ä»¤æŸ¥çœ‹æœåŠ¡connectorä¿¡æ¯ï¼Œå…ˆè¾“å‡ºä¸‹é¢è¿™æ ·çš„ä¿¡æ¯å°±è¯´æ˜connectorå·²ç»æ³¨å†Œåˆ°Pulsarä¸Šé¢äº†\n1 curl -s http://localhost:8080/admin/v2/functions/connectors 2. å®‰è£…Cassandra åŸºäº brew install --cask --appdir=/Applications docker å®‰è£…docker(ä»…é’ˆå¯¹macç¯å¢ƒ)\nåŸºäºdockerè¿è¡Œ cassandraï¼ŒæˆåŠŸè¿è¡Œåé€šè¿‡ docker pså¯ä»¥çœ‹åˆ°CassandraæœåŠ¡å·²ç»èµ·æ¥äº†\n1 docker run -d --rm --name=cassandra -p 9042:9042 cassandra:3.11 é€šè¿‡ docker exec -ti cassandra cqlsh localhost è¿›å…¥CassandraæœåŠ¡çš„å®¹å™¨ï¼Œå¹¶é€šè¿‡ä»¥ä¸‹æŒ‡ä»¤è¿›è¡Œåº“è¡¨çš„åˆå§‹åŒ–\n1 2 3 4 5 CREATE KEYSPACE pulsar_test_keyspace WITH replication = {\u0026#39;class\u0026#39;:\u0026#39;SimpleStrategy\u0026#39;, \u0026#39;replication_factor\u0026#39;:1}; USE pulsar_test_keyspace; CREATE TABLE pulsar_test_table (key text PRIMARY KEY, col text); å…ˆæŸ¥è¯¢è¯¥è¡¨ç¡®ä¿æ²¡æœ‰æ•°æ® select * from pulsar_test_table;\n3. åŠŸèƒ½éªŒè¯ å†™é…ç½®æ–‡ä»¶cassandra-sink.yml\n1 2 3 4 5 6 configs: roots: \u0026#34;localhost:9042\u0026#34; keyspace: \u0026#34;pulsar_test_keyspace\u0026#34; columnFamily: \u0026#34;pulsar_test_table\u0026#34; keyname: \u0026#34;key\u0026#34; columnName: \u0026#34;col\u0026#34; å¯åŠ¨å†™Cassandraçš„sinkï¼Œå¯åŠ¨åé€šè¿‡æŒ‡ä»¤æŸ¥çœ‹æ˜¾ç¤ºsinkå·²ç»æ­£å¸¸å¯åŠ¨\n1 2 3 4 5 6 7 pulsar-admin sinks create \\ --tenant public \\ --namespace default \\ --name cassandra-test-sink \\ --sink-type cassandra \\ --sink-config-file examples/cassandra-sink.yml \\ --inputs test_cassandra æ‰§è¡Œå‘½ä»¤æ‰¹é‡å¾€pulsarä¸­å†™å…¥æ•°æ®ï¼Œçœ‹æ˜¯å¦ä¼šæ­£å¸¸è¾“å‡ºåˆ°Cassandraä¸­\n1 for i in {0..9}; do pulsar-client produce -m \u0026#34;key-$i\u0026#34; -n 1 test_cassandra; done ç”±äºä¸Šé¢çš„æ“ä½œæ˜¯æœ‰å»¶è¿Ÿçš„ï¼Œæ‰€ä»¥ä¸æ–­çš„æŸ¥è¯¢Cassandraçš„è¡¨æ˜¯å¯ä»¥çœ‹åˆ°æ•°æ®åœ¨é€æ­¥çš„å¢åŠ ï¼Œå¹¶æœ€ç»ˆå†™æ»¡åæ¡æ•°æ®\nå››ã€æ€»ç»“ çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œç»çŸ¥æ­¤äº‹è¦èº¬è¡Œã€‚ å­¦ä¹ ä¸èƒ½ä»…ä»…åœç•™åœ¨çº¸é¢ä¸Šæˆ–è€…ç†è®ºï¼Œè„±ç¦»ä½¿ç”¨å»æ¢è®¨è®¾è®¡æˆ–è€…æºç éƒ½æ˜¯ä¸åˆ‡å®é™…çš„ã€‚å› æ­¤ä»Šå¤©ä¸€èµ·ä½“éªŒäº†ä¸€æŠŠPulsar IOï¼Œé™¤æ­¤ä¹‹å¤–Pulsarè¿˜æä¾›äº†éå¸¸ä¸°å¯Œçš„è·Ÿå…¶ä»–ç³»ç»Ÿäº¤äº’çš„Connectorï¼Œè¯¦ç»†å¯ä»¥çœ‹ä¸Šé¢å‘çš„ä¸‹è½½åœ°å€å¹¶å°è¯•ä½¿ç”¨è‡ªå·±æ„Ÿå…´è¶£çš„Connectoræ„Ÿå—ä¸‹å®æ“çš„å¿«ä¹ï½\n","date":"2024-09-20T10:34:55+08:00","image":"https://sherlock-lin.github.io/p/pulsario%E5%AE%9E%E6%88%98/image-20240313191618099_hu9489298534787853151.png","permalink":"https://sherlock-lin.github.io/p/pulsario%E5%AE%9E%E6%88%98/","title":"PulsarIOå®æˆ˜"},{"content":"å¼•è¨€ ä»Šå¤©ä¸€èµ·æ¥çœ‹çœ‹PulsaræœåŠ¡ç«¯æ¶ˆæ¯ç›¸å…³æœ€é‡è¦çš„ä¸€ä¸ªç±»PersistentTopicï¼Œçœ‹çœ‹å®ƒéƒ½è´Ÿè´£å“ªäº›äº‹æƒ…ä»¥åŠæ˜¯å¦‚ä½•è®¾è®¡çš„\næ­£æ–‡ åœ¨Topicè¢«åˆ›å»ºæ—¶ï¼ŒPulsaré›†ç¾¤ä¸­ä¼šæœ‰ä¸€å°Brokerç»´æŠ¤è¿™ä¸ªTopicï¼Œåœ¨å®ç°ä¸Šå°±æ˜¯ç»´æŠ¤ä¸€ä¸ªPersistentTopicå¯¹è±¡ï¼Œè¿™ä¸ªPersistentTopicå¯¹è±¡å¤„ç†é’ˆå¯¹è¯¥Topicç›¸å…³çš„ä¸€åˆ‡æ“ä½œï¼Œå…·ä½“è´Ÿè´£çš„ç›¸å…³æ“ä½œå¦‚ä¸‹\nå¤„ç†è®¢é˜…ä»¥åŠä¸‹çº¿è®¢é˜… æ–°å¢ç”Ÿäº§è€…å¯¹è±¡ä»¥åŠä¸‹çº¿ç”Ÿäº§è€…å¯¹è±¡ å¤„ç†æ¶ˆæ¯å†™å…¥ è¿›è¡Œè·¨é›†ç¾¤å¤åˆ¶ è®°å½•Topicåº¦é‡çŠ¶æ€ä»¥åŠåšTopicé™æµ æ£€æŸ¥æ¶ˆæ¯çš„TTLã€ç§¯å‹ã€å‹ç¼©ã€é…ç½®ç­–ç•¥æ›´æ–° ç»˜æˆè¡¨æ ¼çš„å½¢å¼å¦‚ä¸‹å›¾\næœ¬ç¯‡æ–‡ç« ä¸ä¼šæ·±å…¥è®²è§£æ¯ä¸€é¡¹ï¼Œä¸»è¦æ˜¯å¤§æ¦‚è¿‡ä¸‹è¿™ä¸ªç±»éƒ½åšäº†å“ªäº›äº‹æƒ…ä»¥åŠå¤§è‡´é€»è¾‘ï¼Œå› ä¸ºæœåŠ¡ç«¯çš„ä»£ç ä¼šç»å¸¸è·Ÿè¿™ä¸ªç±»æ‰“äº¤é“ï¼Œå› æ­¤ä¸“é—¨å¼„æ¸…æ¥šè¿™ä¸ªç±»çš„ç›¸å…³çŸ¥è¯†è¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚æ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬å¸¦ç€ä»¥ä¸‹ä¸‰ä¸ªç–‘é—®å»çœ‹ä¸‹é¢çš„å†…å®¹\nPersistentTopicåœ¨ä»€ä¹ˆæ—¶å€™ä¼šè¢«åˆ›å»ºï¼Ÿéƒ½æœ‰å“ªäº›é‡è¦çš„æˆå‘˜å˜é‡ï¼Ÿ PersistentTopicçš„åˆ›å»ºæµç¨‹éƒ½ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ ä¸Šé¢é‚£äº›ç›¸å…³æ“ä½œå¤§æ¦‚æ˜¯ä»€ä¹ˆå®ç°çš„ï¼Ÿ ä¸€ã€ä½•æ—¶åˆ›å»º ä»¥ä¸‹åˆ—å‡ºåˆ›å»ºçš„æ—¶æœºï¼ŒåŸºæœ¬ä¸Šæµç¨‹éƒ½æ˜¯å‘èµ·åˆ›å»ºTopicçš„æ—¶å€™ä¼šé€šè¿‡ä¸€è‡´æ€§å“ˆå¸Œè®¡ç®—å‡ºè¿™ä¸ªTopicæ‰€å½’å±çš„Bundleï¼Œç„¶åå»zookeeperè·å–è¿™ä¸ªBundleæ‰€å½’å±çš„Brokeræœºå™¨ï¼Œæœ€åè¯·æ±‚è¿™å°BrokerèŠ‚ç‚¹åˆ›å»ºå¯¹åº”çš„PersistentTopicå¯¹è±¡\nç®¡ç†æµåˆ›å»º cliç®¡ç†å‘½ä»¤è¡Œ å¤šè¯­è¨€Client Httpæ–¹å¼ å†™å…¥æµåˆ›å»º ç”Ÿäº§è€…å†™å…¥æµ æ¶ˆè´¹è€…å†™å…¥æµ æ¥ä¸‹æ¥çœ‹çœ‹è¿™ä¸ªç±»çš„ä¸»è¦æˆå‘˜å˜é‡ï¼Œé‡è¦çš„ä¸€äº›å·²ç»åŠ ä¸Šæ³¨é‡Šè§£é‡Šäº†\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 public class PersistentTopic extends AbstractTopic implements Topic, AddEntryCallback { // ç®¡ç†Bookkeeperçš„Ledgerï¼Œåœ¨åšæ¶ˆæ¯è¯»å–æˆ–è€…å†™å…¥æ—¶ä¼šé€šè¿‡è¯¥å¯¹è±¡ protected final ManagedLedger ledger; // å­˜å‚¨è®¢é˜…å½“å‰Topicçš„æ‰€æœ‰è®¢é˜…å¯¹è±¡ï¼Œkeyæ˜¯è®¢é˜…åï¼Œvalueæ˜¯è®¢é˜…å¯¹è±¡ private final ConcurrentOpenHashMap\u0026lt;String, PersistentSubscription\u0026gt; subscriptions; // ç®¡ç†å¯¹ç«¯é›†ç¾¤ï¼Œè´Ÿè´£åšè·¨é›†ç¾¤æ•°æ®å¤åˆ¶ private final ConcurrentOpenHashMap\u0026lt;String/*RemoteCluster*/, Replicator\u0026gt; replicators; //è·Ÿreplicatorsç±»ä¼¼ private final ConcurrentOpenHashMap\u0026lt;String/*ShadowTopic*/, Replicator\u0026gt; shadowReplicators; @Getter private volatile List\u0026lt;String\u0026gt; shadowTopics; private final TopicName shadowSourceTopic; //è°ƒåº¦é™æµå™¨ private Optional\u0026lt;DispatchRateLimiter\u0026gt; dispatchRateLimiter = Optional.empty(); //è°ƒåº¦é™æµé” private final Object dispatchRateLimiterLock = new Object(); //è®¢é˜…é™æµå™¨ private Optional\u0026lt;SubscribeRateLimiter\u0026gt; subscribeRateLimiter = Optional.empty(); //ç§¯å‹æ¸¸æ ‡é˜ˆå€¼æ¡æ•° private final long backloggedCursorThresholdEntries; public static final int MESSAGE_RATE_BACKOFF_MS = 1000; //å¤„ç†æ¶ˆæ¯é‡å¤æƒ…å†µ protected final MessageDeduplication messageDeduplication; //å¤„ç†æ¶ˆæ¯å‹ç¼©æœåŠ¡ private TopicCompactionService topicCompactionService; // åœ¨å¯¹å¤–å¼€æ”¾å‹ç¼©ç­–ç•¥é…ç½®æ—¶ï¼Œæ ¹æ®ç”¨æˆ·é…ç½®åˆ›å»ºå¯¹åº”çš„å‹ç¼©ç­–ç•¥ private static Map\u0026lt;String, TopicCompactionStrategy\u0026gt; strategicCompactionMap = Map.of( ServiceUnitStateChannelImpl.TOPIC, new ServiceUnitStateCompactionStrategy()); //æœªçŸ¥ private CompletableFuture\u0026lt;MessageIdImpl\u0026gt; currentOffload = CompletableFuture.completedFuture( (MessageIdImpl) MessageId.earliest); //è´Ÿè´£è·¨é›†ç¾¤å¤åˆ¶æ—¶è®¢é˜…ç›¸å…³äº‹é¡¹ private volatile Optional\u0026lt;ReplicatedSubscriptionsController\u0026gt; replicatedSubscriptionsController = Optional.empty(); //è®°å½•Topicåº¦é‡ç›¸å…³ä¿¡æ¯ï¼Œå¦‚è¿™ä¸ªTopicçš„å†™å…¥é€Ÿç‡ã€æ¶ˆè´¹é€Ÿç‡ç­‰ private static final FastThreadLocal\u0026lt;TopicStatsHelper\u0026gt; threadLocalTopicStats = new FastThreadLocal\u0026lt;TopicStatsHelper\u0026gt;() { @Override protected TopicStatsHelper initialValue() { return new TopicStatsHelper(); } }; } äºŒã€åˆ›å»ºæµç¨‹ åˆ›å»ºæµç¨‹ä¸»è¦åˆ†ä¸ºæ„å»ºå’Œåˆå§‹åŒ–ä¸¤ä¸ªé˜¶æ®µï¼Œä¸€èˆ¬æ˜¯å…ˆé€šè¿‡æ„é€ å‡½æ•°åˆ›å»ºPersistentTopicï¼Œåˆ›å»ºå¥½ååœ¨è°ƒç”¨å…¶initializeæ–¹æ³•è¿›è¡Œåˆå§‹åŒ–\n1. æ„é€ å‡½æ•° æ„é€ å‡½æ•°ä¸»è¦åšä¸‰ä»¶äº‹ï¼š1. æ›´æ–°Brokerçº§åˆ«ç­–ç•¥ 2. åˆ›å»ºå‘å¸ƒé™æµ 3. åˆå§‹åŒ–å®¹å™¨ã€‚å…·ä½“ä»£ç å®ç°å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 public AbstractTopic(String topic, BrokerService brokerService) { //åŸºæœ¬éƒ½æ˜¯èµ‹å€¼æ“ä½œ this.topic = topic; this.brokerService = brokerService; this.producers = new ConcurrentHashMap\u0026lt;\u0026gt;(); this.isFenced = false; ServiceConfiguration config = brokerService.pulsar().getConfiguration(); this.replicatorPrefix = config.getReplicatorPrefix(); topicPolicies = new HierarchyTopicPolicies(); updateTopicPolicyByBrokerConfig(); this.lastActive = System.nanoTime(); this.preciseTopicPublishRateLimitingEnable = config.isPreciseTopicPublishRateLimiterEnable(); //åˆ›å»ºå‘å¸ƒé™æµ topicPublishRateLimiter = new PublishRateLimiterImpl(brokerService.getPulsar().getMonotonicSnapshotClock()); //æ›´æ–°é™æµç­–ç•¥ updateActiveRateLimiters(); } public PersistentTopic(String topic, ManagedLedger ledger, BrokerService brokerService) { super(topic, brokerService); //èµ‹å€¼æ“ä½œ this.orderedExecutor = brokerService.getTopicOrderedExecutor() != null ? brokerService.getTopicOrderedExecutor().chooseThread(topic) : null; this.ledger = ledger; //åˆå§‹åŒ–å®¹å™¨ï¼Œåˆ†åˆ«æ˜¯ç»´æŠ¤å½“å‰Topicçš„è®¢é˜…æƒ…å†µã€è·¨é›†ç¾¤å‰¯æœ¬æƒ…å†µ this.subscriptions = ConcurrentOpenHashMap.\u0026lt;String, PersistentSubscription\u0026gt;newBuilder() .expectedItems(16) .concurrencyLevel(1) .build(); this.replicators = ConcurrentOpenHashMap.\u0026lt;String, Replicator\u0026gt;newBuilder() .expectedItems(16) .concurrencyLevel(1) .build(); this.shadowReplicators = ConcurrentOpenHashMap.\u0026lt;String, Replicator\u0026gt;newBuilder() .expectedItems(16) .concurrencyLevel(1) .build(); this.backloggedCursorThresholdEntries = brokerService.pulsar().getConfiguration().getManagedLedgerCursorBackloggedThreshold(); .... } 2. initializeæ–¹æ³• åˆå§‹åŒ–æ–¹æ³•çš„é€»è¾‘ç›¸æ¯”ä¸‹è¦ä¸°å¯Œå†™ï¼Œå½’çº³èµ·æ¥æœ‰ä»¥ä¸‹å››ç‚¹\nè·å–å‹ç¼©æœåŠ¡\né€šè¿‡åŒé‡åˆ¤æ–­è·å–å•ä¾‹TwoPhaseCompactorè¿›è¡Œå‹ç¼©ï¼Œæœ‰ä¸“é—¨çš„çº¿ç¨‹æ± è¿›è¡Œå¤„ç†å‹ç¼©åŠ¨ä½œ\néå†æ¸¸æ ‡æ¢å¤è®¢é˜…çš„çŠ¶æ€\nå½“Topicé‡æ–°åˆ†é…åï¼Œåœ¨æ–°çš„Brokerä¸­è¦æ ¹æ®æ¸¸æ ‡æ¢å¤è®¢é˜…ã€è·¨é›†ç¾¤å¤åˆ¶çš„çŠ¶æ€ï¼Œè¿™æ ·æ‰èƒ½è®©å®¢æˆ·ç«¯â€œæ— æ„Ÿâ€\nè·¨é›†ç¾¤å¤åˆ¶\néå†è¿™ä¸ªTopicçš„æ¸¸æ ‡ï¼Œå¦‚æœæ¸¸æ ‡ä¸­å­˜åœ¨è·¨é›†ç¾¤å¤åˆ¶æ¸¸æ ‡åˆ™åˆ›å»ºå¯¹åº”çš„GeoPersistentReplicatorå¯¹è±¡è¿›è¡Œæ¶ˆæ¯çš„å¤åˆ¶\næ›´æ–°é…ç½®\næ›´æ–°Topicå‘½åç©ºé—´çš„é…ç½®ç­–ç•¥ åˆå§‹åŒ–è°ƒåº¦é™æµDispatchRateLimiter æ›´æ–°è®¢é˜…/å‘å¸ƒ/èµ„æºç»„é™æµ æ›´æ–°Topicçº§åˆ«çš„é…ç½® å…·ä½“ä»£ç å®ç°å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 public CompletableFuture\u0026lt;Void\u0026gt; initialize() { List\u0026lt;CompletableFuture\u0026lt;Void\u0026gt;\u0026gt; futures = new ArrayList\u0026lt;\u0026gt;(); //è·å–Brokerå‹ç¼©å¯¹è±¡ futures.add(brokerService.getPulsar().newTopicCompactionService(topic) .thenAccept(service -\u0026gt; { PersistentTopic.this.topicCompactionService = service; //éå†è¿™ä¸ªTopicçš„æ¸¸æ ‡æ¢å¤è®¢é˜…ä¸­çš„å¯¹è±¡ this.createPersistentSubscriptions(); })); //éå†è¿™ä¸ªTopicçš„æ¸¸æ ‡ï¼Œå¦‚æœæ¸¸æ ‡ä¸­å­˜åœ¨è·¨é›†ç¾¤å¤åˆ¶æ¸¸æ ‡åˆ™åˆ›å»ºå¯¹åº”çš„GeoPersistentReplicatorå¯¹è±¡è¿›è¡Œæ¶ˆæ¯çš„å¤åˆ¶ for (ManagedCursor cursor : ledger.getCursors()) { if (cursor.getName().startsWith(replicatorPrefix)) { String localCluster = brokerService.pulsar().getConfiguration().getClusterName(); String remoteCluster = PersistentReplicator.getRemoteCluster(cursor.getName()); futures.add(addReplicationCluster(remoteCluster, cursor, localCluster)); } } return FutureUtil.waitForAll(futures).thenCompose(__ -\u0026gt; brokerService.pulsar().getPulsarResources().getNamespaceResources() .getPoliciesAsync(TopicName.get(topic).getNamespaceObject()) .thenAcceptAsync(optPolicies -\u0026gt; { if (!optPolicies.isPresent()) { isEncryptionRequired = false; updatePublishDispatcher(); //è¿›è¡Œèµ„æºç»„çº§åˆ«çš„éš”ç¦» updateResourceGroupLimiter(new Policies()); initializeDispatchRateLimiterIfNeeded(); updateSubscribeRateLimiter(); return; } Policies policies = optPolicies.get(); //æ›´æ–°å‘½åç©ºé—´çº§åˆ«çš„ç­–ç•¥ this.updateTopicPolicyByNamespacePolicy(policies); //åˆå§‹åŒ–è°ƒåº¦é™æµ initializeDispatchRateLimiterIfNeeded(); //æ›´æ–°è®¢é˜…é™æµ updateSubscribeRateLimiter(); //æ›´æ–°å‘å¸ƒé™æµ updatePublishDispatcher(); //æ›´æ–°èµ„æºç»„é™æµ updateResourceGroupLimiter(policies); this.isEncryptionRequired = policies.encryption_required; isAllowAutoUpdateSchema = policies.is_allow_auto_update_schema; }, getOrderedExecutor()) .thenCompose(ignore -\u0026gt; initTopicPolicy()) .exceptionally(ex -\u0026gt; { .... })); } ä¸‰ã€è´Ÿè´£å†…å®¹ 1ã€ç”Ÿäº§è€…ç›¸å…³ æ–°å¢ ç”Ÿäº§è€…å®¢æˆ·ç«¯å¯åŠ¨æ—¶ä¼šè·ŸTopicå½’å±çš„Brokerå»ºç«‹TCPè¿æ¥å¹¶è¯·æ±‚Brokerç«¯ServerCnxçš„handleProduceræ–¹æ³•è¿›è¡Œå¤„ç†ï¼Œè¿™ä¸ªæ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨PersistentTopicçš„addProduceræ–¹æ³•è¿›è¡Œåˆ›å»ºï¼Œå’±ä»¬æ¥çœ‹çœ‹å®ç°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 public CompletableFuture\u0026lt;Optional\u0026lt;Long\u0026gt;\u0026gt; addProducer(Producer producer, CompletableFuture\u0026lt;Void\u0026gt; producerQueuedFuture) { //è¿›å»çœ‹çœ‹çˆ¶ç±»çš„å®ç° return super.addProducer(producer, producerQueuedFuture).thenCompose(topicEpoch -\u0026gt; { messageDeduplication.producerAdded(producer.getProducerName()); // Start replication producers if not already return startReplProducers().thenApply(__ -\u0026gt; topicEpoch); }); } public CompletableFuture\u0026lt;Optional\u0026lt;Long\u0026gt;\u0026gt; addProducer(Producer producer, CompletableFuture\u0026lt;Void\u0026gt; producerQueuedFuture) { .... //ç»§ç»­è·Ÿè¸ª return internalAddProducer(producer); .... } protected CompletableFuture\u0026lt;Void\u0026gt; internalAddProducer(Producer producer) { .... //producersæ˜¯ConcurrentHashMapç»“æ„ï¼Œç›¸å½“äºä¼šåœ¨PersistentTopicä¸­ç»´æŠ¤æœåŠ¡ç«¯çš„ç”Ÿäº§è€…å¯¹è±¡ Producer existProducer = producers.putIfAbsent(producer.getProducerName(), producer); .... return CompletableFuture.completedFuture(null); } åˆ é™¤ åˆ é™¤çš„é€»è¾‘å¾ˆç®€å•ï¼Œä¹Ÿæ˜¯é€šè¿‡TCPæ¥æ”¶åˆ°å®¢æˆ·ç«¯æ–­å¼€è¿æ¥çš„è¯·æ±‚åï¼Œä¼šè°ƒç”¨Producerçš„closeæ–¹æ³•è¿›è¡Œèµ„æºé‡Šæ”¾ï¼ŒåŒæ—¶ä»ç»´æŠ¤çš„producersä¸­ç§»é™¤æ­¤å¯¹è±¡\n2. è®¢é˜…ç›¸å…³ æ¶ˆè´¹è€…å®¢æˆ·ç«¯å¯åŠ¨æ—¶ä¼šè·ŸTopicå½’å±çš„Brokerå»ºç«‹TCPè¿æ¥å¹¶è¯·æ±‚Brokerç«¯ï¼Œè¯·æ±‚ç”±ServerCnxçš„handleSubscribeæ–¹æ³•è¿›è¡Œå¤„ç†ï¼Œè¿™ä¸ªæ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨PersistentTopicçš„internalSubscribeæ–¹æ³•è¿›è¡Œåˆ›å»ºï¼Œå’±ä»¬æ¥çœ‹çœ‹å®ç°\næ–°å¢ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 private CompletableFuture\u0026lt;Consumer\u0026gt; internalSubscribe(final TransportCnx cnx, String subscriptionName, long consumerId, SubType subType, int priorityLevel, String consumerName, boolean isDurable, MessageId startMessageId, Map\u0026lt;String, String\u0026gt; metadata, boolean readCompacted, InitialPosition initialPosition, long startMessageRollbackDurationSec, boolean replicatedSubscriptionStateArg, KeySharedMeta keySharedMeta, Map\u0026lt;String, String\u0026gt; subscriptionProperties, long consumerEpoch, SchemaType schemaType) { .... //åˆ›å»ºå¯¹åº”çš„å®¢æˆ·ç«¯å¯¹è±¡ Consumer consumer = new Consumer(subscription, subType, topic, consumerId, priorityLevel, consumerName, isDurable, cnx, cnx.getAuthRole(), metadata, readCompacted, keySharedMeta, startMessageId, consumerEpoch, schemaType); .... //å°†æ¶ˆè´¹è€…å¯¹è±¡åŠ åˆ°è®¢é˜…é‡Œ return addConsumerToSubscription(subscription, consumer); } protected CompletableFuture\u0026lt;Void\u0026gt; addConsumerToSubscription(Subscription subscription, Consumer consumer) { .... //æœ€ç»ˆå°†å°†åˆ›å»ºçš„æ¶ˆè´¹è€…æ”¾åˆ°Dispatcherä¸­è¿›è¡Œç®¡ç†ä»¥åŠåŠ åˆ°subscriptionsè¿™ä¸ªMapä¸­è¿›è¡Œç»´æŠ¤ return subscription.addConsumer(consumer); } åˆ é™¤ åˆ é™¤çš„é€»è¾‘ä¹Ÿæ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå°±æ˜¯ä»subscriptionsä¸­è¿›è¡Œç§»é™¤\n3. å¤„ç†æ¶ˆæ¯å†™å…¥ æ¶ˆæ¯å†™å…¥çš„æµç¨‹ç›¸å¯¹æ¯”è¾ƒå¤æ‚ï¼Œåé¢å†å•ç‹¬åˆ†æï¼Œæš‚æ—¶è·³è¿‡\n4. è·¨é›†ç¾¤å¤åˆ¶ è·¨é›†ç¾¤å¤åˆ¶è¿™é‡Œå®ç°é€»è¾‘å…¶å®ä¸éš¾ï¼Œç›¸å½“äºåœ¨Brokerä¸Šå»è¯»å–Bookkeeperè·å–æ•°æ®å¹¶é€šè¿‡å¯åŠ¨ç”Ÿäº§è€…å¾€å…¶ä»–é›†ç¾¤è¿›è¡Œæ•°æ®å†™å…¥ï¼Œå…·ä½“ç»†èŠ‚åé¢ä¹Ÿå•ç‹¬å†™æ–‡ç« è¿›è¡Œåˆ†æ\n5. æ¶ˆæ¯æ¸…ç† Pulsarçš„æ¶ˆæ¯TTLã€ç§¯å‹ã€å‹ç¼©éƒ½æ˜¯åœ¨Brokerå¯åŠ¨æ—¶å¾€çº¿ç¨‹æ± ä¸­åŠ å…¥å®šæ—¶ä»»åŠ¡è½®è¯¢è§¦å‘çš„\nTTL TTLä¼šå¾ªç¯æ‰«ææ¯ä¸ªTopicè¿‡æœŸçš„æ¶ˆæ¯ä½ç½®ï¼Œå¹¶é€šè¿‡æ”¹å˜æ¸¸æ ‡è¿›è¡Œæ ‡è®°ï¼Œè€Œæ¸…ç†æ˜¯ç”±ä¸“é—¨çš„çº¿ç¨‹æ ¹æ®æ¸¸æ ‡è¿›è¡Œå¤„ç†çš„\nç§¯å‹ æ¶ˆæ¯ç§¯å‹ä¹Ÿæ˜¯ä¼šå®šæœŸæ£€æµ‹ï¼Œåˆ†ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯æ¶ˆæ¯è¶…è¿‡é™åˆ¶é¢åº¦ï¼Œå¦ä¸€ç§æ˜¯æ¶ˆæ¯æ—¶é—´è¶…è¿‡é¢åº¦ã€‚è¿™ä¸¤ç§æƒ…å†µéƒ½ä¼šè§¦å‘ç§¯å‹ç­–ç•¥çš„å¤„ç†ï¼Œå…·ä½“çš„ç­–ç•¥åœ¨BacklogQuota.RetentionPolicyä¸­å®šä¹‰\nå‹ç¼© è·Ÿä¸Šé¢ä¸€æ ·ï¼Œè½®è¯¢æ£€æµ‹è¿›è¡Œå¤„ç†\né…ç½®æ›´æ–° åœ¨PersistentTopicå¯åŠ¨çš„åˆå§‹åŒ–initializeæ–¹æ³•ä¸­ä¼šè°ƒç”¨onUpdateè¿›è¡Œç­–ç•¥æ›´æ–°ï¼Œé‚£Pulsaråˆæ˜¯å¦‚ä½•åšçš„æ”¯æŒé…ç½®åŠ¨æ€æ›´æ–°çš„å‘¢ï¼Ÿè¿™ä¸ªé—®é¢˜ä¿ç•™ç»™å¤§å®¶\nå››ã€æ€»ç»“ æœ¬æ–‡ä¸»è¦å¼ºè°ƒPersistentTopicç±»çš„é‡è¦æ€§ã€èŠèŠå®ƒéƒ½è´Ÿè´£å“ªäº›äº‹æƒ…ä»¥åŠå¤§æ¦‚å®ç°ï¼Œå…·ä½“æ¯ä¸ªç»†èŠ‚å±•å¼€éƒ½èƒ½å•ç‹¬å†™ä¸€ç¯‡æ–‡ç« ï¼Œè¿™ä¸ªæ•¬è¯·æœŸå¾…ï½\n","date":"2024-09-20T10:34:55+08:00","image":"https://sherlock-lin.github.io/image-20240331085922332.png","permalink":"https://sherlock-lin.github.io/p/pulsar%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B9%8Bpersistenttopic%E7%B1%BB/","title":"Pulsaræºç è§£æä¹‹PersistentTopicç±»"},{"content":"ä¸€ã€Pulsarå®¢æˆ·ç«¯ç®€æ pulsaræœåŠ¡æ˜¯ç»å…¸çš„C/Sæ¶æ„ï¼Œç”±å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ„æˆã€‚æœåŠ¡ç«¯æä¾›å¤„ç†è¯»å†™è¯·æ±‚æœåŠ¡ï¼Œå®¢æˆ·ç«¯è´Ÿè´£å‘èµ·è¯»å†™è¯·æ±‚ã€‚pulsarå°†å®¢æˆ·ç«¯æŒ‰ç…§è¯»å†™åˆ†æˆäº†ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œä½†æ˜¯æ— è®ºæ€ä¹ˆåˆ†ï¼Œå®ƒä»¬æœ¬è´¨ä¸Šéƒ½æ˜¯Pulsarå®¢æˆ·ç«¯å¹¶æœ‰å¾ˆå¤šç›¸åŒçš„åœ°æ–¹ï¼Œæœ¬ç¯‡å°±é’ˆå¯¹å®¢æˆ·ç«¯è¿›è¡Œåˆ†æã€‚\nä¸‹å›¾æ˜¯å®¢æˆ·ç«¯çš„ç»„æˆéƒ¨åˆ†\nConnectionPoolè¿æ¥æ± (å€¼å¾—æ·±æŒ–)\nè¿æ¥æ± æ˜¯å®¢æˆ·ç«¯çš„æ ¸å¿ƒï¼Œç»´æŠ¤ç€è·ŸæœåŠ¡ç«¯çš„TCPè¿æ¥ï¼Œå®¢æˆ·ç«¯çš„è¯»å†™(ç”Ÿäº§è€…/æ¶ˆè´¹è€…)éƒ½å¼ºä¾èµ–ç½‘ç»œè¿æ¥ï¼Œå› ä¸ºæœ€åæ•°æ®è¿˜æ˜¯è¦é€šè¿‡åº•å±‚çš„ç½‘ç»œè¿›è¡Œé€šä¿¡\nLookupService\nå…·æœ‰è·¯æœ‰å±æ€§çš„å®¢æˆ·ç«¯è§’è‰²ï¼Œè´Ÿè´£æŸ¥æ‰¾Topicå½’å±çš„BrokerèŠ‚ç‚¹\nçº¿ç¨‹æ± \näº‹ä»¶çº¿ç¨‹æ± \nå¤–éƒ¨çº¿ç¨‹æ± \nå†…éƒ¨çº¿ç¨‹æ± \näºŒã€åˆ›å»ºå®¢æˆ·ç«¯å¯¹è±¡ 1ã€åˆ›å»ºæµç¨‹ å…ˆçœ‹çœ‹ä¸‹é¢ä¸€æ®µä»£ç \nè¿™æ˜¯é€šè¿‡ç”Ÿäº§è€…å†™æ•°æ®åˆ°PulsaræœåŠ¡ç«¯çš„caseï¼Œç›¸ä¿¡å¤§å®¶ä¸ä¼šæ„Ÿåˆ°é™Œç”Ÿï¼Œå…¶ä¸­34è¡Œå°±æ˜¯åˆ›å»ºå®¢æˆ·ç«¯çš„é€»è¾‘ï¼Œå› æ­¤å°±ä»è¿™é‡Œè¿›è¡Œè·Ÿè¸ª\né€šè¿‡è·Ÿè¸ªPulsarClient.builderæ–¹æ³•å¯ä»¥çœ‹åˆ°è¿™æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°è¿”å›å€¼æ˜¯ClientBuilderå¯¹è±¡ï¼Œå…·ä½“å®ç°é€»è¾‘å’±ä»¬å…ˆä¸å…³å¿ƒï¼Œå’±ä»¬åªéœ€è¦çŸ¥é“è¿™ä¸ªæ–¹æ³•ä¼šåˆ›å»ºä¸€ä¸ªClientBuilderå°±å¤Ÿäº†ï¼Œç»“åˆä¹‹å‰çš„åˆ›å»ºçš„é€»è¾‘å¯ä»¥çŸ¥é“æœ€ç»ˆä¼šèµ°åˆ°ClientBuilder#buildæ–¹æ³•\nbuildæ–¹æ³•ä¸­æ ¸å¿ƒå°±æ˜¯50è¡Œçš„é€šè¿‡PulsarClientImplæ„é€ å‡½æ•°åˆ›å»ºå®¢æˆ·ç«¯å¯¹è±¡ï¼Œå…¶ä»–çš„éƒ½æ˜¯ä¸€äº›é…ç½®æ ¡éªŒå·¥ä½œã€‚ä¸‹é¢å°±ç›´æ¥è¿›å…¥PulsarClientImplçš„æ„é€ å‡½æ•°è¿›è¡Œåˆ†æ\nè¿™ä¸ªæ„é€ æ–¹æ³•è™½ç„¶é€»è¾‘ä¸å°‘ï¼Œä½†å®é™…ä¸Šé‡è¦çš„å°±æ˜¯201è¡Œçš„åˆå§‹åŒ–\nä¸‰ã€åˆ›å»ºç½‘ç»œè¿æ¥æ±  1. åˆå§‹åŒ– è¿™é‡Œçš„ClientCnxå¯¹è±¡éå¸¸é‡è¦ï¼Œåé¢å†ç»†è®²ã€‚ç°åœ¨å…ˆç»§ç»­è·Ÿè¸ªæ„é€ å‡½æ•°çš„é€»è¾‘\nè¿™é‡Œåˆå§‹åŒ–äº†Nettyå®¢æˆ·ç«¯ï¼Œåœ¨è·Ÿå¤–éƒ¨åˆ›å»ºç½‘ç»œè¿æ¥æ—¶ç›´æ¥é€šè¿‡Nettyå®¢æˆ·ç«¯è¿›è¡Œå³å¯ã€‚å®¢æˆ·ç«¯åˆå§‹åŒ–é˜¶æ®µï¼Œç½‘ç»œè¿æ¥æ± åŸºæœ¬ä¸Šå°±åšäº†è¿™äº›äº‹ï¼Œé‚£ä¹ˆå®ƒæ˜¯æ€ä¹ˆå·¥ä½œçš„å‘¢ï¼Œè®©æˆ‘ä»¬æ¥å¾€ä¸‹çœ‹\n2. å·¥ä½œæµç¨‹ åœ¨åˆ›å»ºç”Ÿäº§è€…å¯¹è±¡æ—¶ï¼Œä¼šèµ°åˆ°PulsarClientImpl#getConnectionè¿™ä¸ªæ–¹æ³•ï¼Œä»è¿™é‡Œå¼€å§‹è¿›è¡Œåˆ†æ\næ­¤æ–¹æ³•ç¬¬ä¸€è¡Œæ˜¯é€šè¿‡LookupæœåŠ¡æŸ¥æ‰¾Topicå½’å±çš„BrokerèŠ‚ç‚¹ä¿¡æ¯ï¼ŒLookupç›¸å…³çš„æ„Ÿå…´è¶£çš„å¯ä»¥çœ‹ Apache Pulsaræºç è§£æä¹‹Lookupæœºåˆ¶ è¿™ç¯‡æ–‡ç« ï¼Œåœ¨969è¡Œä¼šå°†LookupæŸ¥åˆ°çš„Brokeråœ°å€è¿›è¡Œåˆ›å»ºç½‘ç»œè¿æ¥\nå¯ä»¥çœ‹åˆ°è·å–ç½‘ç»œè¿æ¥æ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨ConnectionPoolç±»çš„æ–¹æ³•è¿›è¡Œè·å–\nè¿™é‡Œä¼šæ ¹æ®å‚æ•°randomKey(Broker IPåœ°å€)è¿›è¡Œç½‘ç»œè¿æ¥çš„å¤ç”¨ï¼Œå¦‚æœè¿˜æ²¡åˆ›å»ºçš„è¯åˆ™è¿›è¡Œåˆ›å»ºï¼ŒåŒæ—¶æ£€æŸ¥æ¸…ç†ä¸å¯ç”¨çš„ç½‘ç»œè¿æ¥è¿›è¡Œé‡Šæ”¾\nè°ƒç”¨createConnectionæ–¹æ³•è¿›è¡Œè¿æ¥åˆ›å»ºï¼ŒåŒæ—¶ä¹Ÿåœ¨é€šé“åˆ›å»ºé€šé“æˆåŠŸåç»‘å®šç›‘å¬å™¨ï¼Œåœ¨é€šé“è¢«å…³é—­æ—¶ä¸€èµ·å…³é—­å½“å‰çš„ç½‘ç»œè¿æ¥ã€‚\nå°†unresolvedPhysicalAddressè§£æå‡ºæ­£ç¡®çš„åœ°å€ï¼Œç°åœ¨è¿˜ä¸å¤ªæ¸…æ¥šå·²ç»æœ‰äº†logicalAddress(ç›®æ ‡Brokeråœ°å€)ï¼Œè¿˜è§£æè¿™ä¸ªçš„ç”¨é€”æ˜¯ä»€ä¹ˆ\nè°ƒç”¨connectToAddressæ–¹æ³•åˆ›å»ºç½‘ç»œè¿æ¥ï¼Œå¦‚æœå‡ºç°å¼‚å¸¸æ—¶ï¼Œå¦‚æœæœåŠ¡ç«¯åœ¨Lookupé˜¶æ®µè¿”å›ä¸æ­¢ä¸€ä¸ªåœ°å€ï¼Œé‚£ä¹ˆå°±å°è¯•è·Ÿä¸‹ä¸€ä¸ªåœ°å€åˆ›å»ºç½‘ç»œè¿æ¥\nè¿™é‡Œåº”è¯¥å°±å¾ˆç†Ÿæ‚‰äº†ï¼Œå°±æ˜¯é€šè¿‡Nettyå®¢æˆ·ç«¯åˆ›å»ºè·Ÿç›®æ ‡BrokerèŠ‚ç‚¹çš„TCPè¿æ¥ã€‚\n3. å°ç»“ è¿æ¥æ± æ˜¯ä¸€ä¸ªConcurrentHashMapï¼Œkeyæ˜¯IP+ç«¯å£ï¼Œvalueæ˜¯ClientCnxæ¥ç¼“å­˜è¿™äº›è¿æ¥ã€‚ClientCnxé™¤äº†ç®¡ç†è¿æ¥è¿˜ç®¡ç†æ‰€æœ‰çš„ä¸šåŠ¡å‘½ä»¤ï¼Œä¾‹å¦‚å‘é€æ¶ˆæ¯æ˜¯Sendå‘½ä»¤ï¼ŒæœåŠ¡ç«¯ä¼šå¯¹åº”ä¸€ä¸ªhandleSendæ–¹æ³•æ¥å¤„ç†è¿™ä¸ªå‘½ä»¤ã€‚\nè¿æ¥æ± æ˜¯å®¢æˆ·ç«¯æœ€é‡è¦çš„å†…å®¹ï¼Œæ— è®ºæ˜¯ç”Ÿäº§è€…è¿˜æ˜¯æ¶ˆè´¹è€…åœ¨åˆ›å»ºçš„æ—¶å€™ï¼Œéƒ½ä¼šå»è¿æ¥æ± è·å–/åˆ›å»ºè·ŸBrokerçš„ç½‘ç»œè¿æ¥ï¼Œåç»­çš„æ•°æ®è¯»å†™æœ¬è´¨ä¸Šéƒ½æ˜¯é€šè¿‡Nettyçš„channelè¿›è¡Œçš„ï¼Œå› æ­¤å¯è§å®ƒæ˜¯ç›¸å½“é‡è¦çš„ã€‚è¿æ¥æ± çš„è®¾è®¡å°†ç½‘ç»œè¿æ¥è·Ÿå…¶ä»–è¯»å†™åŠŸèƒ½å‰¥ç¦»å¼€æ¥è¾¾åˆ°èŒè´£åˆ†ç¦»çš„æ•ˆæœï¼ŒåŒæ—¶é€šè¿‡æ± åŒ–æ¦‚å¿µï¼Œåœ¨å¤šä¸ªç”Ÿäº§è€…/æ¶ˆè´¹è€…æƒ…å†µä¸‹ä¸ä»…èŠ‚çº¦äº†ç½‘ç»œè¿æ¥çš„åˆ›å»ºï¼ŒåŒæ—¶è¿˜æå‡ç½‘ç»œè¿æ¥åˆ›å»ºçš„æ€§èƒ½(å¤ç”¨æ€è·¯)ã€‚\nå››ã€å…¶ä»–åŠŸèƒ½ 1. LookupService Lookupæœºåˆ¶å·¥ä½œé€»è¾‘åœ¨ Apache Pulsaræºç è§£æä¹‹Lookupæœºåˆ¶ è¿™ç¯‡æ–‡ç« å·²ç»è¯´æ˜äº†ï¼Œè¿™é‡Œä¸»è¦ä¸€èµ·çœ‹çœ‹å®ƒçš„åˆ›å»ºé€»è¾‘ã€‚åœ¨PulsarClientImplæ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬èƒ½çœ‹åˆ°ä»¥ä¸‹ä»£ç \nPulsaræ”¯æŒä¸¤ç§Lookupå®ç°ï¼Œä¸€ç§æ˜¯é€šè¿‡httpåè®®å»è·ŸæœåŠ¡ç«¯é€šä¿¡ï¼Œå¦ä¸€ç§æ˜¯é€šè¿‡äºŒè¿›åˆ¶æ–¹å¼æŸ¥è¯¢(æ€§èƒ½æ›´å¥½)ã€‚æœ¬æ¬¡å°±è·Ÿç€æ¯”è¾ƒå¸¸è§çš„httpæ–¹å¼è¿›è¡Œåˆ†æ\né€šè¿‡æ„é€ å‡½æ•°å¯ä»¥çœ‹åˆ°æ˜¯é€šè¿‡åˆ›å»ºHttpClientå¯¹è±¡è¿›è¡Œçš„ï¼Œè¿™é‡Œæˆ‘ä¸€å¼€å§‹ä»¥ä¸ºæ˜¯ç”¨çš„å¼€æºçš„HttpClientå°±æ²¡ç»§ç»­è·Ÿï¼Œåæ¥åœ¨è°ƒè¯•çš„æ—¶å€™è·Ÿè¿›å»æ‰å‘ç°ï¼Œè¿™æ˜¯Pulsar è‡ªå®šä¹‰å¯¹è±¡\nè·Ÿè¸ªè¿›å»çœ‹ï¼Œå…¶ä»–éƒ½æ˜¯èµ‹å€¼ã€å®‰å…¨æ£€æŸ¥çš„å·¥ä½œï¼Œæ ¸å¿ƒåœ¨161è¡Œçš„httpClientåˆ›å»ºã€‚ è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯åˆ›å»ºçš„AsyncHttpClientå¯¹è±¡ï¼Œè¿™æ˜¯ä¸€ä¸ªå°è£…Nettyçš„async-http-client-2.12.1.jarçš„å¤–éƒ¨åŒ…ï¼Œè¿™æ˜¯æ”¯æŒå¼‚æ­¥å¤„ç†çš„é«˜æ€§èƒ½HTTPå·¥å…·åŒ…\n2. MemoryLimitController ç”±äºMemoryLimitControllerçš„å†…å®¹ä¸å¤šï¼Œå°±çœ‹çœ‹å®ƒçš„åˆ›å»ºä»¥åŠå·¥ä½œæµç¨‹\nåœ¨PulsarClientImplçš„æ„é€ å‡½æ•°ä¸­å¯ä»¥çœ‹åˆ°ä¼šè°ƒç”¨MemoryLimitControlleræ„é€ å‡½æ•°è¿›è¡Œåˆ›é€ ï¼Œä»è¿™é‡Œè¿›å»åˆ†æ\næ„é€ é€»è¾‘å¾ˆç®€å•ï¼Œå°±åªæœ‰èµ‹å€¼æ“ä½œï¼Œåˆ°è¿™é‡Œå°±æˆåŠŸåˆ›å»ºMemoryLimitControllerå¯¹è±¡äº†ï¼Œé‚£å°±å†çœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆå·¥ä½œçš„å§ã€‚MemoryLimitControllerçš„æ ¸å¿ƒå·¥ä½œé€»è¾‘æ˜¯checkTriggeræ–¹æ³•\nè¿™é‡Œä¼šè°ƒç”¨triggerçš„runæ–¹æ³•ï¼Œè¿™ä¸ªtriggerçš„é€»è¾‘å…¶å®å°±æ˜¯åˆ›å»ºMemoryLimitControllerçš„æ„é€ æ–¹æ³•ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„reduceConsumerReceiverQueueSizeæ–¹æ³•ï¼Œé‚£ä¹ˆç»§ç»­è·Ÿè¸ª\nå¾ªç¯è°ƒç”¨æ‰€æœ‰çš„æ¶ˆè´¹è€…çš„reduceCurrentReceiverQueueSizeæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´MemoryLimitControllerç›®å‰åªèƒ½é™åˆ¶æ¶ˆè´¹è€…çš„å†…å­˜ã€‚\nè¿™é‡Œçš„é™åˆ¶é€»è¾‘ç›¸å½“äºå°†æ‰€æœ‰æ¶ˆè´¹è€…çš„æ¥æ”¶é˜Ÿåˆ—çš„å®¹é‡å‡åŠï¼Œé¿å…é˜Ÿåˆ—ä¸­çš„æ•°æ®å ç”¨è¿‡å¤šå†…å­˜ã€‚ç”±æ­¤å¯è§MemoryLimitControllerç›®å‰åšçš„è¿˜æ˜¯æ¯”è¾ƒå°èŒƒå›´çš„å†…å­˜æ§åˆ¶ï¼Œå¹¶ä¸”æ•´ä½“é€»è¾‘å¹¶ä¸å¤æ‚ã€‚\n3. çº¿ç¨‹æ±  å®¢æˆ·ç«¯å¯¹è±¡åˆå§‹åŒ–æ—¶å€™ï¼Œä¼šåˆ›å»ºä¸‰ä¸ªçº¿ç¨‹æ± ï¼Œç°åœ¨å°±æ¥åˆ†æä¸‹å®ƒä»¬çš„ç”¨é€”\né¦–å…ˆæ˜¯externalExecutorProviderçº¿ç¨‹æ± é€šè¿‡æŸ¥çœ‹è°ƒç”¨çš„æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯è¢«æ¶ˆè´¹è€…ä½¿ç”¨ï¼Œé‡Œé¢çš„å·¥ä½œçº¿ç¨‹ä¸»è¦æ˜¯ç”¨äºæ¶ˆè´¹æœåŠ¡ç«¯çš„æ¶ˆæ¯\nå†æ¥çœ‹çœ‹internalExecutorProviderçº¿ç¨‹æ± ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯ç”¨æ¥æ˜¯ä¸€äº›è·Ÿåå‘Pulsarç³»ç»Ÿå±‚é¢çš„å·¥ä½œ\nè‡³äºscheduledExecutorProviderç›¸ä¿¡å°±æ›´ç®€å•äº†ï¼Œé¡¾åæ€ä¹‰éƒ½æ˜¯å¤„ç†ä¸€äº›å‘¨æœŸæ€§çš„ä»»åŠ¡ï¼Œä¾‹å¦‚ä¸‹é¢çš„å‘¨æœŸæ€§çš„åŒæ­¥Topicåˆ†åŒºä¿¡æ¯åˆ°å®¢æˆ·ç«¯\näº”ã€æ€»ç»“ PulsarClientä¸­çš„EventLoopGroupè´Ÿè´£åˆ›å»ºTCPè¿æ¥ï¼ŒConnectionPoolå¯¹è±¡è´Ÿè´£ç®¡ç†è¿æ¥ï¼Œåœ¨åˆ›å»ºConnectionPoolå¯¹è±¡æ—¶ä¼šé€šè¿‡EventLoopGroupåˆ›å»ºè¿æ¥ã€‚ PulsarClientä½¿ç”¨Nettyæ¥åˆ›å»ºTCPè¿æ¥ï¼Œå¹¶ç®¡ç†ä¸€ä¸ªè¿æ¥æ± å’Œä¸¤ä¸ªçº¿ç¨‹æ± ï¼Œæ‰€æœ‰Producerå’ŒConsumeréƒ½ä¼šå¤ç”¨PulsarClientçš„è¿æ¥æ± å’Œçº¿ç¨‹æ± ï¼Œè¿™æ ·å¯ä»¥é¿å…å®¢æˆ·ç«¯åˆ›å»ºè¿‡å¤šçš„è¿æ¥å’Œçº¿ç¨‹ã€‚å› æ­¤é€šå¸¸ä¸€ä¸ªè¿›ç¨‹ä¸­åªåˆ›å»ºä¸€ä¸ªPulsarClientï¼Œæ¯ä¸ªTopicå¯ä»¥è‡ªå·±å•ç‹¬åˆ›å»ºProducerå’ŒConsumerã€‚ ç”±äºBrokerä½¿ç”¨äº†Reactoræ¨¡å‹ï¼Œå•çº¿ç¨‹åªè´Ÿè´£è½¬å‘äº‹ä»¶ï¼Œè€Œæ•°æ®çš„è¯»å–ã€è§£ç ã€å¤„ç†ç­‰éƒ½æ˜¯åœ¨å·¥ä½œçº¿ç¨‹ä¸­å®Œæˆçš„ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡ç«¯æ‰€æœ‰è¯·æ±‚éƒ½æ˜¯å¼‚æ­¥å®Œæˆçš„ï¼›å®¢æˆ·ç«¯Producer/Consumeréƒ½æ˜¯å¼‚æ­¥çš„ï¼Œå› æ­¤ä¸å­˜åœ¨å•è¿æ¥çš„æ€§èƒ½é—®é¢˜ã€‚ PulsarClienté»˜è®¤åªä¼šä¸æ¯ä¸ªBrokerå»ºç«‹ä¸€ä¸ªè¿æ¥ï¼Œå¦‚æœè§‰å¾—ä¸å¤Ÿå¯ä»¥é€šè¿‡é…ç½®æ¥è°ƒå¤§ã€‚ ClientCnxéå¸¸é‡è¦ï¼Œè¿™æ˜¯nettyçš„å…¥é˜Ÿå¤„ç†é€»è¾‘ç±»ã€‚åç»­ä¼šä¸“é—¨é’ˆå¯¹è¿™ä¸ªç±»è¿›è¡Œè§£æ ","date":"2024-09-20T10:34:21+08:00","image":"https://sherlock-lin.github.io/p/pulsarclient%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20240715212010651_hu12175125588812162081.png","permalink":"https://sherlock-lin.github.io/p/pulsarclient%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/","title":"PulsarClientæºç è§£æ"},{"content":"ä¸€ã€ç®€æ schemaæ˜¯pulsaré‡è¦çš„åŠŸèƒ½ä¹‹ä¸€ï¼Œç°åœ¨å°±ä¸€èµ·ä»æºç çš„è§†è§’çœ‹ä¸‹ç®¡ç†æµåˆ›å»ºschemaæ—¶å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„è¡¨ç°\nå®¢æˆ·ç«¯ å®¢æˆ·ç«¯ä¸»è¦ç»å†ä»¥ä¸‹å››ä¸ªæ­¥éª¤\nåˆ›å»ºSchemaå®ä¾‹\næ ¹æ®æ•°æ®ç±»å‹åˆ›å»ºç›¸å¯¹åº”çš„å®ä¾‹ï¼Œä¾‹å¦‚Avroåˆ›å»ºAvroSchemaã€JSONåˆ›å»ºJSONSchemaç­‰\nè·å–å¤„ç†Schemaçš„å¯¹è±¡\nç®¡ç†æµPulsarAdminå¯¹è±¡è·å–SchemasImplå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯ä¸“é—¨å¤„ç†æ‰€æœ‰schemaç›¸å…³çš„æ“ä½œã€‚é™¤æ­¤ä¹‹å¤–PulsarAdminå¯¹è±¡è¿˜ç»´æŠ¤ç€Clustersã€Brokersã€Tenantsç­‰ç­‰ç®¡ç†ç»´æŠ¤é›†ç¾¤çš„é‡è¦å¯¹è±¡ï¼Œé€šè¿‡è¿™äº›å¯¹è±¡å¯ä»¥å¾ˆå¥½çš„ç®¡ç†ç»´æŠ¤Pulsaré›†ç¾¤\næ„é€ SchemaInfo\né€šè¿‡Schemaå®ä¾‹åˆ›å»ºå…¶å¯¹åº”çš„SchemaInfoä¿¡æ¯ï¼Œé‡Œé¢å°±åŒ…æ‹¬è¿™ä¸ªschemaçš„åå­—ã€schemaçš„ç»“æ„åŒ–ä¿¡æ¯ã€schemaç±»å‹ç­‰ç­‰ï¼Œæœ€åSchemaInfoè¿™ä¸ªå¯¹è±¡ä¼šè½¬æˆå­—ç¬¦ä¸²å‘åˆ°æœåŠ¡ç«¯\nå‘é€HTTPè¯·æ±‚\né€šè¿‡postè¯·æ±‚å°†æ•°æ®å‘åˆ°æœåŠ¡ç«¯ï¼Œè¿™é‡Œæ˜¯é€šè¿‡Java Reståº“javax.ws.rs-apiè¿›è¡Œå¤„ç†çš„\næœåŠ¡ç«¯ æœåŠ¡ç«¯ä¸»è¦ç»å†ä»¥ä¸‹å››ä¸ªæ­¥éª¤\nå‚æ•°æ ¼å¼æ ¡éªŒ\næ ¡éªŒç§Ÿæˆ·ã€å‘½åç©ºé—´çš„æ˜¯å¦æœ‰æ•ˆ(åˆ¤ç©ºã€æ˜¯å¦æœ‰ç‰¹æ®Šå­—ç¬¦) ä»ç¼“å­˜ä¸­æ ¹æ®Topicè·å–å…¶å¯¹åº”çš„TopicNameå¯¹è±¡ æƒé™æ ¡éªŒ\nåˆ¤æ–­æ˜¯å¦æ˜¯Topicçš„owner åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰æ“ä½œå½“å‰Topicçš„æƒé™ SchemaRegistryæ³¨å†Œschema\nSchemaRegistryServiceæ˜¯æœåŠ¡ç«¯å¤„ç†æ‰€æœ‰schemaç›¸å…³çš„å¯¹è±¡ï¼Œè€Œschemaç›¸å…³çš„è¯»å†™æ“ä½œæ˜¯ä¾èµ–å®ƒçš„æˆå‘˜SchemaStorageè¿›è¡Œå¤„ç†çš„ï¼ŒSchemaStorageçš„æœ€ç»ˆæ˜¯é€šè¿‡Bookkeeperå®¢æˆ·ç«¯å¯¹è±¡å‘é€å†™è¯·æ±‚\nå†™Bookkeeper\né€šè¿‡LedgerHandleå¯¹è±¡å‘BookkeeperæœåŠ¡ç«¯å‘é€å†™è¯·æ±‚\nå°ç»“ schameæ–°å»ºæµç¨‹æ¦‚æ‹¬èµ·æ¥å°±æ˜¯ï¼Œå®¢æˆ·ç«¯æ„é€ schemaä¿¡æ¯ï¼ŒæœåŠ¡ç«¯è´Ÿè´£schemaæ ¡éªŒï¼Œbookkeeperè´Ÿè´£schemaçš„å­˜å‚¨\näºŒã€å®¢æˆ·ç«¯æºç è§£æ æºç è·Ÿè¸ª ä¸‹é¢æ˜¯é€šè¿‡ç®¡ç†æµåˆ›å»ºschemaçš„æ ·ä¾‹ä»£ç ï¼Œæ ¸å¿ƒå°±æ˜¯é€šè¿‡PulsarAdmin.schemasè·å–schemaå¯¹è±¡ï¼Œè¿™ä¸ªschemaå¯¹è±¡è´Ÿè´£æ‰€æœ‰å®¢æˆ·ç«¯è·Ÿschemaç›¸å…³çš„æ“ä½œï¼ŒåŒ…æ‹¬schemaçš„å¢åˆ æ”¹æŸ¥ç­‰ã€‚é€šè¿‡æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°å¯ä»¥çœ‹åˆ°æ˜¯é€šè¿‡Schemaæ¥å£æä¾›çš„é™æ€æ–¹æ³•AVROæ¥æ„é€ Avroæ ¼å¼çš„schemaå¯¹è±¡ï¼Œé™¤æ­¤ä¹‹å¤–Schemaæ¥å£è¿˜æä¾›äº†è¯¸å¦‚JSONã€KeyValueã€PROTOBUFç­‰é™æ€æ–¹æ³•æä¾›å¯¹åº”æ•°æ®æ ¼å¼çš„schemaå¯¹è±¡ï¼Œè¿™é‡Œå¦‚æœå°†è¿™å—æ„é€ schemaå¯¹è±¡é€»è¾‘æŠ½æˆç®€å•å·¥å‚æ¨¡å¼å¯èƒ½ä¼šæ›´åˆé€‚äº›\næ¥ä¸‹æ¥å°±è¿›å…¥createSchemaæ–¹æ³•ï¼Œé¡¾åæ€ä¹‰å¯ä»¥çŸ¥é“è¿™ä¸ªæ–¹æ³•å°±æ˜¯ç”¨äºåˆ›å»ºschemaçš„ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯topicï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯SchemaInfoå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡åŒ…å«äº†æ‰€æœ‰è¦æ–°å»ºçš„schemaä¿¡æ¯ï¼Œè¿™é‡Œä¼šå°†å®ƒè½¬æ¢ä¸ºPostSchemaPayloadå¯¹è±¡ä¼ é€’ç»™ä¸‹ä¸€ä¸ªæ–¹æ³•ã€‚PostSchemaPayloadæ˜¯ç”¨æ¥è¯·æ±‚åˆ°æœåŠ¡ç«¯çš„å‚æ•°\nè¿™ä¸ªæ–¹æ³•å¹¶ä¸ä¼šæœ‰è¿”å›å€¼ï¼Œsyncæ–¹æ³•æ˜¯å¤„ç†å¼‚æ­¥ç»“æœå¯¹è±¡ï¼Œå®ƒåœ¨æ­£å¸¸å†™æˆåŠŸæƒ…å†µä¸‹ä¸ä¼šåšä»»ä½•æ“ä½œï¼Œä½†å¦‚æœæœ‰ä»€ä¹ˆé”™è¯¯ä¼šå¾€å¤–æŠ›å‡ºå¼‚å¸¸ã€‚è¿™é‡Œæ ¸å¿ƒé€»è¾‘æ˜¯åœ¨createSchemaAsyncæ–¹æ³•\nå¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼æ˜¯ä¸ªå¼‚æ­¥å¯¹è±¡ï¼Œ146è¡Œè¿™é‡Œä¼šè·å–å½“å‰topicå¯¹åº”çš„TopicNameå¯¹è±¡ï¼Œå¹¶é€šè¿‡schemaPathæ–¹æ³•æ„é€ WebTargetå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¸­å°±åŒ…å«ç€è¦è¯·æ±‚çš„HTTPåœ°å€ï¼Œä¸»è¦æ˜¯æ ¹æ®å½“å‰Topicçš„ç‰ˆæœ¬æ¥å†³å®šè¯·æ±‚æœåŠ¡ç«¯å“ªä¸ªç‰ˆæœ¬çš„å¤„ç†æ–¹æ³•ã€‚é™¤æ­¤ä¹‹å¤–è¿˜å¯ä»¥çœ‹åˆ°æœ‰é€šè¿‡Entity.jsonæ–¹æ³•å°†PostSchemaPayloadå¯¹è±¡è½¬æ¢ä¸ºHTTPè¯·æ±‚çš„å‚æ•°å¯¹è±¡ï¼Œè½¬æ¢é€»è¾‘æ˜¯javax.ws.rs-apiè¿™ä¸ªç½‘ç»œåº“å°è£…çš„ï¼Œå°±ä¸è¿›è¡Œè·Ÿè¸ªäº†\nè¿™é‡Œå°±æ˜¯å®¢æˆ·ç«¯æœ€åå‘é€çš„åœ°æ–¹ï¼Œrequestæ–¹æ³•ä¸­è¿˜ä¼šå‘é€å‰çš„å®‰å…¨ç›¸å…³æ£€æŸ¥ï¼Œasyncæ–¹æ³•åŸºæœ¬ä¸Šå°±è¯´æ˜æœ¬æ¬¡HTTPè¯·æ±‚æ˜¯å¼‚æ­¥çš„ï¼Œè€Œpostæ–¹æ³•ä¹Ÿèƒ½çœ‹å¾—å‡ºï¼Œè¿™æ˜¯ä¸€ä¸ªPOSTç±»å‹çš„HTTPè¯·æ±‚ï¼Œå†å¾€åå°±æ˜¯å°†è¯·æ±‚å‘é€å‡ºå»äº†\nä¸çŸ¥æ˜¯å¦æœ‰äººå¥½å¥‡å‚æ•°WebTargeté•¿ä»€ä¹ˆæ ·å­ï¼Œé€šè¿‡é€šè¿‡è°ƒè¯•å¯ä»¥çœ‹åˆ°å€¼ä¸º\n/admin/v2/schemas/public/test-namespace-jytixthzgatgirem/test-multi-version-schema-one/schema\næ­¤å€¼ä»…ä¾›å­¦ä¹ å‚è€ƒï¼Œå…·ä½“è¿™ä¸ªå€¼çš„æ„é€ é€»è¾‘å¦‚ä¸‹\nå°ç»“ ç®€å•å½’çº³å¦‚ä¸‹\né€šè¿‡Schemaæ¥å£æ„é€ å¯¹åº”æ•°æ®æ ¼å¼çš„schemaå¯¹è±¡ï¼Œç”±æ­¤å¯¹è±¡å¯å¾—åˆ°schemaç›¸å…³çš„å…ƒä¿¡æ¯SchemaInfo æ„é€ è¯·æ±‚ç›®æ ‡çš„HTTPåœ°å€ é€šè¿‡javax.ws.rs-apiæä¾›çš„åº“å‘é€å¼‚æ­¥HTTPè¯·æ±‚åˆ°æœåŠ¡ç«¯ ä¸‰ã€æœåŠ¡ç«¯æºç è§£æ æºç è·Ÿè¸ª æœåŠ¡ç«¯çš„æ¥æ”¶é€»è¾‘åœ¨SchemasResourceç±»ï¼Œè¿™ä¸ªç±»åœ¨org.apache.pulsar.broker.adminåŒ…ä¸‹ï¼Œè¿™ä¸ªåŒ…ä¸‹å…¨æ˜¯å¤„ç†ç®¡ç†æµç›¸å…³çš„æ“ä½œï¼Œå¦‚æœæœ‰åšpulsarå¹³å°åŒ–éœ€æ±‚çš„ï¼Œè¿™ä¸ªåŒ…ä¸‹çš„ç›¸å…³é€»è¾‘å€¼å¾—ä¸€è¯»ã€‚\nå†æ¥çœ‹çœ‹postSchemaæ–¹æ³•ï¼Œé¦–å…ˆæ˜¯validateTopicNameæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯å¯¹å…¥å‚è¿›è¡Œåˆ¤ç©ºã€æ˜¯å¦æœ‰ç‰¹æ®Šå­—ç¬¦åšæ£€æŸ¥ï¼›æ¥ä¸‹æ¥å°±æ˜¯æ ¸å¿ƒæ–¹æ³•postSchemaAsyncï¼Œé€šè¿‡æ–¹æ³•åå¯ä»¥æ¨æ–­å‡ºè¿™æ˜¯ä¸ªå¼‚æ­¥å¤„ç†schemaå†™è¯·æ±‚çš„æ–¹æ³•\npostSchemaAsyncæ–¹æ³•çœ‹ä¼¼å¤æ‚ï¼Œå®é™…ä¸Šæ ¸å¿ƒçš„å°±æ˜¯133è¡Œï¼Œå…¶ä½™çš„æ–¹æ³•å¤§æ¦‚è¯´ä¸€ä¸‹ï¼ŒvalidateOwnershipAndOperationAsyncæ–¹æ³•ä¸»è¦æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰æ–°å»ºschemaçš„æ“ä½œæƒé™ï¼ŒgetSchemaCompatibilityStrategyAsyncWithoutAuthæ–¹æ³•ç›¸å¯¹å¤æ‚ä¸€äº›ï¼Œæ”¾åˆ°åé¢è¯¦ç»†è®²è§£ã€‚é‚£ä¹ˆå†çœ‹å›133è¡Œï¼Œå…¶ä¸­getSchemaRegistryServiceæ–¹æ³•è·å–çš„æ˜¯SchemaRegistryServiceImplå¯¹è±¡ï¼Œé¡¾åæ€ä¹‰å¯ä»¥çŸ¥é“Pulsarçš„SchemaResistryç›¸å…³çš„åŠŸèƒ½éƒ½æ˜¯ç”±å®ƒè¿›è¡Œå¤„ç†ï¼Œç°åœ¨å…ˆçœ‹å®ƒçš„putSchemaIfAbsentæ–¹æ³•\nSchemaStorageå¯¹è±¡æ˜¯SchemaRegistryServiceImplçš„æ ¸å¿ƒæˆå‘˜ï¼Œè´Ÿè´£schemaå­˜å‚¨ç›¸å…³çš„æ“ä½œã€‚åœ¨æ–°å»ºschemaæ—¶ä¼šè°ƒç”¨å®ƒçš„putæ–¹æ³•è¿›è¡Œåˆ›å»ºï¼›è¿™é‡Œæœ‰ä¸ªtrimDeletedSchemaAndGetListæ–¹æ³•ï¼Œå¦‚æœputæ–¹æ³•åœ¨åˆ›å»ºschemaæ—¶æœ‰ä»»ä½•å¼‚å¸¸ï¼Œåˆ™æ­¤æ–¹æ³•ä¼šå»åˆ é™¤è¯¥æ–°å»ºçš„schemaï¼Œé¿å…å†™\u0026quot;ä¸€åŠ\u0026quot;çš„æƒ…å†µå‘ç”Ÿï¼ŒæŸç§æ„ä¹‰ä¸Šè¿™ä¹Ÿæ˜¯ä¸€ç§å›æ»šçš„è®¾è®¡ã€‚\nè¿™é‡Œçš„getAllæ–¹æ³•å¾ˆé‡è¦ï¼Œä¼šæ ¹æ®schemaçš„idæ¥æŸ¥è¯¢æ˜¯å¦å·²ç»å­˜åœ¨å½“å‰schemaï¼Œæœ‰çš„è¯åˆ™å°†ç‰ˆæœ¬å·åŠ 1ã€‚å¤„ç†å®Œä¹‹åå°±è°ƒç”¨putæ–¹æ³•\nè¿™é‡Œæ²¡ä»€ä¹ˆé€»è¾‘ï¼Œç»§ç»­å¾€ä¸‹è·Ÿè¸ª\ngetSchemaLocatoræ–¹æ³•ä¼šæ„é€ LocatorEntryå¯¹è±¡ï¼Œè°ƒç”¨putSchema\nç”±äºæ˜¯åˆæ¬¡åˆ›å»ºschemaï¼Œå› æ­¤ç›´æ¥èµ°åˆ°337è¡Œï¼›å¦‚æœè¿™ä¸ªtopicå·²ç»åˆ›å»ºè¿‡schemaåˆ™ä¼šè¯»å–ä¹‹å‰çš„schemaä¿¡æ¯å†æ–°å¢ï¼ŒåŒæ—¶æŠŠç‰ˆæœ¬å·è‡ªå¢\nåœ¨è¿™é‡Œå¯ä»¥çœ‹å¾—åˆ°æ„é€ IndexEntryå¯¹è±¡ï¼Œè¿™æ˜¯æ¶ˆæ¯çš„ç´¢å¼•å¯¹è±¡ï¼Œåç»­ç”¨æ¥åŠ é€ŸæŸ¥è¯¢schema\nè¿™ä¸ªæ–¹æ³•çš„å†…å®¹å°±å¾ˆçœ¼ç†Ÿäº†(bookkeeperç›¸å…³å†…å®¹)ï¼ŒcreateLedgeræ–¹æ³•ä¼šå…ˆåˆ›å»ºè¿™ä¸ªLedger\nåœ¨576è¡Œå¯ä»¥çœ‹åˆ°æœ€ç»ˆè°ƒç”¨bookkeeperåˆ›å»ºè¿™ä¸ªLedger\nå†æ¥çœ‹çœ‹addEntryæ–¹æ³•ï¼Œè¿™é‡Œæ ¸å¿ƒä¹Ÿæ˜¯è°ƒç”¨bookkeeperçš„ledgerHandleè¿›è¡Œæ•°æ®å†™å…¥\nè¿™ä¸ªæ–¹æ³•æ˜¯å±äºBookkeeperå®¢æˆ·ç«¯çš„é€»è¾‘äº†ï¼Œé€šè¿‡æ–¹æ³•æ³¨é‡Šå¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ–¹æ³•è´Ÿè´£å°†æ•°æ®å¼‚æ­¥å†™å…¥åˆ°ä¸€ä¸ªæ‰“å¼€çš„Ledgerã€‚Bookkeeperç›¸å…³çš„é€»è¾‘åç»­åœ¨å•ç‹¬å†™postè¿›è¡Œè®²è§£\nå°ç»“ ç®€å•å½’çº³å¦‚ä¸‹\nå‚æ•°æ ¼å¼æ ¡éªŒã€æ“ä½œæƒé™æ ¡éªŒ æŸ¥è¯¢å½“å‰Topicæ˜¯å¦å·²ç»åˆ›å»ºè¿‡schemaï¼Œæœ‰åˆ™ä»¥æ’å…¥æ—¶ç‰ˆæœ¬å·è‡ªå¢ å¦‚æœæ˜¯åˆæ¬¡åˆ›å»ºSchemaï¼Œåˆ™è°ƒç”¨bookkeeperåˆ›å»ºLedger å¾€è¿™ä¸ªSchemaå¯¹åº”çš„Ledgerå†…æ’å…¥schemaå…ƒæ•°æ®ä¿¡æ¯ å››ã€å…¶ä»– åºåˆ—åŒ–å¯¹è±¡åˆ›å»ºæµç¨‹ ç°åœ¨å†ä¸“é—¨æ¥çœ‹çœ‹åºåˆ—åŒ–å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ï¼Œå›åˆ°å¼€å¤´ç®¡ç†æµåˆ›å»ºschemaçš„åœ°æ–¹ï¼ŒSchema.AVROæ–¹æ³•æ˜¯å’±ä»¬æœ¬æ¬¡è¦çœ‹çš„\né€šè¿‡æ³¨é‡Šå¯ä»¥çœ‹åˆ°ï¼Œæ­¤é™æ€æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ªAvroç±»å‹çš„schemaå¯¹è±¡ï¼ŒgetDefaultImplementationæ–¹æ³•æ˜¯è·å–å®ç°ç±»(é¥¿æ±‰å•ä¾‹è®¾è®¡æ¨¡å¼)ï¼Œè€ŒnewAvroSchemaæ–¹æ³•æ‰æ˜¯æœ¬æ¬¡è¦çœ‹çš„\nç»§ç»­å¾€ä¸‹è·Ÿè¸ª\nè·å–å¯¹åº”å¤„ç†çš„ç±»åŠ è½½å™¨ï¼Œå¹¶é€šè¿‡å¯¹åº”çš„ç±»åŠ è½½å™¨åˆ›å»ºAvroSchemaå®ä¾‹\n54è¡Œæ˜¯æ ¸å¿ƒï¼Œå…¶ä»–çš„éƒ½æ˜¯èµ‹å€¼æ“ä½œ\nsuperè°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°åšèµ‹å€¼æ“ä½œï¼Œè¿˜æ˜¯ç»§ç»­çœ‹\nç»§ç»­è·Ÿè¸ªparseé€»è¾‘\nFACTORY.createParseræ–¹æ³•æ˜¯jacksonçš„æ–¹æ³•ï¼Œç”¨äºåˆ›å»ºJsonParserå¯¹è±¡çš„ï¼›å› æ­¤ç»§ç»­è·Ÿè¸ªparseæ–¹æ³•\n1471è¡Œå¯ä»¥çœ‹åˆ°è¿”å›äº†æˆ‘ä»¬æƒ³è¦çš„Schemaå¯¹è±¡ï¼Œé‚£ä¹ˆSchema.parseæ–¹æ³•å°±æ˜¯é‡ä¸­ä¹‹é‡\nè¿™ä¸ªæ–¹æ³•æ˜¯æ ¸å¿ƒï¼Œæœ¬èº«ä¼šé€’å½’çš„è¿›è¡Œè§£æèµ‹å€¼ç»™schemaå¯¹è±¡\nç›¸ä¿¡è¯»è€…è¯»åˆ°è¿™é‡Œä¹Ÿå¥½å¥‡schemaé•¿ä»€ä¹ˆæ ·ï¼Œå› æ­¤æä¾›ä¸‹å›¾è®©è¯»è€…æ„Ÿå—ä¸‹ï¼Œèƒ½å¤§æ¦‚æ¨æµ‹å¾—å‡ºæ¥è¿™é‡Œå·²ç»æ¶µç›–äº†schemaçš„ç»“æ„ä¿¡æ¯äº†\ngetSchemaCompatibilityStrategyAsyncWithoutAuthæ–¹æ³• AdminResource#getSchemaCompatibilityStrategyAsyncWithoutAuthæ–¹æ³•æ˜¯åœ¨æœåŠ¡ç«¯å¤„ç†schemaåˆ›å»ºè¯·æ±‚é˜¶æ®µä¼šè°ƒç”¨çš„æ–¹æ³•ï¼Œç°åœ¨å°±ä¸€èµ·è·Ÿè¸ªçœ‹çœ‹\n731è¡Œå’Œ739è¡Œåˆ†åˆ«æ˜¯è·å–Topicçº§åˆ«å’ŒNamespaceçº§åˆ«çš„schemaå…¼å®¹ç­–ç•¥ï¼Œå¦‚æœæ²¡æœ‰å®šä¹‰åˆ™é»˜è®¤è‡ªåŠ¨æ›´æ–°ã€‚ä¾‹å¦‚Topic Aä¹‹å‰å·²ç»åˆ›å»ºè¿‡schema1ï¼Œé‚£ä¹ˆå¦‚æœæ­¤æ—¶å†å‘èµ·schema2åˆ›å»ºè¯·æ±‚ï¼Œåˆ™æœåŠ¡ç«¯ä¼šç»§ç»­ä¿å­˜å¹¶ä¸”ç”Ÿæ•ˆschema2ï¼Œåªä¸è¿‡å®ƒçš„ç‰ˆæœ¬å·ä¼šè¿›è¡Œç´¯åŠ ï¼Œå½“ç„¶ï¼Œä¹Ÿå¯ä»¥é…ç½®ä¸ºä¸æ”¯æŒschemaç­–ç•¥ä¸æ”¯æŒæ›´æ–°ï¼Œä¸€æ—¦ç¡®å®šäº†åå°±ä¸å…è®¸å†å˜æ›´\näº”ã€æ€»ç»“ ç›¸ä¿¡å¤§å®¶å¯¹schemaåˆ›å»ºçš„æµç¨‹å·²ç»å¾ˆæ¸…æ¥šäº†ï¼Œå†æ¬¡ç®€å•å½’çº³ä¸‹\nå®¢æˆ·ç«¯æ ¹æ®ç”¨æˆ·å®šä¹‰çš„ç»“æ„ä¿¡æ¯åˆ›å»ºå¯¹åº”çš„Schemaå¯¹è±¡ï¼Œå¹¶å°†ç»“æ„ä¿¡æ¯ä»¥HTTPè¯·æ±‚å‘ç»™æœåŠ¡ç«¯ æœåŠ¡ç«¯æ£€æµ‹å¹¶æ ¹æ®Schemaå…¼å®¹ç­–ç•¥åšç›¸å¯¹åº”çš„å¤„ç†ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¼šè°ƒç”¨Bookkeeperåˆ›å»ºLedgerä»¥åŠEntry Bookkeeperå°†æ­¤Schemaæ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œç›¸å½“äºSchemaä¿¡æ¯ä¼šè¢«Bookkeeperå½“ä½œä¸€æ¡æ¶ˆæ¯è¿›è¡Œå­˜å‚¨ è¿™åŸºæœ¬ä¸Šå°±æ˜¯å…¨éƒ¨å†…å®¹ï¼Œå½“ç„¶ç»†èŠ‚æ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è‡ªè¡Œè·Ÿè¸ªä»£ç ï¼Œç›¸ä¿¡ä½ ä¼šæœ‰æ›´å¤šæ”¶è·ï½\n","date":"2021-09-20T10:02:55+08:00","image":"https://sherlock-lin.github.io/p/%E7%AE%A1%E7%90%86%E6%B5%81%E5%88%9B%E5%BB%BAschema%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20240801111546500_hu11517481045871944850.png","permalink":"https://sherlock-lin.github.io/p/%E7%AE%A1%E7%90%86%E6%B5%81%E5%88%9B%E5%BB%BAschema%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/","title":"ç®¡ç†æµåˆ›å»ºschemaæµç¨‹æºç è§£æ"},{"content":"æ­£æ–‡æµ‹è¯• è€Œè¿™äº›å¹¶ä¸æ˜¯å®Œå…¨é‡è¦ï¼Œæ›´åŠ é‡è¦çš„é—®é¢˜æ˜¯ï¼Œ å¸¦ç€è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬æ¥å®¡è§†ä¸€ä¸‹å­¦ç”Ÿä¼šé€€ä¼šã€‚ æ—¢ç„¶å¦‚ä½•ï¼Œ å¯¹æˆ‘ä¸ªäººè€Œè¨€ï¼Œå­¦ç”Ÿä¼šé€€ä¼šä¸ä»…ä»…æ˜¯ä¸€ä¸ªé‡å¤§çš„äº‹ä»¶ï¼Œè¿˜å¯èƒ½ä¼šæ”¹å˜æˆ‘çš„äººç”Ÿã€‚ æˆ‘ä»¬ä¸å¾—ä¸é¢å¯¹ä¸€ä¸ªéå¸¸å°´å°¬çš„äº‹å®ï¼Œé‚£å°±æ˜¯ï¼Œ å¯æ˜¯ï¼Œå³ä½¿æ˜¯è¿™æ ·ï¼Œå­¦ç”Ÿä¼šé€€ä¼šçš„å‡ºç°ä»ç„¶ä»£è¡¨äº†ä¸€å®šçš„æ„ä¹‰ã€‚ å­¦ç”Ÿä¼šé€€ä¼šï¼Œå‘ç”Ÿäº†ä¼šå¦‚ä½•ï¼Œä¸å‘ç”Ÿåˆä¼šå¦‚ä½•ã€‚ ç»è¿‡ä¸Šè¿°è®¨è®ºï¼Œ ç”Ÿæ´»ä¸­ï¼Œè‹¥å­¦ç”Ÿä¼šé€€ä¼šå‡ºç°äº†ï¼Œæˆ‘ä»¬å°±ä¸å¾—ä¸è€ƒè™‘å®ƒå‡ºç°äº†çš„äº‹å®ã€‚ å­¦ç”Ÿä¼šé€€ä¼šï¼Œåˆ°åº•åº”è¯¥å¦‚ä½•å®ç°ã€‚ è¿™æ ·çœ‹æ¥ï¼Œ åœ¨è¿™ç§å›°éš¾çš„æŠ‰æ‹©ä¸‹ï¼Œæœ¬äººæ€æ¥æƒ³å»ï¼Œå¯é£Ÿéš¾å®‰ã€‚ å¯¹æˆ‘ä¸ªäººè€Œè¨€ï¼Œå­¦ç”Ÿä¼šé€€ä¼šä¸ä»…ä»…æ˜¯ä¸€ä¸ªé‡å¤§çš„äº‹ä»¶ï¼Œè¿˜å¯èƒ½ä¼šæ”¹å˜æˆ‘çš„äººç”Ÿã€‚ å°±æˆ‘ä¸ªäººæ¥è¯´ï¼Œå­¦ç”Ÿä¼šé€€ä¼šå¯¹æˆ‘çš„æ„ä¹‰ï¼Œä¸èƒ½ä¸è¯´éå¸¸é‡å¤§ã€‚ èå£«æ¯”äºšæ›¾ç»æåˆ°è¿‡ï¼Œäººçš„ä¸€ç”Ÿæ˜¯çŸ­çš„ï¼Œä½†å¦‚æœå‘åŠ£åœ°è¿‡è¿™ä¸€ç”Ÿï¼Œå°±å¤ªé•¿äº†ã€‚è¿™ä¼¼ä¹è§£ç­”äº†æˆ‘çš„ç–‘æƒ‘ã€‚ è«æ‰ç‰¹è¯´è¿‡ä¸€å¥å¯Œæœ‰å“²ç†çš„è¯ï¼Œè°å’Œæˆ‘ä¸€æ ·ç”¨åŠŸï¼Œè°å°±ä¼šå’Œæˆ‘ä¸€æ ·æˆåŠŸã€‚è¿™å¯å‘äº†æˆ‘ï¼Œ å¯¹æˆ‘ä¸ªäººè€Œè¨€ï¼Œå­¦ç”Ÿä¼šé€€ä¼šä¸ä»…ä»…æ˜¯ä¸€ä¸ªé‡å¤§çš„äº‹ä»¶ï¼Œè¿˜å¯èƒ½ä¼šæ”¹å˜æˆ‘çš„äººç”Ÿã€‚ å­¦ç”Ÿä¼šé€€ä¼šï¼Œåˆ°åº•åº”è¯¥å¦‚ä½•å®ç°ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œ ä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼Œ è¿™ç§äº‹å®å¯¹æœ¬äººæ¥è¯´æ„ä¹‰é‡å¤§ï¼Œç›¸ä¿¡å¯¹è¿™ä¸ªä¸–ç•Œä¹Ÿæ˜¯æœ‰ä¸€å®šæ„ä¹‰çš„ã€‚ åœ¨è¿™ç§å›°éš¾çš„æŠ‰æ‹©ä¸‹ï¼Œæœ¬äººæ€æ¥æƒ³å»ï¼Œå¯é£Ÿéš¾å®‰ã€‚ äº†è§£æ¸…æ¥šå­¦ç”Ÿä¼šé€€ä¼šåˆ°åº•æ˜¯ä¸€ç§æ€ä¹ˆæ ·çš„å­˜åœ¨ï¼Œæ˜¯è§£å†³ä¸€åˆ‡é—®é¢˜çš„å…³é”®ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œ ç”Ÿæ´»ä¸­ï¼Œè‹¥å­¦ç”Ÿä¼šé€€ä¼šå‡ºç°äº†ï¼Œæˆ‘ä»¬å°±ä¸å¾—ä¸è€ƒè™‘å®ƒå‡ºç°äº†çš„äº‹å®ã€‚ é—®é¢˜çš„å…³é”®ç©¶ç«Ÿä¸ºä½•ï¼Ÿ è€Œè¿™äº›å¹¶ä¸æ˜¯å®Œå…¨é‡è¦ï¼Œæ›´åŠ é‡è¦çš„é—®é¢˜æ˜¯ã€‚\nå¥¥æ–¯ç‰¹æ´›å¤«æ–¯åŸºæ›¾ç»è¯´è¿‡ï¼Œå…±åŒçš„äº‹ä¸šï¼Œå…±åŒçš„æ–—äº‰ï¼Œå¯ä»¥ä½¿äººä»¬äº§ç”Ÿå¿å—ä¸€åˆ‡çš„åŠ›é‡ã€‚ã€€å¸¦ç€è¿™å¥è¯ï¼Œæˆ‘ä»¬è¿˜è¦æ›´åŠ æ…é‡çš„å®¡è§†è¿™ä¸ªé—®é¢˜ï¼š ä¸€èˆ¬æ¥è®²ï¼Œæˆ‘ä»¬éƒ½å¿…é¡»åŠ¡å¿…æ…é‡çš„è€ƒè™‘è€ƒè™‘ã€‚ æ—¢ç„¶å¦‚æ­¤ï¼Œ è¿™ç§äº‹å®å¯¹æœ¬äººæ¥è¯´æ„ä¹‰é‡å¤§ï¼Œç›¸ä¿¡å¯¹è¿™ä¸ªä¸–ç•Œä¹Ÿæ˜¯æœ‰ä¸€å®šæ„ä¹‰çš„ã€‚ å¸¦ç€è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬æ¥å®¡è§†ä¸€ä¸‹å­¦ç”Ÿä¼šé€€ä¼šã€‚ æˆ‘è®¤ä¸ºï¼Œ æˆ‘è®¤ä¸ºï¼Œ åœ¨è¿™ç§å›°éš¾çš„æŠ‰æ‹©ä¸‹ï¼Œæœ¬äººæ€æ¥æƒ³å»ï¼Œå¯é£Ÿéš¾å®‰ã€‚ é—®é¢˜çš„å…³é”®ç©¶ç«Ÿä¸ºä½•ï¼Ÿ æ¯ä¸ªäººéƒ½ä¸å¾—ä¸é¢å¯¹è¿™äº›é—®é¢˜ã€‚ åœ¨é¢å¯¹è¿™ç§é—®é¢˜æ—¶ï¼Œ è¦æƒ³æ¸…æ¥šï¼Œå­¦ç”Ÿä¼šé€€ä¼šï¼Œåˆ°åº•æ˜¯ä¸€ç§æ€ä¹ˆæ ·çš„å­˜åœ¨ã€‚ æˆ‘è®¤ä¸ºï¼Œ æ—¢ç„¶å¦‚æ­¤ï¼Œ æ¯ä¸ªäººéƒ½ä¸å¾—ä¸é¢å¯¹è¿™äº›é—®é¢˜ã€‚ åœ¨é¢å¯¹è¿™ç§é—®é¢˜æ—¶ï¼Œ é‚£ä¹ˆï¼Œ æˆ‘è®¤ä¸ºï¼Œ å­¦ç”Ÿä¼šé€€ä¼šå› ä½•è€Œå‘ç”Ÿã€‚\nå¼•ç”¨ æ€å¿µæ˜¯æœ€æš–çš„å¿§ä¼¤åƒä¸€åŒç¿…è†€\nè®©æˆ‘åœä¸äº†é£ä¸è¿œåœ¨è¿‡å¾€æ¸¸è¡\nä¸å‘Šè€Œåˆ«çš„ä½  å°±ç®—ä¸ºäº†æˆ‘ç€æƒ³\nè¿™ä¹ˆæ²‰ç—›çš„å‘µæŠ¤ æˆ‘æ€ä¹ˆèƒ½ç¿±ç¿”\næœ€æš–çš„æ†‚å‚· - ç”°é¦¥ç”„\nå›¾ç‰‡ 1 2 3 ![Photo by Florian Klauer on Unsplash](florian-klauer-nptLmg6jqDo-unsplash.jpg) ![Photo by Luca Bravo on Unsplash](luca-bravo-alS7ewQ41M8-unsplash.jpg) ![Photo by Helena Hertz on Unsplash](helena-hertz-wWZzXlDpMog-unsplash.jpg) ![Photo by Hudai Gayiran on Unsplash](hudai-gayiran-3Od_VKcDEAA-unsplash.jpg) ç›¸å†Œè¯­æ³•æ¥è‡ª Typlog\n","date":"2020-09-09T00:00:00Z","image":"https://sherlock-lin.github.io/p/test-chinese/helena-hertz-wWZzXlDpMog-unsplash_hu4699868770670889127.jpg","permalink":"https://sherlock-lin.github.io/p/test-chinese/","title":"Chinese Test"},{"content":"This article offers a sample of basic Markdown syntax that can be used in Hugo content files, also it shows whether basic HTML elements are decorated with CSS in a Hugo theme.\nHeadings The following HTML \u0026lt;h1\u0026gt;â€”\u0026lt;h6\u0026gt; elements represent six levels of section headings. \u0026lt;h1\u0026gt; is the highest section level while \u0026lt;h6\u0026gt; is the lowest.\nH1 H2 H3 H4 H5 H6 Paragraph Xerum, quo qui aut unt expliquam qui dolut labo. Aque venitatiusda cum, voluptionse latur sitiae dolessi aut parist aut dollo enim qui voluptate ma dolestendit peritin re plis aut quas inctum laceat est volestemque commosa as cus endigna tectur, offic to cor sequas etum rerum idem sintibus eiur? Quianimin porecus evelectur, cum que nis nust voloribus ratem aut omnimi, sitatur? Quiatem. Nam, omnis sum am facea corem alique molestrunt et eos evelece arcillit ut aut eos eos nus, sin conecerem erum fuga. Ri oditatquam, ad quibus unda veliamenimin cusam et facea ipsamus es exerum sitate dolores editium rerore eost, temped molorro ratiae volorro te reribus dolorer sperchicium faceata tiustia prat.\nItatur? Quiatae cullecum rem ent aut odis in re eossequodi nonsequ idebis ne sapicia is sinveli squiatum, core et que aut hariosam ex eat.\nBlockquotes The blockquote element represents content that is quoted from another source, optionally with a citation which must be within a footer or cite element, and optionally with in-line changes such as annotations and abbreviations.\nBlockquote without attribution Tiam, ad mint andaepu dandae nostion secatur sequo quae. Note that you can use Markdown syntax within a blockquote.\nBlockquote with attribution Don\u0026rsquo;t communicate by sharing memory, share memory by communicating.\nâ€” Rob Pike1\nTables Tables aren\u0026rsquo;t part of the core Markdown spec, but Hugo supports supports them out-of-the-box.\nName Age Bob 27 Alice 23 Inline Markdown within tables Italics Bold Code italics bold code A B C D E F Lorem ipsum dolor sit amet, consectetur adipiscing elit. Phasellus ultricies, sapien non euismod aliquam, dui ligula tincidunt odio, at accumsan nulla sapien eget ex. Proin eleifend dictum ipsum, non euismod ipsum pulvinar et. Vivamus sollicitudin, quam in pulvinar aliquam, metus elit pretium purus Proin sit amet velit nec enim imperdiet vehicula. Ut bibendum vestibulum quam, eu egestas turpis gravida nec Sed scelerisque nec turpis vel viverra. Vivamus vitae pretium sapien Code Blocks Code block with backticks 1 2 3 4 5 6 7 8 9 10 \u0026lt;!doctype html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;\u0026gt; \u0026lt;title\u0026gt;Example HTML5 Document\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;p\u0026gt;Test\u0026lt;/p\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; Code block indented with four spaces \u0026lt;!doctype html\u0026gt; \u0026lt;html lang=\u0026quot;en\u0026quot;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026quot;utf-8\u0026quot;\u0026gt; \u0026lt;title\u0026gt;Example HTML5 Document\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;p\u0026gt;Test\u0026lt;/p\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; Code block with Hugo\u0026rsquo;s internal highlight shortcode 1 2 3 4 5 6 7 8 9 10 \u0026lt;!doctype html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;\u0026gt; \u0026lt;title\u0026gt;Example HTML5 Document\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;p\u0026gt;Test\u0026lt;/p\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; Diff code block 1 2 3 4 5 [dependencies.bevy] git = \u0026#34;https://github.com/bevyengine/bevy\u0026#34; rev = \u0026#34;11f52b8c72fc3a568e8bb4a4cd1f3eb025ac2e13\u0026#34; - features = [\u0026#34;dynamic\u0026#34;] + features = [\u0026#34;jpeg\u0026#34;, \u0026#34;dynamic\u0026#34;] List Types Ordered List First item Second item Third item Unordered List List item Another item And another item Nested list Fruit Apple Orange Banana Dairy Milk Cheese Other Elements â€” abbr, sub, sup, kbd, mark GIF is a bitmap image format.\nH2O\nXn + Yn = Zn\nPress CTRL + ALT + Delete to end the session.\nMost salamanders are nocturnal, and hunt for insects, worms, and other small creatures.\nHyperlinked image The above quote is excerpted from Rob Pike\u0026rsquo;s talk during Gopherfest, November 18, 2015.\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n","date":"2019-03-11T00:00:00Z","image":"https://sherlock-lin.github.io/p/markdown-syntax-guide/pawel-czerwinski-8uZPynIu-rQ-unsplash_hu6307248181568134095.jpg","permalink":"https://sherlock-lin.github.io/p/markdown-syntax-guide/","title":"Markdown Syntax Guide"},{"content":"Lorem est tota propiore conpellat pectoribus de pectora summo.\nRedit teque digerit hominumque toris verebor lumina non cervice subde tollit usus habet Arctonque, furores quas nec ferunt. Quoque montibus nunc caluere tempus inhospita parcite confusaque translucet patri vestro qui optatis lumine cognoscere flos nubis! Fronde ipsamque patulos Dryopen deorum.\nExierant elisi ambit vivere dedere Duce pollice Eris modo Spargitque ferrea quos palude Rursus nulli murmur; hastile inridet ut ab gravi sententia! Nomine potitus silentia flumen, sustinet placuit petis in dilapsa erat sunt. Atria tractus malis.\nComas hunc haec pietate fetum procerum dixit Post torum vates letum Tiresia Flumen querellas Arcanaque montibus omnes Quidem et Vagus elidunt The Van de Graaf Canon\nMane refeci capiebant unda mulcebat Victa caducifer, malo vulnere contra dicere aurato, ludit regale, voca! Retorsit colit est profanae esse virescere furit nec; iaculi matertera et visa est, viribus. Divesque creatis, tecta novat collumque vulnus est, parvas. Faces illo pepulere tempus adest. Tendit flamma, ab opes virum sustinet, sidus sequendo urbis.\nIubar proles corpore raptos vero auctor imperium; sed et huic: manus caeli Lelegas tu lux. Verbis obstitit intus oblectamina fixis linguisque ausus sperare Echionides cornuaque tenent clausit possit. Omnia putatur. Praeteritae refert ausus; ferebant e primus lora nutat, vici quae mea ipse. Et iter nil spectatae vulnus haerentia iuste et exercebat, sui et.\nEurytus Hector, materna ipsumque ut Politen, nec, nate, ignari, vernum cohaesit sequitur. Vel mitis temploque vocatus, inque alis, oculos nomen non silvis corpore coniunx ne displicet illa. Crescunt non unus, vidit visa quantum inmiti flumina mortis facto sic: undique a alios vincula sunt iactata abdita! Suspenderat ego fuit tendit: luna, ante urbem Propoetides parte.\n","date":"2019-03-09T00:00:00Z","image":"https://sherlock-lin.github.io/p/placeholder-text/matt-le-SJSpo9hQf7s-unsplash_hu10664154974910995856.jpg","permalink":"https://sherlock-lin.github.io/p/placeholder-text/","title":"Placeholder Text"},{"content":"Mathematical notation in a Hugo project can be enabled by using third party JavaScript libraries.\nIn this example we will be using KaTeX\nCreate a partial under /layouts/partials/math.html Within this partial reference the Auto-render Extension or host these scripts locally. Include the partial in your templates like so: 1 2 3 {{ if or .Params.math .Site.Params.math }} {{ partial \u0026#34;math.html\u0026#34; . }} {{ end }} To enable KaTeX globally set the parameter math to true in a project\u0026rsquo;s configuration To enable KaTeX on a per page basis include the parameter math: true in content files Note: Use the online reference of Supported TeX Functions\nExamples Inline math: $\\varphi = \\dfrac{1+\\sqrt5}{2}= 1.6180339887â€¦$\nBlock math: $$ \\varphi = 1+\\frac{1} {1+\\frac{1} {1+\\frac{1} {1+\\cdots} } } $$","date":"2019-03-08T00:00:00Z","permalink":"https://sherlock-lin.github.io/p/math-typesetting/","title":"Math Typesetting"},{"content":"Emoji can be enabled in a Hugo project in a number of ways.\nThe emojify function can be called directly in templates or Inline Shortcodes.\nTo enable emoji globally, set enableEmoji to true in your site\u0026rsquo;s configuration and then you can type emoji shorthand codes directly in content files; e.g.\nğŸ™ˆ :see_no_evil: ğŸ™‰ :hear_no_evil: ğŸ™Š :speak_no_evil:\nThe Emoji cheat sheet is a useful reference for emoji shorthand codes.\nN.B. The above steps enable Unicode Standard emoji characters and sequences in Hugo, however the rendering of these glyphs depends on the browser and the platform. To style the emoji you can either use a third party emoji font or a font stack; e.g.\n1 2 3 .emoji { font-family: Apple Color Emoji, Segoe UI Emoji, NotoColorEmoji, Segoe UI Symbol, Android Emoji, EmojiSymbols; } ","date":"2019-03-05T00:00:00Z","image":"https://sherlock-lin.github.io/p/emoji-support/the-creative-exchange-d2zvqp3fpro-unsplash_hu5876398126655421130.jpg","permalink":"https://sherlock-lin.github.io/p/emoji-support/","title":"Emoji Support"}]