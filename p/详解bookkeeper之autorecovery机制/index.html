<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="å¼•è¨€å°æ•…äº‹ å¼ ä¸‰åœ¨ä¸€å®¶å°å‹äº’è”ç½‘å…¬å¸ä¸Šç­ï¼Œç”±äºå…¬å¸å®è¡Œçš„996ï¼Œå› æ­¤ç»å¸¸æœ‰åŒäº‹â€œä¸è¾è€Œåˆ«â€ï¼Œä¸ºäº†å·¥ä½œçš„æ­£å¸¸æ¨è¿›ï¼Œå›¢é˜Ÿå†…è¾¾æˆäº†æŸç§é»˜å¥‘ï¼Œè¿™ç§é»˜å¥‘å°±æ˜¯é€šè¿‡æŸä¸ªè§„åˆ™æ¥é€‰å‡ºä¸€ä¸ªåŒäº‹ï¼Œè¿™ä¸ªåŒäº‹é™¤äº†å·¥ä½œä¹‹ä½™è¿˜æœ‰é¢å¤–çœ‹çœ‹æ¯å¤©æ˜¯å¦æœ‰åŒäº‹â€œä¸è¾è€Œåˆ«â€ï¼Œå½“å‘ç°æœ‰åŒäº‹æå››ç¦»èŒæ—¶ï¼Œå°±ä¼šå»æŠŠæå››è´Ÿè´£çš„å·¥ä½œçš„å†…å®¹è¿›è¡Œæ‹†åˆ†ç»™å…¶ä»–çš„åŒäº‹è¿›è¡Œå¤„ç†ã€‚æ•´ä¸ªè¿‡ç¨‹å¤§è‡´å¦‚ä¸‹å›¾\n">
<title>è¯¦è§£bookkeeperä¹‹AutoRecoveryæœºåˆ¶</title>

<link rel='canonical' href='https://sherlock-lin.github.io/p/%E8%AF%A6%E8%A7%A3bookkeeper%E4%B9%8Bautorecovery%E6%9C%BA%E5%88%B6/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="è¯¦è§£bookkeeperä¹‹AutoRecoveryæœºåˆ¶">
<meta property='og:description' content="å¼•è¨€å°æ•…äº‹ å¼ ä¸‰åœ¨ä¸€å®¶å°å‹äº’è”ç½‘å…¬å¸ä¸Šç­ï¼Œç”±äºå…¬å¸å®è¡Œçš„996ï¼Œå› æ­¤ç»å¸¸æœ‰åŒäº‹â€œä¸è¾è€Œåˆ«â€ï¼Œä¸ºäº†å·¥ä½œçš„æ­£å¸¸æ¨è¿›ï¼Œå›¢é˜Ÿå†…è¾¾æˆäº†æŸç§é»˜å¥‘ï¼Œè¿™ç§é»˜å¥‘å°±æ˜¯é€šè¿‡æŸä¸ªè§„åˆ™æ¥é€‰å‡ºä¸€ä¸ªåŒäº‹ï¼Œè¿™ä¸ªåŒäº‹é™¤äº†å·¥ä½œä¹‹ä½™è¿˜æœ‰é¢å¤–çœ‹çœ‹æ¯å¤©æ˜¯å¦æœ‰åŒäº‹â€œä¸è¾è€Œåˆ«â€ï¼Œå½“å‘ç°æœ‰åŒäº‹æå››ç¦»èŒæ—¶ï¼Œå°±ä¼šå»æŠŠæå››è´Ÿè´£çš„å·¥ä½œçš„å†…å®¹è¿›è¡Œæ‹†åˆ†ç»™å…¶ä»–çš„åŒäº‹è¿›è¡Œå¤„ç†ã€‚æ•´ä¸ªè¿‡ç¨‹å¤§è‡´å¦‚ä¸‹å›¾\n">
<meta property='og:url' content='https://sherlock-lin.github.io/p/%E8%AF%A6%E8%A7%A3bookkeeper%E4%B9%8Bautorecovery%E6%9C%BA%E5%88%B6/'>
<meta property='og:site_name' content='å¤æ´›å…‹-æ—'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2024-01-04T12:00:10&#43;08:00'/><meta property='article:modified_time' content='2024-01-04T12:00:10&#43;08:00'/><meta property='og:image' content='https://sherlock-lin.github.io/p/%E8%AF%A6%E8%A7%A3bookkeeper%E4%B9%8Bautorecovery%E6%9C%BA%E5%88%B6/image-20231215102118251.png' />
<meta name="twitter:title" content="è¯¦è§£bookkeeperä¹‹AutoRecoveryæœºåˆ¶">
<meta name="twitter:description" content="å¼•è¨€å°æ•…äº‹ å¼ ä¸‰åœ¨ä¸€å®¶å°å‹äº’è”ç½‘å…¬å¸ä¸Šç­ï¼Œç”±äºå…¬å¸å®è¡Œçš„996ï¼Œå› æ­¤ç»å¸¸æœ‰åŒäº‹â€œä¸è¾è€Œåˆ«â€ï¼Œä¸ºäº†å·¥ä½œçš„æ­£å¸¸æ¨è¿›ï¼Œå›¢é˜Ÿå†…è¾¾æˆäº†æŸç§é»˜å¥‘ï¼Œè¿™ç§é»˜å¥‘å°±æ˜¯é€šè¿‡æŸä¸ªè§„åˆ™æ¥é€‰å‡ºä¸€ä¸ªåŒäº‹ï¼Œè¿™ä¸ªåŒäº‹é™¤äº†å·¥ä½œä¹‹ä½™è¿˜æœ‰é¢å¤–çœ‹çœ‹æ¯å¤©æ˜¯å¦æœ‰åŒäº‹â€œä¸è¾è€Œåˆ«â€ï¼Œå½“å‘ç°æœ‰åŒäº‹æå››ç¦»èŒæ—¶ï¼Œå°±ä¼šå»æŠŠæå››è´Ÿè´£çš„å·¥ä½œçš„å†…å®¹è¿›è¡Œæ‹†åˆ†ç»™å…¶ä»–çš„åŒäº‹è¿›è¡Œå¤„ç†ã€‚æ•´ä¸ªè¿‡ç¨‹å¤§è‡´å¦‚ä¸‹å›¾\n"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://sherlock-lin.github.io/p/%E8%AF%A6%E8%A7%A3bookkeeper%E4%B9%8Bautorecovery%E6%9C%BA%E5%88%B6/image-20231215102118251.png' />
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu12794431219067479509.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ˜Š</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">å¤æ´›å…‹-æ—</a></h1>
            <h2 class="site-description">æ¬¢è¿æ¥åˆ°ä¸€ä¸ªè¯»ä¹¦ç‹‚é­”ã€åæ‰§ç‹‚çš„åšå®¢~</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/CaiJimmy/hugo-theme-stack'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>ä¸»é¡µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>å…³äº</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>å½’æ¡£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>æœç´¢</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%8F%8B%E6%83%85%E9%93%BE%E6%8E%A5/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>å‹æƒ…é“¾æ¥</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>æš—è‰²æ¨¡å¼</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#å¼•è¨€å°æ•…äº‹">å¼•è¨€å°æ•…äº‹</a></li>
    <li><a href="#bookkeeperåŸºç¡€">bookkeeperåŸºç¡€</a></li>
    <li><a href="#autorecoveryæœºåˆ¶">autorecoveryæœºåˆ¶</a></li>
    <li><a href="#autorecoveryå¯åŠ¨æºç ">autorecoveryå¯åŠ¨æºç </a></li>
    <li><a href="#autorecoveryå·¥ä½œæºç ">autorecoveryå·¥ä½œæºç </a></li>
    <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
    <li><a href="#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/%E8%AF%A6%E8%A7%A3bookkeeper%E4%B9%8Bautorecovery%E6%9C%BA%E5%88%B6/">
                <img src="/p/%E8%AF%A6%E8%A7%A3bookkeeper%E4%B9%8Bautorecovery%E6%9C%BA%E5%88%B6/image-20231215102118251_hu183750765844973856.png"
                        srcset="/p/%E8%AF%A6%E8%A7%A3bookkeeper%E4%B9%8Bautorecovery%E6%9C%BA%E5%88%B6/image-20231215102118251_hu183750765844973856.png 800w, /p/%E8%AF%A6%E8%A7%A3bookkeeper%E4%B9%8Bautorecovery%E6%9C%BA%E5%88%B6/image-20231215102118251_hu15266597061700172477.png 1600w"
                        width="800" 
                        height="451" 
                        loading="lazy"
                        alt="Featured image of post è¯¦è§£bookkeeperä¹‹AutoRecoveryæœºåˆ¶" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/pulsar/" style="background-color: #2a9d8f; color: #fff;">
                Pulsar
            </a>
        
            <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" style="background-color: #2a9d8f; color: #fff;">
                å¤§æ•°æ®
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/%E8%AF%A6%E8%A7%A3bookkeeper%E4%B9%8Bautorecovery%E6%9C%BA%E5%88%B6/">è¯¦è§£bookkeeperä¹‹AutoRecoveryæœºåˆ¶</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2024-01-04</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 21 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="å¼•è¨€å°æ•…äº‹">å¼•è¨€å°æ•…äº‹
</h2><p>å¼ ä¸‰åœ¨ä¸€å®¶å°å‹äº’è”ç½‘å…¬å¸ä¸Šç­ï¼Œç”±äºå…¬å¸å®è¡Œçš„996ï¼Œå› æ­¤ç»å¸¸æœ‰åŒäº‹â€œä¸è¾è€Œåˆ«â€ï¼Œä¸ºäº†å·¥ä½œçš„æ­£å¸¸æ¨è¿›ï¼Œå›¢é˜Ÿå†…è¾¾æˆäº†æŸç§é»˜å¥‘ï¼Œè¿™ç§é»˜å¥‘å°±æ˜¯é€šè¿‡æŸä¸ªè§„åˆ™æ¥é€‰å‡ºä¸€ä¸ªåŒäº‹ï¼Œè¿™ä¸ªåŒäº‹é™¤äº†å·¥ä½œä¹‹ä½™è¿˜æœ‰é¢å¤–çœ‹çœ‹æ¯å¤©æ˜¯å¦æœ‰åŒäº‹â€œä¸è¾è€Œåˆ«â€ï¼Œå½“å‘ç°æœ‰åŒäº‹æå››ç¦»èŒæ—¶ï¼Œå°±ä¼šå»æŠŠæå››è´Ÿè´£çš„å·¥ä½œçš„å†…å®¹è¿›è¡Œæ‹†åˆ†ç»™å…¶ä»–çš„åŒäº‹è¿›è¡Œå¤„ç†ã€‚æ•´ä¸ªè¿‡ç¨‹å¤§è‡´å¦‚ä¸‹å›¾</p>
<img src="image-20231215102118251.png" alt="image-20231215102118251" style="zoom:50%;" />
<p>ç”±ä¸Šå›¾å¯ä»¥çœ‹åˆ°è¿™ä¸ªå…¬å¸é€šè¿‡ä¸€ä¸ªç­¾åˆ°æœ¬å’Œå·¥ä½œè¿›åº¦è¡¨æ¥å®Œæˆæ•´ä¸ªæµç¨‹ï¼Œæ¯ä¸ªåŒäº‹ä¸Šç­æ—¶éƒ½è¦åœ¨ç­¾åˆ°æœ¬ä¸Šè¿›è¡Œç­¾åˆ°ï¼Œæ¯å¤©ä¸‹ç­å‰è¦åœ¨å·¥ä½œè¿›åº¦è¡¨ä¸ŠåŒæ­¥ä»Šå¤©çš„å·¥ä½œè¿›å±•ï¼›ä¾‹å¦‚ä»Šå¤©æå››â€œä¸è¾è€Œåˆ«â€æºœäº†ï¼Œå¼ ä¸‰åœ¨ç­¾åˆ°æœ¬ä¸Šçœ‹åˆ°æå››æ²¡æœ‰ç­¾åˆ°è®°å½•ï¼Œå°±åˆ¤å®šè¿™å®¶ä¼™ä¸å¹²äº†åŒæ—¶åœ¨å·¥ä½œè¿›åº¦è¡¨ä¸­æŠŠæå››çš„ä»»åŠ¡è¿›è¡Œæ‹†åˆ†ç»™å¤§ç‹—å’ŒäºŒç‹—æ¥åš&hellip;</p>
<p>é€šè¿‡ä¸Šé¢çš„æ•…äº‹ä¼šå‘ç°æœ‰å‡ ä¸ªé—®é¢˜</p>
<ul>
<li>å¼ ä¸‰æ˜¯é€šè¿‡ä»€ä¹ˆè§„åˆ™è¢«é€‰æˆâ€œç›‘ç£è€…â€çš„ï¼Ÿ</li>
<li>å¦‚æœå¼ ä¸‰ä¹Ÿä¸è¾è€Œåˆ«å‘¢ï¼Ÿ</li>
<li>ä¸ºå•¥è¦é€šè¿‡ç­¾åˆ°æœ¬çš„æ–¹å¼ï¼Œè€Œä¸æ˜¯å¼ ä¸‰ç›´æ¥å»æŒ¨ä¸ªæŒ¨ä¸ªçœ‹ï¼Ÿ</li>
<li>&hellip;.</li>
</ul>
<p>å’±ä»¬å¯ä»¥å¸¦ç€è¿™äº›ç§ç§å¿ƒé‡Œçš„ç–‘æƒ‘çœ‹ä¸‹é¢çš„æ–‡ç« ï¼Œè¿™ä¸ªæ•…äº‹å…¶å®æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼å­˜å‚¨ç»„ä»¶çš„é›å½¢ï¼Œåˆšåˆšæ‰€è®¨è®ºçš„é‚£äº›é—®é¢˜ä¹Ÿæ˜¯è¿™äº›ç»„ä»¶æ‰€ä¼šé‡åˆ°çš„ä¸”å¤§éƒ¨åˆ†éƒ½æ˜¯æœ‰è§£æ³•çš„ï¼Œæ‰€ä»¥å’±ä»¬æ¥ä¸‹æ¥å°±æ¥çœ‹çœ‹bookkeeperè¿™ä¸ªåˆ†å¸ƒå¼å­˜å‚¨ç»„ä»¶æ˜¯å¦‚ä½•è§£å†³ä¸Šè¿°é—®é¢˜çš„</p>
<h2 id="bookkeeperåŸºç¡€">bookkeeperåŸºç¡€
</h2><p>â€œç¡¬ä»¶æ— æ³•ä¿è¯ä¸æ•…éšœâ€ï¼Œåœ¨è¿™ä¸ªå¤§å‰æä¸‹ï¼Œæ‰€æœ‰è¿è¡Œåœ¨ç¡¬ä»¶ä¸Šçš„å­˜å‚¨ç»„ä»¶éƒ½ä¸€å®šä¼šåšä¸€ä»¶å¾ˆé‡è¦çš„äº‹æƒ…ï¼Œè¿™ä»¶äº‹å°±æ˜¯æ•°æ®æ¢å¤ï¼Œè¦ä¹ˆæ˜¯åœ¨ç»„ä»¶å†…éƒ¨æ¥åšï¼Œè¦ä¹ˆæ˜¯åœ¨ç»„ä»¶å¤–éƒ¨æ¥åšã€‚</p>
<p>bkæ˜¯ä¸€ä¸ªå…·æœ‰å®¹é”™çš„åˆ†å¸ƒå¼å­˜å‚¨ç»„ä»¶ï¼ŒåŒä¸€ä»½æ•°æ®ä¼šæœ‰å¤šä¸ªå‰¯æœ¬ï¼Œåˆ†åˆ«å­˜åœ¨å¤šä¸ªbookieä¸­æ¥æä¾›å®¹é”™ä¿è¯ï¼Œé‚£ä¹ˆå½“ä¸€å°bookieä¸å¯ç”¨æ—¶ï¼Œå…¶ä¸Šé¢ä¿å­˜çš„æ•°æ®éƒ½å°‘äº†ä¸€ä¸ªå‰¯æœ¬ï¼Œå¦‚æœä¸è¿›è¡Œæ•°æ®æ¢å¤/å¤åˆ¶çš„è¯å†æœ‰å…¶ä»–çš„bookieä¸å¯ç”¨å°±å¾ˆå®¹æ˜“é€ æˆæ•°æ®çš„ä¸¢å¤±ã€‚å› æ­¤bkè‡ªèº«å†…éƒ¨æä¾›äº†æ•°æ®æ¢å¤çš„æœºåˆ¶ï¼Œä»Šå¤©é€šç¯‡å¤§è®ºéƒ½æ˜¯å›´ç»•bkçš„è¿™ä¸ªæœºåˆ¶è¿›è¡Œå±•å¼€çš„</p>
<p>æ•°æ®æ¢å¤ä¸€èˆ¬åˆ†ä¸ºæ‰‹åŠ¨å’Œè‡ªåŠ¨ï¼ŒbkåŒæ—¶æ”¯æŒè¿™ä¸¤ç§æ–¹å¼ï¼Œæ¥ä¸‹æ¥å°±çœ‹çœ‹å…·ä½“æ€ä¹ˆæ“ä½œçš„</p>
<p><strong>æ‰‹åŠ¨æ¢å¤</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bin/bookkeeper shell recover 192.168.1.10:3181  æŒ‡å®šbookieæœºå™¨æ¥æ¢å¤
</span></span><span class="line"><span class="cl">bin/bookkeeper shell recover 192.168.1.10:3181 --ledger ledgerID æŒ‡å®šbookieæœºå™¨ä¸Šçš„æŸä¸ªledgerIdè¿›è¡Œæ¢å¤
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨æ‰§è¡Œæ‰‹åŠ¨æ¢å¤æ—¶ï¼Œä¼šå‘ç”Ÿä»¥ä¸‹å››ä¸ªæ­¥éª¤</p>
<ol>
<li>å®¢æˆ·ç«¯ä»zookeeperè¯»å–Ledgerä¿¡æ¯</li>
<li>æ ¹æ®Ledgerä¿¡æ¯ç¡®å®šéœ€è¦åšæ•°æ®å¤åˆ¶çš„Ledger(æ ¹æ®Ledgerä¸­å­˜æœ‰è¢«å“ªäº›bookieå­˜å‚¨çš„å…ƒä¿¡æ¯æ¥ç¡®å®š)</li>
<li>åœ¨å®¢æˆ·ç«¯å¯åŠ¨ä¸€ä¸ªåšæ•°æ®æ¢å¤çš„è¿›ç¨‹ï¼Œé’ˆå¯¹éœ€è¦åšæ•°æ®å¤åˆ¶çš„Ledgerè¿›è¡Œæ•°æ®æ¢å¤</li>
<li>ä¸€æ—¦æ‰€æœ‰Ledgerè¢«æ ‡è®°ä¸ºå…¨å‰¯æœ¬äº†ï¼Œåˆ™æ¢å¤åŠ¨ä½œå®Œæˆ</li>
</ol>
<p><strong>è‡ªåŠ¨æ¢å¤</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">bin</span><span class="o">/</span><span class="n">bookkeeper</span><span class="w"> </span><span class="n">autorecovery</span><span class="w"> </span><span class="n">bookie</span><span class="w"> </span><span class="n">é›†ç¾¤å¼€å¯è‡ªåŠ¨æ¢å¤æœºåˆ¶</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">bin</span><span class="o">/</span><span class="n">bookkeeper</span><span class="w"> </span><span class="n">shell</span><span class="w"> </span><span class="n">autorecovery</span><span class="w"> </span><span class="o">-</span><span class="n">disable</span><span class="w"> </span><span class="n">å…³é—­è‡ªåŠ¨æ¢å¤æœºåˆ¶</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">bin</span><span class="o">/</span><span class="n">bookkeeper</span><span class="w"> </span><span class="n">shell</span><span class="w"> </span><span class="n">autorecovery</span><span class="w"> </span><span class="o">-</span><span class="n">enable</span><span class="w"> </span><span class="n">å…³é—­æ¢å¤åå†é‡æ–°å¼€å¯</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>é™¤äº†é€šè¿‡æŒ‡ä»¤çš„æ–¹å¼å¯åŠ¨ï¼Œbkè¿˜æ”¯æŒé…ç½®çš„æ–¹å¼ï¼Œåªéœ€è¦åœ¨bookieèŠ‚ç‚¹é…ç½®autoRecoveryDaemonEnabledä¸ºfalseï¼Œè¿™ä¸ªbookieèŠ‚ç‚¹åœ¨å¯åŠ¨çš„æ—¶å€™ä¹ŸåŒæ ·ä¼šå¯åŠ¨autorecoveryæœåŠ¡</p>
<h2 id="autorecoveryæœºåˆ¶">autorecoveryæœºåˆ¶
</h2><p><em>ä¸Šä¸€ç« èŠ‚è®²äº†æ€ä¹ˆä½¿ç”¨ï¼Œæœ¬ç« èŠ‚ä¸»è¦è®²æ˜autorecoveryè¿™ä¸ªæœºåˆ¶</em></p>
<p>è‡ªåŠ¨æ¢å¤æœºåˆ¶ä¸­æœ‰ä¸¤ä¸ªè§’è‰²Auditorå’Œreplication workerï¼Œåœ¨å¯åŠ¨è‡ªåŠ¨æ¢å¤æœºåˆ¶åï¼Œä¼šåœ¨æ¯ä¸ªbookieå®ä¾‹ä¸­å¯åŠ¨è¿™ä¸¤ä¸ªè§’è‰²</p>
<p><strong>Auditor</strong></p>
<p>bké›†ç¾¤ä¸­çš„Auditorä»¬ä¼šé€šè¿‡zookeeperé€‰ä¸¾äº§ç”Ÿä¸€ä½leaderï¼Œè¿™ä¸ªleaderè´Ÿè´£ç›‘å¬  zookeeper /ledgers/available èŠ‚ç‚¹å˜åŒ–æƒ…å†µæ¥åˆ¤å®šæ˜¯å¦è¦åšæ•°æ®æ¢å¤åŠ¨ä½œï¼Œå› ä¸ºæ‰€æœ‰èŠ‚ç‚¹å¯åŠ¨éƒ½ä¼šæ³¨å†Œåœ¨ä¸Šé¢ï¼Œå¦‚æœæœ‰æœåŠ¡ä¸å¯ç”¨ç”±äºzookeeperçš„ä¸´æ—¶ç›®å½•æœºåˆ¶ï¼Œä¼šè‡ªåŠ¨åˆ é™¤åœ¨æ­¤ç›®å½•ä¸‹è‡ªå·±èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œå› æ­¤leaderé€šè¿‡watchæœºåˆ¶å¯ä»¥è½»æ¾æ„ŸçŸ¥åˆ°æœ‰èŠ‚ç‚¹ä¸å¯ç”¨ï¼Œå½“Auditor leaderæ„ŸçŸ¥åˆ°æœ‰èŠ‚ç‚¹ä¸å¯ç”¨æ—¶ï¼Œä¼šå°†æ­¤bookieæ‰€è´Ÿè´£çš„æ‰€æœ‰LedgeråŠ åœ¨zookeeper /ledgers/underreplicated è·¯å¾„ä¸‹ï¼Œé€šè¿‡è¿™ç§æ–¹å¼é€šçŸ¥replication workeråšæ•°æ®æ¢å¤è¿‡ç¨‹</p>
<p><strong>replication worker</strong></p>
<p>æ¯ä¸ªreplication workeréƒ½ä¼šç›‘å¬  /ledgers/underreplicated åœ°å€ï¼Œåœ¨ç›‘å¬åˆ°æœ‰æ•°æ®æ¢å¤ä»»åŠ¡æ—¶ï¼Œä¼šåœ¨ /ledgers/underreplication/locksä¸‹æ·»åŠ é”ä»è€Œé¿å…å¹¶å‘é—®é¢˜ï¼›å¦‚æœåœ¨å¼€å§‹æ¢å¤å‰å‘ä¸‹å½“å‰Ledgerçš„Fragmentè¿˜å¤„äºå†™å…¥ä¸­çš„çŠ¶æ€ï¼Œreplication workerä¼šå…ˆå°è¯•ç­‰å¾…å®ƒå†™å®Œå†åšæ•°æ®æ¢å¤åŠ¨ä½œï¼Œä½†å¦‚æœç­‰äº†ä¸€æ®µæ—¶é—´è¿˜æ²¡å†™å®Œä¼šé€šè¿‡Fenceæœºåˆ¶å¤„ç†å†åšå¤åˆ¶ï¼ŒåŒæ—¶å¼€å¯ä¸€ä¸ªæ–°çš„Fragmentç»™å®¢æˆ·ç«¯åšæ•°æ®çš„ç»§ç»­å†™å…¥</p>
<p><strong>å¯åŠ¨å·¥ä½œæµç¨‹</strong></p>
<img src="image-20240920120129459.png" alt="image-20240920120129459" style="zoom:50%;" />
<p>å‚ç…§ä¸Šå›¾ï¼Œåœ¨æœåŠ¡å™¨èŠ‚ç‚¹ä¸Šæ‰§è¡Œ<code>bin/bookkeeper autorecovery bookie</code>åä¼šå‘ç”Ÿä»¥ä¸‹æ­¥éª¤</p>
<ol>
<li>é€šè¿‡exec shellæŒ‡ä»¤è°ƒç”¨æ“ä½œç³»ç»Ÿæ‹‰èµ·AutoRecoveryMain è¿™ä¸ªJavaè¿›ç¨‹</li>
<li>AutoRecoveryMainè¿›ç¨‹å¯åŠ¨æ—¶ä¼šåŒæ—¶å¯åŠ¨Auditorçº¿ç¨‹å’ŒReplicationWorkerçº¿ç¨‹ï¼Œç”±äºç¯å¢ƒä¸­å¯èƒ½ä¼šå¯åŠ¨å¤šä¸ªAutoRecoveryMainè¿›ç¨‹æ¥åšHAé«˜å¯ç”¨ï¼Œå› æ­¤å¤šä¸ªAuditorçº¿ç¨‹ä¼šé€šè¿‡zookeeperé€‰ä¸¾æ¥äº§ç”Ÿä¸€ä¸ªAuditor Leader</li>
<li>ç”±äºbookieé›†ç¾¤ç”¨zookeeperæ¥åšé›†ç¾¤æ„ŸçŸ¥ï¼Œå› æ­¤Auditor Leaderåªéœ€è¦é€šè¿‡watchç›‘å¬zookeeperä¸Š bookieæ‰€æ³¨å†Œçš„åœ°å€å°±èƒ½æ„ŸçŸ¥åˆ°æ˜¯å¦æœ‰bookieèŠ‚ç‚¹ä¸å¯ç”¨ï¼›å½“bookieèŠ‚ç‚¹ä¸å¯ç”¨æ—¶ä¸€èˆ¬å°±ä¸ä¼šä¸ŠæŠ¥å¿ƒè·³ç»™zookeeperï¼Œzookeeperå°±ä¼šå°†è¯¥èŠ‚ç‚¹åˆ›å»ºçš„ä¸´æ—¶ç›®å½•è¿›è¡Œåˆ é™¤å¹¶å‘ŠçŸ¥æ·»åŠ watchçš„Auditor Leader</li>
<li>Auditor Leaderæ”¶åˆ°é€šçŸ¥åä¼šå»zookeeperæŸ¥è¯¢è¯¥ä¸å¯ç”¨bookieæ‰€è´Ÿè´£çš„Ledgeråˆ—è¡¨ï¼Œç†è®ºä¸Šè¿™äº›Ledgeréƒ½æ˜¯éœ€è¦åšæ•°æ®æ¢å¤çš„ï¼Œå› æ­¤ä¼šå°†å®ƒä»¬æ”¾åœ¨zookeeperçš„/ledgers/underreplicated ç›®å½•ä¸‹æ¥é€šçŸ¥ReplicationWorker</li>
<li>ReplicationWorkeré€šè¿‡watchç›‘å¬åˆ°æ­¤ç›®å½•æœ‰éœ€è¦åšæ•°æ®æ¢å¤çš„Ledgeråï¼Œä¼šå…ˆåœ¨zkåŠ é”å†è¿›è¡Œæ•°æ®æ¢å¤é€»è¾‘ï¼›é€šè¿‡å°†Ledgeråˆ’åˆ†ä¸ºå¤šä¸ªFragmentæ¥è½®è®­è¿›è¡Œæ•°æ®æ¢å¤ï¼Œé€šè¿‡è¯»å–å…¶ä»–æ­£å¸¸bookieä¸Šè¯¥Ledgerçš„æ•°æ®å¹¶å†™åˆ°å…¶ä»–æ²¡æœ‰è¯¥æ•°æ®çš„bookieçš„èŠ‚ç‚¹ä¸Šä»è€Œä¿è¯æ¯ä»½æ•°æ®éƒ½æœ‰å¤šä¸ªå‰¯æœ¬ï¼Œç›´åˆ°å°†/ledgers/underreplicated ä¸‹çš„æ‰€æœ‰Ledgerè¿›è¡Œå¤åˆ¶å®Œï¼Œæœ¬æ¬¡ autorecoveryå°±ç®—å®Œæˆäº†ã€‚è€ŒAuditorçº¿ç¨‹å’ŒReplicationWorkerçº¿ç¨‹ä¼šä¸åœçš„ç›‘å¬zookeeperç›´åˆ°ä¸‹ä¸€ä¸ªbookieèŠ‚ç‚¹ä¸å¯ç”¨</li>
</ol>
<p>é€šè¿‡æ­¤æœºåˆ¶ç»™bookkeeperæé«˜äº†ç¨³å®šæ€§ä»¥åŠé«˜å¯ç”¨èƒ½åŠ›ï¼Œåœ¨æœ‰ä¸ªåˆ«èŠ‚ç‚¹æŒ‚æ‰çš„æ—¶å€™ä¾ç„¶èƒ½è‡ªåŠ¨åšåˆ°æ•°æ®å®Œå¤‡ä¸ä¸¢ï¼Œè¿™ç§è®¾è®¡æ˜¯ä¸€ä¸ªæˆç†Ÿçš„ç»„ä»¶è¯¥å…·å¤‡çš„èƒ½åŠ›</p>
<h2 id="autorecoveryå¯åŠ¨æºç ">autorecoveryå¯åŠ¨æºç 
</h2><p>æºç ä¸»è¦åˆ† å¯åŠ¨æµç¨‹ä»¥åŠå·¥ä½œæµç¨‹è¿›è¡Œè®²è§£ï¼ŒåŒæ—¶åœ¨è¿™é‡Œç»™éœ€è¦é˜…è¯»çš„æœ‹å‹æä¾›ä¸€ä¸ªå¯èƒ½ä¼šç”¨ä¸Šçš„â€œè¯å…¸â€</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">AutoRecoveryMainæ ¸å¿ƒç±», ä¸»è¦è´Ÿè´£å¯åŠ¨AutoRecoveryæœåŠ¡
</span></span><span class="line"><span class="cl">AutoRecoveryServiceæ ¸å¿ƒç±»ï¼Œä¸»è¦è´Ÿè´£AutoRecoveryç›¸å…³çš„æœåŠ¡
</span></span><span class="line"><span class="cl">LedgerManager å¯¹å¤–æä¾›ä¸€ä¸ªç®¡ç†ledgerçš„apiï¼Œå¯¹å†…è´Ÿè´£å¦‚ä½•å°†ledgerçš„å…ƒæ•°æ®å­˜å‚¨åœ¨kvå­˜å‚¨ä¸Šã€‚æä¾›å¢åˆ ã€è¯»å†™ã€æ³¨å†Œ/æ³¨é”€å…­ä¸ªæ ¸å¿ƒæ¥å£
</span></span><span class="line"><span class="cl">AbstractZkLedgerManager æŠ½è±¡ç±»
</span></span><span class="line"><span class="cl">LedgerIdGeneratorï¼šåŸºäºzkå®ç°å…¨å±€å”¯ä¸€é€’å¢çš„ledgerId
</span></span><span class="line"><span class="cl">ZkLedgerUnderreplicationManagerï¼šç®¡ç†æœªå®Œæˆå¤åˆ¶çš„Ledger
</span></span><span class="line"><span class="cl">ZkLedgerAuditorManagerï¼šç®¡ç†Auditor
</span></span><span class="line"><span class="cl">ReplicationWorkerï¼šè´Ÿè´£ä»ZkLedgerUnderreplicationManagerä¸­è·å–æœªå®Œæˆå¤åˆ¶çš„Ledgerå¹¶è¿›è¡Œå¤åˆ¶ï¼Œæ¯éš”rwRereplicateBackoffMsè§¦å‘ä¸€æ¬¡
</span></span><span class="line"><span class="cl">LedgerFragmentï¼šç»„æˆLedgerçš„å•å…ƒï¼Œä¹Ÿæ˜¯æ¢å¤å¤åˆ¶çš„å•å…ƒ
</span></span><span class="line"><span class="cl">EmbeddedServerï¼šå¯åŠ¨bkå®ä¾‹çš„èŠ‚ç‚¹
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»ç°åœ¨å¼€å§‹è·Ÿè¸ªå¯åŠ¨çš„æºç ï¼Œåœ¨å®¢æˆ·ç«¯æ‰§è¡Œ <code>bin/bookkeeper autorecovery bookie</code> åä¼šèµ°åˆ° bookkeeper/bin/bookkeeper è¿™ä¸ªè„šæœ¬ä¸‹é¢çš„è¿™è¡Œé€»è¾‘</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">COMMAND</span><span class="si">}</span> <span class="o">==</span> <span class="s2">&#34;autorecovery&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  <span class="nb">exec</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">JAVA</span><span class="si">}</span><span class="s2">&#34;</span> <span class="si">${</span><span class="nv">OPTS</span><span class="si">}</span> <span class="si">${</span><span class="nv">JMX_ARGS</span><span class="si">}</span> org.apache.bookkeeper.replication.AutoRecoveryMain --conf <span class="si">${</span><span class="nv">BOOKIE_CONF</span><span class="si">}</span> <span class="nv">$@</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é€»è¾‘éå¸¸æ¸…æ™°ï¼Œå…¶å®å°±æ˜¯é€šè¿‡shellå¯åŠ¨AutoRecovery è¿™æ ·ä¸€ä¸ªç‹¬ç«‹çš„Javaè¿›ç¨‹ï¼Œä¸“é—¨è´Ÿè´£åšæ•…éšœæ•°æ®æ¢å¤ã€‚JVMä¼šä»å¯åŠ¨ç±»çš„mainæ–¹æ³•è¿›è¡Œå¼•å¯¼æ‰§è¡Œï¼Œå› æ­¤å’±ä»¬æ¥ä¸‹æ¥ä»AutoRecoveryMainçš„mainæ–¹æ³•ä½œä¸ºå…¥å£æ¥çœ‹çœ‹åé¢ä¼šå‘ç”Ÿå“ªäº›äº‹æƒ…</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//è°ƒç”¨çœŸæ­£æ‰§è¡Œçš„æ–¹æ³•ï¼Œå¼€æºé¡¹ç›®ä¸­çœŸæ­£æ‰§è¡ŒæŸä¸ªæ“ä½œä¼šä»¥doå‰ç¼€æ¥è¿›è¡Œä¿®é¥°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">retCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">doMain</span><span class="p">(</span><span class="n">args</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">doMain</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ServerConfiguration</span><span class="w"> </span><span class="n">conf</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          	</span><span class="c1">//æ ¹æ®shellå¯åŠ¨å‘½ä»¤ä¸­æŒ‡å®šçš„é…ç½®åœ°å€åŠ è½½æˆé…ç½®å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">conf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseArgs</span><span class="p">(</span><span class="n">args</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IllegalArgumentException</span><span class="w"> </span><span class="n">iae</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LifecycleComponent</span><span class="w"> </span><span class="n">server</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          	</span><span class="c1">//æ„å»ºAutoRecoveryServerå¯¹è±¡ï¼Œæ¯”è¾ƒé‡è¦çš„æ–¹æ³•</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buildAutoRecoveryServer</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">BookieConfiguration</span><span class="p">(</span><span class="n">conf</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          	</span><span class="c1">//å¯åŠ¨AutoRecoveryServerå¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ComponentStarter</span><span class="p">.</span><span class="na">startComponent</span><span class="p">(</span><span class="n">server</span><span class="p">).</span><span class="na">get</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">ie</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ExitCode</span><span class="p">.</span><span class="na">OK</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡è¿™é‡Œå¯ä»¥å‘ç°AutoRecoveryMainçš„mainæ–¹æ³•åªæ˜¯åšä¸€ä¸ªå¼•å¯¼çš„åŠ¨ä½œï¼Œæœ€ç»ˆå¯åŠ¨çš„æ˜¯AutoRecoveryServerå¯¹è±¡ã€‚å› æ­¤è®©æˆ‘ä»¬æ·±å…¥çœ‹çœ‹è¿™ä¸ªæœåŠ¡çš„æ„é€ ä»¥åŠå¯åŠ¨çš„æµç¨‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">LifecycleComponentStack</span><span class="w"> </span><span class="nf">buildAutoRecoveryServer</span><span class="p">(</span><span class="n">BookieConfiguration</span><span class="w"> </span><span class="n">conf</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LifecycleComponentStack</span><span class="p">.</span><span class="na">Builder</span><span class="w"> </span><span class="n">serverBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LifecycleComponentStack</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">withName</span><span class="p">(</span><span class="s">&#34;autorecovery-server&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 1. åˆ›å»ºStatsProviderServiceå¯¹è±¡ï¼Œä¸»è¦ç”¨æ¥è®°å½•AutoRecoveryæœåŠ¡çš„å„é¡¹æŒ‡æ ‡çŠ¶æ€</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">StatsProviderService</span><span class="w"> </span><span class="n">statsProviderService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StatsProviderService</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 2. é€šè¿‡æ„é€ å‡½æ•°çš„æ–¹å¼åˆ›å»ºAutoRecoveryServiceå¯¹è±¡ï¼Œè¿™æ˜¯æ ¸å¿ƒçš„ä»£ç </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">AutoRecoveryService</span><span class="w"> </span><span class="n">autoRecoveryService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AutoRecoveryService</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span><span class="w"> </span><span class="n">rootStatsLogger</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 3. åˆ›å»ºBKHttpServiceProviderå¯¹è±¡ï¼Œä¸»è¦ç”¨æ¥å¯¹å¤–æä¾›httpæœåŠ¡ï¼Œæ”¯æŒé€šè¿‡httpæ–¹å¼è¯»å–å†…éƒ¨çŠ¶æ€ä¿¡æ¯ç­‰</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">conf</span><span class="p">.</span><span class="na">getServerConf</span><span class="p">().</span><span class="na">isHttpServerEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">BKHttpServiceProvider</span><span class="w"> </span><span class="n">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BKHttpServiceProvider</span><span class="p">.</span><span class="na">Builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">.</span><span class="na">setAutoRecovery</span><span class="p">(</span><span class="n">autoRecoveryService</span><span class="p">.</span><span class="na">getAutoRecoveryServer</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">.</span><span class="na">setServerConfiguration</span><span class="p">(</span><span class="n">conf</span><span class="p">.</span><span class="na">getServerConf</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">.</span><span class="na">setStatsProvider</span><span class="p">(</span><span class="n">statsProviderService</span><span class="p">.</span><span class="na">getStatsProvider</span><span class="p">()).</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">HttpService</span><span class="w"> </span><span class="n">httpService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HttpService</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span><span class="w"> </span><span class="n">conf</span><span class="p">,</span><span class="w"> </span><span class="n">rootStatsLogger</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">						</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">serverBuilder</span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>å†çœ‹AutoRecoveryServiceçš„æ„é€ å‡½æ•°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">AutoRecoveryService</span><span class="p">(</span><span class="n">BookieConfiguration</span><span class="w"> </span><span class="n">conf</span><span class="p">,</span><span class="w"> </span><span class="n">StatsLogger</span><span class="w"> </span><span class="n">statsLogger</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">NAME</span><span class="p">,</span><span class="w"> </span><span class="n">conf</span><span class="p">,</span><span class="w"> </span><span class="n">statsLogger</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//é€šè¿‡æ„é€ å‡½æ•°åˆ›å»ºAutoRecoveryMainï¼ŒAutoRecoveryMainæ˜¯AutoRecoveryServiceçš„æˆå‘˜å˜é‡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//è¿›å…¥çœ‹çœ‹å®ƒçš„å®ç°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AutoRecoveryMain</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">conf</span><span class="p">.</span><span class="na">getServerConf</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">statsLogger</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">AutoRecoveryMain</span><span class="p">(</span><span class="n">ServerConfiguration</span><span class="w"> </span><span class="n">conf</span><span class="p">,</span><span class="w"> </span><span class="n">StatsLogger</span><span class="w"> </span><span class="n">statsLogger</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">InterruptedException</span><span class="p">,</span><span class="w"> </span><span class="n">KeeperException</span><span class="p">,</span><span class="w"> </span><span class="n">UnavailableException</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">CompatibilityException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//åˆ›å»ºAuditorElectorå¯¹è±¡ï¼Œè´Ÿè´£é€‰ä¸¾äº§ç”ŸAuditor Leader</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">auditorElector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AuditorElector</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">BookieImpl</span><span class="p">.</span><span class="na">getBookieId</span><span class="p">(</span><span class="n">conf</span><span class="p">).</span><span class="na">toString</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">conf</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">bkc</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">statsLogger</span><span class="p">.</span><span class="na">scope</span><span class="p">(</span><span class="n">AUDITOR_SCOPE</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//åˆ›å»ºReplicationWorkerå¯¹è±¡ï¼Œè´Ÿè´£åšæ•°æ®çš„æ‹·è´å·¥ä½œ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">replicationWorker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplicationWorker</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">conf</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">bkc</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kc">false</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">statsLogger</span><span class="p">.</span><span class="na">scope</span><span class="p">(</span><span class="n">REPLICATION_WORKER_SCOPE</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">deathWatcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AutoRecoveryDeathWatcher</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>æœåŠ¡æ„é€ çš„é€»è¾‘å·®ä¸å¤šå°±è·Ÿåˆ°è¿™äº†ï¼Œæˆ‘ä»¬çŸ¥é“æœ€ç»ˆæ˜¯ä¸ºäº†åˆ›å»ºAuditorElectorå’ŒReplicationWorkerè¿™ä¸¤ä¸ªå¯¹è±¡å°±å¤Ÿäº†ã€‚æœåŠ¡å¯åŠ¨è¿™å—ä»ä¸Šé¢çš„ <code>ComponentStarter.startComponent(server).get();</code> è¿›è¡Œè·Ÿè¸ª</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">startComponent</span><span class="p">(</span><span class="n">LifecycleComponent</span><span class="w"> </span><span class="n">component</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//è°ƒç”¨startæ–¹æ³•ï¼Œè¿™é‡Œæ¶‰åŠä¸Šé‡‡ç”¨äº†æ¨¡ç‰ˆæ–¹æ³•è®¾è®¡æ¨¡å¼ä»¥åŠé—­åŒ…ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯å°±æ˜¯è°ƒç”¨åˆ›å»ºçš„</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//StatsProviderServiceã€	AutoRecoveryServiceã€HttpServiceè¿™ä¸‰ä¸ªæœåŠ¡çš„doStartæ–¹æ³•</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">component</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doStart</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//è¿˜æ˜¯è°ƒçš„AutoRecoveryMainæ–¹æ³•çš„startæ–¹æ³•</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">main</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">start</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//å¯åŠ¨auditorElectoræœåŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">auditorElector</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//å¯åŠ¨replicationWorkeræœåŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">replicationWorker</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">deathWatcher</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ç»“åˆä¸Šé¢çš„å¯ä»¥å‘ç°AutoRecoveryçš„å¯åŠ¨æœ¬è´¨ä¸Šå°±æ˜¯å¯åŠ¨AuditorElectorå’ŒReplicationWorkerè¿™ä¸¤ä¸ªæœåŠ¡ï¼Œå› æ­¤æ¥ä¸‹æ¥å’±ä»¬å°±æ¥çœ‹çœ‹è¿™ä¸¤ä¸ªæœåŠ¡çš„startè¿‡ç¨‹ï¼Œå…ˆæ¥çœ‹çœ‹AuditorElector</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">start</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">running</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//æäº¤é€‰ä¸¾ä»»åŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">submitElectionTask</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Future</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">submitElectionTask</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Runnable</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Runnable</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">									</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="c1">//åˆ›å»ºä¸€ä¸ªAuditorå¯¹è±¡å¹¶è¿›è¡Œå¯åŠ¨</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="n">auditor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Auditor</span><span class="p">(</span><span class="n">bookieId</span><span class="p">,</span><span class="w"> </span><span class="n">conf</span><span class="p">,</span><span class="w"> </span><span class="n">bkc</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">statsLogger</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="n">auditor</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          	</span><span class="c1">//å¼‚æ­¥æ‰§è¡Œä»¥ä¸Šé€»è¾‘</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">executor</span><span class="p">.</span><span class="na">submit</span><span class="p">(</span><span class="n">r</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RejectedExecutionException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨è¿™é‡Œå…¶å®å°±æ˜¯å¯¹Auditorå¯¹è±¡è¿›è¡Œåˆå§‹åŒ–ä»¥åŠå¯åŠ¨ï¼Œå†è¿›ä¸€æ­¥è·Ÿè¸ª</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">Auditor</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">bookieIdentifier</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                   </span><span class="n">ServerConfiguration</span><span class="w"> </span><span class="n">conf</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                   </span><span class="n">BookKeeper</span><span class="w"> </span><span class="n">bkc</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                   </span><span class="kt">boolean</span><span class="w"> </span><span class="n">ownBkc</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                   </span><span class="n">BookKeeperAdmin</span><span class="w"> </span><span class="n">admin</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                   </span><span class="kt">boolean</span><span class="w"> </span><span class="n">ownAdmin</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                   </span><span class="n">StatsLogger</span><span class="w"> </span><span class="n">statsLogger</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">UnavailableException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//è°ƒç”¨åˆå§‹åŒ–Auditorå¯¹è±¡é€»è¾‘</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">initialize</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span><span class="w"> </span><span class="n">bkc</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">ServerConfiguration</span><span class="w"> </span><span class="n">conf</span><span class="p">,</span><span class="w"> </span><span class="n">BookKeeper</span><span class="w"> </span><span class="n">bkc</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">UnavailableException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">LedgerManagerFactory</span><span class="w"> </span><span class="n">ledgerManagerFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bkc</span><span class="p">.</span><span class="na">getLedgerManagerFactory</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ledgerManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ledgerManagerFactory</span><span class="p">.</span><span class="na">newLedgerManager</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">bookieLedgerIndexer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BookieLedgerIndexer</span><span class="p">(</span><span class="n">ledgerManager</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">ledgerUnderreplicationManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ledgerManagerFactory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">.</span><span class="na">newLedgerUnderreplicationManager</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">lostBookieRecoveryDelayBeforeChange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">ledgerUnderreplicationManager</span><span class="p">.</span><span class="na">getLostBookieRecoveryDelay</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">CompatibilityException</span><span class="w"> </span><span class="n">ce</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">						</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>çœ‹å®Œäº†åˆå§‹åŒ–é€»è¾‘ï¼Œå†ç»§ç»­çœ‹ä¸‹Auditorçš„å¯åŠ¨é€»è¾‘</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">start</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;I&#39;m starting as Auditor Bookie. ID: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">bookieIdentifier</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          	</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              	</span><span class="c1">//1. ç›‘å¬bookieå˜æ›´äº‹ä»¶ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯åœ¨zk /ledgers/available ç›®å½•ä¸‹å¢åŠ watchç›‘å¬èŠ‚ç‚¹çš„å˜åŠ¨</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              	</span><span class="c1">//è¿™é‡Œè¿˜ä¼šç›‘å¬ åªè¯»bookie èŠ‚ç‚¹çš„å˜åŠ¨</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">watchBookieChanges</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              	</span><span class="c1">//ä»zkè·å–å¤„äºå¯ç”¨çš„bkèŠ‚ç‚¹åˆ—è¡¨</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">knownBookies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getAvailableBookies</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">BKException</span><span class="w"> </span><span class="n">bke</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              	</span><span class="c1">//1. åœ¨æ„ŸçŸ¥åˆ°æœ‰bookieèŠ‚ç‚¹ä¸å¯ç”¨æ—¶å›è°ƒLostBookieRecoveryDelayChangedCbè¿›è¡Œé€»è¾‘å¤„ç†</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">this</span><span class="p">.</span><span class="na">ledgerUnderreplicationManager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">.</span><span class="na">notifyLostBookieRecoveryDelayChanged</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">LostBookieRecoveryDelayChangedCb</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">UnavailableException</span><span class="w"> </span><span class="n">ue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">               </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              	</span><span class="c1">//1. æ„ŸçŸ¥åˆ°æœ‰Ledgerçš„å‰¯æœ¬å°‘æ—¶è§¦å‘ï¼Œè·Ÿä¸Šé¢ä¸€æ ·ä¹Ÿæ˜¯é€šè¿‡å›è°ƒæ–¹å¼è¿›è¡Œå¤„ç†</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">this</span><span class="p">.</span><span class="na">ledgerUnderreplicationManager</span><span class="p">.</span><span class="na">notifyUnderReplicationLedgerChanged</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">new</span><span class="w"> </span><span class="n">UnderReplicatedLedgersChangedCb</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">UnavailableException</span><span class="w"> </span><span class="n">ue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">scheduleBookieCheckTask</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          	</span><span class="c1">//å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ£€æŸ¥Ledgerçš„çŠ¶æ€</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">scheduleCheckAllLedgersTask</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">schedulePlacementPolicyCheckTask</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">scheduleReplicasCheckTask</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™äº›å°±æ˜¯Auditorå¯åŠ¨çš„é€»è¾‘ï¼Œæ¥ä¸‹æ¥å†çœ‹çœ‹ReplicationWorkerçš„å¯åŠ¨é€»è¾‘</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">start</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//workerThreadå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªBookieThreadå¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">workerThread</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">workerRunning</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">workerRunning</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              	</span><span class="c1">//æ ¸å¿ƒé€»è¾‘å°±æ˜¯å¾ªç¯è°ƒç”¨rereplicateæ–¹æ³•</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rereplicate</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">LOG</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&#34;failed while replicating fragments&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">waitBackOffTime</span><span class="p">(</span><span class="n">rwRereplicateBackoffMs</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     						</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;ReplicationWorker exited loop!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">rereplicate</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="p">,</span><span class="w"> </span><span class="n">BKException</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">UnavailableException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//è·å–éœ€è¦åšæ•°æ®æ¢å¤çš„Ledger</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">ledgerIdToReplicate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">underreplicationManager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">getLedgerToRereplicate</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Stopwatch</span><span class="w"> </span><span class="n">stopwatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stopwatch</span><span class="p">.</span><span class="na">createStarted</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          	</span><span class="c1">//è¿›è¡Œæ•°æ®æ¢å¤</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rereplicate</span><span class="p">(</span><span class="n">ledgerIdToReplicate</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">success</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="autorecoveryå·¥ä½œæºç ">autorecoveryå·¥ä½œæºç 
</h2><p>è¿™å—ç”±äºé€»è¾‘ç›¸å¯¹è¾ƒå¤šï¼Œå› æ­¤é’ˆå¯¹autorecoveryå·¥ä½œæµç¨‹å•ç‹¬å¼€ä¸€ç« ã€‚ç»è¿‡ä¸Šé¢æˆ‘ä»¬å¯ä»¥æ¸…æ™°çš„çŸ¥é“åœ¨ç»è¿‡å¯åŠ¨åéƒ½å‘ç”Ÿäº†å“ªäº›äº‹æƒ…ï¼Œæ¥ä¸‹æ¥å’±ä»¬çœ‹çœ‹autorecoveryçœŸæ­£å·¥ä½œçš„é€»è¾‘ã€‚åœ¨Auditor startçš„æ—¶å€™ï¼Œä¼šé€šè¿‡ç›‘å¬zookeeperæ¥æ„ŸçŸ¥æ•°æ®çš„åŠ¨æ€å˜åŒ–</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">start</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c1">//æ„ŸçŸ¥bookieèŠ‚ç‚¹ä¸‹çº¿ï¼Œå°†è¿™äº›bookieä¸Šç®¡ç†çš„Ledgeræ ‡è®°ä¸ºéœ€è¦å¤‡ä»½æ”¾åˆ°zookeeperä¸Š</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">this</span><span class="p">.</span><span class="na">ledgerUnderreplicationManager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">.</span><span class="na">notifyLostBookieRecoveryDelayChanged</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">LostBookieRecoveryDelayChangedCb</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c1">//æ„ŸçŸ¥Ledgerå‰¯æœ¬å˜åŠ¨ï¼Œç»Ÿè®¡åˆ°æŒ‡æ ‡é‡Œ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="k">this</span><span class="p">.</span><span class="na">ledgerUnderreplicationManager</span><span class="p">.</span><span class="na">notifyUnderReplicationLedgerChanged</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">new</span><span class="w"> </span><span class="n">UnderReplicatedLedgersChangedCb</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°ä¸¤ä¸ªå”¤é†’æ–¹æ³•ä¸»è¦æ˜¯é€šè¿‡watchæ„ŸçŸ¥zookeeperäº‹ä»¶ï¼Œæ‰€ä»¥å’±ä»¬ä¸»è¦çœ‹å›è°ƒç±»é‡Œé¢çš„å¤„ç†é€»è¾‘ï¼Œå…ˆçœ‹ä¸‹LostBookieRecoveryDelayChangedCbç±»</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LostBookieRecoveryDelayChangedCb</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">GenericCallback</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">operationComplete</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">rc</span><span class="p">,</span><span class="w"> </span><span class="n">Void</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Auditor</span><span class="p">.</span><span class="na">this</span><span class="p">.</span><span class="na">ledgerUnderreplicationManager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">.</span><span class="na">notifyLostBookieRecoveryDelayChanged</span><span class="p">(</span><span class="n">LostBookieRecoveryDelayChangedCb</span><span class="p">.</span><span class="na">this</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//æäº¤äº‹ä»¶å˜åŠ¨å¤„ç†ä»»åŠ¡ï¼Œè¿›å»çœ‹çœ‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Auditor</span><span class="p">.</span><span class="na">this</span><span class="p">.</span><span class="na">submitLostBookieRecoveryDelayChangedEvent</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">submitLostBookieRecoveryDelayChangedEvent</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">executor</span><span class="p">.</span><span class="na">submit</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">lostBookieRecoveryDelay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">waitIfLedgerReplicationDisabled</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">lostBookieRecoveryDelay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Auditor</span><span class="p">.</span><span class="na">this</span><span class="p">.</span><span class="na">ledgerUnderreplicationManager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">.</span><span class="na">getLostBookieRecoveryDelay</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">										</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">										</span><span class="c1">//æ ¸å¿ƒé€»è¾‘,è¿›å»çœ‹çœ‹éƒ½åšäº†äº›ä»€ä¹ˆ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">auditorBookieCheckTask</span><span class="p">.</span><span class="na">startAudit</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">auditTask</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;lostBookieRecoveryDelay has been set to {}, so rescheduling AuditTask accordingly&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">lostBookieRecoveryDelay</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">auditTask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">executor</span><span class="p">.</span><span class="na">schedule</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">auditorBookieCheckTask</span><span class="p">.</span><span class="na">startAudit</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">auditTask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">bookiesToBeAudited</span><span class="p">.</span><span class="na">clear</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">},</span><span class="w"> </span><span class="n">lostBookieRecoveryDelay</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">auditorStats</span><span class="p">.</span><span class="na">getNumBookieAuditsDelayed</span><span class="p">().</span><span class="na">inc</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">ie</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lostBookieRecoveryDelay</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">-</span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">lostBookieRecoveryDelayBeforeChange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lostBookieRecoveryDelay</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">startAudit</span><span class="p">(</span><span class="kt">boolean</span><span class="w"> </span><span class="n">shutDownTask</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          	</span><span class="c1">//çœ‹èµ·æ¥æ˜¯å¼€å§‹åšAuditorçš„ä¸»è¦ä»»åŠ¡äº†ï¼Œç»§ç»­å¾€ä¸‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">auditBookies</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">shutDownTask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">BKException</span><span class="w"> </span><span class="n">bke</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">					</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">auditBookies</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">ReplicationException</span><span class="p">.</span><span class="na">BKAuditException</span><span class="p">,</span><span class="w"> </span><span class="n">InterruptedException</span><span class="p">,</span><span class="w"> </span><span class="n">BKException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">availableBookies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getAvailableBookies</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// find lost bookies</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">knownBookies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ledgerDetails</span><span class="p">.</span><span class="na">keySet</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//é€šè¿‡ä¹‹å‰å†…å­˜ä¸­å­˜çš„bookieé›†åˆå‡å» zkå½“å‰bookieé›†åˆå³å¯å¾—å‡ºéƒ½æœ‰å“ªäº›bookieèŠ‚ç‚¹ä¸å¯ç”¨äº†</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lostBookies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CollectionUtils</span><span class="p">.</span><span class="na">subtract</span><span class="p">(</span><span class="n">knownBookies</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">availableBookies</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//å¦‚æœæœ¬æ¬¡å˜åŠ¨æ¶‰åŠåˆ°bookieèŠ‚ç‚¹ä¸å¯ç”¨ï¼Œåˆ™è°ƒç”¨handleLostBookiesAsyncæ–¹æ³•å¤„ç†ä¸å¯ç”¨çš„èŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lostBookies</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">FutureUtils</span><span class="p">.</span><span class="na">result</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">handleLostBookiesAsync</span><span class="p">(</span><span class="n">lostBookies</span><span class="p">,</span><span class="w"> </span><span class="n">ledgerDetails</span><span class="p">),</span><span class="w"> </span><span class="n">ReplicationException</span><span class="p">.</span><span class="na">EXCEPTION_HANDLER</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ReplicationException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">handleLostBookiesAsync</span><span class="p">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lostBookies</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">ledgerDetails</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;Following are the failed bookies: {},&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; and searching its ledgers for re-replication&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">lostBookies</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">FutureUtils</span><span class="p">.</span><span class="na">processList</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Lists</span><span class="p">.</span><span class="na">newArrayList</span><span class="p">(</span><span class="n">lostBookies</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          			</span><span class="c1">//çœ‹æ–¹æ³•åå¤§æ¦‚èƒ½çŒœå¾—å‡ºæ¥è®¡ç®—è¿™äº›bookieä¸Šçš„Ledgerï¼Œå¹¶é’ˆå¯¹è¿™äº›Ledgerè¿›è¡Œæ•°æ®æ¢å¤</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          			</span><span class="c1">//ç”±äºä¹‹å‰æœ‰å­˜èŠ‚ç‚¹è·ŸLedgerçš„æ˜ å°„å…³ç³»ï¼Œå› æ­¤ç›´æ¥é€šè¿‡ledgerDetailsæ˜ å°„è¡¨æ¥è·å–è¿™äº›ä¸å¯ç”¨èŠ‚ç‚¹æ‰€è´Ÿè´£çš„Ledger</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">bookieIP</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">publishSuspectedLedgersAsync</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">Lists</span><span class="p">.</span><span class="na">newArrayList</span><span class="p">(</span><span class="n">bookieIP</span><span class="p">),</span><span class="w"> </span><span class="n">ledgerDetails</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">bookieIP</span><span class="p">)),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">publishSuspectedLedgersAsync</span><span class="p">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">missingBookies</span><span class="p">,</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ledgers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LongAdder</span><span class="w"> </span><span class="n">underReplicatedSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LongAdder</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FutureUtils</span><span class="p">.</span><span class="na">processList</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Lists</span><span class="p">.</span><span class="na">newArrayList</span><span class="p">(</span><span class="n">ledgers</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ledgerId</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          							</span><span class="c1">//é€šè¿‡è¯»å–è¿™äº›Ledgerçš„å…ƒæ•°æ®ï¼Œæ–¹ä¾¿åç»­çš„æ•°æ®æ¢å¤åŠ¨ä½œ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">ledgerManager</span><span class="p">.</span><span class="na">readLedgerMetadata</span><span class="p">(</span><span class="n">ledgerId</span><span class="p">).</span><span class="na">whenComplete</span><span class="p">((</span><span class="n">metadata</span><span class="p">,</span><span class="w"> </span><span class="n">exception</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exception</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="n">underReplicatedSize</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">metadata</span><span class="p">.</span><span class="na">getValue</span><span class="p">().</span><span class="na">getLength</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}),</span><span class="w"> </span><span class="kc">null</span><span class="p">).</span><span class="na">whenComplete</span><span class="p">((</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">FutureUtils</span><span class="p">.</span><span class="na">processList</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Lists</span><span class="p">.</span><span class="na">newArrayList</span><span class="p">(</span><span class="n">ledgers</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          			</span><span class="c1">//ä¸»æµç¨‹ï¼Œç»§ç»­å¾€ä¸‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ledgerId</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">ledgerUnderreplicationManager</span><span class="p">.</span><span class="na">markLedgerUnderreplicatedAsync</span><span class="p">(</span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="n">missingBookies</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">markLedgerUnderreplicatedAsync</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">missingReplicas</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">znode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getUrLedgerZnode</span><span class="p">(</span><span class="n">ledgerId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//æ ‡è®°éœ€è¦åšå¤‡ä»½çš„Ledger</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">tryMarkLedgerUnderreplicatedAsync</span><span class="p">(</span><span class="n">znode</span><span class="p">,</span><span class="w"> </span><span class="n">missingReplicas</span><span class="p">,</span><span class="w"> </span><span class="n">zkAcls</span><span class="p">,</span><span class="w"> </span><span class="n">createFuture</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">createFuture</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">tryMarkLedgerUnderreplicatedAsync</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">znode</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                   </span><span class="kd">final</span><span class="w"> </span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">missingReplicas</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                   </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">ACL</span><span class="o">&gt;</span><span class="w"> </span><span class="n">zkAcls</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                   </span><span class="kd">final</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">finalFuture</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//å°†éœ€è¦åšæ•°æ®æ¢å¤çš„å‰¯æœ¬è¿›è¡Œè¿›è¡Œprotoç¼–ç </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">missingReplicas</span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">builder</span><span class="p">::</span><span class="n">addReplica</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ZkUtils</span><span class="p">.</span><span class="na">asyncCreateFullPathOptimistic</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">zkc</span><span class="p">,</span><span class="w"> </span><span class="n">znode</span><span class="p">,</span><span class="w"> </span><span class="n">urLedgerData</span><span class="p">,</span><span class="w"> </span><span class="n">zkAcls</span><span class="p">,</span><span class="w"> </span><span class="n">CreateMode</span><span class="p">.</span><span class="na">PERSISTENT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">(</span><span class="n">rc</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Code</span><span class="p">.</span><span class="na">OK</span><span class="p">.</span><span class="na">intValue</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">rc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">FutureUtils</span><span class="p">.</span><span class="na">complete</span><span class="p">(</span><span class="n">finalFuture</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Code</span><span class="p">.</span><span class="na">NODEEXISTS</span><span class="p">.</span><span class="na">intValue</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">rc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">//è¦åœ¨zookeeperå°†è¿™äº›Ledgeræ ‡è®°ä¸ºéœ€è¦åšæ•°æ®æ¢å¤</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">handleLedgerUnderreplicatedAlreadyMarked</span><span class="p">(</span><span class="n">znode</span><span class="p">,</span><span class="w"> </span><span class="n">missingReplicas</span><span class="p">,</span><span class="w"> </span><span class="n">zkAcls</span><span class="p">,</span><span class="w"> </span><span class="n">finalFuture</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">FutureUtils</span><span class="p">.</span><span class="na">completeExceptionally</span><span class="p">(</span><span class="n">finalFuture</span><span class="p">,</span><span class="w"> </span><span class="n">KeeperException</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">Code</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">rc</span><span class="p">)));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleLedgerUnderreplicatedAlreadyMarked</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">znode</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                          </span><span class="kd">final</span><span class="w"> </span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">missingReplicas</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                          </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">ACL</span><span class="o">&gt;</span><span class="w"> </span><span class="n">zkAcls</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                          </span><span class="kd">final</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">finalFuture</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// get the existing underreplicated ledger data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">zkc</span><span class="p">.</span><span class="na">getData</span><span class="p">(</span><span class="n">znode</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">getRc</span><span class="p">,</span><span class="w"> </span><span class="n">getPath</span><span class="p">,</span><span class="w"> </span><span class="n">getCtx</span><span class="p">,</span><span class="w"> </span><span class="n">existingUrLedgerData</span><span class="p">,</span><span class="w"> </span><span class="n">getStat</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Code</span><span class="p">.</span><span class="na">OK</span><span class="p">.</span><span class="na">intValue</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">getRc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// deserialize existing underreplicated ledger data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="n">UnderreplicatedLedgerFormat</span><span class="p">.</span><span class="na">Builder</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnderreplicatedLedgerFormat</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">TextFormat</span><span class="p">.</span><span class="na">merge</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">existingUrLedgerData</span><span class="p">,</span><span class="w"> </span><span class="n">UTF_8</span><span class="p">),</span><span class="w"> </span><span class="n">builder</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ParseException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">UnderreplicatedLedgerFormat</span><span class="w"> </span><span class="n">existingUrLedgerFormat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">boolean</span><span class="w"> </span><span class="n">replicaAdded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">missingReplica</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">missingReplicas</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">existingUrLedgerFormat</span><span class="p">.</span><span class="na">getReplicaList</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="n">missingReplica</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">continue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">builder</span><span class="p">.</span><span class="na">addReplica</span><span class="p">(</span><span class="n">missingReplica</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">replicaAdded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//ç›²çŒœè¿™é‡Œåœ¨zkå°†Ledgeræ ‡å¿—ä¸ºéœ€è¦åšæ•°æ®åŒæ­¥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">zkc</span><span class="p">.</span><span class="na">setData</span><span class="p">(</span><span class="n">znode</span><span class="p">,</span><span class="w"> </span><span class="n">newUrLedgerData</span><span class="p">,</span><span class="w"> </span><span class="n">getStat</span><span class="p">.</span><span class="na">getVersion</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="n">setRc</span><span class="p">,</span><span class="w"> </span><span class="n">setPath</span><span class="p">,</span><span class="w"> </span><span class="n">setCtx</span><span class="p">,</span><span class="w"> </span><span class="n">setStat</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Code</span><span class="p">.</span><span class="na">OK</span><span class="p">.</span><span class="na">intValue</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">setRc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">FutureUtils</span><span class="p">.</span><span class="na">complete</span><span class="p">(</span><span class="n">finalFuture</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Code</span><span class="p">.</span><span class="na">NONODE</span><span class="p">.</span><span class="na">intValue</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">setRc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">tryMarkLedgerUnderreplicatedAsync</span><span class="p">(</span><span class="n">znode</span><span class="p">,</span><span class="w"> </span><span class="n">missingReplicas</span><span class="p">,</span><span class="w"> </span><span class="n">zkAcls</span><span class="p">,</span><span class="w"> </span><span class="n">finalFuture</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Code</span><span class="p">.</span><span class="na">BADVERSION</span><span class="p">.</span><span class="na">intValue</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">setRc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">handleLedgerUnderreplicatedAlreadyMarked</span><span class="p">(</span><span class="n">znode</span><span class="p">,</span><span class="w"> </span><span class="n">missingReplicas</span><span class="p">,</span><span class="w"> </span><span class="n">zkAcls</span><span class="p">,</span><span class="w"> </span><span class="n">finalFuture</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">FutureUtils</span><span class="p">.</span><span class="na">completeExceptionally</span><span class="p">(</span><span class="n">finalFuture</span><span class="p">,</span><span class="w"> </span><span class="n">KeeperException</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">Code</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">setRc</span><span class="p">)));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">},</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Code</span><span class="p">.</span><span class="na">NONODE</span><span class="p">.</span><span class="na">intValue</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">getRc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">tryMarkLedgerUnderreplicatedAsync</span><span class="p">(</span><span class="n">znode</span><span class="p">,</span><span class="w"> </span><span class="n">missingReplicas</span><span class="p">,</span><span class="w"> </span><span class="n">zkAcls</span><span class="p">,</span><span class="w"> </span><span class="n">finalFuture</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">FutureUtils</span><span class="p">.</span><span class="na">completeExceptionally</span><span class="p">(</span><span class="n">finalFuture</span><span class="p">,</span><span class="w"> </span><span class="n">KeeperException</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">Code</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">getRc</span><span class="p">)));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ä»ReplicationWorkerçš„rereplicateæ–¹æ³•å¼€å§‹å°±æ˜¯çœŸæ­£åšæ•°æ®æ¢å¤çš„è¿‡ç¨‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">rereplicate</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">ledgerIdToReplicate</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="p">,</span><span class="w"> </span><span class="n">BKException</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">UnavailableException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="c1">//è·å–éœ€è¦åšæ•°æ®æ¢å¤çš„Ledgerçš„å¤„ç†å¯¹è±¡LedgerHandle </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">LedgerHandle</span><span class="w"> </span><span class="n">lh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">admin</span><span class="p">.</span><span class="na">openLedgerNoRecovery</span><span class="p">(</span><span class="n">ledgerIdToReplicate</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          	</span><span class="c1">//é€šè¿‡å¯¹Ledgerè¿›è¡Œåˆ†è§£æˆæ›´å°æ•°æ®æ¢å¤å•ä½LedgerFragmentï¼Œåç»­åˆ†åˆ«å¯¹LedgerFragmentè¿›è¡Œæ•°æ®æ¢å¤</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">LedgerFragment</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fragments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getUnderreplicatedFragments</span><span class="p">(</span><span class="n">lh</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">conf</span><span class="p">.</span><span class="na">getAuditorLedgerVerificationPercentage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">						</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">LedgerFragment</span><span class="w"> </span><span class="n">ledgerFragment</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">fragments</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">								</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  	</span><span class="c1">//å¯¹LedgerFragmentè¿›è¡Œæ•°æ®æ¢å¤</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">admin</span><span class="p">.</span><span class="na">replicateLedgerFragment</span><span class="p">(</span><span class="n">lh</span><span class="p">,</span><span class="w"> </span><span class="n">ledgerFragment</span><span class="p">,</span><span class="w"> </span><span class="n">onReadEntryFailureCallback</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">numFragsReplicated</span><span class="o">++</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ledgerFragment</span><span class="p">.</span><span class="na">getReplicateType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">LedgerFragment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="p">.</span><span class="na">ReplicateType</span><span class="p">.</span><span class="na">DATA_NOT_ADHERING_PLACEMENT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">numNotAdheringPlacementFragsReplicated</span><span class="o">++</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">BKException</span><span class="p">.</span><span class="na">BKBookieHandleNotAvailableException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">						</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">fragments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getUnderreplicatedFragments</span><span class="p">(</span><span class="n">lh</span><span class="p">,</span><span class="w"> </span><span class="n">conf</span><span class="p">.</span><span class="na">getAuditorLedgerVerificationPercentage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">						</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">BKNoSuchLedgerExistsOnMetadataServerException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">						</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ç»§ç»­è¿›ä¸€æ­¥çœ‹admin.replicateLedgerFragmentçš„å®ç°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">replicateLedgerFragment</span><span class="p">(</span><span class="n">LedgerHandle</span><span class="w"> </span><span class="n">lh</span><span class="p">,</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">LedgerFragment</span><span class="w"> </span><span class="n">ledgerFragment</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">BiConsumer</span><span class="o">&lt;</span><span class="n">Long</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">onReadEntryFailureCallback</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="p">,</span><span class="w"> </span><span class="n">BKException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//ç»§ç»­å¾€ä¸‹è·Ÿè¸ª</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">replicateLedgerFragment</span><span class="p">(</span><span class="n">lh</span><span class="p">,</span><span class="w"> </span><span class="n">ledgerFragment</span><span class="p">,</span><span class="w"> </span><span class="n">targetBookieAddresses</span><span class="p">,</span><span class="w"> </span><span class="n">onReadEntryFailureCallback</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">replicateLedgerFragment</span><span class="p">(</span><span class="n">LedgerHandle</span><span class="w"> </span><span class="n">lh</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">LedgerFragment</span><span class="w"> </span><span class="n">ledgerFragment</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span><span class="w"> </span><span class="n">BookieId</span><span class="o">&gt;</span><span class="w"> </span><span class="n">targetBookieAddresses</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">BiConsumer</span><span class="o">&lt;</span><span class="n">Long</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">onReadEntryFailureCallback</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="p">,</span><span class="w"> </span><span class="n">BKException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//åœ¨è¿™é‡Œçœ‹åˆ°è¿™ä¸ªæ¢å¤å…¶å®æ˜¯å¼‚æ­¥å¤„ç†çš„è¿‡ç¨‹ï¼Œç»§ç»­å¾€ä¸‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">asyncRecoverLedgerFragment</span><span class="p">(</span><span class="n">lh</span><span class="p">,</span><span class="w"> </span><span class="n">ledgerFragment</span><span class="p">,</span><span class="w"> </span><span class="n">cb</span><span class="p">,</span><span class="w"> </span><span class="n">targetBookieSet</span><span class="p">,</span><span class="w"> </span><span class="n">onReadEntryFailureCallback</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">asyncRecoverLedgerFragment</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">LedgerHandle</span><span class="w"> </span><span class="n">lh</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">LedgerFragment</span><span class="w"> </span><span class="n">ledgerFragment</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">AsyncCallback</span><span class="p">.</span><span class="na">VoidCallback</span><span class="w"> </span><span class="n">ledgerFragmentMcb</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">BookieId</span><span class="o">&gt;</span><span class="w"> </span><span class="n">newBookies</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">BiConsumer</span><span class="o">&lt;</span><span class="n">Long</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">onReadEntryFailureCallback</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//å‘ç°ä¼šè°ƒç”¨LedgerFragmentReplicatorå¯¹è±¡è¿›è¡Œæ•°æ®æ¢å¤ï¼Œç»§ç»­å¾€ä¸‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">lfr</span><span class="p">.</span><span class="na">replicate</span><span class="p">(</span><span class="n">lh</span><span class="p">,</span><span class="w"> </span><span class="n">ledgerFragment</span><span class="p">,</span><span class="w"> </span><span class="n">ledgerFragmentMcb</span><span class="p">,</span><span class="w"> </span><span class="n">newBookies</span><span class="p">,</span><span class="w"> </span><span class="n">onReadEntryFailureCallback</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">replicate</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">LedgerHandle</span><span class="w"> </span><span class="n">lh</span><span class="p">,</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">LedgerFragment</span><span class="w"> </span><span class="n">lf</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">AsyncCallback</span><span class="p">.</span><span class="na">VoidCallback</span><span class="w"> </span><span class="n">ledgerFragmentMcb</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">BookieId</span><span class="o">&gt;</span><span class="w"> </span><span class="n">targetBookieAddresses</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">BiConsumer</span><span class="o">&lt;</span><span class="n">Long</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">onReadEntryFailureCallback</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">LedgerFragment</span><span class="o">&gt;</span><span class="w"> </span><span class="n">partionedFragments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">splitIntoSubFragments</span><span class="p">(</span><span class="n">lh</span><span class="p">,</span><span class="w"> </span><span class="n">lf</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">bkc</span><span class="p">.</span><span class="na">getConf</span><span class="p">().</span><span class="na">getRereplicationEntryBatchSize</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//ç»§ç»­å¾€ä¸‹çœ‹å®ç°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">replicateNextBatch</span><span class="p">(</span><span class="n">lh</span><span class="p">,</span><span class="w"> </span><span class="n">partionedFragments</span><span class="p">.</span><span class="na">iterator</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ledgerFragmentMcb</span><span class="p">,</span><span class="w"> </span><span class="n">targetBookieAddresses</span><span class="p">,</span><span class="w"> </span><span class="n">onReadEntryFailureCallback</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">replicateNextBatch</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">LedgerHandle</span><span class="w"> </span><span class="n">lh</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">Iterator</span><span class="o">&lt;</span><span class="n">LedgerFragment</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fragments</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">AsyncCallback</span><span class="p">.</span><span class="na">VoidCallback</span><span class="w"> </span><span class="n">ledgerFragmentMcb</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">BookieId</span><span class="o">&gt;</span><span class="w"> </span><span class="n">targetBookieAddresses</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">BiConsumer</span><span class="o">&lt;</span><span class="n">Long</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">onReadEntryFailureCallback</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fragments</span><span class="p">.</span><span class="na">hasNext</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              	</span><span class="c1">//æ¥äº†ï¼Œä¸€èˆ¬æœ‰Internalçš„åœ°æ–¹éƒ½ä¼šæœ‰å®ç°çš„å¹²è´§ï¼Œç»§ç»­è¿›å»</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">replicateFragmentInternal</span><span class="p">(</span><span class="n">lh</span><span class="p">,</span><span class="w"> </span><span class="n">fragments</span><span class="p">.</span><span class="na">next</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">new</span><span class="w"> </span><span class="n">AsyncCallback</span><span class="p">.</span><span class="na">VoidCallback</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">processResult</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">rc</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">BKException</span><span class="p">.</span><span class="na">Code</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                    </span><span class="n">ledgerFragmentMcb</span><span class="p">.</span><span class="na">processResult</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                            </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                    </span><span class="n">replicateNextBatch</span><span class="p">(</span><span class="n">lh</span><span class="p">,</span><span class="w"> </span><span class="n">fragments</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                            </span><span class="n">ledgerFragmentMcb</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                            </span><span class="n">targetBookieAddresses</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                            </span><span class="n">onReadEntryFailureCallback</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">},</span><span class="w"> </span><span class="n">targetBookieAddresses</span><span class="p">,</span><span class="w"> </span><span class="n">onReadEntryFailureCallback</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ledgerFragmentMcb</span><span class="p">.</span><span class="na">processResult</span><span class="p">(</span><span class="n">BKException</span><span class="p">.</span><span class="na">Code</span><span class="p">.</span><span class="na">OK</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">replicateFragmentInternal</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">LedgerHandle</span><span class="w"> </span><span class="n">lh</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">LedgerFragment</span><span class="w"> </span><span class="n">lf</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">AsyncCallback</span><span class="p">.</span><span class="na">VoidCallback</span><span class="w"> </span><span class="n">ledgerFragmentMcb</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">BookieId</span><span class="o">&gt;</span><span class="w"> </span><span class="n">newBookies</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">BiConsumer</span><span class="o">&lt;</span><span class="n">Long</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">onReadEntryFailureCallback</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//é’ˆå¯¹æ¯ä¸ªEntryå¯¹è±¡å¾ªç¯åšæ•°æ®æ¢å¤ï¼ŒEntryæ˜¯BKé‡Œæœ€å°çš„æ•°æ®å•å…ƒ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">entryId</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">entriesToReplicate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">recoverLedgerFragmentEntry</span><span class="p">(</span><span class="n">entryId</span><span class="p">,</span><span class="w"> </span><span class="n">lh</span><span class="p">,</span><span class="w"> </span><span class="n">ledgerFragmentEntryMcb</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">newBookies</span><span class="p">,</span><span class="w"> </span><span class="n">onReadEntryFailureCallback</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">recoverLedgerFragmentEntry</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">entryId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">LedgerHandle</span><span class="w"> </span><span class="n">lh</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">AsyncCallback</span><span class="p">.</span><span class="na">VoidCallback</span><span class="w"> </span><span class="n">ledgerFragmentEntryMcb</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">BookieId</span><span class="o">&gt;</span><span class="w"> </span><span class="n">newBookies</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">BiConsumer</span><span class="o">&lt;</span><span class="n">Long</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">onReadEntryFailureCallback</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">startReadEntryTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MathUtils</span><span class="p">.</span><span class="na">nowInNano</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Read the ledger entry using the LedgerHandle. This will allow us to
</span></span></span><span class="line"><span class="cl"><span class="cm">         * read the entry from one of the other replicated bookies other than
</span></span></span><span class="line"><span class="cl"><span class="cm">         * the dead one.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//åˆ°äº†çœŸæ­£è¯»å–Entryçš„é€»è¾‘ï¼Œç»§ç»­å¾€ä¸‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">lh</span><span class="p">.</span><span class="na">asyncReadEntries</span><span class="p">(</span><span class="n">entryId</span><span class="p">,</span><span class="w"> </span><span class="n">entryId</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReadCallback</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    						</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">asyncReadEntries</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">firstEntry</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">lastEntry</span><span class="p">,</span><span class="w"> </span><span class="n">ReadCallback</span><span class="w"> </span><span class="n">cb</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//è°ƒç”¨å¼‚æ­¥è¯»å–é€»è¾‘</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">asyncReadEntriesInternal</span><span class="p">(</span><span class="n">firstEntry</span><span class="p">,</span><span class="w"> </span><span class="n">lastEntry</span><span class="p">,</span><span class="w"> </span><span class="n">cb</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">asyncReadEntriesInternal</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">firstEntry</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">lastEntry</span><span class="p">,</span><span class="w"> </span><span class="n">ReadCallback</span><span class="w"> </span><span class="n">cb</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                  </span><span class="n">Object</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isRecoveryRead</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">clientCtx</span><span class="p">.</span><span class="na">isClientClosed</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          	</span><span class="c1">//ç»§ç»­å¾€ä¸‹è·Ÿè¸ª</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">readEntriesInternalAsync</span><span class="p">(</span><span class="n">firstEntry</span><span class="p">,</span><span class="w"> </span><span class="n">lastEntry</span><span class="p">,</span><span class="w"> </span><span class="n">isRecoveryRead</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">whenCompleteAsync</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">FutureEventListener</span><span class="o">&lt;</span><span class="n">LedgerEntries</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">},</span><span class="w"> </span><span class="n">clientCtx</span><span class="p">.</span><span class="na">getMainWorkerPool</span><span class="p">().</span><span class="na">chooseThread</span><span class="p">(</span><span class="n">ledgerId</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">cb</span><span class="p">.</span><span class="na">readComplete</span><span class="p">(</span><span class="n">Code</span><span class="p">.</span><span class="na">ClientClosedException</span><span class="p">,</span><span class="w"> </span><span class="n">LedgerHandle</span><span class="p">.</span><span class="na">this</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">LedgerEntries</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">readEntriesInternalAsync</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">firstEntry</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                              </span><span class="kt">long</span><span class="w"> </span><span class="n">lastEntry</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                              </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isRecoveryRead</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//æ„é€ è¯»æ•°æ®çš„å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="n">PendingReadOp</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PendingReadOp</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">clientCtx</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                             </span><span class="n">firstEntry</span><span class="p">,</span><span class="w"> </span><span class="n">lastEntry</span><span class="p">,</span><span class="w"> </span><span class="n">isRecoveryRead</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//è¿è¡Œèµ·æ¥ï¼Œè·Ÿè¿›å»ç…ç…</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="n">op</span><span class="p">.</span><span class="na">run</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">op</span><span class="p">.</span><span class="na">future</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//æ— ä»–ï¼Œç»§ç»­å¾€ä¸‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">initiate</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">initiate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       	</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">						</span><span class="c1">//å†³å®šæ˜¯ä¸²è¡Œè¯»å–æ•°æ®è¿˜æ˜¯å¹¶è¡Œè¯»å–æ•°æ®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parallelRead</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ParallelReadRequest</span><span class="p">(</span><span class="n">ensemble</span><span class="p">,</span><span class="w"> </span><span class="n">lh</span><span class="p">.</span><span class="na">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SequenceReadRequest</span><span class="p">(</span><span class="n">ensemble</span><span class="p">,</span><span class="w"> </span><span class="n">lh</span><span class="p">.</span><span class="na">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">seq</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">i</span><span class="o">++</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">endEntryId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// read the entries.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">LedgerEntryRequest</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">seq</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          	</span><span class="c1">//æ ¸å¿ƒé€»è¾‘ï¼Œè¿™é‡Œè¿›è¡Œæ•°æ®è¯»å–æ“ä½œ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">entry</span><span class="p">.</span><span class="na">read</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">read</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//ç»§ç»­å¾€ä¸‹çœ‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sendNextRead</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="kd">synchronized</span><span class="w"> </span><span class="n">BookieId</span><span class="w"> </span><span class="nf">sendNextRead</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">						</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">BookieId</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ensemble</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">bookieIndex</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              	</span><span class="c1">//å‘é€è¯»å–è¯·æ±‚çš„æ“ä½œ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">sendReadTo</span><span class="p">(</span><span class="n">bookieIndex</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">ie</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">								</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendReadTo</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">bookieIndex</span><span class="p">,</span><span class="w"> </span><span class="n">BookieId</span><span class="w"> </span><span class="n">to</span><span class="p">,</span><span class="w"> </span><span class="n">LedgerEntryRequest</span><span class="w"> </span><span class="n">entry</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">isRecoveryRead</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          	</span><span class="c1">//è°ƒç”¨BKå®¢æˆ·ç«¯è¿›è¡Œæ•°æ®çš„è¯»å–</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">clientCtx</span><span class="p">.</span><span class="na">getBookieClient</span><span class="p">().</span><span class="na">readEntry</span><span class="p">(</span><span class="n">to</span><span class="p">,</span><span class="w"> </span><span class="n">lh</span><span class="p">.</span><span class="na">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="na">eId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReadContext</span><span class="p">(</span><span class="n">bookieIndex</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">),</span><span class="w"> </span><span class="n">BookieProtocol</span><span class="p">.</span><span class="na">FLAG_NONE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">default</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">readEntry</span><span class="p">(</span><span class="n">BookieId</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">entryId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                           </span><span class="n">ReadEntryCallback</span><span class="w"> </span><span class="n">cb</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//ç»§ç»­å¾€ä¸‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">readEntry</span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="n">entryId</span><span class="p">,</span><span class="w"> </span><span class="n">cb</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">default</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">readEntry</span><span class="p">(</span><span class="n">BookieId</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">entryId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                           </span><span class="n">ReadEntryCallback</span><span class="w"> </span><span class="n">cb</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">masterKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//ç»§ç»­å¾€ä¸‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">readEntry</span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="n">entryId</span><span class="p">,</span><span class="w"> </span><span class="n">cb</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">masterKey</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">readEntry</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">BookieId</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">entryId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="kd">final</span><span class="w"> </span><span class="n">ReadEntryCallback</span><span class="w"> </span><span class="n">cb</span><span class="p">,</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">masterKey</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">allowFastFail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//è·å–è¦è®¿é—®çš„å®¢æˆ·ç«¯å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">PerChannelBookieClientPool</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookupClient</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">client</span><span class="p">.</span><span class="na">obtain</span><span class="p">((</span><span class="n">rc</span><span class="p">,</span><span class="w"> </span><span class="n">pcbc</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">BKException</span><span class="p">.</span><span class="na">Code</span><span class="p">.</span><span class="na">OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">completeRead</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span><span class="w"> </span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="n">entryId</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">cb</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              	</span><span class="c1">//è°ƒç”¨è¯»å–é€»è¾‘</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">pcbc</span><span class="p">.</span><span class="na">readEntry</span><span class="p">(</span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="n">entryId</span><span class="p">,</span><span class="w"> </span><span class="n">cb</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">masterKey</span><span class="p">,</span><span class="w"> </span><span class="n">allowFastFail</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="n">ledgerId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">readEntry</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ledgerId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">entryId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="n">ReadEntryCallback</span><span class="w"> </span><span class="n">cb</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="n">Object</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">masterKey</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="kt">boolean</span><span class="w"> </span><span class="n">allowFastFail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//çœ‹åˆ°Internalå°±çŸ¥é“è¦æœ‰ä¸œè¥¿äº†ï¼Œç»§ç»­å¾€ä¸‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">readEntryInternal</span><span class="p">(</span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="n">entryId</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="n">cb</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">masterKey</span><span class="p">,</span><span class="w"> </span><span class="n">allowFastFail</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">readEntryInternal</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ledgerId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                   </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">entryId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                   </span><span class="kd">final</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">previousLAC</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                   </span><span class="kd">final</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">timeOutInMillis</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                   </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">piggyBackEntry</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                   </span><span class="kd">final</span><span class="w"> </span><span class="n">ReadEntryCallback</span><span class="w"> </span><span class="n">cb</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                   </span><span class="kd">final</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                   </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                   </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">masterKey</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                   </span><span class="kt">boolean</span><span class="w"> </span><span class="n">allowFastFail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//æ„é€ è¯·æ±‚å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ReadRequest</span><span class="p">.</span><span class="na">Builder</span><span class="w"> </span><span class="n">readBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReadRequest</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">.</span><span class="na">setLedgerId</span><span class="p">(</span><span class="n">ledgerId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">.</span><span class="na">setEntryId</span><span class="p">(</span><span class="n">entryId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">withRequestContext</span><span class="p">(</span><span class="n">Request</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">.</span><span class="na">setHeader</span><span class="p">(</span><span class="n">headerBuilder</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">.</span><span class="na">setReadRequest</span><span class="p">(</span><span class="n">readBuilder</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//ç»§ç»­å¾€ä¸‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">writeAndFlush</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">completionKey</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">allowFastFail</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeAndFlush</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">Channel</span><span class="w"> </span><span class="n">channel</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                           </span><span class="kd">final</span><span class="w"> </span><span class="n">CompletionKey</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                           </span><span class="kd">final</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                           </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">allowFastFail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          	</span><span class="c1">//è·Ÿåˆ°è¿™é‡Œå°±çŸ¥é“æœ€ç»ˆè°ƒç”¨äº†Nettyçš„å®¢æˆ·ç«¯æ¥å‘èµ·è¯·æ±‚</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">channel</span><span class="p">.</span><span class="na">writeAndFlush</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">promise</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ°è¿™é‡Œæ•°æ®å°±å‘å‡ºå»äº†ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½çŸ¥é“AutoRecoveryè¿›ç¨‹æ˜¯é€šè¿‡Nettyå‘BKçš„æœåŠ¡ç«¯è¿›è¡Œæ•°æ®è¯»å–ï¼Œé‚£ä¹ˆæœåŠ¡ç«¯åœ¨æ¥æ”¶åˆ°è¯·æ±‚ååˆæ˜¯æ€ä¹ˆå¤„ç†çš„å‘¢ï¼Œè¿™é‡Œå’±ä»¬ä»æœåŠ¡ç«¯æ¥æ”¶è¯·æ±‚çš„é€»è¾‘å¼€å§‹è·Ÿï¼Œç”±äºBKæœ¬èº«ä¹Ÿæ˜¯é€šè¿‡Nettyå®ä¾‹è¿›è¡Œç½‘ç»œè¯·æ±‚å¤„ç†çš„ï¼Œå› æ­¤å¯ä»¥è½»æ¾æ‰¾åˆ°BookieRequestHandlerçš„channelReadæ–¹æ³•ç›‘å¬å¤–éƒ¨ç½‘ç»œè¯·æ±‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">channelRead</span><span class="p">(</span><span class="n">ChannelHandlerContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//èŒè´£åˆ†ç¦»åšå¾—å¾ˆå¥½ï¼ŒBookieRequestHandleråªè´Ÿè´£æ¥æ”¶è¯·æ±‚ï¼Œé€»è¾‘å¤„ç†ç›¸å…³çš„å…¨æƒäº¤ç»™requestProcessorå¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">requestProcessor</span><span class="p">.</span><span class="na">processRequest</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">processRequest</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="n">BookieRequestHandler</span><span class="w"> </span><span class="n">requestHandler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Channel</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requestHandler</span><span class="p">.</span><span class="na">ctx</span><span class="p">().</span><span class="na">channel</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">BookkeeperProtocol</span><span class="p">.</span><span class="na">Request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">BookkeeperProtocol</span><span class="p">.</span><span class="na">Request</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">BookkeeperProtocol</span><span class="p">.</span><span class="na">Request</span><span class="p">)</span><span class="w"> </span><span class="n">msg</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">restoreMdcContextFromRequest</span><span class="p">(</span><span class="n">r</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">BookkeeperProtocol</span><span class="p">.</span><span class="na">BKPacketHeader</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">getHeader</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              	</span><span class="c1">//éå¸¸å¥½çš„ä¸€ç§è®¾è®¡ï¼Œkafkaçš„KafkaApisç±»é‡Œä¹Ÿæ˜¯è¿™æ ·è®¾è®¡ï¼ŒæœåŠ¡ç«¯æ”¯æŒçš„æ“ä½œåœ¨è¿™é‡Œå°±èƒ½å¾ˆæ¸…æ™°çš„çœ‹åˆ°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="na">getOperation</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="n">ADD_ENTRY</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">processAddRequestV3</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">requestHandler</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="n">READ_ENTRY</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    		</span><span class="c1">//åœ¨è¿™é‡Œå¯ä»¥å¤„ç†çš„è¯»å–è¯·æ±‚ï¼Œä»è¿™é‡Œè¿›å»çœ‹çœ‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">processReadRequestV3</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">requestHandler</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="n">FORCE_LEDGER</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">processForceLedgerRequestV3</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">requestHandler</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">										</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="n">WRITE_LAC</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">processWriteLacRequestV3</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">requestHandler</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="n">READ_LAC</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">processReadLacRequestV3</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">requestHandler</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="n">GET_BOOKIE_INFO</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">processGetBookieInfoRequestV3</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">requestHandler</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="n">START_TLS</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">processStartTLSRequestV3</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">requestHandler</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="n">GET_LIST_OF_ENTRIES_OF_LEDGER</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">processGetListOfEntriesOfLedgerProcessorV3</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">requestHandler</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">default</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">												</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">MDC</span><span class="p">.</span><span class="na">clear</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  					</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">processReadRequestV3</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">BookkeeperProtocol</span><span class="p">.</span><span class="na">Request</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">BookieRequestHandler</span><span class="w"> </span><span class="n">requestHandler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       
</span></span></span><span class="line"><span class="cl"><span class="w">    		</span><span class="c1">//èƒ½çœ‹åˆ°BKä¹ŸåŒæ—¶æ”¯æŒé•¿è½®è¯¢çš„æ–¹å¼è¯»å–æ•°æ®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">RequestUtils</span><span class="p">.</span><span class="na">isLongPollReadRequest</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">getReadRequest</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LongPollReadEntryProcessorV3</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">requestHandler</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">fenceThread</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                                    </span><span class="n">lpThread</span><span class="p">,</span><span class="w"> </span><span class="n">requestTimer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReadEntryProcessorV3</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">requestHandler</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">fenceThread</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">						</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kc">null</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">threadPool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          	</span><span class="c1">//è·Ÿè¿›å»çœ‹çœ‹å®ç°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">read</span><span class="p">.</span><span class="na">run</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">						</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//æ‰§è¡Œè¯»å–æ“ä½œ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">executeOp</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">executeOp</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//è¿™é‡Œæ„Ÿè§‰è®¾è®¡å¾—ä¸æ˜¯å¾ˆæ¸…æ™°ï¼Œåº”è¯¥å…ˆè¯»å–æ•°æ®å‡ºæ¥å†æ„é€ è¿”å›å¯¹è±¡çš„ï¼Œä½ ä»¬è§‰å¾—å‘¢ï¼Ÿ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ReadResponse</span><span class="w"> </span><span class="n">readResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getReadResponse</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kc">null</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">readResponse</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">sendResponse</span><span class="p">(</span><span class="n">readResponse</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">ReadResponse</span><span class="w"> </span><span class="nf">getReadResponse</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">						</span><span class="c1">// è¯»å–Entryæ•°æ®çš„åœ°æ–¹ï¼Œåœ¨æ­¤å¤„æ·±å…¥æ¢ç´¢ä¸‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">readEntry</span><span class="p">(</span><span class="n">readResponse</span><span class="p">,</span><span class="w"> </span><span class="n">entryId</span><span class="p">,</span><span class="w"> </span><span class="n">startTimeSw</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Bookie</span><span class="p">.</span><span class="na">NoLedgerException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">						</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">ReadResponse</span><span class="w"> </span><span class="nf">readEntry</span><span class="p">(</span><span class="n">ReadResponse</span><span class="p">.</span><span class="na">Builder</span><span class="w"> </span><span class="n">readResponseBuilder</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                     </span><span class="kt">long</span><span class="w"> </span><span class="n">entryId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                     </span><span class="n">Stopwatch</span><span class="w"> </span><span class="n">startTimeSw</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">BookieException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//ç»§ç»­æ·±å…¥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">readEntry</span><span class="p">(</span><span class="n">readResponseBuilder</span><span class="p">,</span><span class="w"> </span><span class="n">entryId</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">startTimeSw</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">ReadResponse</span><span class="w"> </span><span class="nf">readEntry</span><span class="p">(</span><span class="n">ReadResponse</span><span class="p">.</span><span class="na">Builder</span><span class="w"> </span><span class="n">readResponseBuilder</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                     </span><span class="kt">long</span><span class="w"> </span><span class="n">entryId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                     </span><span class="kt">boolean</span><span class="w"> </span><span class="n">readLACPiggyBack</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                     </span><span class="n">Stopwatch</span><span class="w"> </span><span class="n">startTimeSw</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">BookieException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//è°ƒç”¨Bookieçš„readEntryæ¥è¯»å–æ•°æ®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ByteBuf</span><span class="w"> </span><span class="n">entryBody</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requestProcessor</span><span class="p">.</span><span class="na">getBookie</span><span class="p">().</span><span class="na">readEntry</span><span class="p">(</span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="n">entryId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     		</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="kd">public</span><span class="w"> </span><span class="n">ByteBuf</span><span class="w"> </span><span class="nf">readEntry</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">entryId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">NoLedgerException</span><span class="p">,</span><span class="w"> </span><span class="n">BookieException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">LedgerDescriptor</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handles</span><span class="p">.</span><span class="na">getReadOnlyHandle</span><span class="p">(</span><span class="n">ledgerId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  					</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//è°ƒç”¨çœŸæ­£è¯»æ•°æ®çš„é€»è¾‘ï¼Œå› ä¸ºåœ¨è¿™é‡Œèƒ½çœ‹åˆ°è·å–çš„å€¼entryä¹Ÿæ˜¯å¯¹å¤–è¿”å›çš„</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//è¿™é‡Œè°ƒç”¨çš„æ˜¯LedgerDescriptorç±»çš„readEntryæ–¹æ³•</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ByteBuf</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handle</span><span class="p">.</span><span class="na">readEntry</span><span class="p">(</span><span class="n">entryId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">entry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ByteBuf</span><span class="w"> </span><span class="nf">readEntry</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">entryId</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">BookieException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//è°ƒç”¨LedgerStorageæ¥å£ï¼ŒSingleDirectoryDbLedgerStorageå®ç°ç±»æ¥è¯»å–Entry</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ledgerStorage</span><span class="p">.</span><span class="na">getEntry</span><span class="p">(</span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="n">entryId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ByteBuf</span><span class="w"> </span><span class="nf">getEntry</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">entryId</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">BookieException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">startTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MathUtils</span><span class="p">.</span><span class="na">nowInNano</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          	</span><span class="c1">//ç»§ç»­å¾€ä¸‹è·Ÿè¸ª</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ByteBuf</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">doGetEntry</span><span class="p">(</span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="n">entryId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">recordSuccessfulEvent</span><span class="p">(</span><span class="n">dbLedgerStorageStats</span><span class="p">.</span><span class="na">getReadEntryStats</span><span class="p">(),</span><span class="w"> </span><span class="n">startTime</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">entry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="kd">private</span><span class="w"> </span><span class="n">ByteBuf</span><span class="w"> </span><span class="nf">doGetEntry</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">entryId</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">BookieException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="c1">//å°è¯•ä»BKæœ¬åœ°ç¼“å­˜ä¸­è¯»å–æ•°æ®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ByteBuf</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">localWriteCache</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="n">entryId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//å°è¯•ä»æœ¬åœ°ç¼“å­˜flushä¸­è¿›è¡Œæ•°æ®å‘½ä¸­æ•°æ®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">localWriteCacheBeingFlushed</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="n">entryId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// å°è¯•ä»è¯»ç¼“å­˜ä¸­è¿›è¡Œæ•°æ®è¯»å–</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readCache</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="n">entryId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="c1">//ä»ç£ç›˜æ–‡ä»¶ä¸­è¿›è¡Œæ•°æ®è¯»å–, è°ƒç”¨çš„æ˜¯EntryLoggeræ¥å£ï¼ŒDefaultEntryLoggerå¯¹è±¡çš„readEntryæ–¹æ³•</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entryLogger</span><span class="p">.</span><span class="na">readEntry</span><span class="p">(</span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="n">entryId</span><span class="p">,</span><span class="w"> </span><span class="n">entryLocation</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="c1">//å†™åˆ°è¯»ç¼“å­˜ä¸­</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">readCache</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="n">entryId</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">entry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ByteBuf</span><span class="w"> </span><span class="nf">readEntry</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">entryId</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">entryLocation</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">Bookie</span><span class="p">.</span><span class="na">NoEntryException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//å†è¿›ä¸€æ­¥æ¢ç´¢</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">internalReadEntry</span><span class="p">(</span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="n">entryId</span><span class="p">,</span><span class="w"> </span><span class="n">entryLocation</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="cm">/* validateEntry */</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ByteBuf</span><span class="w"> </span><span class="nf">internalReadEntry</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">entryId</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">location</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">validateEntry</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">Bookie</span><span class="p">.</span><span class="na">NoEntryException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//è·å–entryæ‰€åœ¨çš„LogId</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">entryLogId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logIdForOffset</span><span class="p">(</span><span class="n">location</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">posForOffset</span><span class="p">(</span><span class="n">location</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">BufferedReadChannel</span><span class="w"> </span><span class="n">fc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">entrySize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">fc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getFCForEntryInternal</span><span class="p">(</span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="n">entryId</span><span class="p">,</span><span class="w"> </span><span class="n">entryLogId</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ByteBuf</span><span class="w"> </span><span class="n">sizeBuff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readEntrySize</span><span class="p">(</span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="n">entryId</span><span class="p">,</span><span class="w"> </span><span class="n">entryLogId</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">fc</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">entrySize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sizeBuff</span><span class="p">.</span><span class="na">getInt</span><span class="p">(</span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">validateEntry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">validateEntry</span><span class="p">(</span><span class="n">ledgerId</span><span class="p">,</span><span class="w"> </span><span class="n">entryId</span><span class="p">,</span><span class="w"> </span><span class="n">entryLogId</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">sizeBuff</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">EntryLookupException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ByteBuf</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allocator</span><span class="p">.</span><span class="na">buffer</span><span class="p">(</span><span class="n">entrySize</span><span class="p">,</span><span class="w"> </span><span class="n">entrySize</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//è¿›è¡Œæ•°æ®è¯»å–</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readFromLogChannel</span><span class="p">(</span><span class="n">entryLogId</span><span class="p">,</span><span class="w"> </span><span class="n">fc</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">data</span><span class="p">.</span><span class="na">writerIndex</span><span class="p">(</span><span class="n">entrySize</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">readFromLogChannel</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">entryLogId</span><span class="p">,</span><span class="w"> </span><span class="n">BufferedReadChannel</span><span class="w"> </span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">ByteBuf</span><span class="w"> </span><span class="n">buff</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">BufferedLogChannel</span><span class="w"> </span><span class="n">bc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entryLogManager</span><span class="p">.</span><span class="na">getCurrentLogIfPresent</span><span class="p">(</span><span class="n">entryLogId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//ç»§ç»­å¾€ä¸‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">channel</span><span class="p">.</span><span class="na">read</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="n">ByteBuf</span><span class="w"> </span><span class="n">dest</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">//ç»§ç»­å¾€ä¸‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">read</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">dest</span><span class="p">.</span><span class="na">writableBytes</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="n">ByteBuf</span><span class="w"> </span><span class="n">dest</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">length</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// Check if the data is in the buffer, if so, copy it.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">readBufferStartPosition</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">currentPosition</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">currentPosition</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">readBufferStartPosition</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">readBuffer</span><span class="p">.</span><span class="na">readableBytes</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">posInBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">currentPosition</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">readBufferStartPosition</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">bytesToCopy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="n">readBuffer</span><span class="p">.</span><span class="na">readableBytes</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">posInBuffer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">dest</span><span class="p">.</span><span class="na">writeBytes</span><span class="p">(</span><span class="n">readBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">posInBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">bytesToCopy</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">currentPosition</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">bytesToCopy</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">length</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">bytesToCopy</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">cacheHitCount</span><span class="o">++</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// We don&#39;t have it in the buffer, so put necessary data in the buffer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">readBufferStartPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">currentPosition</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">readBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              	</span><span class="c1">//ä»ç£ç›˜è¯»å–æ•°æ®åˆ°readBufferä¸­ï¼Œå†å°†readBufferçš„æ•°æ®å†™åˆ° destä¸­ä½œä¸ºè¿”å›å€¼</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              	</span><span class="c1">//è¿™é‡Œè°ƒç”¨çš„æ˜¯Java NIO FileChannelç±»çš„readæ–¹æ³•æ¥ä»ç£ç›˜è¿›è¡Œæ•°æ®çš„è¯»å–</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">readBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">validateAndGetFileChannel</span><span class="p">().</span><span class="na">read</span><span class="p">(</span><span class="n">readBuffer</span><span class="p">.</span><span class="na">internalNioBuffer</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">readCapacity</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">currentPosition</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IOException</span><span class="p">(</span><span class="s">&#34;Reading from filechannel returned a non-positive value. Short read.&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">readBuffer</span><span class="p">.</span><span class="na">writerIndex</span><span class="p">(</span><span class="n">readBytes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">currentPosition</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="æ€»ç»“">æ€»ç»“
</h2><p>åœ¨è¿™é‡Œè§£ç­”ä¸‹å¼•è¨€å°æ•…äº‹</p>
<ul>
<li>
<p>å¼ ä¸‰æ˜¯é€šè¿‡ä»€ä¹ˆè§„åˆ™è¢«é€‰æˆâ€œç›‘ç£è€…â€çš„ï¼Ÿ</p>
<p>å¼ ä¸‰æ˜¯é€šè¿‡zookeeperçš„Paxosç®—æ³•é€‰ä¸¾äº§ç”Ÿçš„</p>
</li>
<li>
<p>å¦‚æœå¼ ä¸‰ä¹Ÿä¸è¾è€Œåˆ«å‘¢ï¼Ÿ</p>
<p>å¤§ç‹—å’ŒäºŒç‹—ä¹Ÿä¼šé€šè¿‡zookeeperç›‘å¬å¼ ä¸‰çš„çŠ¶æ€ï¼Œå¦‚æœå¼ ä¸‰ä¸è¾è€Œåˆ«çš„è¯ï¼Œå¤§ç‹—äºŒç‹—ä¼šé€šè¿‡zookeeperé€‰ä¸¾æˆä¸ºæ–°çš„â€œç›‘ç£è€…â€</p>
</li>
<li>
<p>ä¸ºå•¥è¦é€šè¿‡ç­¾åˆ°æœ¬çš„æ–¹å¼ï¼Œè€Œä¸æ˜¯å¼ ä¸‰ç›´æ¥å»æŒ¨ä¸ªæŒ¨ä¸ªçœ‹ï¼Ÿ</p>
<p>é€šè¿‡ç­¾åˆ°æœ¬çš„æ–¹å¼æ¯”è¾ƒèŠ‚çº¦å¼ ä¸‰çš„æ—¶é—´ï¼Œå¦åˆ™å½“å‘˜å·¥æ¯”è¾ƒå¤šçš„æ—¶å€™å¹¶ä¸”å¯¹æ„ŸçŸ¥æ—¶é—´æ¯”è¾ƒå¿«çš„æ—¶å€™ï¼Œå¼ ä¸‰å°±è¦æ¯éš”å‡ åˆ†é’Ÿå°±è¦è·‘å»æŒ¨ä¸ªæŒ¨ä¸ªçœ‹ï¼Œè¿™æ ·æ²¡å¤šä¹…å¼ ä¸‰ä¹Ÿè¦â€œä¸è¾è€Œåˆ«â€äº†ã€‚é€šè¿‡ç­¾åˆ°æœ¬å¦‚æœæŸä¸ªåŒäº‹ä¸ç­¾åˆ°äº†å¼ ä¸‰å°±èƒ½å¾ˆè½»æ¾æ„ŸçŸ¥åˆ°å¹¶åšç›¸å¯¹åº”çš„å¤„ç†äº†</p>
</li>
</ul>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™
</h2><ol>
<li><a class="link" href="https://bookkeeper.apache.org/docs/admin/autorecovery/"  target="_blank" rel="noopener"
    >https://bookkeeper.apache.org/docs/admin/autorecovery/</a></li>
<li>bké¡¹ç›® site3/website/docs/admin/* æŒ‡ä»¤ä½¿ç”¨è¯´æ˜</li>
</ol>

</section>


    <footer class="article-footer">
    

    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/flink%E9%9B%86%E6%88%90pulsar%E8%BF%9B%E8%A1%8C%E8%AF%BB%E5%86%99/">
        
        
            <div class="article-image">
                <img src="/p/flink%E9%9B%86%E6%88%90pulsar%E8%BF%9B%E8%A1%8C%E8%AF%BB%E5%86%99/image-20241010212758255.3b8d865776299f9bc8d1681c57a67652_hu7262335394239924420.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Flinké›†æˆPulsarè¿›è¡Œè¯»å†™"
                        
                        data-hash="md5-O42GV3Ypn5vI0WgcV6Z2Ug==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Flinké›†æˆPulsarè¿›è¡Œè¯»å†™</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/pulsario%E9%9B%86%E6%88%90mysql/">
        
        
            <div class="article-image">
                <img src="/p/pulsario%E9%9B%86%E6%88%90mysql/image-20241008163436302.a76781ee601fc70c412d1a52fa1ecff8_hu16634190987435192676.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post PulsarIOé›†æˆmysql"
                        
                        data-hash="md5-p2eB7mAfxwxBLRpS&#43;h7P&#43;A==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">PulsarIOé›†æˆmysql</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E5%90%AF%E7%A8%8Bpulsar%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E9%AB%98%E9%80%9F%E5%90%AF%E5%8A%A8%E5%BC%95%E6%93%8E%E6%8F%AD%E7%A7%98%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%B7%A8%E5%85%BD%E7%9A%84%E8%AF%9E%E7%94%9F/">
        
        
            <div class="article-image">
                <img src="/p/%E5%90%AF%E7%A8%8Bpulsar%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E9%AB%98%E9%80%9F%E5%90%AF%E5%8A%A8%E5%BC%95%E6%93%8E%E6%8F%AD%E7%A7%98%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%B7%A8%E5%85%BD%E7%9A%84%E8%AF%9E%E7%94%9F/image-20240913141630196.cfdbfabbec9931a0e8aa797475dd75ef_hu14409126970437613443.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post å¯ç¨‹Pulsarï¼šæ·±å…¥å‰–æé«˜é€Ÿå¯åŠ¨å¼•æ“ï¼Œæ­ç§˜æ¶ˆæ¯ä¸­é—´ä»¶å·¨å…½çš„è¯ç”Ÿ"
                        
                        data-hash="md5-z9v6u&#43;yZMaDoqnl0dd117w==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">å¯ç¨‹Pulsarï¼šæ·±å…¥å‰–æé«˜é€Ÿå¯åŠ¨å¼•æ“ï¼Œæ­ç§˜æ¶ˆæ¯ä¸­é—´ä»¶å·¨å…½çš„è¯ç”Ÿ</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/schema%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/">
        
        
            <div class="article-image">
                <img src="/p/schema%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/image-20240308104136110.ac62fe16bef7c35fa075c319ed270052_hu12371496663848303101.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Schemaæ·±åº¦è§£æ"
                        
                        data-hash="md5-rGL&#43;Fr73w1&#43;gdcMZ7ScAUg==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Schemaæ·±åº¦è§£æ</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E7%AE%A1%E7%90%86%E6%B5%81%E5%88%9B%E5%BB%BAschema%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">
        
        
            <div class="article-image">
                <img src="/p/%E7%AE%A1%E7%90%86%E6%B5%81%E5%88%9B%E5%BB%BAschema%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20240801111546500.a4a283d1848dd7c78dd2f8154c075ded_hu9510561139179840573.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post ç®¡ç†æµåˆ›å»ºschemaæµç¨‹æºç è§£æ"
                        
                        data-hash="md5-pKKD0YSN18eN0vgVTAdd7Q==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">ç®¡ç†æµåˆ›å»ºschemaæµç¨‹æºç è§£æ</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo="sherlock-lin/utterances-comments"
        issue-term="pathname"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    let utterancesLoaded = false;

    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;

        
        utterancesLoaded = true;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        if (!utterancesLoaded) return;
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2022 - 
        
        2024 sherlock-lin
    </section>
    
    <section class="powerby">
        ä½¿ç”¨ <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> æ„å»º <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.27.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv">æœ¬ç«™æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"></span> æ¬¡ Â· </span>
<span id="busuanzi_container_site_uv">æ‚¨æ˜¯æœ¬ç«™ç¬¬ <span id="busuanzi_value_site_uv"></span> ä½è®¿é—®è€…</span>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
