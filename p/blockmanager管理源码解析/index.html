<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="Ê¶ÇËø∞ SparkÂ≠òÂÇ®‰∏ªË¶ÅÁî±BlockManagerÊù•ÂÆåÊàêÔºåÂÆÉ‰∏ªË¶ÅÂÆåÊàê‰∫ÜÔºö\nÂÜôÂÖ•Êï∞ÊçÆÂùóÔºåÂ¶ÇÊûúÈúÄË¶ÅÂ§á‰ªΩÊï∞ÊçÆÂùóÔºåÂàôÂ∞ÜÊï∞ÊçÆÂùóÂÜôÂÖ•ÂÖ∂‰ªñËäÇÁÇπÔºõ ËØªÂèñÊï∞ÊçÆÂùóÔºåÂ¶ÇÊûúÂΩìÂâçËäÇÁÇπ‰∏çÂê´ÊúâÊï∞ÊçÆÂùóÔºåÂàô‰ªéÂÖ∂‰ªñËäÇÁÇπËé∑ÂèñÊï∞ÊçÆÂùóÔºõ ÂêëDriverËäÇÁÇπÊ≥®ÂÜåËá™Ë∫´ÁöÑBlockManagerÔºå‰ª•Âèä‰∏äÊä•ÂÖ∂ÊâÄÁÆ°ÁêÜÁöÑÊï∞ÊçÆÂùóËäÇÁÇπ„ÄÇ Spark‰ΩøÁî®BlockInfoManagerÊù•ÁÆ°ÁêÜÂΩìÂâçËäÇÁÇπÊâÄÁÆ°ÁêÜÁöÑÊï∞ÊçÆÂùóÁöÑÂÖÉÊï∞ÊçÆÔºåÁª¥Êä§‰∫ÜBlockIdÔºàÊï∞ÊçÆÂùóÁöÑÂîØ‰∏ÄÊ†áËØÜÔºâÂà∞BlockInfoÔºàÊï∞ÊçÆÂùóÂÖÉÊï∞ÊçÆÔºâÁöÑÊò†Â∞ÑÂÖ≥Á≥ª„ÄÇ‰ΩøÁî®ÂÜÖÂ≠òÔºàMemoryStoreÔºâÂíåÁ£ÅÁõòÔºàDiskStoreÔºâÊù•Â≠òÂÇ®Êï∞ÊçÆÂùó„ÄÇSpark‰ΩøÁî®BlockManagerMaster‰ΩøExecutorÁöÑBlockManager‰∏éDriverËøõË°åÈÄö‰ø°ÔºåÂêëDriverÊ≥®ÂÜåËá™Â∑±ÔºåÂπ∂‰∏äÊä•Êï∞ÊçÆÂùó‰ø°ÊÅØ„ÄÇDriverÈÄöËøáExecutor BlockManagerÁöÑBlockManagerStorageEndpointÂêëExecutorÂèëÂá∫Âà†Èô§Êï∞ÊçÆÂùó/Rdd/Shuffle/BroadcastÁ≠âÊï∞ÊçÆ„ÄÇSpark‰ΩøÁî®BlockTransferServiceÊù•ÂÆûÁé∞‰∏çÂêåExecutor BlockManager‰πãÈó¥ÁöÑÈÄö‰ø°„ÄÇÁî®Ëøô‰∏™BlockTransferServiceÂéªÂÖ∂‰ªñblockManagerËé∑ÂèñÊï∞ÊçÆÂùóblockÊàñËÄÖÊõ¥Êñ∞Êï∞ÊçÆÂùóblock‰ø°ÊÅØ„ÄÇ\n">
<title>BlockManagerÁÆ°ÁêÜÊ∫êÁ†ÅËß£Êûê</title>

<link rel='canonical' href='https://sherlock-lin.github.io/p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="BlockManagerÁÆ°ÁêÜÊ∫êÁ†ÅËß£Êûê">
<meta property='og:description' content="Ê¶ÇËø∞ SparkÂ≠òÂÇ®‰∏ªË¶ÅÁî±BlockManagerÊù•ÂÆåÊàêÔºåÂÆÉ‰∏ªË¶ÅÂÆåÊàê‰∫ÜÔºö\nÂÜôÂÖ•Êï∞ÊçÆÂùóÔºåÂ¶ÇÊûúÈúÄË¶ÅÂ§á‰ªΩÊï∞ÊçÆÂùóÔºåÂàôÂ∞ÜÊï∞ÊçÆÂùóÂÜôÂÖ•ÂÖ∂‰ªñËäÇÁÇπÔºõ ËØªÂèñÊï∞ÊçÆÂùóÔºåÂ¶ÇÊûúÂΩìÂâçËäÇÁÇπ‰∏çÂê´ÊúâÊï∞ÊçÆÂùóÔºåÂàô‰ªéÂÖ∂‰ªñËäÇÁÇπËé∑ÂèñÊï∞ÊçÆÂùóÔºõ ÂêëDriverËäÇÁÇπÊ≥®ÂÜåËá™Ë∫´ÁöÑBlockManagerÔºå‰ª•Âèä‰∏äÊä•ÂÖ∂ÊâÄÁÆ°ÁêÜÁöÑÊï∞ÊçÆÂùóËäÇÁÇπ„ÄÇ Spark‰ΩøÁî®BlockInfoManagerÊù•ÁÆ°ÁêÜÂΩìÂâçËäÇÁÇπÊâÄÁÆ°ÁêÜÁöÑÊï∞ÊçÆÂùóÁöÑÂÖÉÊï∞ÊçÆÔºåÁª¥Êä§‰∫ÜBlockIdÔºàÊï∞ÊçÆÂùóÁöÑÂîØ‰∏ÄÊ†áËØÜÔºâÂà∞BlockInfoÔºàÊï∞ÊçÆÂùóÂÖÉÊï∞ÊçÆÔºâÁöÑÊò†Â∞ÑÂÖ≥Á≥ª„ÄÇ‰ΩøÁî®ÂÜÖÂ≠òÔºàMemoryStoreÔºâÂíåÁ£ÅÁõòÔºàDiskStoreÔºâÊù•Â≠òÂÇ®Êï∞ÊçÆÂùó„ÄÇSpark‰ΩøÁî®BlockManagerMaster‰ΩøExecutorÁöÑBlockManager‰∏éDriverËøõË°åÈÄö‰ø°ÔºåÂêëDriverÊ≥®ÂÜåËá™Â∑±ÔºåÂπ∂‰∏äÊä•Êï∞ÊçÆÂùó‰ø°ÊÅØ„ÄÇDriverÈÄöËøáExecutor BlockManagerÁöÑBlockManagerStorageEndpointÂêëExecutorÂèëÂá∫Âà†Èô§Êï∞ÊçÆÂùó/Rdd/Shuffle/BroadcastÁ≠âÊï∞ÊçÆ„ÄÇSpark‰ΩøÁî®BlockTransferServiceÊù•ÂÆûÁé∞‰∏çÂêåExecutor BlockManager‰πãÈó¥ÁöÑÈÄö‰ø°„ÄÇÁî®Ëøô‰∏™BlockTransferServiceÂéªÂÖ∂‰ªñblockManagerËé∑ÂèñÊï∞ÊçÆÂùóblockÊàñËÄÖÊõ¥Êñ∞Êï∞ÊçÆÂùóblock‰ø°ÊÅØ„ÄÇ\n">
<meta property='og:url' content='https://sherlock-lin.github.io/p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/'>
<meta property='og:site_name' content='Â§èÊ¥õÂÖã-Êûó'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2025-04-05T12:09:22&#43;08:00'/><meta property='article:modified_time' content='2025-04-05T12:09:22&#43;08:00'/><meta property='og:image' content='https://sherlock-lin.github.io/p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/dolphin-8949505_1280.jpg' />
<meta name="twitter:title" content="BlockManagerÁÆ°ÁêÜÊ∫êÁ†ÅËß£Êûê">
<meta name="twitter:description" content="Ê¶ÇËø∞ SparkÂ≠òÂÇ®‰∏ªË¶ÅÁî±BlockManagerÊù•ÂÆåÊàêÔºåÂÆÉ‰∏ªË¶ÅÂÆåÊàê‰∫ÜÔºö\nÂÜôÂÖ•Êï∞ÊçÆÂùóÔºåÂ¶ÇÊûúÈúÄË¶ÅÂ§á‰ªΩÊï∞ÊçÆÂùóÔºåÂàôÂ∞ÜÊï∞ÊçÆÂùóÂÜôÂÖ•ÂÖ∂‰ªñËäÇÁÇπÔºõ ËØªÂèñÊï∞ÊçÆÂùóÔºåÂ¶ÇÊûúÂΩìÂâçËäÇÁÇπ‰∏çÂê´ÊúâÊï∞ÊçÆÂùóÔºåÂàô‰ªéÂÖ∂‰ªñËäÇÁÇπËé∑ÂèñÊï∞ÊçÆÂùóÔºõ ÂêëDriverËäÇÁÇπÊ≥®ÂÜåËá™Ë∫´ÁöÑBlockManagerÔºå‰ª•Âèä‰∏äÊä•ÂÖ∂ÊâÄÁÆ°ÁêÜÁöÑÊï∞ÊçÆÂùóËäÇÁÇπ„ÄÇ Spark‰ΩøÁî®BlockInfoManagerÊù•ÁÆ°ÁêÜÂΩìÂâçËäÇÁÇπÊâÄÁÆ°ÁêÜÁöÑÊï∞ÊçÆÂùóÁöÑÂÖÉÊï∞ÊçÆÔºåÁª¥Êä§‰∫ÜBlockIdÔºàÊï∞ÊçÆÂùóÁöÑÂîØ‰∏ÄÊ†áËØÜÔºâÂà∞BlockInfoÔºàÊï∞ÊçÆÂùóÂÖÉÊï∞ÊçÆÔºâÁöÑÊò†Â∞ÑÂÖ≥Á≥ª„ÄÇ‰ΩøÁî®ÂÜÖÂ≠òÔºàMemoryStoreÔºâÂíåÁ£ÅÁõòÔºàDiskStoreÔºâÊù•Â≠òÂÇ®Êï∞ÊçÆÂùó„ÄÇSpark‰ΩøÁî®BlockManagerMaster‰ΩøExecutorÁöÑBlockManager‰∏éDriverËøõË°åÈÄö‰ø°ÔºåÂêëDriverÊ≥®ÂÜåËá™Â∑±ÔºåÂπ∂‰∏äÊä•Êï∞ÊçÆÂùó‰ø°ÊÅØ„ÄÇDriverÈÄöËøáExecutor BlockManagerÁöÑBlockManagerStorageEndpointÂêëExecutorÂèëÂá∫Âà†Èô§Êï∞ÊçÆÂùó/Rdd/Shuffle/BroadcastÁ≠âÊï∞ÊçÆ„ÄÇSpark‰ΩøÁî®BlockTransferServiceÊù•ÂÆûÁé∞‰∏çÂêåExecutor BlockManager‰πãÈó¥ÁöÑÈÄö‰ø°„ÄÇÁî®Ëøô‰∏™BlockTransferServiceÂéªÂÖ∂‰ªñblockManagerËé∑ÂèñÊï∞ÊçÆÂùóblockÊàñËÄÖÊõ¥Êñ∞Êï∞ÊçÆÂùóblock‰ø°ÊÅØ„ÄÇ\n"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://sherlock-lin.github.io/p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/dolphin-8949505_1280.jpg' />
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="ÂàáÊç¢ËèúÂçï">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/cs_hu10005534405353342465.jpg" width="300"
                            height="294" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ü•≥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Â§èÊ¥õÂÖã-Êûó</a></h1>
            <h2 class="site-description">Ê¨¢ËøéÊù•Âà∞‰∏Ä‰∏™ËØª‰π¶ÁãÇÈ≠î„ÄÅÂÅèÊâßÁãÇÁöÑÂçöÂÆ¢~</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/CaiJimmy/hugo-theme-stack'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>‰∏ªÈ°µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>ÂÖ≥‰∫é</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>ÂΩíÊ°£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>ÊêúÁ¥¢</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%8F%8B%E6%83%85%E9%93%BE%E6%8E%A5/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>ÂèãÊÉÖÈìæÊé•</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>ÊöóËâ≤Ê®°Âºè</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ÁõÆÂΩï</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#Ê¶ÇËø∞">Ê¶ÇËø∞</a></li>
    <li><a href="#blockinfomanager">BlockInfoManager</a>
      <ol>
        <li><a href="#blockidËß£Êûê">BlockIdËß£Êûê</a></li>
        <li><a href="#blockinfoËß£Êûê">BlockInfoËß£Êûê</a></li>
      </ol>
    </li>
    <li><a href="#blockmanagerËß£Êûê">BlockManagerËß£Êûê</a>
      <ol>
        <li><a href="#blockmanagerÁöÑÁªÑ‰ª∂">BlockManagerÁöÑÁªÑ‰ª∂</a></li>
        <li><a href="#blockmanagerÂàõÂª∫ÁöÑÊó∂Êú∫">BlockManagerÂàõÂª∫ÁöÑÊó∂Êú∫</a></li>
      </ol>
    </li>
    <li><a href="#blockmanagermasterËß£Êûê">BlockManagerMasterËß£Êûê</a></li>
    <li><a href="#blockmanagermasterendpoint">BlockManagerMasterEndpoint</a>
      <ol>
        <li><a href="#blockmanagermasterendpointÁöÑÊñπÊ≥ï">BlockManagerMasterEndpointÁöÑÊñπÊ≥ï</a>
          <ol>
            <li><a href="#receiveandreply">receiveAndReply</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#Â≠òÂèñblockÁöÑËøáÁ®ã">Â≠òÂèñblockÁöÑËøáÁ®ã</a>
      <ol>
        <li><a href="#executorÁ´ØÂ≠òÂÇ®blockÁöÑÊâßË°åÊµÅÁ®ã">ExecutorÁ´ØÂ≠òÂÇ®blockÁöÑÊâßË°åÊµÅÁ®ã</a></li>
        <li><a href="#driverÁ´ØÁöÑËé∑ÂèñblockÁöÑÊâßË°åÊµÅÁ®ã">driverÁ´ØÁöÑËé∑ÂèñblockÁöÑÊâßË°åÊµÅÁ®ã</a></li>
      </ol>
    </li>
    <li><a href="#Âà†Èô§blockÁöÑËøáÁ®ã">Âà†Èô§blockÁöÑËøáÁ®ã</a></li>
    <li><a href="#ÊÄªÁªì">ÊÄªÁªì</a></li>
    <li><a href="#ÂèÇËÄÉ">ÂèÇËÄÉ</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">
                <img src="/p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/dolphin-8949505_1280_hu12894558835196541998.jpg"
                        srcset="/p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/dolphin-8949505_1280_hu12894558835196541998.jpg 800w, /p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/dolphin-8949505_1280_hu53765993347886950.jpg 1600w"
                        width="800" 
                        height="533" 
                        loading="lazy"
                        alt="Featured image of post BlockManagerÁÆ°ÁêÜÊ∫êÁ†ÅËß£Êûê" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/spark/" style="background-color: #2a9d8f; color: #fff;">
                Spark
            </a>
        
            <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" style="background-color: #2a9d8f; color: #fff;">
                Â§ßÊï∞ÊçÆ
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">BlockManagerÁÆ°ÁêÜÊ∫êÁ†ÅËß£Êûê</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2025-04-05</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    ÈòÖËØªÊó∂Èïø: 27 ÂàÜÈíü
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="Ê¶ÇËø∞">Ê¶ÇËø∞
</h2><p><img src="/p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250405104327775.png"
	width="1926"
	height="1070"
	srcset="/p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250405104327775_hu6286005587082314117.png 480w, /p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250405104327775_hu8205538478772633062.png 1024w"
	loading="lazy"
	
		alt="image-20250405104327775"
	
	
		class="gallery-image" 
		data-flex-grow="180"
		data-flex-basis="432px"
	
></p>
<p>SparkÂ≠òÂÇ®‰∏ªË¶ÅÁî±BlockManagerÊù•ÂÆåÊàêÔºåÂÆÉ‰∏ªË¶ÅÂÆåÊàê‰∫ÜÔºö</p>
<ol>
<li>ÂÜôÂÖ•Êï∞ÊçÆÂùóÔºåÂ¶ÇÊûúÈúÄË¶ÅÂ§á‰ªΩÊï∞ÊçÆÂùóÔºåÂàôÂ∞ÜÊï∞ÊçÆÂùóÂÜôÂÖ•ÂÖ∂‰ªñËäÇÁÇπÔºõ</li>
<li>ËØªÂèñÊï∞ÊçÆÂùóÔºåÂ¶ÇÊûúÂΩìÂâçËäÇÁÇπ‰∏çÂê´ÊúâÊï∞ÊçÆÂùóÔºåÂàô‰ªéÂÖ∂‰ªñËäÇÁÇπËé∑ÂèñÊï∞ÊçÆÂùóÔºõ</li>
<li>ÂêëDriverËäÇÁÇπÊ≥®ÂÜåËá™Ë∫´ÁöÑBlockManagerÔºå‰ª•Âèä‰∏äÊä•ÂÖ∂ÊâÄÁÆ°ÁêÜÁöÑÊï∞ÊçÆÂùóËäÇÁÇπ„ÄÇ</li>
</ol>
<p>Spark‰ΩøÁî®BlockInfoManagerÊù•ÁÆ°ÁêÜÂΩìÂâçËäÇÁÇπÊâÄÁÆ°ÁêÜÁöÑÊï∞ÊçÆÂùóÁöÑÂÖÉÊï∞ÊçÆÔºåÁª¥Êä§‰∫ÜBlockIdÔºàÊï∞ÊçÆÂùóÁöÑÂîØ‰∏ÄÊ†áËØÜÔºâÂà∞BlockInfoÔºàÊï∞ÊçÆÂùóÂÖÉÊï∞ÊçÆÔºâÁöÑÊò†Â∞ÑÂÖ≥Á≥ª„ÄÇ‰ΩøÁî®ÂÜÖÂ≠òÔºàMemoryStoreÔºâÂíåÁ£ÅÁõòÔºàDiskStoreÔºâÊù•Â≠òÂÇ®Êï∞ÊçÆÂùó„ÄÇSpark‰ΩøÁî®BlockManagerMaster‰ΩøExecutorÁöÑBlockManager‰∏éDriverËøõË°åÈÄö‰ø°ÔºåÂêëDriverÊ≥®ÂÜåËá™Â∑±ÔºåÂπ∂‰∏äÊä•Êï∞ÊçÆÂùó‰ø°ÊÅØ„ÄÇDriverÈÄöËøáExecutor BlockManagerÁöÑBlockManagerStorageEndpointÂêëExecutorÂèëÂá∫Âà†Èô§Êï∞ÊçÆÂùó/Rdd/Shuffle/BroadcastÁ≠âÊï∞ÊçÆ„ÄÇSpark‰ΩøÁî®BlockTransferServiceÊù•ÂÆûÁé∞‰∏çÂêåExecutor BlockManager‰πãÈó¥ÁöÑÈÄö‰ø°„ÄÇÁî®Ëøô‰∏™BlockTransferServiceÂéªÂÖ∂‰ªñblockManagerËé∑ÂèñÊï∞ÊçÆÂùóblockÊàñËÄÖÊõ¥Êñ∞Êï∞ÊçÆÂùóblock‰ø°ÊÅØ„ÄÇ</p>
<p>SparkËÆæÁΩÆ‰∫ÜÂ§öÁßçÂ≠òÂÇ®Á∫ßÂà´Ôºö</p>
<ul>
<li>DISK_ONLY	Âè™‰ΩøÁî®Á£ÅÁõòÂ≠òÂÇ®</li>
<li>DISK_ONLY_2	Âè™‰ΩøÁî®Á£ÅÁõòÂ≠òÂÇ®ÔºåÂπ∂‰∏îÊúâ‰∏Ä‰∏™Â§á‰ªΩ</li>
<li>MEMORY_ONLY	Âè™‰ΩøÁî®ÂÜÖÂ≠òÂÇ®Â≠òÂÇ®</li>
<li>MEMORY_ONLY_2	Âè™‰ΩøÁî®ÂÜÖÂ≠òÂ≠òÂÇ®ÔºåÂπ∂Êúâ‰∏Ä‰∏™Â§á‰ªΩ</li>
<li>MEMORY_ONLY_SER	Âè™‰ΩøÁî®ÂÜÖÂ≠òÂ≠òÂÇ®Â∫èÂàóÂåñÊï∞ÊçÆ</li>
<li>MEMORY_ONLY_SER_2	Âè™‰ΩøÁî®ÂÜÖÂ≠òÂ≠òÂÇ®Â∫èÂàóÂåñÊï∞ÊçÆÔºåÂπ∂Êúâ‰∏Ä‰∏™Â§á‰ªΩ</li>
<li>MEMORY_AND_DISK	Âè™‰ΩøÁî®ÂÜÖÂ≠òÂ≠òÂÇ®Â∫èÂàóÂåñÊï∞ÊçÆÔºåÂπ∂Êúâ‰∏Ä‰∏™Â§á‰ªΩ</li>
<li>MEMORY_AND_DISK_2	‰ºòÂÖàÂÜÖÂ≠òÂ≠òÂÇ®ÔºåÂÜÖÂ≠ò‰∏çË∂≥‰ΩøÁî®Á£ÅÁõòÔºåÂπ∂Êúâ‰∏Ä‰∏™Â§á‰ªΩ</li>
<li>MEMORY_AND_DISK_SER	‰ºòÂÖàÂÜÖÂ≠òÂ≠òÂÇ®Â∫èÂàóÂåñÊï∞ÊçÆÔºåÂÜÖÂ≠ò‰∏çË∂≥‰ΩøÁî®Á£ÅÁõò</li>
<li>MEMORY_AND_DISK_SER_2	‰ºòÂÖàÂÜÖÂ≠òÂ≠òÂÇ®Â∫èÂàóÂåñÊï∞ÊçÆÔºåÂÜÖÂ≠ò‰∏çË∂≥‰ΩøÁî®Á£ÅÁõòÔºåÂπ∂Êúâ‰∏Ä‰∏™Â§á‰ªΩ</li>
<li>OFF_HEAP	‰ΩøÁî®Â†ÜÂ§ñÂ≠òÂÇ®ÔºàÂêåMEMORY_AND_DISK_SERÔºåÂè™ÊòØ‰ΩøÁî®Â†ÜÂ§ñÂÜÖÂ≠òÔºâ</li>
</ul>
<p>put blockÔºàÂÜôÂÖ•Êï∞ÊçÆÂùóÔºâÔºöÂú®ÂÜôÊï∞ÊçÆÂùóÁöÑÊó∂ÂÄôÔºåÊ†πÊçÆÂ≠òÂÇ®Á∫ßÂà´ÁöÑ‰∏çÂêåÔºåÂ¶ÇÊûúÂ≠òÂÇ®Á∫ßÂà´Ë¶ÅÊ±ÇÂ≠òÂÇ®Â∫èÂàóÂåñ/ÈùûÂ∫èÂàóÂåñÁöÑÊï∞ÊçÆÔºåËÄåËæìÂÖ•ÁöÑÊï∞ÊçÆÂùóÊòØÈùûÂ∫èÂàóÂåñ/Â∫èÂàóÂåñÁöÑÔºåÂàôË¶ÅÈ¶ñÂÖàÂ∫èÂàóÂåñ/ÂèçÂ∫èÂàóÂåñÔºõÂ¶ÇÊûúÊîØÊåÅÂÜÖÂ≠òÂ≠òÂÇ®ÔºåÂàôÂ∞ÜÊï∞ÊçÆÂùó‰øùÂ≠òÂà∞ÂÜÖÂ≠ò‰∏≠ÔºåÂ¶ÇÊûúËÆæÁΩÆ‰∫ÜMEMORY_AND_DISK‰πãÁ±ªÁöÑÂ≠òÂÇ®Á∫ßÂà´ÔºåÂΩìÂÜÖÂ≠ò‰∏çË∂≥Êó∂Ôºå‰ºöÂ∞ÜÊï∞ÊçÆÂùóÂÜôÂÖ•Á£ÅÁõò„ÄÇÂ¶ÇÊûú‰∏çÊîØÊåÅÂÜÖÂ≠òÂ≠òÂÇ®ÔºåÂè™ÊîØÊåÅÁ£ÅÁõòÂ≠òÂÇ®ÔºåÂàôÁõ¥Êé•Â∞ÜÊï∞ÊçÆÂùóÂÜôÂÖ•Á£ÅÁõò„ÄÇÂ¶ÇÊûúÈúÄË¶ÅÂ§á‰ªΩÊï∞ÊçÆÂùóÔºåÂàôÂ∞ÜÊï∞ÊçÆÂùóÂêåÊ≠•ÁöÑÂÜôÂÖ•ÂÖ∂‰ªñËäÇÁÇπ„ÄÇ</p>
<p>get blockÔºàËé∑ÂèñÊï∞ÊçÆÂùóÔºâÔºöËé∑ÂèñÊï∞ÊçÆÂùóÊó∂ÔºåÂ¶ÇÊûúËØ∑Ê±ÇÂ∫èÂàóÂåñÁöÑÊï∞ÊçÆËÄåÂ≠òÂÇ®Á∫ßÂà´ÊòØÈùûÂ∫èÂàóÂåñÔºåÂàô‰ºòÂÖà‰ªéÁ£ÅÁõò‰∏≠Ëé∑ÂèñÊï∞ÊçÆÔºåÂ¶ÇÊûúÁ£ÅÁõòËé∑Âèñ‰∏çÂà∞ÔºåÂàôÊ†πÊçÆÂ≠òÂÇ®Á∫ßÂà´Â∞ùËØï‰ªéÂÜÖÂ≠òËé∑ÂèñÊï∞ÊçÆÂπ∂Â∞ÜÂÖ∂Â∫èÂàóÂåñÔºõÂ¶ÇÊûúÂ≠òÂÇ®Á∫ßÂà´Â∞±ÊòØÂ∫èÂàóÂåñÊï∞ÊçÆÔºåÂàôÈ¶ñÂÖàÂ∞ùËØï‰ªéÂÜÖÂ≠òËé∑ÂèñÊï∞ÊçÆÔºåÂ¶ÇÊûúËé∑Âèñ‰∏çÂà∞ÔºåÂàôÊ†πÊçÆÂ≠òÂÇ®Á∫ßÂà´‰ªéÁ£ÅÁõòËé∑ÂèñÊï∞ÊçÆ„ÄÇÂ¶ÇÊûúËØ∑Ê±ÇÁöÑÊòØÈùûÂ∫èÂàóÂåñÁöÑÊï∞ÊçÆÔºåÂ¶ÇÊûúÂ≠òÂÇ®Á∫ßÂà´ÂåÖÊã¨ÂÜÖÂ≠òÔºåÂàôÈ¶ñÂÖàÂ∞ùËØï‰ªéÂÜÖÂ≠òËé∑ÂèñÔºåÂ¶ÇÊûúËé∑Âèñ‰∏çÂà∞ÔºåÂàôÊ†πÊçÆÂ≠òÂÇ®Á∫ßÂà´ÂÜçÂ∞ùËØï‰ªéÁ£ÅÁõòËé∑ÂèñÂπ∂ÂèçÂ∫èÂàóÂåñÊï∞ÊçÆÔºõÂ¶ÇÊûúÂ≠òÂÇ®Á∫ßÂà´Âè™ÂåÖÊã¨Á£ÅÁõòÔºåÂàôÁõ¥Êé•‰ªéÁ£ÅÁõòËé∑ÂèñÂπ∂ÂèçÂ∫èÂàóÂåñÊï∞ÊçÆ„ÄÇ</p>
<p>register &amp; register blockÔºàÊ≥®ÂÜåBlockManager&amp;‰∏äÊä•Êï∞ÊçÆÂùó‰ø°ÊÅØÔºâÔºöExecutorÁöÑBlockManagerÂú®ÂàùÂßãÂåñÊó∂ÈúÄË¶ÅÂêëDriverÊ≥®ÂÜåÔºåÂπ∂ÂÆöÊó∂‰∏äÊä•ÂÖ∂ÊâÄÁÆ°ÁêÜÁöÑÊï∞ÊçÆÂùó‰ø°ÊÅØ„ÄÇ</p>
<p>removeÔºàÂà†Èô§Êï∞ÊçÆÂùóÔºâÔºöDriverÂêëExecutor BlockManager‰∏ãÂèëÂà†Èô§Êï∞ÊçÆÂùó/Rdd/Shuffle/BroadcastÁ≠âÊï∞ÊçÆÁöÑÊåá‰ª§ÔºåExecutor BlockManagerÊé•Êî∂Êåá‰ª§Âπ∂Âú®Êú¨Âú∞ÊâßË°åÂà†Èô§Êìç‰Ωú„ÄÇ</p>
<h2 id="blockinfomanager">BlockInfoManager
</h2><p>BlockInfoManager‰∏ªË¶ÅÁª¥Êä§‰∫ÜBlockManagerÊâÄÁÆ°ÁêÜÁöÑÊâÄÊúâÊï∞ÊçÆÂùóÂÖÉÊï∞ÊçÆ‰ª•ÂèäÂØπÁî≥ËØ∑Êï∞ÊçÆÂùóËØªÂÜôÁöÑ‰ªªÂä°Êèê‰æõÊï∞ÊçÆÂùóËØªÂÜôÈîÅ„ÄÇSpark‰∏≠ÁöÑÊï∞ÊçÆÂùóÈô§‰∫ÜÂÆûÈôÖÂ≠òÂÇ®Êï∞ÊçÆÁöÑBlock‰πãÂ§ñÔºåËøòÊúâ‰∏§‰∏™Êï∞ÊçÆÁªìÊûÑÔºåBlockIdÂíåBlockInfoÂàÜÂà´Áî®Êù•‰∏∫Êï∞ÊçÆÂùóÊèê‰æõÂÖ®Â±ÄÂîØ‰∏ÄÁöÑÊ†áËÆ∞Ôºå‰ª•ÂèäËÆ∞ÂΩïÊï∞ÊçÆÂùóÁöÑÂÖÉÊï∞ÊçÆ„ÄÇ</p>
<h3 id="blockidËß£Êûê">BlockIdËß£Êûê
</h3><p>Âú®SparkÁöÑÂ≠òÂÇ®‰ΩìÁ≥ª‰∏≠ÔºåÊï∞ÊçÆÁöÑËØªÂÜôÊòØ‰ª•block‰∏∫Âçï‰ΩçÁöÑÔºåËøôÊòØÁî®Êà∑ÁöÑÊìç‰ΩúÂçï‰ΩçÔºå‰∏Ä‰∏™BlockÂØπÂ∫î‰∏ÄÂùóÂÜÖÂ≠ò„ÄÇÊØè‰∏™blockÈÉΩÊúâÂîØ‰∏ÄÁöÑÊ†áËØÜÔºåSparkÊääËøô‰∏™Ê†áËØÜÊäΩË±°ÊàêBlockIdÔºåblockIdÊúâÂ§ö‰∏™ÂÆûÁé∞Á±ªÔºåÂ§ßËá¥ÂèØ‰ª•ÊúçÂä°‰∫éShuffle„ÄÅRDD„ÄÅBroadcast„ÄÅTaskReuslt„ÄÅStreamÁ≠â</p>
<p><img src="/p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250405111315357.png"
	width="980"
	height="420"
	srcset="/p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250405111315357_hu15846251071821746649.png 480w, /p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250405111315357_hu18326209398234817706.png 1024w"
	loading="lazy"
	
		alt="image-20250405111315357"
	
	
		class="gallery-image" 
		data-flex-grow="233"
		data-flex-basis="560px"
	
></p>
<h3 id="blockinfoËß£Êûê">BlockInfoËß£Êûê
</h3><p>BlockInfoÊòØÂØπ‰∏Ä‰∏™BlockÂÖÉ‰ø°ÊÅØÁöÑËÆ∞ÂΩïÔºåÂèØ‰ª•Êñπ‰æøË∑üË∏™blockidÁöÑ‰∏Ä‰∫õÂü∫Êú¨Êï∞ÊçÆÔºåËØ•Á±ªÁî±‰∏â‰∏™ÂèòÈáèÊèèËø∞Ôºö</p>
<ol>
<li>levelÔºöÂùóÁöÑÊúüÊúõÂ≠òÂÇ®Á≠âÁ∫ßÔºå‰∏ç‰ª£Ë°®ÂÆûÈôÖÁöÑÂ≠òÂÇ®ÊÉÖÂÜµ„ÄÇËÄåËøô‰∏™Â∞±ÊòØStorageLevel</li>
<li>classTagÔºöÂùóÁöÑÁ±ªÊ†áÁ≠æ</li>
<li>tellMasterÔºöÊòØÂê¶Ë¶ÅÂ∞ÜËØ•ÂùóÁöÑÂÖÉ‰ø°ÊÅØÂëäÁü•Master</li>
<li>sizeÔºöËøô‰∏™ÂùóÁöÑÂ∞∫ÂØ∏</li>
<li>readerCountÔºöËØ•ÂùóÂ∑≤ÈîÅÂÆöÁî®‰∫éreadÁöÑÊ¨°Êï∞</li>
<li>writerTaskÔºöÂΩìÂâçÊåÅÊúâËØ•ÂùóÂÜôÈîÅÁöÑTaskID</li>
</ol>
<h2 id="blockmanagerËß£Êûê">BlockManagerËß£Êûê
</h2><p>Spark‰∏≠‰ΩøÁî®BlockManagerÂùóÊù•ÁÆ°ÁêÜÂΩìÂâçËäÇÁÇπÂÜÖÂ≠òÂíåÁ£ÅÁõòÁöÑÊï∞ÊçÆÂùóÔºåDriverÂíåExecutorËäÇÁÇπÈÉΩ‰ºöÂàõÂª∫BlockManager„ÄÇ ÂùóÁÆ°ÁêÜÂô®Ë¥üË¥£Êï∞ÊçÆÁöÑËØªÂÜôËØ∑Ê±ÇÔºåÂà†Èô§Á≠âÊìç‰ΩúÔºåÂπ∂ÂêëDriverËäÇÁÇπÊ≥®ÂÜåÔºåÊ±áÊä•ÂÖ∂ÊâÄÁÆ°ÁêÜÁöÑÊï∞ÊçÆÂùóÂÖÉÊï∞ÊçÆ‰ø°ÊÅØÔºàÂ¶ÇÊûúÊòØDriverËäÇÁÇπÁöÑÂùóÁÆ°ÁêÜÂô®ÔºåÂàôÊï¥‰∏™Ê≥®ÂÜåËøáÁ®ãÊó†ÈúÄÁΩëÁªúÈÄö‰ø°ÔºåÂ¶ÇÊûúÊòØExecutorËäÇÁÇπÁöÑÂùóÁÆ°ÁêÜÂô®Ê≥®ÂÜåÔºåÂàôÈúÄË¶Å‰∏éDriverËäÇÁÇπËøõË°åÁΩëÁªúÈÄö‰ø°Ôºâ„ÄÇÂΩìËäÇÁÇπÈúÄË¶ÅÁöÑÊï∞ÊçÆÂùó‰∏çÂú®Êú¨Âú∞Êó∂ÔºåÂùóÁÆ°ÁêÜÂô®‰ºöÈ¶ñÂÖàÈÄöËøáDriverËäÇÁÇπËé∑ÂèñÂà∞ÊåÅÊúâÊâÄÈúÄÊï∞ÊçÆÂùóÁöÑËäÇÁÇπÔºåÁÑ∂ÂêéÁõ¥Êé•‰∏éËØ•ËäÇÁÇπËøõË°åÈÄö‰ø°ÔºåÂÆåÊàêÊï∞ÊçÆÁöÑ‰º†Ëæì„ÄÇÂÖ∂‰∏≠Ê∂âÂèäÂà∞ÁöÑÈÄö‰ø°Ôºà‰∏çËÆ∫ÊòØÁΩëÁªúÈÄö‰ø°ËøòÊòØÊú¨Âú∞ÈÄö‰ø°ÔºâÔºåÈÉΩÊòØÈÄöËøáSparkÁöÑRPCÊ°ÜÊû∂ÂÆûÁé∞ÁöÑ</p>
<h3 id="blockmanagerÁöÑÁªÑ‰ª∂">BlockManagerÁöÑÁªÑ‰ª∂
</h3><ul>
<li>
<p>MemoryStore Ë¥üË¥£ÂÜÖÂ≠òÊï∞ÊçÆÁöÑËØªÂÜôÊìç‰Ωú„ÄÇMemoryStoreÁî®Êù•Â∞ÜÊï∞ÊçÆÂùó‰ª•Â∫èÂàóÂåñ/ÈùûÂ∫èÂàóÂåñÁöÑÂΩ¢Âºè‰øùÂ≠òÂà∞ÂÜÖÂ≠ò‰∏≠Ôºå‰ª•Âèä‰ªéÂÜÖÂ≠ò‰∏≠Ëé∑ÂèñÊï∞ÊçÆÂùó„ÄÇÂΩìÂÜÖÂ≠òÁ©∫Èó¥‰∏çË∂≥Êó∂ÔºåMemoryStore‰ºöÂ∞ÜÂÜÖÂ≠ò‰∏≠ÁöÑÊï∞ÊçÆÂùóËøÅÁßªÂà∞Á£ÅÁõò‰∏≠„ÄÇ</p>
</li>
<li>
<p>DiskStoreË¥üË¥£Á£ÅÁõòÊï∞ÊçÆÁöÑËØªÂÜôÊìç‰Ωú„ÄÇDiskStoreÁî®Êù•Â∞ÜÊï∞ÊçÆÂùóÂ≠òÂÇ®Âà∞Á£ÅÁõò‰∏äÔºå‰ª•Âèä‰ªéÁ£ÅÁõò‰∏äËé∑ÂèñÊï∞ÊçÆÂùó„ÄÇÂ¶ÇÊûúÊï∞ÊçÆÂùóÁöÑÂ≠òÂÇ®Á∫ßÂà´ÈÖçÁΩÆ‰∫ÜÁ£ÅÁõòÔºåÂàôÂΩìÂÜÖÂ≠ò‰∏çË∂≥Êó∂ÔºåSpark‰ºöÂ∞ÜÊï∞ÊçÆÂùó‰ªéÂÜÖÂ≠òÁßªÂä®Âà∞Á£ÅÁõò‰∏ä„ÄÇÂú®Êñ∞Âª∫DiskStoreÊó∂Ôºå‰ºö‰º†ÂÖ•DiskBlockManagerÂÆû‰æãÔºåDiskBlockManager‰∏ªË¶ÅÁî®Êù•ÂàõÂª∫ÂíåÁª¥Êä§ÈÄªËæëÊï∞ÊçÆÂùóÂíåÁ£ÅÁõòÂÆûÈôÖÂ≠òÂÇ®ÁöÑÁâ©ÁêÜ‰ΩçÁΩÆÁöÑÊò†Â∞ÑÂÖ≥Á≥ª„ÄÇ</p>
</li>
<li>
<p>BlockTransferService ËøôÈáåmapOutputTracker‰∏éÂÖ∂‰ªñÁöÑBlockMangerËøûÊé•ÊàêÂäüÂêéÔºåË¥üË¥£ËøõË°åÊï∞ÊçÆÁöÑ‰º†ËæìÔºåÊñπÊ≥ïÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>‰ªéÂÖ∂‰ªñExecutorËé∑ÂèñÊï∞ÊçÆÂùóÁöÑÊñπÊ≥ïfetechBlocks</li>
<li>ÂìçÂ∫îÂÖ∂‰ªñExecutorÁöÑËØ∑Ê±ÇÔºåÂ∞ÜÊï∞ÊçÆÂùóËøîÂõûÁªôËØ∑Ê±ÇÁöÑExecutor„ÄÇuploadBlock</li>
</ul>
</li>
<li>
<p>mapOutputTracker„ÄÇ shuffleËæìÂá∫ÁöÑÊó∂ÂÄôÔºåË¶ÅËÆ∞ÂΩïshufflemaptaskÁöÑËæìÂá∫‰ΩçÁΩÆÔºå‰ª•‰æõ‰∏ã‰∏Ä‰∏™Stage‰ΩøÁî®ÔºåÂõ†Ê≠§ÈúÄË¶ÅËøõË°åËÆ∞ÂΩï</p>
</li>
<li>
<p>DiskBlockManager„ÄÇDiskBlockManagerÁî®Êù•ÂàõÂª∫Âπ∂Áª¥Êä§ÈÄªËæëÊï∞ÊçÆÂùóÂíåÁ£ÅÁõòÂÆûÈôÖÂ≠òÂÇ®ÁöÑÁâ©ÁêÜ‰ΩçÁΩÆÁöÑÊò†Â∞ÑÂÖ≥Á≥ª„ÄÇÊï∞ÊçÆÂùó‰ºöË¢´‰øùÂ≠òÂà∞‰ª•BlockId‰∏∫ÂêçÂ≠óÁöÑÊñá‰ª∂‰∏≠„ÄÇÊï∞ÊçÆÂùóÊñá‰ª∂‰ºöË¢´hashÂà∞spark.local.dirÊâÄÈÖçÁΩÆÁöÑÁõÆÂΩï„ÄÇ</p>
</li>
</ul>
<h3 id="blockmanagerÂàõÂª∫ÁöÑÊó∂Êú∫">BlockManagerÂàõÂª∫ÁöÑÊó∂Êú∫
</h3><p><strong>DriverÁ´Ø</strong></p>
<p>Âú®DriverÁöÑÂàõÂª∫ÁéØÂ¢ÉSparkEnvÁöÑÊó∂ÂÄôÂàõÂª∫</p>
<p><strong>ExecutorÁ´Ø</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">val</span><span class="w"> </span><span class="n">blockManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BlockManager</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">executorId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">rpcEnv</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">blockManagerMaster</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">serializerManager</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">conf</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">memoryManager</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">mapOutputTracker</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// shuffleManagerÊòØÂú®SparkEnv‰∏≠ÂàõÂª∫ÁöÑÔºåÂ∞ÜshuffleManager‰º†ÂÖ•Âà∞BlockManagerÔºåBlockManagerÂ∞±Êã•ÊúâshuffleManagerÁöÑÊàêÂëòÂèòÈáèÔºå</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// ‰ªéËÄåÂèØ‰ª•Ë∞ÉÁî®shuffleManagerÁöÑÁõ∏ÂÖ≥ÊñπÊ≥ï</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">shuffleManager</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">blockTransferService</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">securityManager</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">externalShuffleClient</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ÂèØ‰ª•ÁúãÂà∞Âú®ÂàõÂª∫blockManagerÁöÑÊó∂ÂÄôÔºå‰º†ÂÖ•‰∫ÜblockManagerMasterÁöÑÂèÇÊï∞ÔºåmemoryManagerÔºåmapOutputTrackerÔºåÔºàÂÆûÁé∞ÊòØUnifiedMemoryManagerÔºâ‰ª•ÂèäblockTransferServiceÁöÑ‰∏éÂùóÁÆ°ÁêÜÁõ∏ÂÖ≥ÁöÑÂèÇÊï∞„ÄÇÊé•‰∏ãÊù•ÁöÑÁØáÂπÖ‰ºöËÆ≤Ëß£ËøôÂá†‰∏™ÈÉ®ÂàÜ</p>
<p>ÁÑ∂ÂêéÂõûÂà∞<code>SparkContext</code>ÔºåÂú®ËøôÈáåÊâßË°å‰∫Ü</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">_env</span><span class="p">.</span><span class="na">blockManager</span><span class="p">.</span><span class="na">initialize</span><span class="p">(</span><span class="n">_applicationId</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Ë°®Á§∫Â∏¶ÁùÄÂ∫îÁî®IDÊù•Ê≥®ÂÜåblockManager.ÁÇπËøõÂéªÊñπÊ≥ïÈáåÈù¢,</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">appId</span><span class="p">:</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="cm">/** Â∫îÁî®id **/</span><span class="p">):</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Ë∞ÉÁî®blockTransferServiceÁöÑinitÊñπÊ≥ïÔºåblockTransferServiceÁî®‰∫éÂú®‰∏çÂêåËäÇÁÇπfetchÊï∞ÊçÆÔºå‰º†ÈÄÅÊï∞ÊçÆ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// ÂàùÂßãÂåñBlockTransferService</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">blockTransferService</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">externalBlockStoreClient</span><span class="p">.</span><span class="na">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">blockStoreClient</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// Áî®‰∫éËØªÂèñÂÖ∂‰ªñExecutor‰∏äÁöÑshuffle files</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// ÂàùÂßãÂåñShuffleClient</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">blockStoreClient</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">appId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">blockReplicationPolicy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">priorityClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conf</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="na">STORAGE_REPLICATION_POLICY</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Utils</span><span class="p">.</span><span class="na">classForName</span><span class="p">(</span><span class="n">priorityClass</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getConstructor</span><span class="p">().</span><span class="na">newInstance</span><span class="p">().</span><span class="na">asInstanceOf</span><span class="o">[</span><span class="n">BlockReplicationPolicy</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">logInfo</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Using $priorityClass for block replication policy&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// ÂàõÂª∫BlockManagerId</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">BlockManagerId</span><span class="p">(</span><span class="n">executorId</span><span class="p">,</span><span class="w"> </span><span class="n">blockTransferService</span><span class="p">.</span><span class="na">hostName</span><span class="p">,</span><span class="w"> </span><span class="n">blockTransferService</span><span class="p">.</span><span class="na">port</span><span class="p">,</span><span class="w"> </span><span class="n">None</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// ÂêëblockManagerMasterÊ≥®ÂÜåBlockManagerÔºåÂú®registerBlockManagerÊñπÊ≥ï‰∏≠‰º†ÂÖ•‰∫ÜslaveEndpointÔºåslaveEndpoint‰∏∫BlockManager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// ‰∏≠ÁöÑRPCÂØπË±°ÔºåÁî®‰∫éÂíåblockManagerMasaterÈÄö‰ø°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">idFromMaster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">.</span><span class="na">registerBlockManager</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">diskBlockManager</span><span class="p">.</span><span class="na">localDirsString</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">maxOnHeapMemory</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">maxOffHeapMemory</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">storageEndpoint</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="c1">// Ëøô‰∏™Ê∂àÊÅØÂæ™ÁéØ‰ΩìÊù•Êé•Êî∂Driver‰∏≠BlockManagerMasterÁöÑ‰ø°ÊÅØ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// ÂæóÂà∞shuffleManageId</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">blockManagerId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idFromMaster</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="n">idFromMaster</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// ÂæóÂà∞shuffleServerId</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">shuffleServerId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">externalShuffleServiceEnabled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logInfo</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;external shuffle service port = $externalShuffleServicePort&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">BlockManagerId</span><span class="p">(</span><span class="n">executorId</span><span class="p">,</span><span class="w"> </span><span class="n">blockTransferService</span><span class="p">.</span><span class="na">hostName</span><span class="p">,</span><span class="w"> </span><span class="n">externalShuffleServicePort</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">blockManagerId</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Register Executors&#39; configuration with the local shuffle service, if one should exist.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Ê≥®ÂÜåshuffleserver</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Â¶ÇÊûúÂ≠òÂú®ÔºåÂ∞ÜÊ≥®ÂÜåExecutorsÈÖçÁΩÆ‰∏éÊú¨Âú∞shuffleÊúçÂä°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">externalShuffleServiceEnabled</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">blockManagerId</span><span class="p">.</span><span class="na">isDriver</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">registerWithExternalShuffleServer</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">logInfo</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Initialized BlockManager: $blockManagerId&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Â∞±ÊòØÊâßË°åÂ¶Ç‰∏ãÊ≠•È™§:</p>
<ol>
<li>ÂàùÂßãÂåñBlockTransferService<code>blockTransferService.init(this)</code>,Ëøô‰∏™Á±ªÊòØÁî®Êù•ËøõË°åÁΩëÁªúËøûÊé•Ëé∑ÂèñËøúÁ®ãÊï∞ÊçÆÁöÑ</li>
<li>master.registerBlockManagerÂêëBlockManagerMasterÊ≥®ÂÜå,Ëøô‰∏™Êó∂ÂÄôBlockManagerMaster‰ºö‰∏∫ËØ•BlockManagerÂàõÂª∫ÂØπÂ∫îÁöÑBlockManagerInfo,BlockManagerInfoÁÆ°ÁêÜÈõÜÁæ§‰∏≠ÊØè‰∏™ExecutorÁöÑBlockManagerÂÖÉÊï∞ÊçÆ,Âπ∂Â≠òÂÇ®Âà∞BlockStatus‰∏≠</li>
</ol>
<p><strong>ExecutorÁ´Ø</strong></p>
<p>ÂΩìWorkerËäÇÁÇπ‰∏≠ÂêØÂä®ExecutorRunnerÊó∂ÔºåExecutorRunner‰∏≠‰ºöÂêØÂä®CoarseGrainedExecutorBackendËøõÁ®ã, Âú®CoarseGrainedExecutorBackendÁöÑonStartÊñπÊ≥ï‰∏≠ÔºåÂêëDriverÂèëÂá∫RegisterExecutorÊ≥®ÂÜåËØ∑Ê±Ç„ÄÇÁÑ∂ÂêéDriverÊé•ÂèóRegisterExecutorÂπ∂Ê≥®ÂÜåExecutor, CoarseGrainedExecutorBackendÊé•ÂèóÂà∞ÊàêÂäüÊ≥®ÂÜåÁöÑÂõûÂ∫î‰πãÂêé, ÂêëËá™Â∑±ÂèëÈÄÅRegisteredExecutor, Âπ∂‰∏îÂêØÂä®ExecutorÁöÑÁ±ª„ÄÇ</p>
<p>Âú®ËøôÈáåExecutorÁöÑÁ±ª‰∏≠,ÊúÄÁªàÊâßË°å‰∫Ü‰ª•‰∏ãÂàùÂßãÂåñblockManagerÁöÑÊñπÊ≥ï</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">env</span><span class="p">.</span><span class="na">blockManager</span><span class="p">.</span><span class="na">initialize</span><span class="p">(</span><span class="n">conf</span><span class="p">.</span><span class="na">getAppId</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="blockmanagermasterËß£Êûê">BlockManagerMasterËß£Êûê
</h2><p>BlockManagerMasterÊòØBlockManagerÁöÑÁªÑ‰ª∂ÔºåBlockManagerÈÄöËøáÂÖ∂Êù•‰∏éDriverËøõË°åÈÄö‰ø°ÔºåÂÆåÊàêÂêëDriverÊ≥®ÂÜåBlockManagerÔºå‰ªéDriverËé∑ÂèñÊï∞ÊçÆÂùóÁöÑ‰ΩçÁΩÆ‰ø°ÊÅØÔºåÂÆöÊó∂ÂêëDriverÂêåÊ≠•BlockManagerÊâÄÁÆ°ÁêÜÁöÑÊï∞ÊçÆÂùó‰ø°ÊÅØÔºåÂìçÂ∫îDriverÂèëÊù•ÁöÑÂà†Èô§Êï∞ÊçÆÂùóÁöÑËØ∑Ê±ÇÁ≠â„ÄÇDriverÂíåExecutorËäÇÁÇπÈÉΩ‰ºöÂàõÂª∫Ëá™Â∑±ÁöÑBlockManagerMasterÔºåÂå∫Âà´ÊòØDriverËá™Ë∫´BlockManager‰∏≠ÁöÑBlockManagerMaster‰∏éDriverÈÄö‰ø°Êó∂Ôºå‰∏ç‰∫ßÁîüÁΩëÁªúÈÄö‰ø°„ÄÇËÄåExecutorËäÇÁÇπ‰∏≠ÁöÑBlockManagerMaster‰∏éDriverÈÄö‰ø°Êó∂Ôºå‰ºö‰∫ßÁîüÁΩëÁªúÈÄö‰ø°„ÄÇ</p>
<p>Executor‰ªª‰ΩïÁöÑBlockManagerMasterÊâÄÂÅöÁöÑÂä®‰ΩúÈÉΩÊòØÂéªdriverÂÅöÁöÑÔºåÊâÄ‰ª•ExecutorÁöÑBlockManagerMasterËØ¥ÁôΩ‰∫ÜËøòÂè™ÊòØÁî®Êù•Ë∑üdriverÈÄö‰ø°ËÄåÂ∑≤„ÄÇÂÖ≥ÈîÆËÉΩÂÅöÂä®‰ΩúÁöÑÊØîÂ¶ÇÔºàupdateBlockInfo„ÄÅgetLocations„ÄÅremoveBlockÔºâËøòÊòØÈúÄË¶ÅÂêÑÊñπexeuctorÁöÑblockÈÄöÁü•ÁªôdriverÁ´ØÂéªÊâßË°åÂëΩ‰ª§ÔºÅÔºÅÔºÅ</p>
<h2 id="blockmanagermasterendpoint">BlockManagerMasterEndpoint
</h2><p>BlockManagerMasterEndpointÊòØRpcEndpointÁöÑ‰∏Ä‰∏™ÂÖ∑‰ΩìÂÆûÁé∞Á±ªÔºåÂ∞±ÊòØ‰∏äÊñá‰∏≠BlockManagerMasterÊâÄÊåÅÊúâÁöÑRpcEndpointRefÁöÑÂÖ∑‰ΩìÊåáÂêëÁ±ªÔºåÊòØDriverÁöÑBlockManagerÂ§ÑÁêÜÊù•Ëá™ExecutorËØ∑Ê±ÇÔºå‰ª•ÂèäÂêëExecutorÂèëÈÄÅËØ∑Ê±ÇÁöÑÈÄªËæë„ÄÇÊù•Ëá™ExecutorÁöÑËØ∑Ê±Ç/ÂêëExecutorÂèëÈÄÅÁöÑËØ∑Ê±Ç‰∏éBlockManagerMasterÂèëÈÄÅÂíåÂìçÂ∫îÁöÑÁõ∏ÂêåÔºå‰∏ªË¶Å‰∏∫Ê≥®ÂÜåExecutorÁöÑBlockManagerÔºåËøîÂõûÊâÄ‰øùÂ≠òÁöÑÊï∞ÊçÆÂùóÁöÑ‰ΩçÁΩÆ‰ø°ÊÅØÔºåÊé•Êî∂Âπ∂Êõ¥Êñ∞ExecutorÂèëÈÄÅËøáÊù•ÁöÑÊï∞ÊçÆÂùó‰ø°ÊÅØÔºåÂêëExecutorÂèëÈÄÅÂà†Èô§Êï∞ÊçÆÂùóÁöÑËØ∑Ê±ÇÁ≠â„ÄÇ</p>
<p>Âú®BlockManagerMasterEndpoint‰∏≠Áª¥Êä§‰∫ÜÊ≥®ÂÜåÁöÑBlockManagerÔºåBlockManagerÂíåExecutorÁöÑÊò†Â∞ÑÂÖ≥Á≥ªÔºåÊï∞ÊçÆÂùóÊâÄÂú®ÁöÑ‰ΩçÁΩÆÁ≠â‰ø°ÊÅØ„ÄÇËøô‰∫õÈÉΩÂèØ‰ª•ÁúãÂÅöÊòØÂ≠òÂÇ®Áõ∏ÂÖ≥ÁöÑÂÖÉÊï∞ÊçÆ‰ø°ÊÅØ„ÄÇDriverËäÇÁÇπÈÄöËøá‰øùÂ≠òËøô‰∫õÂÖÉÊï∞ÊçÆÊù•ÁÆ°ÁêÜÊï¥‰∏™ÈõÜÁæ§ÁöÑÂ≠òÂÇ®„ÄÇ</p>
<h3 id="blockmanagermasterendpointÁöÑÊñπÊ≥ï">BlockManagerMasterEndpointÁöÑÊñπÊ≥ï
</h3><h4 id="receiveandreply">receiveAndReply
</h4><p>Ê†πÊçÆÊù•Ëá™Executor‰∏çÂêåÁöÑËØ∑Ê±ÇÔºåË∞ÉÁî®Áõ∏ÂÖ≥ÂáΩÊï∞Âπ∂ÂõûË∞ÉËØ∑Ê±ÇÂõûË∞ÉÂáΩÊï∞ÔºåÊØîÂ¶Ç</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">RegisterBlockManager</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">localDirs</span><span class="p">,</span><span class="w"> </span><span class="n">maxOnHeapMemSize</span><span class="p">,</span><span class="w"> </span><span class="n">maxOffHeapMemSize</span><span class="p">,</span><span class="w"> </span><span class="n">endpoint</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">context</span><span class="p">.</span><span class="na">reply</span><span class="p">(</span><span class="n">register</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">localDirs</span><span class="p">,</span><span class="w"> </span><span class="n">maxOnHeapMemSize</span><span class="p">,</span><span class="w"> </span><span class="n">maxOffHeapMemSize</span><span class="p">,</span><span class="w"> </span><span class="n">endpoint</span><span class="p">))</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ËøòÊúâÂÖ∂‰ªñÁöÑÊñπÊ≥ïÊØîÂ¶Ç</p>
<ol>
<li>updateBlockInfo</li>
<li><code>GetLocationsAndStatus(blockId, requesterHost)</code>Ê†πÊçÆblockId, requesterHost‰ΩçÁΩÆËøîÂõûÂ≠ò‰ªñ‰ª¨BlockManagerIdÁöÑ‰ΩçÁΩÆÂíåblockidÁöÑÁä∂ÊÄÅ</li>
<li><code>GetLocations(blockId)</code>È¶ñÂÖàÂà§Êñ≠ÂÜÖÂ≠òÁºìÂ≠òÁªìÊûÑblockLocations‰∏≠ÊòØÂê¶ÂåÖÂê´blockIdÔºåÂ¶ÇÊûúÂ∑≤ÂåÖÂê´ÔºåÂ∞±Ëé∑Âèñ‰ΩçÁΩÆ‰ø°ÊÅØÔºåÂê¶ÂàôËøîÂõûÁ©∫ÁöÑ‰ø°ÊÅØ</li>
<li><code>GetLocationsMultipleBlockIds(blockIds)</code>Ëé∑ÂèñÂ≠òÊîæ‰∏ÄÂ†ÜblockIdsÁöÑblockmanagerIdÁöÑ‰ΩçÁΩÆ</li>
<li><code>GetPeers(blockManagerId)</code>Ëé∑ÂèñÁªôÂÆöÂùóÁÆ°ÁêÜÂô®ÁöÑÂØπÁ≠âÊñπÂàóË°®</li>
<li><code>GetExecutorEndpointRef(executorId)</code>ËøîÂõûÁî®‰∫éÂèëÈÄÅ RPC Ê∂àÊÅØÁöÑ BlockManagerReplicaEndpoint ÁöÑ RpcEndpointRef</li>
<li><code>GetMemoryStatus</code>ËøîÂõû‰ªéÂùóÁÆ°ÁêÜÂô® ID Âà∞ÊúÄÂ§ßÂÜÖÂ≠òÂíåÂâ©‰ΩôÂÜÖÂ≠òÁöÑÊò†Â∞Ñ</li>
<li><code>GetStorageStatus</code>‰ΩøÁî®‰∏ÄÁªÑÂàùÂßãÂùóÂàõÂª∫Â≠òÂÇ®Áä∂ÊÄÅÔºåËÄå‰∏ç‰øÆÊîπÊ∫ê</li>
<li>GetBlockStatus(blockId, askSlaves)ËøîÂõûÊâÄÊúâÂùóÁÆ°ÁêÜÂô®ÁöÑÂùóÁä∂ÊÄÅÔºàÂ¶ÇÊûúÊúâÔºâ„ÄÇÊ≥®ÊÑèÔºöËøôÊòØ‰∏ÄÈ°πÂèØËÉΩ‰ª£‰ª∑È´òÊòÇÁöÑÊìç‰ΩúÔºåÂ∫î‰ªÖÁî®‰∫éÊµãËØï„ÄÇÂ¶ÇÊûú askStorageEndpoint ‰∏∫ trueÔºåÂàô‰∏ªËäÇÁÇπÂ∞ÜÊü•ËØ¢ÊØè‰∏™ÂùóÁÆ°ÁêÜÂô®‰ª•Ëé∑ÂèñÊúÄÊñ∞ÁöÑÂùóÁä∂ÊÄÅ„ÄÇÂΩìÊâÄÊúâÂùóÁÆ°ÁêÜÂô®Êú™ÈÄöÁü•‰∏ªËäÇÁÇπÁªôÂÆöÂùóÊó∂ÔºåËøôÂæàÊúâÁî®„ÄÇ</li>
<li><code>GetMatchingBlockIds(filter, askSlaves)</code></li>
<li><code>RemoveRdd(rddId)</code>È¶ñÂÖàÂà†Èô§ÁªôÂÆö RDD ÁöÑÂÖÉÊï∞ÊçÆÔºåÁÑ∂Âêé‰ªéstorage endpoint‰∏≠ÂºÇÊ≠•Âà†Èô§Âùó„ÄÇ</li>
<li><code>RemoveShuffle(shuffleId)</code>ÁßªÈô§ÊâÄÊúâÂ±û‰∫éÁâπÂÆöÈöèÊú∫shuffleÁöÑblock</li>
<li><code>RemoveBroadcast(broadcastId, removeFromDriver)</code>ÁßªÈô§ÊâÄÊúâÂ±û‰∫éÁâπÂÆöÈöèÊú∫broadcastÁöÑblock</li>
<li><code>RemoveBlock(blockId)</code>‰ªéÂÖ∑ÊúâËØ•ÂùóÁöÑstorage endpoint‰∏≠Âà†Èô§ËØ•Âùó„ÄÇËøôÂè™ËÉΩÁî®‰∫éÂà†Èô§‰∏ªËäÇÁÇπÁü•ÈÅìÁöÑÂùó</li>
<li><code>RemoveExecutor(execId)</code>‰ªédriver endpoint‰∏≠Âà†Èô§Â§±ÊïàÁöÑexecutor„ÄÇËøô‰ªÖÂú®driver endpointË∞ÉÁî®</li>
<li><code>StopBlockManagerMaster</code></li>
<li><code>BlockManagerHeartbeat(blockManagerId)</code></li>
<li><code>HasCachedBlocks(executorId)</code></li>
</ol>
<h2 id="Â≠òÂèñblockÁöÑËøáÁ®ã">Â≠òÂèñblockÁöÑËøáÁ®ã
</h2><p>‰ª•ResultTask‰∏∫‰æã</p>
<h3 id="executorÁ´ØÂ≠òÂÇ®blockÁöÑÊâßË°åÊµÅÁ®ã">ExecutorÁ´ØÂ≠òÂÇ®blockÁöÑÊâßË°åÊµÅÁ®ã
</h3><p>Âú®Executor.runÁöÑÊñπÊ≥ï‰∏≠Ôºå‰ªªÂä°ÊâßË°åÂÆå‰ºöÂΩ¢Êàê‰ªªÂä°ÁªìÊûúÔºåËøô‰∏™‰ªªÂä°ÁªìÊûúÊòØÂáÜÂ§áÂèëÈÄÅÁªôTaskSetManagerÁöÑÔºå‰ªªÂä°ÁªìÊûú‰ºöÊ†πÊçÆÁªìÊûúÁöÑÂ§ßÂ∞èÊù•Âà§Êñ≠ÊòØÂê¶ÈúÄË¶ÅÂèòÊàêindirectTaskResultÂØπË±°ÔºåËøôÈáåÁöÑIndirectTaskResultÂØπË±°‰∏≠ÂåÖÂê´ÁªìÊûúÊâÄÂú®ÁöÑBlockIdÔºåÂú®SchedulerBackend‰∏≠ÂèØ‰ª•ÈÄöËøáBlockManagerËé∑ÂæóËØ•BlockIdÂØπÂ∫îÁöÑÁªìÊûúÊï∞ÊçÆ</p>
<p>Âú®Ëøô‰∏™ËøáÁ®ã‰∏≠ÊâßË°å‰∫ÜÂ¶Ç‰∏ã</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">val</span><span class="w"> </span><span class="n">blockId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TaskResultBlockId</span><span class="p">(</span><span class="n">taskId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">env</span><span class="p">.</span><span class="na">blockManager</span><span class="p">.</span><span class="na">putBytes</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">blockId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">new</span><span class="w"> </span><span class="n">ChunkedByteBuffer</span><span class="p">(</span><span class="n">serializedDirectResult</span><span class="p">.</span><span class="na">duplicate</span><span class="p">()),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">StorageLevel</span><span class="p">.</span><span class="na">MEMORY_AND_DISK_SER</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">logInfo</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Finished $taskName. $resultSize bytes result sent via BlockManager)&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// ËøîÂõûÂÖÉÊï∞ÊçÆser.serialize(new IndirectTaskResult[Any](blockId, resultSize))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ser</span><span class="p">.</span><span class="na">serialize</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">IndirectTaskResult</span><span class="o">[</span><span class="n">Any</span><span class="o">]</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">resultSize</span><span class="p">))</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ËøáÁ®ã‰∏≠Ê∏ÖÊô∞ÁöÑÁúãÂá∫‰∫ÜÔºåÈÄöËøáÁî®taskIdÊù•ÂàõÂª∫TaskResultBlockIdÔºåÁÑ∂ÂêéÂ∞Ü‰∏≤Ë°åÂåñ‰πãÂêéÁöÑ‰ø°ÊÅØÈÄöËøáblockManager.putBytesÁöÑÊñπÊ≥ïÊîæËøõblockManager‰∏≠ÔºåËÄå‰∏îÁî®Âà∞ÁöÑÂ≠òÂÇ®Á∫ßÂà´ÊòØMEMORY_AND_DISK_SER</p>
<p>Âú®ÊñπÊ≥ïÂÜÖÈÉ®Ë∞ÉÁî®‰∫ÜblockStoreUpdater.save()ÔºåËØ¶ÁªÜÁúãdoPutÊñπÊ≥ï</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="n">doPut</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">blockId</span><span class="p">:</span><span class="w"> </span><span class="n">BlockId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">level</span><span class="p">:</span><span class="w"> </span><span class="n">StorageLevel</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">classTag</span><span class="p">:</span><span class="w"> </span><span class="n">ClassTag</span><span class="o">[</span><span class="n">_</span><span class="o">]</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">tellMaster</span><span class="p">:</span><span class="w"> </span><span class="n">Boolean</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">keepReadLock</span><span class="p">:</span><span class="w"> </span><span class="n">Boolean</span><span class="p">)(</span><span class="n">putBody</span><span class="p">:</span><span class="w"> </span><span class="n">BlockInfo</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Option</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="p">):</span><span class="w"> </span><span class="n">Option</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 	</span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">putBlockInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">newInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BlockInfo</span><span class="p">(</span><span class="n">level</span><span class="p">,</span><span class="w"> </span><span class="n">classTag</span><span class="p">,</span><span class="w"> </span><span class="n">tellMaster</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// lockNewBlockForWritingÂÜôÂÖ•‰∏Ä‰∏™Êñ∞ÁöÑÂùóÂâçÂÖàÂ∞ùËØïËé∑ÂæóÈÄÇÂΩìÁöÑÈîÅÔºåÂ¶ÇÊûúÊàë‰ª¨ÊòØÁ¨¨‰∏Ä‰∏™ÂÜôÂùóÔºåËé∑ÂæóÂÜôÂÖ•ÈîÅÂêéÁªßÁª≠ÂêéÁª≠Êìç‰Ωú„ÄÇ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Âê¶ÂàôÔºåÂ¶ÇÊûúÂè¶‰∏Ä‰∏™Á∫øÁ®ãÂ∑≤ÁªèÂÜôÂÖ•ÂùóÔºåÈ°ªÁ≠âÂæÖÂÜôÂÖ•ÂÆåÊàêÔºåÊâçËÉΩËé∑ÂèñËØªÂèñÈîÅÔºåË∞ÉÁî®new()ÂáΩÊï∞ÂàõÂª∫‰∏Ä‰∏™BlockInfoËµãÂÄºÁªôputBlockInfoÔºå</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// ÁÑ∂ÂêéÈÄöËøáputBody(putBlockInfo)Â∞ÜÊï∞ÊçÆÂ≠òÂÖ•„ÄÇputBodyÊòØ‰∏Ä‰∏™ÂåøÂêçÂáΩÊï∞ÔºåËæìÂÖ•BlockInfoÔºåËæìÂá∫ÁöÑÊòØ‰∏Ä‰∏™Ê≥õÂûãOption[T]„ÄÇ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// putBodyÂáΩÊï∞‰ΩìÂÜÖÂÆπÊòØdoPutIteratorÊñπÊ≥ïÔºàdoPutBytesÊñπÊ≥ï‰πüÁ±ª‰ººË∞ÉÁî®doPutÔºâË∞ÉÁî®doPutÊó∂‰º†ÂÖ•„ÄÇ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">blockInfoManager</span><span class="p">.</span><span class="na">lockNewBlockForWriting</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">newInfo</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">newInfo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">result</span><span class="p">:</span><span class="w"> </span><span class="n">Option</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">putBody</span><span class="p">(</span><span class="n">putBlockInfo</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">res</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">result</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>
<p>val newInfo = new BlockInfo(level, classTag, tellMaster)ÂàõÂª∫putBlockInfoÔºåÂú®ÂÖ∂‰∏≠ÈúÄË¶ÅÁî®Áî®ÈîÅ</p>
</li>
<li>
<p>ÈÄöËøáputBody(putBlockInfo)Â∞ÜÊï∞ÊçÆÂ≠òÂÖ•</p>
</li>
<li>
<p>putBodyÊòØ‰∏Ä‰∏™ÂåøÂêçÂáΩÊï∞ÔºåÂÖ∂Âú®BlockManager.save()‰∏≠ÂÆö‰πâÔºåÂ¶Ç‰∏ã</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">info</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">startTimeNs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">nanoTime</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Since we&#39;re storing bytes, initiate the replication before storing them locally.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// This is faster as data is already serialized and ready to send.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">replicationFuture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">level</span><span class="p">.</span><span class="na">replication</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Future</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// This is a blocking action and should run in futureExecutionContext which is a cached</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// thread pool.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">replicate</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">blockData</span><span class="p">(),</span><span class="w"> </span><span class="n">level</span><span class="p">,</span><span class="w"> </span><span class="n">classTag</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}(</span><span class="n">futureExecutionContext</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">level</span><span class="p">.</span><span class="na">useMemory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Put it in memory first, even if it also has useDisk set to true;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// We will drop it to disk later if the memory store can&#39;t hold it.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">putSucceeded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">level</span><span class="p">.</span><span class="na">deserialized</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">saveDeserializedValuesToMemoryStore</span><span class="p">(</span><span class="n">blockData</span><span class="p">().</span><span class="na">toInputStream</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">saveSerializedValuesToMemoryStore</span><span class="p">(</span><span class="n">readToByteBuffer</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">putSucceeded</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">level</span><span class="p">.</span><span class="na">useDisk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">logWarning</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Persisting block $blockId to disk instead.&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">saveToDiskStore</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">level</span><span class="p">.</span><span class="na">useDisk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">saveToDiskStore</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">putBlockStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCurrentBlockStatus</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">blockWasSuccessfullyStored</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">putBlockStatus</span><span class="p">.</span><span class="na">storageLevel</span><span class="p">.</span><span class="na">isValid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">blockWasSuccessfullyStored</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Now that the block is in either the memory or disk store,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// tell the master about it.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">info</span><span class="p">.</span><span class="na">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockSize</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">tellMaster</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">tellMaster</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">reportBlockStatus</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">putBlockStatus</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">addUpdatedBlockStatusToTaskMetrics</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">putBlockStatus</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Put block ${blockId} locally took ${Utils.getUsedTimeNs(startTimeNs)}&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">level</span><span class="p">.</span><span class="na">replication</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Wait for asynchronous replication to finish</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ThreadUtils</span><span class="p">.</span><span class="na">awaitReady</span><span class="p">(</span><span class="n">replicationFuture</span><span class="p">,</span><span class="w"> </span><span class="n">Duration</span><span class="p">.</span><span class="na">Inf</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">NonFatal</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SparkException</span><span class="p">(</span><span class="s">&#34;Error occurred while waiting for replication to finish&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">blockWasSuccessfullyStored</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Some</span><span class="p">(</span><span class="n">blockSize</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}.</span><span class="na">isEmpty</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>val replicationFuture = if (level.replication &gt; 1) {}Â¶ÇÊûúlevel‰∏≠ÊòæÁ§∫Â§çÂà∂Êï∞&gt;1ÔºåÈÇ£‰πàÊâßË°åreplicate()ÊñπÊ≥ïÔºåÂ∞ÜËøô‰∏™blockÂ§çÂà∂Âà∞ÂÖ∂‰ªñblock„ÄÇ</p>
<ol>
<li>val initialPeers = getPeers(false).filterNot(existingReplicas.contains)ÔºåÂéªblockManagerMasterÈÇ£ÈáåÊãâÂèñpeer block managersÁöÑ</li>
<li>var peersForReplication = blockReplicationPolicy.prioritizeÂØπblockÁöÑ‰∏ÄÁªÑpeeersËøõË°å‰ºòÂÖàÁ∫ßÊéíÂ∫è</li>
<li>blockTransferService.uploadBlockSyncÂç≥‰∏ä‰º†Â§çÂà∂ÁöÑblockÊï∞ÊçÆÂà∞ÂÖ∂‰ªñÁöÑËäÇÁÇπ‰∏≠</li>
</ol>
</li>
<li>
<p>if (level.useMemory)Âà§Êñ≠ÊòØÂê¶‰ΩøÁî®memory„ÄÇÂç≥‰ΩøËÆæÁΩÆ‰∫Ü‰ΩøÁî®DiskÔºå‰πüÊòØÈ¶ñÂÖà‰ΩøÁî®ÂÜÖÂ≠òÔºåÂ¶ÇÊûúÂÜÖÂ≠òÊó†Ê≥ïÂ≠òÂÇ®ÔºåÊâçÊîæÂà∞Disk‰∏≠„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">val</span><span class="w"> </span><span class="n">putSucceeded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">level</span><span class="p">.</span><span class="na">deserialized</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">saveDeserializedValuesToMemoryStore</span><span class="p">(</span><span class="n">blockData</span><span class="p">().</span><span class="na">toInputStream</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">saveSerializedValuesToMemoryStore</span><span class="p">(</span><span class="n">readToByteBuffer</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">putSucceeded</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">level</span><span class="p">.</span><span class="na">useDisk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logWarning</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Persisting block $blockId to disk instead.&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">saveToDiskStore</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ÊñπÊ≥ïÈùûÂ∏∏Áõ¥ËßÇÔºåÊØîÂ¶ÇËØ¥Â≠òÂÇ®‰∏≤Ë°åÊï∞ÊçÆÂà∞memoryStore‰∏≠ÔºåÂàôÊâßË°åsaveSerializedValuesToMemoryStore</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="nf">saveSerializedValuesToMemoryStore</span><span class="p">(</span><span class="n">bytes</span><span class="p">:</span><span class="w"> </span><span class="n">ChunkedByteBuffer</span><span class="p">):</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">memoryMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">level</span><span class="p">.</span><span class="na">memoryMode</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">memoryStore</span><span class="p">.</span><span class="na">putBytes</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">blockSize</span><span class="p">,</span><span class="w"> </span><span class="n">memoryMode</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">memoryMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MemoryMode</span><span class="p">.</span><span class="na">OFF_HEAP</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">bytes</span><span class="p">.</span><span class="na">chunks</span><span class="p">.</span><span class="na">exists</span><span class="p">(</span><span class="o">!</span><span class="n">_</span><span class="p">.</span><span class="na">isDirect</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">bytes</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span><span class="n">Platform</span><span class="p">.</span><span class="na">allocateDirectBuffer</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">bytes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ÈáçÁÇπÂú®‰∫émemoryStore.putBytes„ÄÇÁúãÂà∞ËøôÈáåÔºåÂÖ∂ÂÆûÂ∞±ÂæàÊòéÁôΩblockManager.puteBytes()ÊúÄÁªàËøòÊòØÊâßË°å‰∫ÜmemoryStoreÊàñËÄÖdiskStoreÁöÑputBytes</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">  </span><span class="n">def</span><span class="w"> </span><span class="n">putBytes</span><span class="o">[</span><span class="n">T</span><span class="p">:</span><span class="w"> </span><span class="n">ClassTag</span><span class="o">]</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">blockId</span><span class="p">:</span><span class="w"> </span><span class="n">BlockId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">size</span><span class="p">:</span><span class="w"> </span><span class="n">Long</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">memoryMode</span><span class="p">:</span><span class="w"> </span><span class="n">MemoryMode</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">_bytes</span><span class="p">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">ChunkedByteBuffer</span><span class="p">):</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">require</span><span class="p">(</span><span class="o">!</span><span class="n">contains</span><span class="p">(</span><span class="n">blockId</span><span class="p">),</span><span class="w"> </span><span class="n">s</span><span class="s">&#34;Block $blockId is already present in the MemoryStore&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">memoryManager</span><span class="p">.</span><span class="na">acquireStorageMemory</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">memoryMode</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// ‰∏∫Ëøô‰∏™Âø´Ëé∑Âæó‰∫ÜË∂≥Â§üÁöÑÂÜÖÂ≠òÔºåÊâÄ‰ª•ÊääÂÆÉÊîæËøõÂéª</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// We acquired enough memory for the block, so go ahead and put it</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_bytes</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">assert</span><span class="p">(</span><span class="n">bytes</span><span class="p">.</span><span class="na">size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SerializedMemoryEntry</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span><span class="w"> </span><span class="n">memoryMode</span><span class="p">,</span><span class="w"> </span><span class="n">implicitly</span><span class="o">[</span><span class="n">ClassTag</span><span class="o">[</span><span class="n">T</span><span class="o">]]</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">entries</span><span class="p">.</span><span class="na">synchronized</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">entries</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">logInfo</span><span class="p">(</span><span class="s">&#34;Block %s stored as bytes in memory (estimated size %s, free %s)&#34;</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">Utils</span><span class="p">.</span><span class="na">bytesToString</span><span class="p">(</span><span class="n">size</span><span class="p">),</span><span class="w"> </span><span class="n">Utils</span><span class="p">.</span><span class="na">bytesToString</span><span class="p">(</span><span class="n">maxMemory</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">blocksMemoryUsed</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>putBytesÊñπÊ≥ïÈáçÁÇπÂú®‰∫é</p>
<ul>
<li>memoryManager.acquireStorageMemory(blockId, size, memoryMode)‰ªéUnifiedMemoryManager‰∏≠Ëé∑ÂèñStorageMemory„ÄÇ</li>
<li>ÈÇ£ÂàÜÈÖçÂà∞ÂÜÖÂ≠ò‰πãÂêéÔºåÂ∞±Ë¶ÅÂ∞ÜËøô‰∏™‰∏úË•øÂ≠òÂÇ®‰∏ãÊù•‰∫Ü„ÄÇ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">val</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SerializedMemoryEntry</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span><span class="w"> </span><span class="n">memoryMode</span><span class="p">,</span><span class="w"> </span><span class="n">implicitly</span><span class="o">[</span><span class="n">ClassTag</span><span class="o">[</span><span class="n">T</span><span class="o">]]</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">entries</span><span class="p">.</span><span class="na">synchronized</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">entries</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ËøôÂ∞±ÂæàÊúâË∂£‰∫ÜÔºåÂÖ∂ÂÆûBlockManagerÂ≠òÂÇ®ÁöÑÂùóÊòØÈÄöËøáLinkedHashMapÊù•ÁÆ°ÁêÜÁöÑ„ÄÇ</p>
</li>
<li>
<p>Ëá≥Ê≠§ÔºåmemoryStoreÂ∑≤ÁªèÂ≠òÊîæÂÆåblockÂÜÖÂÆπ„ÄÇÂ¶ÇÊûúÂÜÖÂ≠ò‰∏çÂ§üÔºåËøîÂõûÂà∞BlockManager‰∏≠ÔºåÂÆÉÊâßË°å‰∫ÜÂ¶Ç‰∏ãÊñπÊ≥ï</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">putSucceeded</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">level</span><span class="p">.</span><span class="na">useDisk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logWarning</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Persisting block $blockId to disk instead.&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">saveToDiskStore</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ËøõÂÖ•saveToDiskStore()‰∏≠ÔºåÂèëÁé∞ÊâßË°ådiskStore.putBytes(blockId, bytes)ÔºåÂÖ∂ÂÆûÂ∞±ÊòØÂà©Áî®java.nioÊù•ÂÜôÁ£ÅÁõò‰∫Ü</p>
</li>
<li>
<p>reportBlockStatus(blockId, putBlockStatus)ÊääËøô‰∏™blockStatusÂèëÈÄÅÂà∞driverÁ´ØÁöÑÔºåÁî®blockManagerInfoÊù•ÂåÖË£ÖÔºåDriverÁöÑblockmanagerInfoÂõ†Ê≠§ÂÅöÁªüËÆ°‰ø°ÊÅØÁöÑÊõ¥Êñ∞</p>
</li>
</ol>
<p>ËøîÂõûExecutor.runÔºåÂ∑≤ÁªèÊääblockÂ≠òÂÇ®Ëá≥blockManager‰πãÂêéÔºåÂ∞±‰ºöÊâßË°åexecBackend.statusUpdate(taskId, TaskState.FINISHED, serializedResult)Â∞ÜÊâßË°åÁöÑÁªìÊûúÂèçÈ¶àÁªôCoarseGrainedSchedulerBackend.receive()„ÄÇ</p>
<h3 id="driverÁ´ØÁöÑËé∑ÂèñblockÁöÑÊâßË°åÊµÅÁ®ã">driverÁ´ØÁöÑËé∑ÂèñblockÁöÑÊâßË°åÊµÅÁ®ã
</h3><p>Âú®ËøôÈáåCoarseGrainedSchedulerBackend.receive()Êé•ÂèóexecutorÂèëÊù•ÁöÑ‰ø°ÊÅØÂºÄÂßãÁúãËµ∑</p>
<p>Ë∞ÉÁî®scheduler.statusUpdate(taskId, state, data.value)Êõ¥Êñ∞Áä∂ÊÄÅ‰ø°ÊÅØ„ÄÇÂú®ÊñπÊ≥ïÂÜÖÈÉ®ÊâßË°å‰∫ÜtaskResultGetter.enqueueSuccessfulTask(taskSet, tid, serializedData)Â§ÑÁêÜtaskÂÆåÊàêÁöÑ‰ø°ÊÅØÔºåÈÇ£ÊñπÊ≥ïÂÜÖÈÉ®‰∏ªË¶ÅÊòØËøô‰∏™ÈÉ®ÂàÜ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">case</span><span class="w"> </span><span class="n">IndirectTaskResult</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="c1">// Â∞±ÈÄöËøáblockManager.getRemoteBytesËøúÁ®ãËé∑ÂèñÔºåËé∑Âèñ‰ª•ÂêéÂÜçËøõË°åÂèçÂ∫èÂàóÂåñ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">taskSetManager</span><span class="p">.</span><span class="na">canFetchMoreResults</span><span class="p">(</span><span class="n">size</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// dropped by executor if size is larger than maxResultSize</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">sparkEnv</span><span class="p">.</span><span class="na">blockManager</span><span class="p">.</span><span class="na">master</span><span class="p">.</span><span class="na">removeBlock</span><span class="p">(</span><span class="n">blockId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// kill the task so that it will not become zombie task</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">scheduler</span><span class="p">.</span><span class="na">handleFailedTask</span><span class="p">(</span><span class="n">taskSetManager</span><span class="p">,</span><span class="w"> </span><span class="n">tid</span><span class="p">,</span><span class="w"> </span><span class="n">TaskState</span><span class="p">.</span><span class="na">KILLED</span><span class="p">,</span><span class="w"> </span><span class="n">TaskKilled</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s">&#34;Tasks result size has exceeded maxResultSize&#34;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Fetching indirect task result for ${taskSetManager.taskName(tid)}&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">scheduler</span><span class="p">.</span><span class="na">handleTaskGettingResult</span><span class="p">(</span><span class="n">taskSetManager</span><span class="p">,</span><span class="w"> </span><span class="n">tid</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">serializedTaskResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sparkEnv</span><span class="p">.</span><span class="na">blockManager</span><span class="p">.</span><span class="na">getRemoteBytes</span><span class="p">(</span><span class="n">blockId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">serializedTaskResult</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cm">/* We won&#39;t be able to get the task result if the machine that ran the task failed
</span></span></span><span class="line"><span class="cl"><span class="cm">       * between when the task ended and when we tried to fetch the result, or if the
</span></span></span><span class="line"><span class="cl"><span class="cm">       * block manager had to flush the result. */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// Â¶ÇÊûúËøêË°å‰ªªÂä°ÁöÑÊú∫Âô®Âú®‰ªªÂä°ÁªìÊùüÂíåÊàë‰ª¨ËØïÂõæËé∑Âèñ‰ªªÂä°ÁªìÊûú‰πãÈó¥ÂèëÁîüÊïÖÈöúÔºåÊàñËÄÖÂå∫ÂùóÁÆ°ÁêÜÂô®ÂøÖÈ°ªÂà∑Êñ∞ÁªìÊûúÔºåÊàë‰ª¨Â∞ÜÊó†Ê≥ïËé∑Âèñ‰ªªÂä°ÁªìÊûú„ÄÇ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">scheduler</span><span class="p">.</span><span class="na">handleFailedTask</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">taskSetManager</span><span class="p">,</span><span class="w"> </span><span class="n">tid</span><span class="p">,</span><span class="w"> </span><span class="n">TaskState</span><span class="p">.</span><span class="na">FINISHED</span><span class="p">,</span><span class="w"> </span><span class="n">TaskResultLost</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">deserializedResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">serializer</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">deserialize</span><span class="o">[</span><span class="n">DirectTaskResult</span><span class="o">[</span><span class="n">_</span><span class="o">]]</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">serializedTaskResult</span><span class="p">.</span><span class="na">get</span><span class="p">.</span><span class="na">toByteBuffer</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// force deserialization of referenced value</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">deserializedResult</span><span class="p">.</span><span class="na">value</span><span class="p">(</span><span class="n">taskResultSerializer</span><span class="p">.</span><span class="na">get</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sparkEnv</span><span class="p">.</span><span class="na">blockManager</span><span class="p">.</span><span class="na">master</span><span class="p">.</span><span class="na">removeBlock</span><span class="p">(</span><span class="n">blockId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="n">deserializedResult</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ÂæàÁõ¥ËßÇÔºåÂ∞±ÊòØÊé•Âèó‰∫Ü‰πãÂâçÂú®ExecutorÂèëÈÄÅÁöÑ<code>IndirectTaskResult(blockId, size)</code>ÂØπË±°</p>
<p>ÁÑ∂Âêéval serializedTaskResult = sparkEnv.blockManager.getRemoteBytes(blockId)Êù•Ê†πÊçÆblockIdËøúÁ®ãËé∑ÂèñÂ∫èÂàóÂåñÁöÑ‰ªªÂä°ÊâßË°åÁªìÊûúÔºåËøô‰∫õÁªìÊûúÂÖàÂâçÂ∑≤ÁªèÂú®ËøúÂ§ÑÁöÑexecutorÈÄöËøáblockManagerÂ≠òÂÇ®ÊàêÂäü‰∫Ü„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">def</span><span class="w"> </span><span class="nf">getRemoteBytes</span><span class="p">(</span><span class="n">blockId</span><span class="p">:</span><span class="w"> </span><span class="n">BlockId</span><span class="p">):</span><span class="w"> </span><span class="n">Option</span><span class="o">[</span><span class="n">ChunkedByteBuffer</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">getRemoteBlock</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="n">ManagedBuffer</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// SPARK-24307 undocumented &#34;escape-hatch&#34; in case there are any issues in converting to</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// ChunkedByteBuffer, to go back to old code-path.  Can be removed post Spark 2.4 if</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// new path is stable.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">remoteReadNioBufferConversion</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="n">ChunkedByteBuffer</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="na">nioByteBuffer</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ChunkedByteBuffer</span><span class="p">.</span><span class="na">fromManagedBuffer</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ËøôÊòØdriverÁ´ØÁöÑËé∑ÂèñËøúÂ§ÑblockÁöÑÊñπÊ≥ïÔºåÁÇπÂáªËøõÂéªÊü•Áúã‰ª£Á†ÅÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="o">[</span><span class="n">spark</span><span class="o">]</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="n">getRemoteBlock</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">blockId</span><span class="p">:</span><span class="w"> </span><span class="n">BlockId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bufferTransformer</span><span class="p">:</span><span class="w"> </span><span class="n">ManagedBuffer</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">T</span><span class="p">):</span><span class="w"> </span><span class="n">Option</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Getting remote block $blockId&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">require</span><span class="p">(</span><span class="n">blockId</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;BlockId is null&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Because all the remote blocks are registered in driver, it is not necessary to ask</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// all the storage endpoints to get block status.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Âõ†‰∏∫ÊâÄÊúâÁöÑËøúÁ®ãÂùóÈÉΩÊ≥®ÂÜåÂú®driver‰∏≠ÔºåÊâÄ‰ª•‰∏çÈúÄË¶ÅË¶ÅÊ±ÇÊâÄÊúâÁöÑ‰ªéÊâßË°åÂô®Ëé∑ÂèñÂùóÁä∂ÊÄÅ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// ÂéªdriverÈÇ£ÈáåËé∑ÂèñÂú∞ÂùÄÂíåÁä∂ÊÄÅ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">locationsAndStatusOption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">.</span><span class="na">getLocationsAndStatus</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">blockManagerId</span><span class="p">.</span><span class="na">host</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">locationsAndStatusOption</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Block $blockId is unknown by block manager master&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">locationsAndStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">locationsAndStatusOption</span><span class="p">.</span><span class="na">get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">blockSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">locationsAndStatus</span><span class="p">.</span><span class="na">status</span><span class="p">.</span><span class="na">diskSize</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="n">locationsAndStatus</span><span class="p">.</span><span class="na">status</span><span class="p">.</span><span class="na">memSize</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">locationsAndStatus</span><span class="p">.</span><span class="na">localDirs</span><span class="p">.</span><span class="na">flatMap</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">localDirs</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">blockDataOption</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">readDiskBlockFromSameHostExecutor</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">localDirs</span><span class="p">,</span><span class="w"> </span><span class="n">locationsAndStatus</span><span class="p">.</span><span class="na">status</span><span class="p">.</span><span class="na">diskSize</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockDataOption</span><span class="p">.</span><span class="na">flatMap</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">blockData</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">Some</span><span class="p">(</span><span class="n">bufferTransformer</span><span class="p">(</span><span class="n">blockData</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">NonFatal</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">logDebug</span><span class="p">(</span><span class="s">&#34;Block from the same host executor cannot be opened: &#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">logInfo</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Read $blockId from the disk of a same host executor is &#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="na">isDefined</span><span class="p">)</span><span class="w"> </span><span class="s">&#34;successful.&#34;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s">&#34;failed.&#34;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">res</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}.</span><span class="na">orElse</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">fetchRemoteManagedBuffer</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">blockSize</span><span class="p">,</span><span class="w"> </span><span class="n">locationsAndStatus</span><span class="p">).</span><span class="na">map</span><span class="p">(</span><span class="n">bufferTransformer</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>
<p>val locationsAndStatusOption = master.getLocationsAndStatus(blockId, blockManagerId.host)Âõ†‰∏∫ÊâÄÊúâÁöÑËøúÁ®ãÂùóÈÉΩÊ≥®ÂÜåÂú®driver‰∏≠ÔºåÊâÄ‰ª•‰∏çÈúÄË¶ÅË¶ÅÊ±ÇÊâÄÊúâÁöÑ‰ªéÊâßË°åÂô®Ëé∑ÂèñÂùóÁä∂ÊÄÅÔºåËøô‰∏™ÊñπÊ≥ïÂ∞±ÊòØÂéªdriverÈÇ£ÈáåËé∑ÂèñÂú∞ÂùÄÂíåÁä∂ÊÄÅ„ÄÇÁÑ∂ÂêéÂú®DriverÁöÑBlockManagerMasterEndpointÊâßË°ågetLocationsAndStatusËé∑ÂèñËøô‰∏™blockIdÂØπÂ∫îÁöÑblockManagerÂú∞ÂùÄÂíåÁä∂ÊÄÅ</p>
</li>
<li>
<p>Â∏¶ÁùÄËøô‰∫õ‰ΩçÁΩÆÂíåÁä∂ÊÄÅÂéªlocalDirsÊù•Ëé∑ÂèñÊú¨Âú∞ÁöÑblockManagerÔºåÊâßË°åreadDiskBlockFromSameHostExecutor„ÄÇ‰ΩÜÂú®ResultÁöÑÂú∫ÊôØ‰∏≠ÔºåresultÂ≠òÊîæÂú®‰∫Üexecutor‰∏≠ÔºåÊâÄ‰ª•ÈúÄË¶ÅËøúÁ´ØÊãøÂèñblock„ÄÇÂç≥ÊâßË°å‰∫ÜÂ¶Ç‰∏ãÁöÑÊñπÊ≥ïÁöÑ‰∫ÜfetchRemoteManagedBuffer(blockId, blockSize, locationsAndStatus).map(bufferTransformer)Ôºå‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="nf">fetchRemoteManagedBuffer</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">blockId</span><span class="p">:</span><span class="w"> </span><span class="n">BlockId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">blockSize</span><span class="p">:</span><span class="w"> </span><span class="n">Long</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">locationsAndStatus</span><span class="p">:</span><span class="w"> </span><span class="n">BlockManagerMessages</span><span class="p">.</span><span class="na">BlockLocationsAndStatus</span><span class="p">):</span><span class="w"> </span><span class="n">Option</span><span class="o">[</span><span class="n">ManagedBuffer</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Â¶ÇÊûúÂùóÂ§ßÂ∞èË∂ÖËøáÈòàÂÄºÔºåÂ∞ÜFileManager‰º†ÈÄíÁªôBlockTransferServiceÔºåÂà©Áî®ÂÆÉÊù•Ê∫¢Âá∫ÂùóÔºõÂ¶ÇÊûúÊ≤°ÊúâÔºå‰º†ÈÄíÁ©∫ÂÄºÊÑèÂë≥ÁùÄÂùóÂ∞ÜÊåÅ‰πÖÂ≠òÂú®ÂÜÖÂ≠ò‰∏≠„ÄÇ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">tempFileManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">blockSize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxRemoteBlockToMem</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">remoteBlockTempFileManager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">runningFailureCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">totalFailureCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// sortLocationsÊñπÊ≥ïËøîÂõûÁªôÂÆöÂùóÁöÑ‰ΩçÁΩÆÂàóË°®ÔºåÊú¨Âú∞ËÆ°ÁÆóÊú∫ÁöÑ‰ºòÂÖàÁ∫ß‰ªéÂ§ö‰∏™ÂùóÁÆ°ÁêÜÂô®ÂèØ‰ª•ÂÖ±‰∫´Âêå‰∏Ä‰∏™‰∏ªÊú∫ÔºåÁÑ∂ÂêéÊòØÂêå‰∏ÄÊú∫Êû∂‰∏äÁöÑ‰∏ªÊú∫</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">locations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sortLocations</span><span class="p">(</span><span class="n">locationsAndStatus</span><span class="p">.</span><span class="na">locations</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">maxFetchFailures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">locations</span><span class="p">.</span><span class="na">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">locationIterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">locations</span><span class="p">.</span><span class="na">iterator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nf">while</span><span class="w"> </span><span class="p">(</span><span class="n">locationIterator</span><span class="p">.</span><span class="na">hasNext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">loc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">locationIterator</span><span class="p">.</span><span class="na">next</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Getting remote block $blockId from $loc&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// Ë∞ÉÁî®blockTransferService.fetchBlockSyncÊñπÊ≥ïÂÆûÁé∞ËøúÁ®ãËé∑ÂèñÊï∞ÊçÆ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockTransferService</span><span class="p">.</span><span class="na">fetchBlockSync</span><span class="p">(</span><span class="n">loc</span><span class="p">.</span><span class="na">host</span><span class="p">,</span><span class="w"> </span><span class="n">loc</span><span class="p">.</span><span class="na">port</span><span class="p">,</span><span class="w"> </span><span class="n">loc</span><span class="p">.</span><span class="na">executorId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">blockId</span><span class="p">.</span><span class="na">toString</span><span class="p">,</span><span class="w"> </span><span class="n">tempFileManager</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">blockSize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">buf</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&#34;Empty buffer received for non empty block&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">buf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">NonFatal</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">runningFailureCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">totalFailureCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ÊîæÂºÉÂ∞ùËØïÁöÑ‰ΩçÁΩÆ„ÄÇË¶Å‰πàÊàë‰ª¨Â∑≤ÁªèÂ∞ùËØï‰∫ÜÊâÄÊúâÁöÑÂéüÂßã‰ΩçÁΩÆ,ÊàñËÄÖÊàë‰ª¨Â∑≤Áªè‰ªémasterËäÇÁÇπÂà∑Êñ∞‰∫Ü‰ΩçÁΩÆÂàóË°®ÔºåÂπ∂‰∏î‰ªçÁÑ∂Âú®Âà∑Êñ∞ÂàóË°®‰∏≠Â∞ùËØï‰ΩçÁΩÆÂêéÂëΩ‰∏≠Â§±Ë¥•</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">totalFailureCount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">maxFetchFailures</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">logWarning</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Failed to fetch block after $totalFailureCount fetch failures. &#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">s</span><span class="s">&#34;Most recent failure cause:&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Â¶ÇÊûúÊúâÂ§ßÈáèÁöÑ ExecutorsÔºåÈÇ£‰πà‰ΩçÁΩÆÂàóË°®ÂèØ‰ª•ÂåÖÂê´‰∏Ä‰∏™ÊóßÁöÑÊù°ÁõÆÈÄ†ÊàêÂ§ßÈáèÈáçËØïÔºåÂèØËÉΩËä±Ë¥πÂ§ßÈáèÁöÑÊó∂Èó¥„ÄÇ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Âú®‰∏ÄÂÆöÊï∞ÈáèÁöÑËé∑ÂèñÂ§±Ë¥•‰πãÂêéÔºå‰∏∫ÂéªÊéâËøô‰∫õÊóßÁöÑÊù°ÁõÆÔºåÊàë‰ª¨Âà∑Êñ∞Âùó‰ΩçÁΩÆ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">runningFailureCount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">maxFailuresBeforeLocationRefresh</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// Â¶ÇÊûúÊúâÂ§ßÈáèÊâßË°åËÄÖÔºåÂàô‰ΩçÁΩÆÂàóË°®ÂèØ‰ª•ÂåÖÂê´Â§ßÈáèËøáÊó∂ÁöÑÊù°ÁõÆÂØºËá¥Â§ßÈáèÈáçËØïÔºåÂèØËÉΩËä±Â§ßÈáèÁöÑÊó∂Èó¥„ÄÇÈô§ÂéªËøô‰∫õÈôàÊóßÁöÑÊù°ÁõÆÔºåÂú®‰∏ÄÂÆöÊï∞ÈáèÁöÑÊèêÂèñÂ§±Ë¥•ÂêéÂà∑Êñ∞Âùó‰ΩçÁΩÆ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">locationIterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sortLocations</span><span class="p">(</span><span class="n">master</span><span class="p">.</span><span class="na">getLocations</span><span class="p">(</span><span class="n">blockId</span><span class="p">)).</span><span class="na">iterator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Refreshed locations from the driver &#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">s</span><span class="s">&#34;after ${runningFailureCount} fetch failures.&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">runningFailureCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// This location failed, so we retry fetch from a different one by returning null here</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Ê≠§‰ΩçÁΩÆÂ§±Ë¥•ÔºåÊâÄ‰ª•Êàë‰ª¨Â∞ùËØï‰ªé‰∏çÂêåÁöÑ‰ΩçÁΩÆËé∑ÂèñÔºåËøôÈáåËøîÂõû‰∏Ä‰∏™ null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="na">isInstanceOf</span><span class="o">[</span><span class="n">BlockManagerManagedBuffer</span><span class="o">]</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">Some</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;The value of block $blockId is null&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Block $blockId not found&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Ëøô‰∏™ÊñπÊ≥ï‰∏ªË¶ÅÂÖ≥Ê≥®‰ª•‰∏ãÁöÑÂÜÖÂÆπÔºö</p>
<ol>
<li>
<p>val locationsAndStatusOption = master.getLocationsAndStatus(blockId, blockManagerId.host)Âõ†‰∏∫ÊâÄÊúâÁöÑËøúÁ®ãÂùóÈÉΩÊ≥®ÂÜåÂú®driver‰∏≠ÔºåÊâÄ‰ª•‰∏çÈúÄË¶ÅË¶ÅÊ±ÇÊâÄÊúâÁöÑ‰ªéÊâßË°åÂô®Ëé∑ÂèñÂùóÁä∂ÊÄÅÔºåËøô‰∏™ÊñπÊ≥ïÂ∞±ÊòØÂéªdriverÈÇ£ÈáåËé∑ÂèñÂú∞ÂùÄÂíåÁä∂ÊÄÅ„ÄÇÁÑ∂ÂêéÂú®DriverÁöÑBlockManagerMasterEndpointÊâßË°ågetLocationsAndStatusËé∑ÂèñËøô‰∏™blockIdÂØπÂ∫îÁöÑblockManagerÂú∞ÂùÄÂíåÁä∂ÊÄÅ</p>
</li>
<li>
<p>Â∏¶ÁùÄËøô‰∫õ‰ΩçÁΩÆÂíåÁä∂ÊÄÅÂéªlocalDirsÊù•Ëé∑ÂèñÊú¨Âú∞ÁöÑblockManagerÔºåÊâßË°åreadDiskBlockFromSameHostExecutor„ÄÇ‰ΩÜÂú®ResultÁöÑÂú∫ÊôØ‰∏≠ÔºåresultÂ≠òÊîæÂú®‰∫Üexecutor‰∏≠ÔºåÊâÄ‰ª•ÈúÄË¶ÅËøúÁ´ØÊãøÂèñblock„ÄÇÂç≥ÊâßË°å‰∫ÜÂ¶Ç‰∏ãÁöÑÊñπÊ≥ïÁöÑ‰∫ÜfetchRemoteManagedBuffer(blockId, blockSize, locationsAndStatus).map(bufferTransformer)Ôºå‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="nf">fetchRemoteManagedBuffer</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">blockId</span><span class="p">:</span><span class="w"> </span><span class="n">BlockId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">blockSize</span><span class="p">:</span><span class="w"> </span><span class="n">Long</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">locationsAndStatus</span><span class="p">:</span><span class="w"> </span><span class="n">BlockManagerMessages</span><span class="p">.</span><span class="na">BlockLocationsAndStatus</span><span class="p">):</span><span class="w"> </span><span class="n">Option</span><span class="o">[</span><span class="n">ManagedBuffer</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Â¶ÇÊûúÂùóÂ§ßÂ∞èË∂ÖËøáÈòàÂÄºÔºåÂ∞ÜFileManager‰º†ÈÄíÁªôBlockTransferServiceÔºåÂà©Áî®ÂÆÉÊù•Ê∫¢Âá∫ÂùóÔºõÂ¶ÇÊûúÊ≤°ÊúâÔºå‰º†ÈÄíÁ©∫ÂÄºÊÑèÂë≥ÁùÄÂùóÂ∞ÜÊåÅ‰πÖÂ≠òÂú®ÂÜÖÂ≠ò‰∏≠„ÄÇ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">tempFileManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">blockSize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxRemoteBlockToMem</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">remoteBlockTempFileManager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">runningFailureCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">totalFailureCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// sortLocationsÊñπÊ≥ïËøîÂõûÁªôÂÆöÂùóÁöÑ‰ΩçÁΩÆÂàóË°®ÔºåÊú¨Âú∞ËÆ°ÁÆóÊú∫ÁöÑ‰ºòÂÖàÁ∫ß‰ªéÂ§ö‰∏™ÂùóÁÆ°ÁêÜÂô®ÂèØ‰ª•ÂÖ±‰∫´Âêå‰∏Ä‰∏™‰∏ªÊú∫ÔºåÁÑ∂ÂêéÊòØÂêå‰∏ÄÊú∫Êû∂‰∏äÁöÑ‰∏ªÊú∫</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">locations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sortLocations</span><span class="p">(</span><span class="n">locationsAndStatus</span><span class="p">.</span><span class="na">locations</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">maxFetchFailures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">locations</span><span class="p">.</span><span class="na">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">locationIterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">locations</span><span class="p">.</span><span class="na">iterator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nf">while</span><span class="w"> </span><span class="p">(</span><span class="n">locationIterator</span><span class="p">.</span><span class="na">hasNext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">loc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">locationIterator</span><span class="p">.</span><span class="na">next</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Getting remote block $blockId from $loc&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// Ë∞ÉÁî®blockTransferService.fetchBlockSyncÊñπÊ≥ïÂÆûÁé∞ËøúÁ®ãËé∑ÂèñÊï∞ÊçÆ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockTransferService</span><span class="p">.</span><span class="na">fetchBlockSync</span><span class="p">(</span><span class="n">loc</span><span class="p">.</span><span class="na">host</span><span class="p">,</span><span class="w"> </span><span class="n">loc</span><span class="p">.</span><span class="na">port</span><span class="p">,</span><span class="w"> </span><span class="n">loc</span><span class="p">.</span><span class="na">executorId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">blockId</span><span class="p">.</span><span class="na">toString</span><span class="p">,</span><span class="w"> </span><span class="n">tempFileManager</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">blockSize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">buf</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&#34;Empty buffer received for non empty block&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">buf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">NonFatal</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">runningFailureCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">totalFailureCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ÊîæÂºÉÂ∞ùËØïÁöÑ‰ΩçÁΩÆ„ÄÇË¶Å‰πàÊàë‰ª¨Â∑≤ÁªèÂ∞ùËØï‰∫ÜÊâÄÊúâÁöÑÂéüÂßã‰ΩçÁΩÆ,ÊàñËÄÖÊàë‰ª¨Â∑≤Áªè‰ªémasterËäÇÁÇπÂà∑Êñ∞‰∫Ü‰ΩçÁΩÆÂàóË°®ÔºåÂπ∂‰∏î‰ªçÁÑ∂Âú®Âà∑Êñ∞ÂàóË°®‰∏≠Â∞ùËØï‰ΩçÁΩÆÂêéÂëΩ‰∏≠Â§±Ë¥•</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">totalFailureCount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">maxFetchFailures</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">logWarning</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Failed to fetch block after $totalFailureCount fetch failures. &#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">s</span><span class="s">&#34;Most recent failure cause:&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Â¶ÇÊûúÊúâÂ§ßÈáèÁöÑ ExecutorsÔºåÈÇ£‰πà‰ΩçÁΩÆÂàóË°®ÂèØ‰ª•ÂåÖÂê´‰∏Ä‰∏™ÊóßÁöÑÊù°ÁõÆÈÄ†ÊàêÂ§ßÈáèÈáçËØïÔºåÂèØËÉΩËä±Ë¥πÂ§ßÈáèÁöÑÊó∂Èó¥„ÄÇ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Âú®‰∏ÄÂÆöÊï∞ÈáèÁöÑËé∑ÂèñÂ§±Ë¥•‰πãÂêéÔºå‰∏∫ÂéªÊéâËøô‰∫õÊóßÁöÑÊù°ÁõÆÔºåÊàë‰ª¨Âà∑Êñ∞Âùó‰ΩçÁΩÆ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">runningFailureCount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">maxFailuresBeforeLocationRefresh</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// Â¶ÇÊûúÊúâÂ§ßÈáèÊâßË°åËÄÖÔºåÂàô‰ΩçÁΩÆÂàóË°®ÂèØ‰ª•ÂåÖÂê´Â§ßÈáèËøáÊó∂ÁöÑÊù°ÁõÆÂØºËá¥Â§ßÈáèÈáçËØïÔºåÂèØËÉΩËä±Â§ßÈáèÁöÑÊó∂Èó¥„ÄÇÈô§ÂéªËøô‰∫õÈôàÊóßÁöÑÊù°ÁõÆÔºåÂú®‰∏ÄÂÆöÊï∞ÈáèÁöÑÊèêÂèñÂ§±Ë¥•ÂêéÂà∑Êñ∞Âùó‰ΩçÁΩÆ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">locationIterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sortLocations</span><span class="p">(</span><span class="n">master</span><span class="p">.</span><span class="na">getLocations</span><span class="p">(</span><span class="n">blockId</span><span class="p">)).</span><span class="na">iterator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Refreshed locations from the driver &#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">s</span><span class="s">&#34;after ${runningFailureCount} fetch failures.&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">runningFailureCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// This location failed, so we retry fetch from a different one by returning null here</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Ê≠§‰ΩçÁΩÆÂ§±Ë¥•ÔºåÊâÄ‰ª•Êàë‰ª¨Â∞ùËØï‰ªé‰∏çÂêåÁöÑ‰ΩçÁΩÆËé∑ÂèñÔºåËøôÈáåËøîÂõû‰∏Ä‰∏™ null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="na">isInstanceOf</span><span class="o">[</span><span class="n">BlockManagerManagedBuffer</span><span class="o">]</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">Some</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;The value of block $blockId is null&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Block $blockId not found&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>‰∏ªË¶ÅÊâßË°åÁöÑÊ≠•È™§Â¶Ç‰∏ãÔºö</p>
<ol>
<li>val locations = sortLocations(locationsAndStatus.locations)„ÄÇsortLocationsÊåâÁÖß‰∏ªÊú∫-&gt;Âêå‰∏ÄÊú∫Êû∂‰∏ªÊú∫ÁöÑÈ°∫Â∫èÊù•ÊéíÂ∫èÔºåËøîÂõûËøô‰∫õËäÇÁÇπÁöÑÂàóË°®</li>
<li>ÁÑ∂ÂêéË∞ÉÁî®blockTransferService.fetchBlockSyncÊñπÊ≥ïÂÆûÁé∞ËøúÁ®ãËé∑ÂèñÊï∞ÊçÆÔºåÁÇπËøõÂéªÊñπÊ≥ïÔºåÂÆûÈôÖ‰∏äÂ∞±ÊòØÊâßË°å‰∫ÜNettyBlockTransferService.fetechBlocksÁöÑÊñπÊ≥ï</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="Âà†Èô§blockÁöÑËøáÁ®ã">Âà†Èô§blockÁöÑËøáÁ®ã
</h2><p>‰∏æ‰∏™‰æãÂ≠êÔºåÂΩìExecutorMemoryË¶ÅÊâ©Â¢ûÁöÑÊó∂ÂÄôÔºåÂ¶ÇÊûúexecutorÂÜÖÂ≠ò‰∏çÂ§üÔºåÈÇ£‰πàÂ∞±Ë¶ÅÂæÄstorageÁöÑ‰ΩçÁΩÆË¶ÅÁ©∫Èó¥Ôºå‰ΩøÁî®StorageMemoryPool.acquireMemoryËøõË°åÔºåmemoryStore.evictBlocksToFreeSpace(Some(blockId), numBytesToFree, memoryMode)‰ª£Á†ÅË°®Á§∫storageÁ©∫Èó¥Âà†Èô§block</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">def</span><span class="w"> </span><span class="n">dropBlock</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="p">(</span><span class="n">blockId</span><span class="p">:</span><span class="w"> </span><span class="n">BlockId</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">:</span><span class="w"> </span><span class="n">MemoryEntry</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="p">):</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DeserializedMemoryEntry</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Left</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">SerializedMemoryEntry</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Right</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">newEffectiveStorageLevel</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">blockEvictionHandler</span><span class="p">.</span><span class="na">dropFromMemory</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">data</span><span class="p">)(</span><span class="n">entry</span><span class="p">.</span><span class="na">classTag</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newEffectiveStorageLevel</span><span class="p">.</span><span class="na">isValid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// The block is still present in at least one store, so release the lock</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// but don&#39;t delete the block info</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">blockInfoManager</span><span class="p">.</span><span class="na">unlock</span><span class="p">(</span><span class="n">blockId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// The block isn&#39;t present in any store, so delete the block info so that the</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// block can be stored again</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">blockInfoManager</span><span class="p">.</span><span class="na">removeBlock</span><span class="p">(</span><span class="n">blockId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ÁúãÁúãËøôÈáåÁúã‰∫Ü‰ªÄ‰πàÔºåblockEvictionHandler.dropFromMemory(blockId, () =&gt; data)(entry.classTag)Â∞±ÊòØÂú®ËøôÈáåÊ†πÊçÆstoragelevelÊù•Âà†Èô§blockÔºåÂ¶ÇÊûústoragelevelÈúÄË¶ÅÁ£ÅÁõòÂ≠òÂÇ®ÁöÑËØùÔºåÂ∞±Âú®ËøôÈáåÂ∞ÜÂÜÖÂ≠ò‰ª•ËΩ¨ÁßªËá≥diskStoreÔºåÂç≥diskStore.putBytes(blockId, bytes)</p>
<p>ÁÑ∂ÂêéÂºÄÂßã‰ªémemoryStoreÂà†Èô§Ëøô‰∏™blockÔºå<code>val blockIsRemoved = memoryStore.remove(blockId)</code>ÔºåÂú®ÈáåÈù¢ÂÆûÈôÖ‰∏äÂ∞±ÊòØ‰ΩøÁî®<code>entries.remove(blockId)</code>„ÄÇ</p>
<p>ÁÑ∂ÂêéËé∑ÂèñËøô‰∏™blockÂΩìÂâçÁöÑstatusÔºåÂà§Êñ≠Áä∂ÊÄÅtellMasterÊòØÂê¶‰∏∫trueÔºåÂ¶ÇÊûúÊòØÁöÑËØùÔºåÂ∞±Â∞Ü‰ø°ÊÅØÂëäËØâmasterÊõ¥Êñ∞„ÄÇÂÖ∑‰ΩìÊâßË°åÁöÑ‰ª£Á†ÅÂ¶ÇBlockManager.tryToReportBlockStatus-&gt;master.updateBlockInfo-&gt;driverEndpoint.askSync<a class="link" href="UpdateBlockInfo.." >Boolean</a>-&gt;Âú®driverÁ´ØÁöÑBlockManagerMasterEndpointÊâßË°åÊõ¥Êç¢ÂÖ≥‰∫éËøô‰∏™blockmanagerÈáåÈù¢ÁöÑblockIdÁöÑ‰ø°ÊÅØÊõ¥Êñ∞‰∏Ä‰∏ã‰∏ã„ÄÇ</p>
<p>ËøîÂõûÂà∞<code>MemoryStore.dropBlock</code>ÁöÑ‰ΩçÁΩÆÔºåÂ¶ÇÊûúÊâÄÊúâÁöÑblockÈÉΩÂà†Èô§ÔºåÈÇ£‰πàÂ∞±‰ΩøÁî®blockInfoManager.removeBlock(blickId)Ôºå‰∏çÂÜçËÆ∞ÂΩïËøô‰∏™blockÁöÑ</p>
<h2 id="ÊÄªÁªì">ÊÄªÁªì
</h2><p>Â•Ω‰∫ÜÔºåÂà∞‰∫ÜËøô‰∏™Êó∂ÂÄôÔºåÂ∑≤ÁªèÁü•ÈÅìSpark‰∏≠BlockManagerÊòØÊÄé‰πàÁÆ°ÁêÜÁöÑ‰∫ÜÔºåÈáåÈù¢Ê∂âÂèäÂà∞Âá†‰∏™Á±ªÔºåÊØîÂ¶ÇBlockInfoManager„ÄÅBlockManager„ÄÅBlockManagerMaster„ÄÅBlockManagerMasterEndpointÁ≠â„ÄÇÂ¶Ç‰ΩïÊ∑±ÂÖ•ÁêÜËß£ÂÆÉ‰ª¨ÊúÄÂ•ΩËøòÊòØÊâæ‰∏Ä‰∏™Â≠òÂèñblockÁöÑËøáÁ®ã‰æãÂ≠êÂéªÁêÜËß£ÊØîËæÉÂ•Ω„ÄÇ</p>
<h2 id="ÂèÇËÄÉ">ÂèÇËÄÉ
</h2><ol>
<li><a class="link" href="https://blog.csdn.net/weixin_41841496/article/details/132372549?spm=1001.2014.3001.5502"  target="_blank" rel="noopener"
    >„ÄêËØªÊáÇÈù¢Áªè‰∏≠ÁöÑÊ∫êÁ†Å„ÄëSPARKÊ∫êÁ†ÅËß£Êûê‚Äî‚ÄîBlockManagerÁÆ°ÁêÜ</a></li>
</ol>

</section>


    <footer class="article-footer">
    

    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Áõ∏ÂÖ≥ÊñáÁ´†</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/spark%E5%B9%BF%E6%92%AD%E6%9C%BA%E5%88%B6%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0/">
        
        
            <div class="article-image">
                <img src="/p/spark%E5%B9%BF%E6%92%AD%E6%9C%BA%E5%88%B6%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0/grebe-7972183_1280.6dd8a2d7b8cf99148cf7a877d9459ae8_hu10399000877992530385.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post SparkÂπøÊí≠Êú∫Âà∂Ê∫êÁ†ÅÂÆûÁé∞"
                        
                        data-hash="md5-bdii17jPmRSM96h32UWa6A==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">SparkÂπøÊí≠Êú∫Âà∂Ê∫êÁ†ÅÂÆûÁé∞</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/oom%E9%83%BD%E6%98%AF%E8%B0%81%E7%9A%84%E9%94%85/">
        
        
            <div class="article-image">
                <img src="/p/oom%E9%83%BD%E6%98%AF%E8%B0%81%E7%9A%84%E9%94%85/winter-8433267_1280.1db9e97625db6d61118e6635dc1248b1_hu14689633931296498845.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post OOMÈÉΩÊòØË∞ÅÁöÑÈîÖ"
                        
                        data-hash="md5-HbnpdiXbbWERjmY13BJIsQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">OOMÈÉΩÊòØË∞ÅÁöÑÈîÖ</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E8%AF%A6%E8%A7%A3spark%E5%B9%BF%E6%92%AD%E5%8F%98%E9%87%8F/">
        
        
            <div class="article-image">
                <img src="/p/%E8%AF%A6%E8%A7%A3spark%E5%B9%BF%E6%92%AD%E5%8F%98%E9%87%8F/pawel-czerwinski-8uZPynIu-rQ-unsplash.c514d916917173a48a42e0114b469961_hu7626638945853200361.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post ËØ¶Ëß£SparkÂπøÊí≠ÂèòÈáè"
                        
                        data-hash="md5-xRTZFpFxc6SKQuARS0aZYQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">ËØ¶Ëß£SparkÂπøÊí≠ÂèòÈáè</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/rdd%E5%92%8Cdataframe%E5%92%8Cdataset%E4%B8%89%E8%80%85%E9%97%B4%E7%9A%84%E5%8C%BA%E5%88%AB/">
        
        
            <div class="article-image">
                <img src="/p/rdd%E5%92%8Cdataframe%E5%92%8Cdataset%E4%B8%89%E8%80%85%E9%97%B4%E7%9A%84%E5%8C%BA%E5%88%AB/trees-8136806_1280.357dd549ed51f498bcbf5425f76e0416_hu9173719500181869714.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post RDDÂíåDataFrameÂíåDataSet‰∏âËÄÖÈó¥ÁöÑÂå∫Âà´"
                        
                        data-hash="md5-NX3VSe1R9Ji8v1Ql924EFg==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">RDDÂíåDataFrameÂíåDataSet‰∏âËÄÖÈó¥ÁöÑÂå∫Âà´</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E8%AF%A6%E8%A7%A3joinhints%E7%89%B9%E6%80%A7/">
        
        
            <div class="article-image">
                <img src="/p/%E8%AF%A6%E8%A7%A3joinhints%E7%89%B9%E6%80%A7/pawel-czerwinski-8uZPynIu-rQ-unsplash.c514d916917173a48a42e0114b469961_hu7626638945853200361.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post ËØ¶Ëß£JoinHintsÁâπÊÄß"
                        
                        data-hash="md5-xRTZFpFxc6SKQuARS0aZYQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">ËØ¶Ëß£JoinHintsÁâπÊÄß</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo="sherlock-lin/utterances-comments"
        issue-term="pathname"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    let utterancesLoaded = false;

    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;

        
        utterancesLoaded = true;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        if (!utterancesLoaded) return;
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2022 - 
        
        2025 sherlock-lin
    </section>
    
    <section class="powerby">
        ‰ΩøÁî® <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> ÊûÑÂª∫ <br />
        ‰∏ªÈ¢ò <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.27.0">Stack</a></b> Áî± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> ËÆæËÆ°
    </section>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv">Êú¨Á´ôÊÄªËÆøÈóÆÈáè <span id="busuanzi_value_site_pv"></span> Ê¨° ¬∑ </span>
<span id="busuanzi_container_site_uv">ÊÇ®ÊòØÊú¨Á´ôÁ¨¨ <span id="busuanzi_value_site_uv"></span> ‰ΩçËÆøÈóÆËÄÖ</span>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
