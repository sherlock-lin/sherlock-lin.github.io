<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="æ¦‚è¿° Sparkå­˜å‚¨ä¸»è¦ç”±BlockManageræ¥å®Œæˆï¼Œå®ƒä¸»è¦å®Œæˆäº†ï¼š\nå†™å…¥æ•°æ®å—ï¼Œå¦‚æœéœ€è¦å¤‡ä»½æ•°æ®å—ï¼Œåˆ™å°†æ•°æ®å—å†™å…¥å…¶ä»–èŠ‚ç‚¹ï¼› è¯»å–æ•°æ®å—ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹ä¸å«æœ‰æ•°æ®å—ï¼Œåˆ™ä»å…¶ä»–èŠ‚ç‚¹è·å–æ•°æ®å—ï¼› å‘DriverèŠ‚ç‚¹æ³¨å†Œè‡ªèº«çš„BlockManagerï¼Œä»¥åŠä¸ŠæŠ¥å…¶æ‰€ç®¡ç†çš„æ•°æ®å—èŠ‚ç‚¹ã€‚ Sparkä½¿ç”¨BlockInfoManageræ¥ç®¡ç†å½“å‰èŠ‚ç‚¹æ‰€ç®¡ç†çš„æ•°æ®å—çš„å…ƒæ•°æ®ï¼Œç»´æŠ¤äº†BlockIdï¼ˆæ•°æ®å—çš„å”¯ä¸€æ ‡è¯†ï¼‰åˆ°BlockInfoï¼ˆæ•°æ®å—å…ƒæ•°æ®ï¼‰çš„æ˜ å°„å…³ç³»ã€‚ä½¿ç”¨å†…å­˜ï¼ˆMemoryStoreï¼‰å’Œç£ç›˜ï¼ˆDiskStoreï¼‰æ¥å­˜å‚¨æ•°æ®å—ã€‚Sparkä½¿ç”¨BlockManagerMasterä½¿Executorçš„BlockManagerä¸Driverè¿›è¡Œé€šä¿¡ï¼Œå‘Driveræ³¨å†Œè‡ªå·±ï¼Œå¹¶ä¸ŠæŠ¥æ•°æ®å—ä¿¡æ¯ã€‚Driveré€šè¿‡Executor BlockManagerçš„BlockManagerStorageEndpointå‘Executorå‘å‡ºåˆ é™¤æ•°æ®å—/Rdd/Shuffle/Broadcastç­‰æ•°æ®ã€‚Sparkä½¿ç”¨BlockTransferServiceæ¥å®ç°ä¸åŒExecutor BlockManagerä¹‹é—´çš„é€šä¿¡ã€‚ç”¨è¿™ä¸ªBlockTransferServiceå»å…¶ä»–blockManagerè·å–æ•°æ®å—blockæˆ–è€…æ›´æ–°æ•°æ®å—blockä¿¡æ¯ã€‚\n">
<title>BlockManagerç®¡ç†æºç è§£æ</title>

<link rel='canonical' href='https://sherlock-lin.github.io/p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="BlockManagerç®¡ç†æºç è§£æ">
<meta property='og:description' content="æ¦‚è¿° Sparkå­˜å‚¨ä¸»è¦ç”±BlockManageræ¥å®Œæˆï¼Œå®ƒä¸»è¦å®Œæˆäº†ï¼š\nå†™å…¥æ•°æ®å—ï¼Œå¦‚æœéœ€è¦å¤‡ä»½æ•°æ®å—ï¼Œåˆ™å°†æ•°æ®å—å†™å…¥å…¶ä»–èŠ‚ç‚¹ï¼› è¯»å–æ•°æ®å—ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹ä¸å«æœ‰æ•°æ®å—ï¼Œåˆ™ä»å…¶ä»–èŠ‚ç‚¹è·å–æ•°æ®å—ï¼› å‘DriverèŠ‚ç‚¹æ³¨å†Œè‡ªèº«çš„BlockManagerï¼Œä»¥åŠä¸ŠæŠ¥å…¶æ‰€ç®¡ç†çš„æ•°æ®å—èŠ‚ç‚¹ã€‚ Sparkä½¿ç”¨BlockInfoManageræ¥ç®¡ç†å½“å‰èŠ‚ç‚¹æ‰€ç®¡ç†çš„æ•°æ®å—çš„å…ƒæ•°æ®ï¼Œç»´æŠ¤äº†BlockIdï¼ˆæ•°æ®å—çš„å”¯ä¸€æ ‡è¯†ï¼‰åˆ°BlockInfoï¼ˆæ•°æ®å—å…ƒæ•°æ®ï¼‰çš„æ˜ å°„å…³ç³»ã€‚ä½¿ç”¨å†…å­˜ï¼ˆMemoryStoreï¼‰å’Œç£ç›˜ï¼ˆDiskStoreï¼‰æ¥å­˜å‚¨æ•°æ®å—ã€‚Sparkä½¿ç”¨BlockManagerMasterä½¿Executorçš„BlockManagerä¸Driverè¿›è¡Œé€šä¿¡ï¼Œå‘Driveræ³¨å†Œè‡ªå·±ï¼Œå¹¶ä¸ŠæŠ¥æ•°æ®å—ä¿¡æ¯ã€‚Driveré€šè¿‡Executor BlockManagerçš„BlockManagerStorageEndpointå‘Executorå‘å‡ºåˆ é™¤æ•°æ®å—/Rdd/Shuffle/Broadcastç­‰æ•°æ®ã€‚Sparkä½¿ç”¨BlockTransferServiceæ¥å®ç°ä¸åŒExecutor BlockManagerä¹‹é—´çš„é€šä¿¡ã€‚ç”¨è¿™ä¸ªBlockTransferServiceå»å…¶ä»–blockManagerè·å–æ•°æ®å—blockæˆ–è€…æ›´æ–°æ•°æ®å—blockä¿¡æ¯ã€‚\n">
<meta property='og:url' content='https://sherlock-lin.github.io/p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/'>
<meta property='og:site_name' content='å¤æ´›å…‹-æ—'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2025-04-05T12:09:22&#43;08:00'/><meta property='article:modified_time' content='2025-04-05T12:09:22&#43;08:00'/><meta property='og:image' content='https://sherlock-lin.github.io/p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/dolphin-8949505_1280.jpg' />
<meta name="twitter:title" content="BlockManagerç®¡ç†æºç è§£æ">
<meta name="twitter:description" content="æ¦‚è¿° Sparkå­˜å‚¨ä¸»è¦ç”±BlockManageræ¥å®Œæˆï¼Œå®ƒä¸»è¦å®Œæˆäº†ï¼š\nå†™å…¥æ•°æ®å—ï¼Œå¦‚æœéœ€è¦å¤‡ä»½æ•°æ®å—ï¼Œåˆ™å°†æ•°æ®å—å†™å…¥å…¶ä»–èŠ‚ç‚¹ï¼› è¯»å–æ•°æ®å—ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹ä¸å«æœ‰æ•°æ®å—ï¼Œåˆ™ä»å…¶ä»–èŠ‚ç‚¹è·å–æ•°æ®å—ï¼› å‘DriverèŠ‚ç‚¹æ³¨å†Œè‡ªèº«çš„BlockManagerï¼Œä»¥åŠä¸ŠæŠ¥å…¶æ‰€ç®¡ç†çš„æ•°æ®å—èŠ‚ç‚¹ã€‚ Sparkä½¿ç”¨BlockInfoManageræ¥ç®¡ç†å½“å‰èŠ‚ç‚¹æ‰€ç®¡ç†çš„æ•°æ®å—çš„å…ƒæ•°æ®ï¼Œç»´æŠ¤äº†BlockIdï¼ˆæ•°æ®å—çš„å”¯ä¸€æ ‡è¯†ï¼‰åˆ°BlockInfoï¼ˆæ•°æ®å—å…ƒæ•°æ®ï¼‰çš„æ˜ å°„å…³ç³»ã€‚ä½¿ç”¨å†…å­˜ï¼ˆMemoryStoreï¼‰å’Œç£ç›˜ï¼ˆDiskStoreï¼‰æ¥å­˜å‚¨æ•°æ®å—ã€‚Sparkä½¿ç”¨BlockManagerMasterä½¿Executorçš„BlockManagerä¸Driverè¿›è¡Œé€šä¿¡ï¼Œå‘Driveræ³¨å†Œè‡ªå·±ï¼Œå¹¶ä¸ŠæŠ¥æ•°æ®å—ä¿¡æ¯ã€‚Driveré€šè¿‡Executor BlockManagerçš„BlockManagerStorageEndpointå‘Executorå‘å‡ºåˆ é™¤æ•°æ®å—/Rdd/Shuffle/Broadcastç­‰æ•°æ®ã€‚Sparkä½¿ç”¨BlockTransferServiceæ¥å®ç°ä¸åŒExecutor BlockManagerä¹‹é—´çš„é€šä¿¡ã€‚ç”¨è¿™ä¸ªBlockTransferServiceå»å…¶ä»–blockManagerè·å–æ•°æ®å—blockæˆ–è€…æ›´æ–°æ•°æ®å—blockä¿¡æ¯ã€‚\n"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://sherlock-lin.github.io/p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/dolphin-8949505_1280.jpg' />
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/cs_hu10005534405353342465.jpg" width="300"
                            height="294" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¥³</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">å¤æ´›å…‹-æ—</a></h1>
            <h2 class="site-description">æ¬¢è¿æ¥åˆ°ä¸€ä¸ªè¯»ä¹¦ç‹‚é­”ã€åæ‰§ç‹‚çš„åšå®¢~</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/CaiJimmy/hugo-theme-stack'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>ä¸»é¡µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>å…³äº</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>å½’æ¡£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>æœç´¢</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%8F%8B%E6%83%85%E9%93%BE%E6%8E%A5/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>å‹æƒ…é“¾æ¥</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>æš—è‰²æ¨¡å¼</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#æ¦‚è¿°">æ¦‚è¿°</a></li>
    <li><a href="#blockinfomanager">BlockInfoManager</a>
      <ol>
        <li><a href="#blockidè§£æ">BlockIdè§£æ</a></li>
        <li><a href="#blockinfoè§£æ">BlockInfoè§£æ</a></li>
      </ol>
    </li>
    <li><a href="#blockmanagerè§£æ">BlockManagerè§£æ</a>
      <ol>
        <li><a href="#blockmanagerçš„ç»„ä»¶">BlockManagerçš„ç»„ä»¶</a></li>
        <li><a href="#blockmanageråˆ›å»ºçš„æ—¶æœº">BlockManageråˆ›å»ºçš„æ—¶æœº</a></li>
      </ol>
    </li>
    <li><a href="#blockmanagermasterè§£æ">BlockManagerMasterè§£æ</a></li>
    <li><a href="#blockmanagermasterendpoint">BlockManagerMasterEndpoint</a>
      <ol>
        <li><a href="#blockmanagermasterendpointçš„æ–¹æ³•">BlockManagerMasterEndpointçš„æ–¹æ³•</a>
          <ol>
            <li><a href="#receiveandreply">receiveAndReply</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#å­˜å–blockçš„è¿‡ç¨‹">å­˜å–blockçš„è¿‡ç¨‹</a>
      <ol>
        <li><a href="#executorç«¯å­˜å‚¨blockçš„æ‰§è¡Œæµç¨‹">Executorç«¯å­˜å‚¨blockçš„æ‰§è¡Œæµç¨‹</a></li>
        <li><a href="#driverç«¯çš„è·å–blockçš„æ‰§è¡Œæµç¨‹">driverç«¯çš„è·å–blockçš„æ‰§è¡Œæµç¨‹</a></li>
      </ol>
    </li>
    <li><a href="#åˆ é™¤blockçš„è¿‡ç¨‹">åˆ é™¤blockçš„è¿‡ç¨‹</a></li>
    <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
    <li><a href="#å‚è€ƒ">å‚è€ƒ</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">
                <img src="/p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/dolphin-8949505_1280_hu12894558835196541998.jpg"
                        srcset="/p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/dolphin-8949505_1280_hu12894558835196541998.jpg 800w, /p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/dolphin-8949505_1280_hu53765993347886950.jpg 1600w"
                        width="800" 
                        height="533" 
                        loading="lazy"
                        alt="Featured image of post BlockManagerç®¡ç†æºç è§£æ" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/spark/" style="background-color: #2a9d8f; color: #fff;">
                Spark
            </a>
        
            <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" style="background-color: #2a9d8f; color: #fff;">
                å¤§æ•°æ®
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">BlockManagerç®¡ç†æºç è§£æ</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2025-04-05</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 27 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="æ¦‚è¿°">æ¦‚è¿°
</h2><p><img src="/p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250405104327775.png"
	width="1926"
	height="1070"
	srcset="/p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250405104327775_hu6286005587082314117.png 480w, /p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250405104327775_hu8205538478772633062.png 1024w"
	loading="lazy"
	
		alt="image-20250405104327775"
	
	
		class="gallery-image" 
		data-flex-grow="180"
		data-flex-basis="432px"
	
></p>
<p>Sparkå­˜å‚¨ä¸»è¦ç”±BlockManageræ¥å®Œæˆï¼Œå®ƒä¸»è¦å®Œæˆäº†ï¼š</p>
<ol>
<li>å†™å…¥æ•°æ®å—ï¼Œå¦‚æœéœ€è¦å¤‡ä»½æ•°æ®å—ï¼Œåˆ™å°†æ•°æ®å—å†™å…¥å…¶ä»–èŠ‚ç‚¹ï¼›</li>
<li>è¯»å–æ•°æ®å—ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹ä¸å«æœ‰æ•°æ®å—ï¼Œåˆ™ä»å…¶ä»–èŠ‚ç‚¹è·å–æ•°æ®å—ï¼›</li>
<li>å‘DriverèŠ‚ç‚¹æ³¨å†Œè‡ªèº«çš„BlockManagerï¼Œä»¥åŠä¸ŠæŠ¥å…¶æ‰€ç®¡ç†çš„æ•°æ®å—èŠ‚ç‚¹ã€‚</li>
</ol>
<p>Sparkä½¿ç”¨BlockInfoManageræ¥ç®¡ç†å½“å‰èŠ‚ç‚¹æ‰€ç®¡ç†çš„æ•°æ®å—çš„å…ƒæ•°æ®ï¼Œç»´æŠ¤äº†BlockIdï¼ˆæ•°æ®å—çš„å”¯ä¸€æ ‡è¯†ï¼‰åˆ°BlockInfoï¼ˆæ•°æ®å—å…ƒæ•°æ®ï¼‰çš„æ˜ å°„å…³ç³»ã€‚ä½¿ç”¨å†…å­˜ï¼ˆMemoryStoreï¼‰å’Œç£ç›˜ï¼ˆDiskStoreï¼‰æ¥å­˜å‚¨æ•°æ®å—ã€‚Sparkä½¿ç”¨BlockManagerMasterä½¿Executorçš„BlockManagerä¸Driverè¿›è¡Œé€šä¿¡ï¼Œå‘Driveræ³¨å†Œè‡ªå·±ï¼Œå¹¶ä¸ŠæŠ¥æ•°æ®å—ä¿¡æ¯ã€‚Driveré€šè¿‡Executor BlockManagerçš„BlockManagerStorageEndpointå‘Executorå‘å‡ºåˆ é™¤æ•°æ®å—/Rdd/Shuffle/Broadcastç­‰æ•°æ®ã€‚Sparkä½¿ç”¨BlockTransferServiceæ¥å®ç°ä¸åŒExecutor BlockManagerä¹‹é—´çš„é€šä¿¡ã€‚ç”¨è¿™ä¸ªBlockTransferServiceå»å…¶ä»–blockManagerè·å–æ•°æ®å—blockæˆ–è€…æ›´æ–°æ•°æ®å—blockä¿¡æ¯ã€‚</p>
<p>Sparkè®¾ç½®äº†å¤šç§å­˜å‚¨çº§åˆ«ï¼š</p>
<ul>
<li>DISK_ONLY	åªä½¿ç”¨ç£ç›˜å­˜å‚¨</li>
<li>DISK_ONLY_2	åªä½¿ç”¨ç£ç›˜å­˜å‚¨ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªå¤‡ä»½</li>
<li>MEMORY_ONLY	åªä½¿ç”¨å†…å­˜å‚¨å­˜å‚¨</li>
<li>MEMORY_ONLY_2	åªä½¿ç”¨å†…å­˜å­˜å‚¨ï¼Œå¹¶æœ‰ä¸€ä¸ªå¤‡ä»½</li>
<li>MEMORY_ONLY_SER	åªä½¿ç”¨å†…å­˜å­˜å‚¨åºåˆ—åŒ–æ•°æ®</li>
<li>MEMORY_ONLY_SER_2	åªä½¿ç”¨å†…å­˜å­˜å‚¨åºåˆ—åŒ–æ•°æ®ï¼Œå¹¶æœ‰ä¸€ä¸ªå¤‡ä»½</li>
<li>MEMORY_AND_DISK	åªä½¿ç”¨å†…å­˜å­˜å‚¨åºåˆ—åŒ–æ•°æ®ï¼Œå¹¶æœ‰ä¸€ä¸ªå¤‡ä»½</li>
<li>MEMORY_AND_DISK_2	ä¼˜å…ˆå†…å­˜å­˜å‚¨ï¼Œå†…å­˜ä¸è¶³ä½¿ç”¨ç£ç›˜ï¼Œå¹¶æœ‰ä¸€ä¸ªå¤‡ä»½</li>
<li>MEMORY_AND_DISK_SER	ä¼˜å…ˆå†…å­˜å­˜å‚¨åºåˆ—åŒ–æ•°æ®ï¼Œå†…å­˜ä¸è¶³ä½¿ç”¨ç£ç›˜</li>
<li>MEMORY_AND_DISK_SER_2	ä¼˜å…ˆå†…å­˜å­˜å‚¨åºåˆ—åŒ–æ•°æ®ï¼Œå†…å­˜ä¸è¶³ä½¿ç”¨ç£ç›˜ï¼Œå¹¶æœ‰ä¸€ä¸ªå¤‡ä»½</li>
<li>OFF_HEAP	ä½¿ç”¨å †å¤–å­˜å‚¨ï¼ˆåŒMEMORY_AND_DISK_SERï¼Œåªæ˜¯ä½¿ç”¨å †å¤–å†…å­˜ï¼‰</li>
</ul>
<p>put blockï¼ˆå†™å…¥æ•°æ®å—ï¼‰ï¼šåœ¨å†™æ•°æ®å—çš„æ—¶å€™ï¼Œæ ¹æ®å­˜å‚¨çº§åˆ«çš„ä¸åŒï¼Œå¦‚æœå­˜å‚¨çº§åˆ«è¦æ±‚å­˜å‚¨åºåˆ—åŒ–/éåºåˆ—åŒ–çš„æ•°æ®ï¼Œè€Œè¾“å…¥çš„æ•°æ®å—æ˜¯éåºåˆ—åŒ–/åºåˆ—åŒ–çš„ï¼Œåˆ™è¦é¦–å…ˆåºåˆ—åŒ–/ååºåˆ—åŒ–ï¼›å¦‚æœæ”¯æŒå†…å­˜å­˜å‚¨ï¼Œåˆ™å°†æ•°æ®å—ä¿å­˜åˆ°å†…å­˜ä¸­ï¼Œå¦‚æœè®¾ç½®äº†MEMORY_AND_DISKä¹‹ç±»çš„å­˜å‚¨çº§åˆ«ï¼Œå½“å†…å­˜ä¸è¶³æ—¶ï¼Œä¼šå°†æ•°æ®å—å†™å…¥ç£ç›˜ã€‚å¦‚æœä¸æ”¯æŒå†…å­˜å­˜å‚¨ï¼Œåªæ”¯æŒç£ç›˜å­˜å‚¨ï¼Œåˆ™ç›´æ¥å°†æ•°æ®å—å†™å…¥ç£ç›˜ã€‚å¦‚æœéœ€è¦å¤‡ä»½æ•°æ®å—ï¼Œåˆ™å°†æ•°æ®å—åŒæ­¥çš„å†™å…¥å…¶ä»–èŠ‚ç‚¹ã€‚</p>
<p>get blockï¼ˆè·å–æ•°æ®å—ï¼‰ï¼šè·å–æ•°æ®å—æ—¶ï¼Œå¦‚æœè¯·æ±‚åºåˆ—åŒ–çš„æ•°æ®è€Œå­˜å‚¨çº§åˆ«æ˜¯éåºåˆ—åŒ–ï¼Œåˆ™ä¼˜å…ˆä»ç£ç›˜ä¸­è·å–æ•°æ®ï¼Œå¦‚æœç£ç›˜è·å–ä¸åˆ°ï¼Œåˆ™æ ¹æ®å­˜å‚¨çº§åˆ«å°è¯•ä»å†…å­˜è·å–æ•°æ®å¹¶å°†å…¶åºåˆ—åŒ–ï¼›å¦‚æœå­˜å‚¨çº§åˆ«å°±æ˜¯åºåˆ—åŒ–æ•°æ®ï¼Œåˆ™é¦–å…ˆå°è¯•ä»å†…å­˜è·å–æ•°æ®ï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™æ ¹æ®å­˜å‚¨çº§åˆ«ä»ç£ç›˜è·å–æ•°æ®ã€‚å¦‚æœè¯·æ±‚çš„æ˜¯éåºåˆ—åŒ–çš„æ•°æ®ï¼Œå¦‚æœå­˜å‚¨çº§åˆ«åŒ…æ‹¬å†…å­˜ï¼Œåˆ™é¦–å…ˆå°è¯•ä»å†…å­˜è·å–ï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™æ ¹æ®å­˜å‚¨çº§åˆ«å†å°è¯•ä»ç£ç›˜è·å–å¹¶ååºåˆ—åŒ–æ•°æ®ï¼›å¦‚æœå­˜å‚¨çº§åˆ«åªåŒ…æ‹¬ç£ç›˜ï¼Œåˆ™ç›´æ¥ä»ç£ç›˜è·å–å¹¶ååºåˆ—åŒ–æ•°æ®ã€‚</p>
<p>register &amp; register blockï¼ˆæ³¨å†ŒBlockManager&amp;ä¸ŠæŠ¥æ•°æ®å—ä¿¡æ¯ï¼‰ï¼šExecutorçš„BlockManageråœ¨åˆå§‹åŒ–æ—¶éœ€è¦å‘Driveræ³¨å†Œï¼Œå¹¶å®šæ—¶ä¸ŠæŠ¥å…¶æ‰€ç®¡ç†çš„æ•°æ®å—ä¿¡æ¯ã€‚</p>
<p>removeï¼ˆåˆ é™¤æ•°æ®å—ï¼‰ï¼šDriverå‘Executor BlockManagerä¸‹å‘åˆ é™¤æ•°æ®å—/Rdd/Shuffle/Broadcastç­‰æ•°æ®çš„æŒ‡ä»¤ï¼ŒExecutor BlockManageræ¥æ”¶æŒ‡ä»¤å¹¶åœ¨æœ¬åœ°æ‰§è¡Œåˆ é™¤æ“ä½œã€‚</p>
<h2 id="blockinfomanager">BlockInfoManager
</h2><p>BlockInfoManagerä¸»è¦ç»´æŠ¤äº†BlockManageræ‰€ç®¡ç†çš„æ‰€æœ‰æ•°æ®å—å…ƒæ•°æ®ä»¥åŠå¯¹ç”³è¯·æ•°æ®å—è¯»å†™çš„ä»»åŠ¡æä¾›æ•°æ®å—è¯»å†™é”ã€‚Sparkä¸­çš„æ•°æ®å—é™¤äº†å®é™…å­˜å‚¨æ•°æ®çš„Blockä¹‹å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªæ•°æ®ç»“æ„ï¼ŒBlockIdå’ŒBlockInfoåˆ†åˆ«ç”¨æ¥ä¸ºæ•°æ®å—æä¾›å…¨å±€å”¯ä¸€çš„æ ‡è®°ï¼Œä»¥åŠè®°å½•æ•°æ®å—çš„å…ƒæ•°æ®ã€‚</p>
<h3 id="blockidè§£æ">BlockIdè§£æ
</h3><p>åœ¨Sparkçš„å­˜å‚¨ä½“ç³»ä¸­ï¼Œæ•°æ®çš„è¯»å†™æ˜¯ä»¥blockä¸ºå•ä½çš„ï¼Œè¿™æ˜¯ç”¨æˆ·çš„æ“ä½œå•ä½ï¼Œä¸€ä¸ªBlockå¯¹åº”ä¸€å—å†…å­˜ã€‚æ¯ä¸ªblockéƒ½æœ‰å”¯ä¸€çš„æ ‡è¯†ï¼ŒSparkæŠŠè¿™ä¸ªæ ‡è¯†æŠ½è±¡æˆBlockIdï¼ŒblockIdæœ‰å¤šä¸ªå®ç°ç±»ï¼Œå¤§è‡´å¯ä»¥æœåŠ¡äºShuffleã€RDDã€Broadcastã€TaskReusltã€Streamç­‰</p>
<p><img src="/p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250405111315357.png"
	width="980"
	height="420"
	srcset="/p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250405111315357_hu15846251071821746649.png 480w, /p/blockmanager%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250405111315357_hu18326209398234817706.png 1024w"
	loading="lazy"
	
		alt="image-20250405111315357"
	
	
		class="gallery-image" 
		data-flex-grow="233"
		data-flex-basis="560px"
	
></p>
<h3 id="blockinfoè§£æ">BlockInfoè§£æ
</h3><p>BlockInfoæ˜¯å¯¹ä¸€ä¸ªBlockå…ƒä¿¡æ¯çš„è®°å½•ï¼Œå¯ä»¥æ–¹ä¾¿è·Ÿè¸ªblockidçš„ä¸€äº›åŸºæœ¬æ•°æ®ï¼Œè¯¥ç±»ç”±ä¸‰ä¸ªå˜é‡æè¿°ï¼š</p>
<ol>
<li>levelï¼šå—çš„æœŸæœ›å­˜å‚¨ç­‰çº§ï¼Œä¸ä»£è¡¨å®é™…çš„å­˜å‚¨æƒ…å†µã€‚è€Œè¿™ä¸ªå°±æ˜¯StorageLevel</li>
<li>classTagï¼šå—çš„ç±»æ ‡ç­¾</li>
<li>tellMasterï¼šæ˜¯å¦è¦å°†è¯¥å—çš„å…ƒä¿¡æ¯å‘ŠçŸ¥Master</li>
<li>sizeï¼šè¿™ä¸ªå—çš„å°ºå¯¸</li>
<li>readerCountï¼šè¯¥å—å·²é”å®šç”¨äºreadçš„æ¬¡æ•°</li>
<li>writerTaskï¼šå½“å‰æŒæœ‰è¯¥å—å†™é”çš„TaskID</li>
</ol>
<h2 id="blockmanagerè§£æ">BlockManagerè§£æ
</h2><p>Sparkä¸­ä½¿ç”¨BlockManagerå—æ¥ç®¡ç†å½“å‰èŠ‚ç‚¹å†…å­˜å’Œç£ç›˜çš„æ•°æ®å—ï¼ŒDriverå’ŒExecutorèŠ‚ç‚¹éƒ½ä¼šåˆ›å»ºBlockManagerã€‚ å—ç®¡ç†å™¨è´Ÿè´£æ•°æ®çš„è¯»å†™è¯·æ±‚ï¼Œåˆ é™¤ç­‰æ“ä½œï¼Œå¹¶å‘DriverèŠ‚ç‚¹æ³¨å†Œï¼Œæ±‡æŠ¥å…¶æ‰€ç®¡ç†çš„æ•°æ®å—å…ƒæ•°æ®ä¿¡æ¯ï¼ˆå¦‚æœæ˜¯DriverèŠ‚ç‚¹çš„å—ç®¡ç†å™¨ï¼Œåˆ™æ•´ä¸ªæ³¨å†Œè¿‡ç¨‹æ— éœ€ç½‘ç»œé€šä¿¡ï¼Œå¦‚æœæ˜¯ExecutorèŠ‚ç‚¹çš„å—ç®¡ç†å™¨æ³¨å†Œï¼Œåˆ™éœ€è¦ä¸DriverèŠ‚ç‚¹è¿›è¡Œç½‘ç»œé€šä¿¡ï¼‰ã€‚å½“èŠ‚ç‚¹éœ€è¦çš„æ•°æ®å—ä¸åœ¨æœ¬åœ°æ—¶ï¼Œå—ç®¡ç†å™¨ä¼šé¦–å…ˆé€šè¿‡DriverèŠ‚ç‚¹è·å–åˆ°æŒæœ‰æ‰€éœ€æ•°æ®å—çš„èŠ‚ç‚¹ï¼Œç„¶åç›´æ¥ä¸è¯¥èŠ‚ç‚¹è¿›è¡Œé€šä¿¡ï¼Œå®Œæˆæ•°æ®çš„ä¼ è¾“ã€‚å…¶ä¸­æ¶‰åŠåˆ°çš„é€šä¿¡ï¼ˆä¸è®ºæ˜¯ç½‘ç»œé€šä¿¡è¿˜æ˜¯æœ¬åœ°é€šä¿¡ï¼‰ï¼Œéƒ½æ˜¯é€šè¿‡Sparkçš„RPCæ¡†æ¶å®ç°çš„</p>
<h3 id="blockmanagerçš„ç»„ä»¶">BlockManagerçš„ç»„ä»¶
</h3><ul>
<li>
<p>MemoryStore è´Ÿè´£å†…å­˜æ•°æ®çš„è¯»å†™æ“ä½œã€‚MemoryStoreç”¨æ¥å°†æ•°æ®å—ä»¥åºåˆ—åŒ–/éåºåˆ—åŒ–çš„å½¢å¼ä¿å­˜åˆ°å†…å­˜ä¸­ï¼Œä»¥åŠä»å†…å­˜ä¸­è·å–æ•°æ®å—ã€‚å½“å†…å­˜ç©ºé—´ä¸è¶³æ—¶ï¼ŒMemoryStoreä¼šå°†å†…å­˜ä¸­çš„æ•°æ®å—è¿ç§»åˆ°ç£ç›˜ä¸­ã€‚</p>
</li>
<li>
<p>DiskStoreè´Ÿè´£ç£ç›˜æ•°æ®çš„è¯»å†™æ“ä½œã€‚DiskStoreç”¨æ¥å°†æ•°æ®å—å­˜å‚¨åˆ°ç£ç›˜ä¸Šï¼Œä»¥åŠä»ç£ç›˜ä¸Šè·å–æ•°æ®å—ã€‚å¦‚æœæ•°æ®å—çš„å­˜å‚¨çº§åˆ«é…ç½®äº†ç£ç›˜ï¼Œåˆ™å½“å†…å­˜ä¸è¶³æ—¶ï¼ŒSparkä¼šå°†æ•°æ®å—ä»å†…å­˜ç§»åŠ¨åˆ°ç£ç›˜ä¸Šã€‚åœ¨æ–°å»ºDiskStoreæ—¶ï¼Œä¼šä¼ å…¥DiskBlockManagerå®ä¾‹ï¼ŒDiskBlockManagerä¸»è¦ç”¨æ¥åˆ›å»ºå’Œç»´æŠ¤é€»è¾‘æ•°æ®å—å’Œç£ç›˜å®é™…å­˜å‚¨çš„ç‰©ç†ä½ç½®çš„æ˜ å°„å…³ç³»ã€‚</p>
</li>
<li>
<p>BlockTransferService è¿™é‡ŒmapOutputTrackerä¸å…¶ä»–çš„BlockMangerè¿æ¥æˆåŠŸåï¼Œè´Ÿè´£è¿›è¡Œæ•°æ®çš„ä¼ è¾“ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä»å…¶ä»–Executorè·å–æ•°æ®å—çš„æ–¹æ³•fetechBlocks</li>
<li>å“åº”å…¶ä»–Executorçš„è¯·æ±‚ï¼Œå°†æ•°æ®å—è¿”å›ç»™è¯·æ±‚çš„Executorã€‚uploadBlock</li>
</ul>
</li>
<li>
<p>mapOutputTrackerã€‚ shuffleè¾“å‡ºçš„æ—¶å€™ï¼Œè¦è®°å½•shufflemaptaskçš„è¾“å‡ºä½ç½®ï¼Œä»¥ä¾›ä¸‹ä¸€ä¸ªStageä½¿ç”¨ï¼Œå› æ­¤éœ€è¦è¿›è¡Œè®°å½•</p>
</li>
<li>
<p>DiskBlockManagerã€‚DiskBlockManagerç”¨æ¥åˆ›å»ºå¹¶ç»´æŠ¤é€»è¾‘æ•°æ®å—å’Œç£ç›˜å®é™…å­˜å‚¨çš„ç‰©ç†ä½ç½®çš„æ˜ å°„å…³ç³»ã€‚æ•°æ®å—ä¼šè¢«ä¿å­˜åˆ°ä»¥BlockIdä¸ºåå­—çš„æ–‡ä»¶ä¸­ã€‚æ•°æ®å—æ–‡ä»¶ä¼šè¢«hashåˆ°spark.local.diræ‰€é…ç½®çš„ç›®å½•ã€‚</p>
</li>
</ul>
<h3 id="blockmanageråˆ›å»ºçš„æ—¶æœº">BlockManageråˆ›å»ºçš„æ—¶æœº
</h3><p><strong>Driverç«¯</strong></p>
<p>åœ¨Driverçš„åˆ›å»ºç¯å¢ƒSparkEnvçš„æ—¶å€™åˆ›å»º</p>
<p><strong>Executorç«¯</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">val</span><span class="w"> </span><span class="n">blockManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BlockManager</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">executorId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">rpcEnv</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">blockManagerMaster</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">serializerManager</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">conf</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">memoryManager</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">mapOutputTracker</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// shuffleManageræ˜¯åœ¨SparkEnvä¸­åˆ›å»ºçš„ï¼Œå°†shuffleManagerä¼ å…¥åˆ°BlockManagerï¼ŒBlockManagerå°±æ‹¥æœ‰shuffleManagerçš„æˆå‘˜å˜é‡ï¼Œ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// ä»è€Œå¯ä»¥è°ƒç”¨shuffleManagerçš„ç›¸å…³æ–¹æ³•</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">shuffleManager</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">blockTransferService</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">securityManager</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">externalShuffleClient</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°åœ¨åˆ›å»ºblockManagerçš„æ—¶å€™ï¼Œä¼ å…¥äº†blockManagerMasterçš„å‚æ•°ï¼ŒmemoryManagerï¼ŒmapOutputTrackerï¼Œï¼ˆå®ç°æ˜¯UnifiedMemoryManagerï¼‰ä»¥åŠblockTransferServiceçš„ä¸å—ç®¡ç†ç›¸å…³çš„å‚æ•°ã€‚æ¥ä¸‹æ¥çš„ç¯‡å¹…ä¼šè®²è§£è¿™å‡ ä¸ªéƒ¨åˆ†</p>
<p>ç„¶åå›åˆ°<code>SparkContext</code>ï¼Œåœ¨è¿™é‡Œæ‰§è¡Œäº†</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">_env</span><span class="p">.</span><span class="na">blockManager</span><span class="p">.</span><span class="na">initialize</span><span class="p">(</span><span class="n">_applicationId</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>è¡¨ç¤ºå¸¦ç€åº”ç”¨IDæ¥æ³¨å†ŒblockManager.ç‚¹è¿›å»æ–¹æ³•é‡Œé¢,</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">appId</span><span class="p">:</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="cm">/** åº”ç”¨id **/</span><span class="p">):</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// è°ƒç”¨blockTransferServiceçš„initæ–¹æ³•ï¼ŒblockTransferServiceç”¨äºåœ¨ä¸åŒèŠ‚ç‚¹fetchæ•°æ®ï¼Œä¼ é€æ•°æ®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// åˆå§‹åŒ–BlockTransferService</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">blockTransferService</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">externalBlockStoreClient</span><span class="p">.</span><span class="na">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">blockStoreClient</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// ç”¨äºè¯»å–å…¶ä»–Executorä¸Šçš„shuffle files</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// åˆå§‹åŒ–ShuffleClient</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">blockStoreClient</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">appId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">blockReplicationPolicy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">priorityClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conf</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="na">STORAGE_REPLICATION_POLICY</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Utils</span><span class="p">.</span><span class="na">classForName</span><span class="p">(</span><span class="n">priorityClass</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getConstructor</span><span class="p">().</span><span class="na">newInstance</span><span class="p">().</span><span class="na">asInstanceOf</span><span class="o">[</span><span class="n">BlockReplicationPolicy</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">logInfo</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Using $priorityClass for block replication policy&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// åˆ›å»ºBlockManagerId</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">BlockManagerId</span><span class="p">(</span><span class="n">executorId</span><span class="p">,</span><span class="w"> </span><span class="n">blockTransferService</span><span class="p">.</span><span class="na">hostName</span><span class="p">,</span><span class="w"> </span><span class="n">blockTransferService</span><span class="p">.</span><span class="na">port</span><span class="p">,</span><span class="w"> </span><span class="n">None</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// å‘blockManagerMasteræ³¨å†ŒBlockManagerï¼Œåœ¨registerBlockManageræ–¹æ³•ä¸­ä¼ å…¥äº†slaveEndpointï¼ŒslaveEndpointä¸ºBlockManager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// ä¸­çš„RPCå¯¹è±¡ï¼Œç”¨äºå’ŒblockManagerMasateré€šä¿¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">idFromMaster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">.</span><span class="na">registerBlockManager</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">diskBlockManager</span><span class="p">.</span><span class="na">localDirsString</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">maxOnHeapMemory</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">maxOffHeapMemory</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">storageEndpoint</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="c1">// è¿™ä¸ªæ¶ˆæ¯å¾ªç¯ä½“æ¥æ¥æ”¶Driverä¸­BlockManagerMasterçš„ä¿¡æ¯</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// å¾—åˆ°shuffleManageId</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">blockManagerId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idFromMaster</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="n">idFromMaster</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// å¾—åˆ°shuffleServerId</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">shuffleServerId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">externalShuffleServiceEnabled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logInfo</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;external shuffle service port = $externalShuffleServicePort&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">BlockManagerId</span><span class="p">(</span><span class="n">executorId</span><span class="p">,</span><span class="w"> </span><span class="n">blockTransferService</span><span class="p">.</span><span class="na">hostName</span><span class="p">,</span><span class="w"> </span><span class="n">externalShuffleServicePort</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">blockManagerId</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Register Executors&#39; configuration with the local shuffle service, if one should exist.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// æ³¨å†Œshuffleserver</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// å¦‚æœå­˜åœ¨ï¼Œå°†æ³¨å†ŒExecutorsé…ç½®ä¸æœ¬åœ°shuffleæœåŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">externalShuffleServiceEnabled</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">blockManagerId</span><span class="p">.</span><span class="na">isDriver</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">registerWithExternalShuffleServer</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">logInfo</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Initialized BlockManager: $blockManagerId&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>å°±æ˜¯æ‰§è¡Œå¦‚ä¸‹æ­¥éª¤:</p>
<ol>
<li>åˆå§‹åŒ–BlockTransferService<code>blockTransferService.init(this)</code>,è¿™ä¸ªç±»æ˜¯ç”¨æ¥è¿›è¡Œç½‘ç»œè¿æ¥è·å–è¿œç¨‹æ•°æ®çš„</li>
<li>master.registerBlockManagerå‘BlockManagerMasteræ³¨å†Œ,è¿™ä¸ªæ—¶å€™BlockManagerMasterä¼šä¸ºè¯¥BlockManageråˆ›å»ºå¯¹åº”çš„BlockManagerInfo,BlockManagerInfoç®¡ç†é›†ç¾¤ä¸­æ¯ä¸ªExecutorçš„BlockManagerå…ƒæ•°æ®,å¹¶å­˜å‚¨åˆ°BlockStatusä¸­</li>
</ol>
<p><strong>Executorç«¯</strong></p>
<p>å½“WorkerèŠ‚ç‚¹ä¸­å¯åŠ¨ExecutorRunneræ—¶ï¼ŒExecutorRunnerä¸­ä¼šå¯åŠ¨CoarseGrainedExecutorBackendè¿›ç¨‹, åœ¨CoarseGrainedExecutorBackendçš„onStartæ–¹æ³•ä¸­ï¼Œå‘Driverå‘å‡ºRegisterExecutoræ³¨å†Œè¯·æ±‚ã€‚ç„¶åDriveræ¥å—RegisterExecutorå¹¶æ³¨å†ŒExecutor, CoarseGrainedExecutorBackendæ¥å—åˆ°æˆåŠŸæ³¨å†Œçš„å›åº”ä¹‹å, å‘è‡ªå·±å‘é€RegisteredExecutor, å¹¶ä¸”å¯åŠ¨Executorçš„ç±»ã€‚</p>
<p>åœ¨è¿™é‡ŒExecutorçš„ç±»ä¸­,æœ€ç»ˆæ‰§è¡Œäº†ä»¥ä¸‹åˆå§‹åŒ–blockManagerçš„æ–¹æ³•</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">env</span><span class="p">.</span><span class="na">blockManager</span><span class="p">.</span><span class="na">initialize</span><span class="p">(</span><span class="n">conf</span><span class="p">.</span><span class="na">getAppId</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="blockmanagermasterè§£æ">BlockManagerMasterè§£æ
</h2><p>BlockManagerMasteræ˜¯BlockManagerçš„ç»„ä»¶ï¼ŒBlockManageré€šè¿‡å…¶æ¥ä¸Driverè¿›è¡Œé€šä¿¡ï¼Œå®Œæˆå‘Driveræ³¨å†ŒBlockManagerï¼Œä»Driverè·å–æ•°æ®å—çš„ä½ç½®ä¿¡æ¯ï¼Œå®šæ—¶å‘DriveråŒæ­¥BlockManageræ‰€ç®¡ç†çš„æ•°æ®å—ä¿¡æ¯ï¼Œå“åº”Driverå‘æ¥çš„åˆ é™¤æ•°æ®å—çš„è¯·æ±‚ç­‰ã€‚Driverå’ŒExecutorèŠ‚ç‚¹éƒ½ä¼šåˆ›å»ºè‡ªå·±çš„BlockManagerMasterï¼ŒåŒºåˆ«æ˜¯Driverè‡ªèº«BlockManagerä¸­çš„BlockManagerMasterä¸Driveré€šä¿¡æ—¶ï¼Œä¸äº§ç”Ÿç½‘ç»œé€šä¿¡ã€‚è€ŒExecutorèŠ‚ç‚¹ä¸­çš„BlockManagerMasterä¸Driveré€šä¿¡æ—¶ï¼Œä¼šäº§ç”Ÿç½‘ç»œé€šä¿¡ã€‚</p>
<p>Executorä»»ä½•çš„BlockManagerMasteræ‰€åšçš„åŠ¨ä½œéƒ½æ˜¯å»driveråšçš„ï¼Œæ‰€ä»¥Executorçš„BlockManagerMasterè¯´ç™½äº†è¿˜åªæ˜¯ç”¨æ¥è·Ÿdriveré€šä¿¡è€Œå·²ã€‚å…³é”®èƒ½åšåŠ¨ä½œçš„æ¯”å¦‚ï¼ˆupdateBlockInfoã€getLocationsã€removeBlockï¼‰è¿˜æ˜¯éœ€è¦å„æ–¹exeuctorçš„blocké€šçŸ¥ç»™driverç«¯å»æ‰§è¡Œå‘½ä»¤ï¼ï¼ï¼</p>
<h2 id="blockmanagermasterendpoint">BlockManagerMasterEndpoint
</h2><p>BlockManagerMasterEndpointæ˜¯RpcEndpointçš„ä¸€ä¸ªå…·ä½“å®ç°ç±»ï¼Œå°±æ˜¯ä¸Šæ–‡ä¸­BlockManagerMasteræ‰€æŒæœ‰çš„RpcEndpointRefçš„å…·ä½“æŒ‡å‘ç±»ï¼Œæ˜¯Driverçš„BlockManagerå¤„ç†æ¥è‡ªExecutorè¯·æ±‚ï¼Œä»¥åŠå‘Executorå‘é€è¯·æ±‚çš„é€»è¾‘ã€‚æ¥è‡ªExecutorçš„è¯·æ±‚/å‘Executorå‘é€çš„è¯·æ±‚ä¸BlockManagerMasterå‘é€å’Œå“åº”çš„ç›¸åŒï¼Œä¸»è¦ä¸ºæ³¨å†ŒExecutorçš„BlockManagerï¼Œè¿”å›æ‰€ä¿å­˜çš„æ•°æ®å—çš„ä½ç½®ä¿¡æ¯ï¼Œæ¥æ”¶å¹¶æ›´æ–°Executorå‘é€è¿‡æ¥çš„æ•°æ®å—ä¿¡æ¯ï¼Œå‘Executorå‘é€åˆ é™¤æ•°æ®å—çš„è¯·æ±‚ç­‰ã€‚</p>
<p>åœ¨BlockManagerMasterEndpointä¸­ç»´æŠ¤äº†æ³¨å†Œçš„BlockManagerï¼ŒBlockManagerå’ŒExecutorçš„æ˜ å°„å…³ç³»ï¼Œæ•°æ®å—æ‰€åœ¨çš„ä½ç½®ç­‰ä¿¡æ¯ã€‚è¿™äº›éƒ½å¯ä»¥çœ‹åšæ˜¯å­˜å‚¨ç›¸å…³çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚DriverèŠ‚ç‚¹é€šè¿‡ä¿å­˜è¿™äº›å…ƒæ•°æ®æ¥ç®¡ç†æ•´ä¸ªé›†ç¾¤çš„å­˜å‚¨ã€‚</p>
<h3 id="blockmanagermasterendpointçš„æ–¹æ³•">BlockManagerMasterEndpointçš„æ–¹æ³•
</h3><h4 id="receiveandreply">receiveAndReply
</h4><p>æ ¹æ®æ¥è‡ªExecutorä¸åŒçš„è¯·æ±‚ï¼Œè°ƒç”¨ç›¸å…³å‡½æ•°å¹¶å›è°ƒè¯·æ±‚å›è°ƒå‡½æ•°ï¼Œæ¯”å¦‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">RegisterBlockManager</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">localDirs</span><span class="p">,</span><span class="w"> </span><span class="n">maxOnHeapMemSize</span><span class="p">,</span><span class="w"> </span><span class="n">maxOffHeapMemSize</span><span class="p">,</span><span class="w"> </span><span class="n">endpoint</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">context</span><span class="p">.</span><span class="na">reply</span><span class="p">(</span><span class="n">register</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">localDirs</span><span class="p">,</span><span class="w"> </span><span class="n">maxOnHeapMemSize</span><span class="p">,</span><span class="w"> </span><span class="n">maxOffHeapMemSize</span><span class="p">,</span><span class="w"> </span><span class="n">endpoint</span><span class="p">))</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>è¿˜æœ‰å…¶ä»–çš„æ–¹æ³•æ¯”å¦‚</p>
<ol>
<li>updateBlockInfo</li>
<li><code>GetLocationsAndStatus(blockId, requesterHost)</code>æ ¹æ®blockId, requesterHostä½ç½®è¿”å›å­˜ä»–ä»¬BlockManagerIdçš„ä½ç½®å’Œblockidçš„çŠ¶æ€</li>
<li><code>GetLocations(blockId)</code>é¦–å…ˆåˆ¤æ–­å†…å­˜ç¼“å­˜ç»“æ„blockLocationsä¸­æ˜¯å¦åŒ…å«blockIdï¼Œå¦‚æœå·²åŒ…å«ï¼Œå°±è·å–ä½ç½®ä¿¡æ¯ï¼Œå¦åˆ™è¿”å›ç©ºçš„ä¿¡æ¯</li>
<li><code>GetLocationsMultipleBlockIds(blockIds)</code>è·å–å­˜æ”¾ä¸€å †blockIdsçš„blockmanagerIdçš„ä½ç½®</li>
<li><code>GetPeers(blockManagerId)</code>è·å–ç»™å®šå—ç®¡ç†å™¨çš„å¯¹ç­‰æ–¹åˆ—è¡¨</li>
<li><code>GetExecutorEndpointRef(executorId)</code>è¿”å›ç”¨äºå‘é€ RPC æ¶ˆæ¯çš„ BlockManagerReplicaEndpoint çš„ RpcEndpointRef</li>
<li><code>GetMemoryStatus</code>è¿”å›ä»å—ç®¡ç†å™¨ ID åˆ°æœ€å¤§å†…å­˜å’Œå‰©ä½™å†…å­˜çš„æ˜ å°„</li>
<li><code>GetStorageStatus</code>ä½¿ç”¨ä¸€ç»„åˆå§‹å—åˆ›å»ºå­˜å‚¨çŠ¶æ€ï¼Œè€Œä¸ä¿®æ”¹æº</li>
<li>GetBlockStatus(blockId, askSlaves)è¿”å›æ‰€æœ‰å—ç®¡ç†å™¨çš„å—çŠ¶æ€ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚æ³¨æ„ï¼šè¿™æ˜¯ä¸€é¡¹å¯èƒ½ä»£ä»·é«˜æ˜‚çš„æ“ä½œï¼Œåº”ä»…ç”¨äºæµ‹è¯•ã€‚å¦‚æœ askStorageEndpoint ä¸º trueï¼Œåˆ™ä¸»èŠ‚ç‚¹å°†æŸ¥è¯¢æ¯ä¸ªå—ç®¡ç†å™¨ä»¥è·å–æœ€æ–°çš„å—çŠ¶æ€ã€‚å½“æ‰€æœ‰å—ç®¡ç†å™¨æœªé€šçŸ¥ä¸»èŠ‚ç‚¹ç»™å®šå—æ—¶ï¼Œè¿™å¾ˆæœ‰ç”¨ã€‚</li>
<li><code>GetMatchingBlockIds(filter, askSlaves)</code></li>
<li><code>RemoveRdd(rddId)</code>é¦–å…ˆåˆ é™¤ç»™å®š RDD çš„å…ƒæ•°æ®ï¼Œç„¶åä»storage endpointä¸­å¼‚æ­¥åˆ é™¤å—ã€‚</li>
<li><code>RemoveShuffle(shuffleId)</code>ç§»é™¤æ‰€æœ‰å±äºç‰¹å®šéšæœºshuffleçš„block</li>
<li><code>RemoveBroadcast(broadcastId, removeFromDriver)</code>ç§»é™¤æ‰€æœ‰å±äºç‰¹å®šéšæœºbroadcastçš„block</li>
<li><code>RemoveBlock(blockId)</code>ä»å…·æœ‰è¯¥å—çš„storage endpointä¸­åˆ é™¤è¯¥å—ã€‚è¿™åªèƒ½ç”¨äºåˆ é™¤ä¸»èŠ‚ç‚¹çŸ¥é“çš„å—</li>
<li><code>RemoveExecutor(execId)</code>ä»driver endpointä¸­åˆ é™¤å¤±æ•ˆçš„executorã€‚è¿™ä»…åœ¨driver endpointè°ƒç”¨</li>
<li><code>StopBlockManagerMaster</code></li>
<li><code>BlockManagerHeartbeat(blockManagerId)</code></li>
<li><code>HasCachedBlocks(executorId)</code></li>
</ol>
<h2 id="å­˜å–blockçš„è¿‡ç¨‹">å­˜å–blockçš„è¿‡ç¨‹
</h2><p>ä»¥ResultTaskä¸ºä¾‹</p>
<h3 id="executorç«¯å­˜å‚¨blockçš„æ‰§è¡Œæµç¨‹">Executorç«¯å­˜å‚¨blockçš„æ‰§è¡Œæµç¨‹
</h3><p>åœ¨Executor.runçš„æ–¹æ³•ä¸­ï¼Œä»»åŠ¡æ‰§è¡Œå®Œä¼šå½¢æˆä»»åŠ¡ç»“æœï¼Œè¿™ä¸ªä»»åŠ¡ç»“æœæ˜¯å‡†å¤‡å‘é€ç»™TaskSetManagerçš„ï¼Œä»»åŠ¡ç»“æœä¼šæ ¹æ®ç»“æœçš„å¤§å°æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦å˜æˆindirectTaskResultå¯¹è±¡ï¼Œè¿™é‡Œçš„IndirectTaskResultå¯¹è±¡ä¸­åŒ…å«ç»“æœæ‰€åœ¨çš„BlockIdï¼Œåœ¨SchedulerBackendä¸­å¯ä»¥é€šè¿‡BlockManagerè·å¾—è¯¥BlockIdå¯¹åº”çš„ç»“æœæ•°æ®</p>
<p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ‰§è¡Œäº†å¦‚ä¸‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">val</span><span class="w"> </span><span class="n">blockId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TaskResultBlockId</span><span class="p">(</span><span class="n">taskId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">env</span><span class="p">.</span><span class="na">blockManager</span><span class="p">.</span><span class="na">putBytes</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">blockId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">new</span><span class="w"> </span><span class="n">ChunkedByteBuffer</span><span class="p">(</span><span class="n">serializedDirectResult</span><span class="p">.</span><span class="na">duplicate</span><span class="p">()),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">StorageLevel</span><span class="p">.</span><span class="na">MEMORY_AND_DISK_SER</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">logInfo</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Finished $taskName. $resultSize bytes result sent via BlockManager)&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// è¿”å›å…ƒæ•°æ®ser.serialize(new IndirectTaskResult[Any](blockId, resultSize))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ser</span><span class="p">.</span><span class="na">serialize</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">IndirectTaskResult</span><span class="o">[</span><span class="n">Any</span><span class="o">]</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">resultSize</span><span class="p">))</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>è¿‡ç¨‹ä¸­æ¸…æ™°çš„çœ‹å‡ºäº†ï¼Œé€šè¿‡ç”¨taskIdæ¥åˆ›å»ºTaskResultBlockIdï¼Œç„¶åå°†ä¸²è¡ŒåŒ–ä¹‹åçš„ä¿¡æ¯é€šè¿‡blockManager.putBytesçš„æ–¹æ³•æ”¾è¿›blockManagerä¸­ï¼Œè€Œä¸”ç”¨åˆ°çš„å­˜å‚¨çº§åˆ«æ˜¯MEMORY_AND_DISK_SER</p>
<p>åœ¨æ–¹æ³•å†…éƒ¨è°ƒç”¨äº†blockStoreUpdater.save()ï¼Œè¯¦ç»†çœ‹doPutæ–¹æ³•</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="n">doPut</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">blockId</span><span class="p">:</span><span class="w"> </span><span class="n">BlockId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">level</span><span class="p">:</span><span class="w"> </span><span class="n">StorageLevel</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">classTag</span><span class="p">:</span><span class="w"> </span><span class="n">ClassTag</span><span class="o">[</span><span class="n">_</span><span class="o">]</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">tellMaster</span><span class="p">:</span><span class="w"> </span><span class="n">Boolean</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">keepReadLock</span><span class="p">:</span><span class="w"> </span><span class="n">Boolean</span><span class="p">)(</span><span class="n">putBody</span><span class="p">:</span><span class="w"> </span><span class="n">BlockInfo</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Option</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="p">):</span><span class="w"> </span><span class="n">Option</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 	</span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">putBlockInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">newInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BlockInfo</span><span class="p">(</span><span class="n">level</span><span class="p">,</span><span class="w"> </span><span class="n">classTag</span><span class="p">,</span><span class="w"> </span><span class="n">tellMaster</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// lockNewBlockForWritingå†™å…¥ä¸€ä¸ªæ–°çš„å—å‰å…ˆå°è¯•è·å¾—é€‚å½“çš„é”ï¼Œå¦‚æœæˆ‘ä»¬æ˜¯ç¬¬ä¸€ä¸ªå†™å—ï¼Œè·å¾—å†™å…¥é”åç»§ç»­åç»­æ“ä½œã€‚</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// å¦åˆ™ï¼Œå¦‚æœå¦ä¸€ä¸ªçº¿ç¨‹å·²ç»å†™å…¥å—ï¼Œé¡»ç­‰å¾…å†™å…¥å®Œæˆï¼Œæ‰èƒ½è·å–è¯»å–é”ï¼Œè°ƒç”¨new()å‡½æ•°åˆ›å»ºä¸€ä¸ªBlockInfoèµ‹å€¼ç»™putBlockInfoï¼Œ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// ç„¶åé€šè¿‡putBody(putBlockInfo)å°†æ•°æ®å­˜å…¥ã€‚putBodyæ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œè¾“å…¥BlockInfoï¼Œè¾“å‡ºçš„æ˜¯ä¸€ä¸ªæ³›å‹Option[T]ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// putBodyå‡½æ•°ä½“å†…å®¹æ˜¯doPutIteratoræ–¹æ³•ï¼ˆdoPutBytesæ–¹æ³•ä¹Ÿç±»ä¼¼è°ƒç”¨doPutï¼‰è°ƒç”¨doPutæ—¶ä¼ å…¥ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">blockInfoManager</span><span class="p">.</span><span class="na">lockNewBlockForWriting</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">newInfo</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">newInfo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">result</span><span class="p">:</span><span class="w"> </span><span class="n">Option</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">putBody</span><span class="p">(</span><span class="n">putBlockInfo</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">res</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">result</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>
<p>val newInfo = new BlockInfo(level, classTag, tellMaster)åˆ›å»ºputBlockInfoï¼Œåœ¨å…¶ä¸­éœ€è¦ç”¨ç”¨é”</p>
</li>
<li>
<p>é€šè¿‡putBody(putBlockInfo)å°†æ•°æ®å­˜å…¥</p>
</li>
<li>
<p>putBodyæ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œå…¶åœ¨BlockManager.save()ä¸­å®šä¹‰ï¼Œå¦‚ä¸‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">info</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">startTimeNs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">nanoTime</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Since we&#39;re storing bytes, initiate the replication before storing them locally.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// This is faster as data is already serialized and ready to send.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">replicationFuture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">level</span><span class="p">.</span><span class="na">replication</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Future</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// This is a blocking action and should run in futureExecutionContext which is a cached</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// thread pool.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">replicate</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">blockData</span><span class="p">(),</span><span class="w"> </span><span class="n">level</span><span class="p">,</span><span class="w"> </span><span class="n">classTag</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}(</span><span class="n">futureExecutionContext</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">level</span><span class="p">.</span><span class="na">useMemory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Put it in memory first, even if it also has useDisk set to true;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// We will drop it to disk later if the memory store can&#39;t hold it.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">putSucceeded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">level</span><span class="p">.</span><span class="na">deserialized</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">saveDeserializedValuesToMemoryStore</span><span class="p">(</span><span class="n">blockData</span><span class="p">().</span><span class="na">toInputStream</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">saveSerializedValuesToMemoryStore</span><span class="p">(</span><span class="n">readToByteBuffer</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">putSucceeded</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">level</span><span class="p">.</span><span class="na">useDisk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">logWarning</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Persisting block $blockId to disk instead.&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">saveToDiskStore</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">level</span><span class="p">.</span><span class="na">useDisk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">saveToDiskStore</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">putBlockStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCurrentBlockStatus</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">blockWasSuccessfullyStored</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">putBlockStatus</span><span class="p">.</span><span class="na">storageLevel</span><span class="p">.</span><span class="na">isValid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">blockWasSuccessfullyStored</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Now that the block is in either the memory or disk store,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// tell the master about it.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">info</span><span class="p">.</span><span class="na">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockSize</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">tellMaster</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">tellMaster</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">reportBlockStatus</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">putBlockStatus</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">addUpdatedBlockStatusToTaskMetrics</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">putBlockStatus</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Put block ${blockId} locally took ${Utils.getUsedTimeNs(startTimeNs)}&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">level</span><span class="p">.</span><span class="na">replication</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Wait for asynchronous replication to finish</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ThreadUtils</span><span class="p">.</span><span class="na">awaitReady</span><span class="p">(</span><span class="n">replicationFuture</span><span class="p">,</span><span class="w"> </span><span class="n">Duration</span><span class="p">.</span><span class="na">Inf</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">NonFatal</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SparkException</span><span class="p">(</span><span class="s">&#34;Error occurred while waiting for replication to finish&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">blockWasSuccessfullyStored</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Some</span><span class="p">(</span><span class="n">blockSize</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}.</span><span class="na">isEmpty</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>val replicationFuture = if (level.replication &gt; 1) {}å¦‚æœlevelä¸­æ˜¾ç¤ºå¤åˆ¶æ•°&gt;1ï¼Œé‚£ä¹ˆæ‰§è¡Œreplicate()æ–¹æ³•ï¼Œå°†è¿™ä¸ªblockå¤åˆ¶åˆ°å…¶ä»–blockã€‚</p>
<ol>
<li>val initialPeers = getPeers(false).filterNot(existingReplicas.contains)ï¼Œå»blockManagerMasteré‚£é‡Œæ‹‰å–peer block managersçš„</li>
<li>var peersForReplication = blockReplicationPolicy.prioritizeå¯¹blockçš„ä¸€ç»„peeersè¿›è¡Œä¼˜å…ˆçº§æ’åº</li>
<li>blockTransferService.uploadBlockSyncå³ä¸Šä¼ å¤åˆ¶çš„blockæ•°æ®åˆ°å…¶ä»–çš„èŠ‚ç‚¹ä¸­</li>
</ol>
</li>
<li>
<p>if (level.useMemory)åˆ¤æ–­æ˜¯å¦ä½¿ç”¨memoryã€‚å³ä½¿è®¾ç½®äº†ä½¿ç”¨Diskï¼Œä¹Ÿæ˜¯é¦–å…ˆä½¿ç”¨å†…å­˜ï¼Œå¦‚æœå†…å­˜æ— æ³•å­˜å‚¨ï¼Œæ‰æ”¾åˆ°Diskä¸­ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">val</span><span class="w"> </span><span class="n">putSucceeded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">level</span><span class="p">.</span><span class="na">deserialized</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">saveDeserializedValuesToMemoryStore</span><span class="p">(</span><span class="n">blockData</span><span class="p">().</span><span class="na">toInputStream</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">saveSerializedValuesToMemoryStore</span><span class="p">(</span><span class="n">readToByteBuffer</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">putSucceeded</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">level</span><span class="p">.</span><span class="na">useDisk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logWarning</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Persisting block $blockId to disk instead.&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">saveToDiskStore</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>æ–¹æ³•éå¸¸ç›´è§‚ï¼Œæ¯”å¦‚è¯´å­˜å‚¨ä¸²è¡Œæ•°æ®åˆ°memoryStoreä¸­ï¼Œåˆ™æ‰§è¡ŒsaveSerializedValuesToMemoryStore</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="nf">saveSerializedValuesToMemoryStore</span><span class="p">(</span><span class="n">bytes</span><span class="p">:</span><span class="w"> </span><span class="n">ChunkedByteBuffer</span><span class="p">):</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">memoryMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">level</span><span class="p">.</span><span class="na">memoryMode</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">memoryStore</span><span class="p">.</span><span class="na">putBytes</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">blockSize</span><span class="p">,</span><span class="w"> </span><span class="n">memoryMode</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">memoryMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MemoryMode</span><span class="p">.</span><span class="na">OFF_HEAP</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">bytes</span><span class="p">.</span><span class="na">chunks</span><span class="p">.</span><span class="na">exists</span><span class="p">(</span><span class="o">!</span><span class="n">_</span><span class="p">.</span><span class="na">isDirect</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">bytes</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span><span class="n">Platform</span><span class="p">.</span><span class="na">allocateDirectBuffer</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">bytes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>é‡ç‚¹åœ¨äºmemoryStore.putBytesã€‚çœ‹åˆ°è¿™é‡Œï¼Œå…¶å®å°±å¾ˆæ˜ç™½blockManager.puteBytes()æœ€ç»ˆè¿˜æ˜¯æ‰§è¡Œäº†memoryStoreæˆ–è€…diskStoreçš„putBytes</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">  </span><span class="n">def</span><span class="w"> </span><span class="n">putBytes</span><span class="o">[</span><span class="n">T</span><span class="p">:</span><span class="w"> </span><span class="n">ClassTag</span><span class="o">]</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">blockId</span><span class="p">:</span><span class="w"> </span><span class="n">BlockId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">size</span><span class="p">:</span><span class="w"> </span><span class="n">Long</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">memoryMode</span><span class="p">:</span><span class="w"> </span><span class="n">MemoryMode</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">_bytes</span><span class="p">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">ChunkedByteBuffer</span><span class="p">):</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">require</span><span class="p">(</span><span class="o">!</span><span class="n">contains</span><span class="p">(</span><span class="n">blockId</span><span class="p">),</span><span class="w"> </span><span class="n">s</span><span class="s">&#34;Block $blockId is already present in the MemoryStore&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">memoryManager</span><span class="p">.</span><span class="na">acquireStorageMemory</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">memoryMode</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// ä¸ºè¿™ä¸ªå¿«è·å¾—äº†è¶³å¤Ÿçš„å†…å­˜ï¼Œæ‰€ä»¥æŠŠå®ƒæ”¾è¿›å»</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// We acquired enough memory for the block, so go ahead and put it</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_bytes</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">assert</span><span class="p">(</span><span class="n">bytes</span><span class="p">.</span><span class="na">size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SerializedMemoryEntry</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span><span class="w"> </span><span class="n">memoryMode</span><span class="p">,</span><span class="w"> </span><span class="n">implicitly</span><span class="o">[</span><span class="n">ClassTag</span><span class="o">[</span><span class="n">T</span><span class="o">]]</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">entries</span><span class="p">.</span><span class="na">synchronized</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">entries</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">logInfo</span><span class="p">(</span><span class="s">&#34;Block %s stored as bytes in memory (estimated size %s, free %s)&#34;</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">Utils</span><span class="p">.</span><span class="na">bytesToString</span><span class="p">(</span><span class="n">size</span><span class="p">),</span><span class="w"> </span><span class="n">Utils</span><span class="p">.</span><span class="na">bytesToString</span><span class="p">(</span><span class="n">maxMemory</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">blocksMemoryUsed</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>putBytesæ–¹æ³•é‡ç‚¹åœ¨äº</p>
<ul>
<li>memoryManager.acquireStorageMemory(blockId, size, memoryMode)ä»UnifiedMemoryManagerä¸­è·å–StorageMemoryã€‚</li>
<li>é‚£åˆ†é…åˆ°å†…å­˜ä¹‹åï¼Œå°±è¦å°†è¿™ä¸ªä¸œè¥¿å­˜å‚¨ä¸‹æ¥äº†ã€‚</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">val</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SerializedMemoryEntry</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span><span class="w"> </span><span class="n">memoryMode</span><span class="p">,</span><span class="w"> </span><span class="n">implicitly</span><span class="o">[</span><span class="n">ClassTag</span><span class="o">[</span><span class="n">T</span><span class="o">]]</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">entries</span><span class="p">.</span><span class="na">synchronized</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">entries</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™å°±å¾ˆæœ‰è¶£äº†ï¼Œå…¶å®BlockManagerå­˜å‚¨çš„å—æ˜¯é€šè¿‡LinkedHashMapæ¥ç®¡ç†çš„ã€‚</p>
</li>
<li>
<p>è‡³æ­¤ï¼ŒmemoryStoreå·²ç»å­˜æ”¾å®Œblockå†…å®¹ã€‚å¦‚æœå†…å­˜ä¸å¤Ÿï¼Œè¿”å›åˆ°BlockManagerä¸­ï¼Œå®ƒæ‰§è¡Œäº†å¦‚ä¸‹æ–¹æ³•</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">putSucceeded</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">level</span><span class="p">.</span><span class="na">useDisk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logWarning</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Persisting block $blockId to disk instead.&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">saveToDiskStore</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>è¿›å…¥saveToDiskStore()ä¸­ï¼Œå‘ç°æ‰§è¡ŒdiskStore.putBytes(blockId, bytes)ï¼Œå…¶å®å°±æ˜¯åˆ©ç”¨java.nioæ¥å†™ç£ç›˜äº†</p>
</li>
<li>
<p>reportBlockStatus(blockId, putBlockStatus)æŠŠè¿™ä¸ªblockStatuså‘é€åˆ°driverç«¯çš„ï¼Œç”¨blockManagerInfoæ¥åŒ…è£…ï¼ŒDriverçš„blockmanagerInfoå› æ­¤åšç»Ÿè®¡ä¿¡æ¯çš„æ›´æ–°</p>
</li>
</ol>
<p>è¿”å›Executor.runï¼Œå·²ç»æŠŠblockå­˜å‚¨è‡³blockManagerä¹‹åï¼Œå°±ä¼šæ‰§è¡ŒexecBackend.statusUpdate(taskId, TaskState.FINISHED, serializedResult)å°†æ‰§è¡Œçš„ç»“æœåé¦ˆç»™CoarseGrainedSchedulerBackend.receive()ã€‚</p>
<h3 id="driverç«¯çš„è·å–blockçš„æ‰§è¡Œæµç¨‹">driverç«¯çš„è·å–blockçš„æ‰§è¡Œæµç¨‹
</h3><p>åœ¨è¿™é‡ŒCoarseGrainedSchedulerBackend.receive()æ¥å—executorå‘æ¥çš„ä¿¡æ¯å¼€å§‹çœ‹èµ·</p>
<p>è°ƒç”¨scheduler.statusUpdate(taskId, state, data.value)æ›´æ–°çŠ¶æ€ä¿¡æ¯ã€‚åœ¨æ–¹æ³•å†…éƒ¨æ‰§è¡Œäº†taskResultGetter.enqueueSuccessfulTask(taskSet, tid, serializedData)å¤„ç†taskå®Œæˆçš„ä¿¡æ¯ï¼Œé‚£æ–¹æ³•å†…éƒ¨ä¸»è¦æ˜¯è¿™ä¸ªéƒ¨åˆ†</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">case</span><span class="w"> </span><span class="n">IndirectTaskResult</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="c1">// å°±é€šè¿‡blockManager.getRemoteBytesè¿œç¨‹è·å–ï¼Œè·å–ä»¥åå†è¿›è¡Œååºåˆ—åŒ–</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">taskSetManager</span><span class="p">.</span><span class="na">canFetchMoreResults</span><span class="p">(</span><span class="n">size</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// dropped by executor if size is larger than maxResultSize</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">sparkEnv</span><span class="p">.</span><span class="na">blockManager</span><span class="p">.</span><span class="na">master</span><span class="p">.</span><span class="na">removeBlock</span><span class="p">(</span><span class="n">blockId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// kill the task so that it will not become zombie task</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">scheduler</span><span class="p">.</span><span class="na">handleFailedTask</span><span class="p">(</span><span class="n">taskSetManager</span><span class="p">,</span><span class="w"> </span><span class="n">tid</span><span class="p">,</span><span class="w"> </span><span class="n">TaskState</span><span class="p">.</span><span class="na">KILLED</span><span class="p">,</span><span class="w"> </span><span class="n">TaskKilled</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s">&#34;Tasks result size has exceeded maxResultSize&#34;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Fetching indirect task result for ${taskSetManager.taskName(tid)}&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">scheduler</span><span class="p">.</span><span class="na">handleTaskGettingResult</span><span class="p">(</span><span class="n">taskSetManager</span><span class="p">,</span><span class="w"> </span><span class="n">tid</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">serializedTaskResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sparkEnv</span><span class="p">.</span><span class="na">blockManager</span><span class="p">.</span><span class="na">getRemoteBytes</span><span class="p">(</span><span class="n">blockId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">serializedTaskResult</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cm">/* We won&#39;t be able to get the task result if the machine that ran the task failed
</span></span></span><span class="line"><span class="cl"><span class="cm">       * between when the task ended and when we tried to fetch the result, or if the
</span></span></span><span class="line"><span class="cl"><span class="cm">       * block manager had to flush the result. */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// å¦‚æœè¿è¡Œä»»åŠ¡çš„æœºå™¨åœ¨ä»»åŠ¡ç»“æŸå’Œæˆ‘ä»¬è¯•å›¾è·å–ä»»åŠ¡ç»“æœä¹‹é—´å‘ç”Ÿæ•…éšœï¼Œæˆ–è€…åŒºå—ç®¡ç†å™¨å¿…é¡»åˆ·æ–°ç»“æœï¼Œæˆ‘ä»¬å°†æ— æ³•è·å–ä»»åŠ¡ç»“æœã€‚</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">scheduler</span><span class="p">.</span><span class="na">handleFailedTask</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">taskSetManager</span><span class="p">,</span><span class="w"> </span><span class="n">tid</span><span class="p">,</span><span class="w"> </span><span class="n">TaskState</span><span class="p">.</span><span class="na">FINISHED</span><span class="p">,</span><span class="w"> </span><span class="n">TaskResultLost</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">deserializedResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">serializer</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">deserialize</span><span class="o">[</span><span class="n">DirectTaskResult</span><span class="o">[</span><span class="n">_</span><span class="o">]]</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">serializedTaskResult</span><span class="p">.</span><span class="na">get</span><span class="p">.</span><span class="na">toByteBuffer</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// force deserialization of referenced value</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">deserializedResult</span><span class="p">.</span><span class="na">value</span><span class="p">(</span><span class="n">taskResultSerializer</span><span class="p">.</span><span class="na">get</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sparkEnv</span><span class="p">.</span><span class="na">blockManager</span><span class="p">.</span><span class="na">master</span><span class="p">.</span><span class="na">removeBlock</span><span class="p">(</span><span class="n">blockId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="n">deserializedResult</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>å¾ˆç›´è§‚ï¼Œå°±æ˜¯æ¥å—äº†ä¹‹å‰åœ¨Executorå‘é€çš„<code>IndirectTaskResult(blockId, size)</code>å¯¹è±¡</p>
<p>ç„¶åval serializedTaskResult = sparkEnv.blockManager.getRemoteBytes(blockId)æ¥æ ¹æ®blockIdè¿œç¨‹è·å–åºåˆ—åŒ–çš„ä»»åŠ¡æ‰§è¡Œç»“æœï¼Œè¿™äº›ç»“æœå…ˆå‰å·²ç»åœ¨è¿œå¤„çš„executoré€šè¿‡blockManagerå­˜å‚¨æˆåŠŸäº†ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">def</span><span class="w"> </span><span class="nf">getRemoteBytes</span><span class="p">(</span><span class="n">blockId</span><span class="p">:</span><span class="w"> </span><span class="n">BlockId</span><span class="p">):</span><span class="w"> </span><span class="n">Option</span><span class="o">[</span><span class="n">ChunkedByteBuffer</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">getRemoteBlock</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="n">ManagedBuffer</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// SPARK-24307 undocumented &#34;escape-hatch&#34; in case there are any issues in converting to</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// ChunkedByteBuffer, to go back to old code-path.  Can be removed post Spark 2.4 if</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// new path is stable.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">remoteReadNioBufferConversion</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="n">ChunkedByteBuffer</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="na">nioByteBuffer</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ChunkedByteBuffer</span><span class="p">.</span><span class="na">fromManagedBuffer</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ˜¯driverç«¯çš„è·å–è¿œå¤„blockçš„æ–¹æ³•ï¼Œç‚¹å‡»è¿›å»æŸ¥çœ‹ä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="o">[</span><span class="n">spark</span><span class="o">]</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="n">getRemoteBlock</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">blockId</span><span class="p">:</span><span class="w"> </span><span class="n">BlockId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bufferTransformer</span><span class="p">:</span><span class="w"> </span><span class="n">ManagedBuffer</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">T</span><span class="p">):</span><span class="w"> </span><span class="n">Option</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Getting remote block $blockId&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">require</span><span class="p">(</span><span class="n">blockId</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;BlockId is null&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Because all the remote blocks are registered in driver, it is not necessary to ask</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// all the storage endpoints to get block status.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// å› ä¸ºæ‰€æœ‰çš„è¿œç¨‹å—éƒ½æ³¨å†Œåœ¨driverä¸­ï¼Œæ‰€ä»¥ä¸éœ€è¦è¦æ±‚æ‰€æœ‰çš„ä»æ‰§è¡Œå™¨è·å–å—çŠ¶æ€</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// å»driveré‚£é‡Œè·å–åœ°å€å’ŒçŠ¶æ€</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">locationsAndStatusOption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master</span><span class="p">.</span><span class="na">getLocationsAndStatus</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">blockManagerId</span><span class="p">.</span><span class="na">host</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">locationsAndStatusOption</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Block $blockId is unknown by block manager master&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">locationsAndStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">locationsAndStatusOption</span><span class="p">.</span><span class="na">get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">blockSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">locationsAndStatus</span><span class="p">.</span><span class="na">status</span><span class="p">.</span><span class="na">diskSize</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="n">locationsAndStatus</span><span class="p">.</span><span class="na">status</span><span class="p">.</span><span class="na">memSize</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">locationsAndStatus</span><span class="p">.</span><span class="na">localDirs</span><span class="p">.</span><span class="na">flatMap</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">localDirs</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">blockDataOption</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">readDiskBlockFromSameHostExecutor</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">localDirs</span><span class="p">,</span><span class="w"> </span><span class="n">locationsAndStatus</span><span class="p">.</span><span class="na">status</span><span class="p">.</span><span class="na">diskSize</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockDataOption</span><span class="p">.</span><span class="na">flatMap</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">blockData</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">Some</span><span class="p">(</span><span class="n">bufferTransformer</span><span class="p">(</span><span class="n">blockData</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">NonFatal</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">logDebug</span><span class="p">(</span><span class="s">&#34;Block from the same host executor cannot be opened: &#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">logInfo</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Read $blockId from the disk of a same host executor is &#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="na">isDefined</span><span class="p">)</span><span class="w"> </span><span class="s">&#34;successful.&#34;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s">&#34;failed.&#34;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">res</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}.</span><span class="na">orElse</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">fetchRemoteManagedBuffer</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="n">blockSize</span><span class="p">,</span><span class="w"> </span><span class="n">locationsAndStatus</span><span class="p">).</span><span class="na">map</span><span class="p">(</span><span class="n">bufferTransformer</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>
<p>val locationsAndStatusOption = master.getLocationsAndStatus(blockId, blockManagerId.host)å› ä¸ºæ‰€æœ‰çš„è¿œç¨‹å—éƒ½æ³¨å†Œåœ¨driverä¸­ï¼Œæ‰€ä»¥ä¸éœ€è¦è¦æ±‚æ‰€æœ‰çš„ä»æ‰§è¡Œå™¨è·å–å—çŠ¶æ€ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯å»driveré‚£é‡Œè·å–åœ°å€å’ŒçŠ¶æ€ã€‚ç„¶ååœ¨Driverçš„BlockManagerMasterEndpointæ‰§è¡ŒgetLocationsAndStatusè·å–è¿™ä¸ªblockIdå¯¹åº”çš„blockManageråœ°å€å’ŒçŠ¶æ€</p>
</li>
<li>
<p>å¸¦ç€è¿™äº›ä½ç½®å’ŒçŠ¶æ€å»localDirsæ¥è·å–æœ¬åœ°çš„blockManagerï¼Œæ‰§è¡ŒreadDiskBlockFromSameHostExecutorã€‚ä½†åœ¨Resultçš„åœºæ™¯ä¸­ï¼Œresultå­˜æ”¾åœ¨äº†executorä¸­ï¼Œæ‰€ä»¥éœ€è¦è¿œç«¯æ‹¿å–blockã€‚å³æ‰§è¡Œäº†å¦‚ä¸‹çš„æ–¹æ³•çš„äº†fetchRemoteManagedBuffer(blockId, blockSize, locationsAndStatus).map(bufferTransformer)ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="nf">fetchRemoteManagedBuffer</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">blockId</span><span class="p">:</span><span class="w"> </span><span class="n">BlockId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">blockSize</span><span class="p">:</span><span class="w"> </span><span class="n">Long</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">locationsAndStatus</span><span class="p">:</span><span class="w"> </span><span class="n">BlockManagerMessages</span><span class="p">.</span><span class="na">BlockLocationsAndStatus</span><span class="p">):</span><span class="w"> </span><span class="n">Option</span><span class="o">[</span><span class="n">ManagedBuffer</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// å¦‚æœå—å¤§å°è¶…è¿‡é˜ˆå€¼ï¼Œå°†FileManagerä¼ é€’ç»™BlockTransferServiceï¼Œåˆ©ç”¨å®ƒæ¥æº¢å‡ºå—ï¼›å¦‚æœæ²¡æœ‰ï¼Œä¼ é€’ç©ºå€¼æ„å‘³ç€å—å°†æŒä¹…å­˜åœ¨å†…å­˜ä¸­ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">tempFileManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">blockSize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxRemoteBlockToMem</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">remoteBlockTempFileManager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">runningFailureCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">totalFailureCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// sortLocationsæ–¹æ³•è¿”å›ç»™å®šå—çš„ä½ç½®åˆ—è¡¨ï¼Œæœ¬åœ°è®¡ç®—æœºçš„ä¼˜å…ˆçº§ä»å¤šä¸ªå—ç®¡ç†å™¨å¯ä»¥å…±äº«åŒä¸€ä¸ªä¸»æœºï¼Œç„¶åæ˜¯åŒä¸€æœºæ¶ä¸Šçš„ä¸»æœº</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">locations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sortLocations</span><span class="p">(</span><span class="n">locationsAndStatus</span><span class="p">.</span><span class="na">locations</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">maxFetchFailures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">locations</span><span class="p">.</span><span class="na">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">locationIterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">locations</span><span class="p">.</span><span class="na">iterator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nf">while</span><span class="w"> </span><span class="p">(</span><span class="n">locationIterator</span><span class="p">.</span><span class="na">hasNext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">loc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">locationIterator</span><span class="p">.</span><span class="na">next</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Getting remote block $blockId from $loc&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// è°ƒç”¨blockTransferService.fetchBlockSyncæ–¹æ³•å®ç°è¿œç¨‹è·å–æ•°æ®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockTransferService</span><span class="p">.</span><span class="na">fetchBlockSync</span><span class="p">(</span><span class="n">loc</span><span class="p">.</span><span class="na">host</span><span class="p">,</span><span class="w"> </span><span class="n">loc</span><span class="p">.</span><span class="na">port</span><span class="p">,</span><span class="w"> </span><span class="n">loc</span><span class="p">.</span><span class="na">executorId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">blockId</span><span class="p">.</span><span class="na">toString</span><span class="p">,</span><span class="w"> </span><span class="n">tempFileManager</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">blockSize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">buf</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&#34;Empty buffer received for non empty block&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">buf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">NonFatal</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">runningFailureCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">totalFailureCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// æ”¾å¼ƒå°è¯•çš„ä½ç½®ã€‚è¦ä¹ˆæˆ‘ä»¬å·²ç»å°è¯•äº†æ‰€æœ‰çš„åŸå§‹ä½ç½®,æˆ–è€…æˆ‘ä»¬å·²ç»ä»masterèŠ‚ç‚¹åˆ·æ–°äº†ä½ç½®åˆ—è¡¨ï¼Œå¹¶ä¸”ä»ç„¶åœ¨åˆ·æ–°åˆ—è¡¨ä¸­å°è¯•ä½ç½®åå‘½ä¸­å¤±è´¥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">totalFailureCount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">maxFetchFailures</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">logWarning</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Failed to fetch block after $totalFailureCount fetch failures. &#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">s</span><span class="s">&#34;Most recent failure cause:&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// å¦‚æœæœ‰å¤§é‡çš„ Executorsï¼Œé‚£ä¹ˆä½ç½®åˆ—è¡¨å¯ä»¥åŒ…å«ä¸€ä¸ªæ—§çš„æ¡ç›®é€ æˆå¤§é‡é‡è¯•ï¼Œå¯èƒ½èŠ±è´¹å¤§é‡çš„æ—¶é—´ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// åœ¨ä¸€å®šæ•°é‡çš„è·å–å¤±è´¥ä¹‹åï¼Œä¸ºå»æ‰è¿™äº›æ—§çš„æ¡ç›®ï¼Œæˆ‘ä»¬åˆ·æ–°å—ä½ç½®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">runningFailureCount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">maxFailuresBeforeLocationRefresh</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// å¦‚æœæœ‰å¤§é‡æ‰§è¡Œè€…ï¼Œåˆ™ä½ç½®åˆ—è¡¨å¯ä»¥åŒ…å«å¤§é‡è¿‡æ—¶çš„æ¡ç›®å¯¼è‡´å¤§é‡é‡è¯•ï¼Œå¯èƒ½èŠ±å¤§é‡çš„æ—¶é—´ã€‚é™¤å»è¿™äº›é™ˆæ—§çš„æ¡ç›®ï¼Œåœ¨ä¸€å®šæ•°é‡çš„æå–å¤±è´¥ååˆ·æ–°å—ä½ç½®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">locationIterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sortLocations</span><span class="p">(</span><span class="n">master</span><span class="p">.</span><span class="na">getLocations</span><span class="p">(</span><span class="n">blockId</span><span class="p">)).</span><span class="na">iterator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Refreshed locations from the driver &#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">s</span><span class="s">&#34;after ${runningFailureCount} fetch failures.&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">runningFailureCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// This location failed, so we retry fetch from a different one by returning null here</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// æ­¤ä½ç½®å¤±è´¥ï¼Œæ‰€ä»¥æˆ‘ä»¬å°è¯•ä»ä¸åŒçš„ä½ç½®è·å–ï¼Œè¿™é‡Œè¿”å›ä¸€ä¸ª null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="na">isInstanceOf</span><span class="o">[</span><span class="n">BlockManagerManagedBuffer</span><span class="o">]</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">Some</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;The value of block $blockId is null&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Block $blockId not found&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸ªæ–¹æ³•ä¸»è¦å…³æ³¨ä»¥ä¸‹çš„å†…å®¹ï¼š</p>
<ol>
<li>
<p>val locationsAndStatusOption = master.getLocationsAndStatus(blockId, blockManagerId.host)å› ä¸ºæ‰€æœ‰çš„è¿œç¨‹å—éƒ½æ³¨å†Œåœ¨driverä¸­ï¼Œæ‰€ä»¥ä¸éœ€è¦è¦æ±‚æ‰€æœ‰çš„ä»æ‰§è¡Œå™¨è·å–å—çŠ¶æ€ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯å»driveré‚£é‡Œè·å–åœ°å€å’ŒçŠ¶æ€ã€‚ç„¶ååœ¨Driverçš„BlockManagerMasterEndpointæ‰§è¡ŒgetLocationsAndStatusè·å–è¿™ä¸ªblockIdå¯¹åº”çš„blockManageråœ°å€å’ŒçŠ¶æ€</p>
</li>
<li>
<p>å¸¦ç€è¿™äº›ä½ç½®å’ŒçŠ¶æ€å»localDirsæ¥è·å–æœ¬åœ°çš„blockManagerï¼Œæ‰§è¡ŒreadDiskBlockFromSameHostExecutorã€‚ä½†åœ¨Resultçš„åœºæ™¯ä¸­ï¼Œresultå­˜æ”¾åœ¨äº†executorä¸­ï¼Œæ‰€ä»¥éœ€è¦è¿œç«¯æ‹¿å–blockã€‚å³æ‰§è¡Œäº†å¦‚ä¸‹çš„æ–¹æ³•çš„äº†fetchRemoteManagedBuffer(blockId, blockSize, locationsAndStatus).map(bufferTransformer)ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="nf">fetchRemoteManagedBuffer</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">blockId</span><span class="p">:</span><span class="w"> </span><span class="n">BlockId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">blockSize</span><span class="p">:</span><span class="w"> </span><span class="n">Long</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">locationsAndStatus</span><span class="p">:</span><span class="w"> </span><span class="n">BlockManagerMessages</span><span class="p">.</span><span class="na">BlockLocationsAndStatus</span><span class="p">):</span><span class="w"> </span><span class="n">Option</span><span class="o">[</span><span class="n">ManagedBuffer</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// å¦‚æœå—å¤§å°è¶…è¿‡é˜ˆå€¼ï¼Œå°†FileManagerä¼ é€’ç»™BlockTransferServiceï¼Œåˆ©ç”¨å®ƒæ¥æº¢å‡ºå—ï¼›å¦‚æœæ²¡æœ‰ï¼Œä¼ é€’ç©ºå€¼æ„å‘³ç€å—å°†æŒä¹…å­˜åœ¨å†…å­˜ä¸­ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">tempFileManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">blockSize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxRemoteBlockToMem</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">remoteBlockTempFileManager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">runningFailureCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">totalFailureCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// sortLocationsæ–¹æ³•è¿”å›ç»™å®šå—çš„ä½ç½®åˆ—è¡¨ï¼Œæœ¬åœ°è®¡ç®—æœºçš„ä¼˜å…ˆçº§ä»å¤šä¸ªå—ç®¡ç†å™¨å¯ä»¥å…±äº«åŒä¸€ä¸ªä¸»æœºï¼Œç„¶åæ˜¯åŒä¸€æœºæ¶ä¸Šçš„ä¸»æœº</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">locations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sortLocations</span><span class="p">(</span><span class="n">locationsAndStatus</span><span class="p">.</span><span class="na">locations</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">maxFetchFailures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">locations</span><span class="p">.</span><span class="na">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">locationIterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">locations</span><span class="p">.</span><span class="na">iterator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nf">while</span><span class="w"> </span><span class="p">(</span><span class="n">locationIterator</span><span class="p">.</span><span class="na">hasNext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">loc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">locationIterator</span><span class="p">.</span><span class="na">next</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Getting remote block $blockId from $loc&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// è°ƒç”¨blockTransferService.fetchBlockSyncæ–¹æ³•å®ç°è¿œç¨‹è·å–æ•°æ®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">val</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockTransferService</span><span class="p">.</span><span class="na">fetchBlockSync</span><span class="p">(</span><span class="n">loc</span><span class="p">.</span><span class="na">host</span><span class="p">,</span><span class="w"> </span><span class="n">loc</span><span class="p">.</span><span class="na">port</span><span class="p">,</span><span class="w"> </span><span class="n">loc</span><span class="p">.</span><span class="na">executorId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">blockId</span><span class="p">.</span><span class="na">toString</span><span class="p">,</span><span class="w"> </span><span class="n">tempFileManager</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">blockSize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">buf</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&#34;Empty buffer received for non empty block&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">buf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">NonFatal</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">runningFailureCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">totalFailureCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// æ”¾å¼ƒå°è¯•çš„ä½ç½®ã€‚è¦ä¹ˆæˆ‘ä»¬å·²ç»å°è¯•äº†æ‰€æœ‰çš„åŸå§‹ä½ç½®,æˆ–è€…æˆ‘ä»¬å·²ç»ä»masterèŠ‚ç‚¹åˆ·æ–°äº†ä½ç½®åˆ—è¡¨ï¼Œå¹¶ä¸”ä»ç„¶åœ¨åˆ·æ–°åˆ—è¡¨ä¸­å°è¯•ä½ç½®åå‘½ä¸­å¤±è´¥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">totalFailureCount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">maxFetchFailures</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">logWarning</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Failed to fetch block after $totalFailureCount fetch failures. &#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">s</span><span class="s">&#34;Most recent failure cause:&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// å¦‚æœæœ‰å¤§é‡çš„ Executorsï¼Œé‚£ä¹ˆä½ç½®åˆ—è¡¨å¯ä»¥åŒ…å«ä¸€ä¸ªæ—§çš„æ¡ç›®é€ æˆå¤§é‡é‡è¯•ï¼Œå¯èƒ½èŠ±è´¹å¤§é‡çš„æ—¶é—´ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// åœ¨ä¸€å®šæ•°é‡çš„è·å–å¤±è´¥ä¹‹åï¼Œä¸ºå»æ‰è¿™äº›æ—§çš„æ¡ç›®ï¼Œæˆ‘ä»¬åˆ·æ–°å—ä½ç½®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">runningFailureCount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">maxFailuresBeforeLocationRefresh</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// å¦‚æœæœ‰å¤§é‡æ‰§è¡Œè€…ï¼Œåˆ™ä½ç½®åˆ—è¡¨å¯ä»¥åŒ…å«å¤§é‡è¿‡æ—¶çš„æ¡ç›®å¯¼è‡´å¤§é‡é‡è¯•ï¼Œå¯èƒ½èŠ±å¤§é‡çš„æ—¶é—´ã€‚é™¤å»è¿™äº›é™ˆæ—§çš„æ¡ç›®ï¼Œåœ¨ä¸€å®šæ•°é‡çš„æå–å¤±è´¥ååˆ·æ–°å—ä½ç½®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">locationIterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sortLocations</span><span class="p">(</span><span class="n">master</span><span class="p">.</span><span class="na">getLocations</span><span class="p">(</span><span class="n">blockId</span><span class="p">)).</span><span class="na">iterator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Refreshed locations from the driver &#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">s</span><span class="s">&#34;after ${runningFailureCount} fetch failures.&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">runningFailureCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// This location failed, so we retry fetch from a different one by returning null here</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// æ­¤ä½ç½®å¤±è´¥ï¼Œæ‰€ä»¥æˆ‘ä»¬å°è¯•ä»ä¸åŒçš„ä½ç½®è·å–ï¼Œè¿™é‡Œè¿”å›ä¸€ä¸ª null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="na">isInstanceOf</span><span class="o">[</span><span class="n">BlockManagerManagedBuffer</span><span class="o">]</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">Some</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;The value of block $blockId is null&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">logDebug</span><span class="p">(</span><span class="n">s</span><span class="s">&#34;Block $blockId not found&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸»è¦æ‰§è¡Œçš„æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>val locations = sortLocations(locationsAndStatus.locations)ã€‚sortLocationsæŒ‰ç…§ä¸»æœº-&gt;åŒä¸€æœºæ¶ä¸»æœºçš„é¡ºåºæ¥æ’åºï¼Œè¿”å›è¿™äº›èŠ‚ç‚¹çš„åˆ—è¡¨</li>
<li>ç„¶åè°ƒç”¨blockTransferService.fetchBlockSyncæ–¹æ³•å®ç°è¿œç¨‹è·å–æ•°æ®ï¼Œç‚¹è¿›å»æ–¹æ³•ï¼Œå®é™…ä¸Šå°±æ˜¯æ‰§è¡Œäº†NettyBlockTransferService.fetechBlocksçš„æ–¹æ³•</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="åˆ é™¤blockçš„è¿‡ç¨‹">åˆ é™¤blockçš„è¿‡ç¨‹
</h2><p>ä¸¾ä¸ªä¾‹å­ï¼Œå½“ExecutorMemoryè¦æ‰©å¢çš„æ—¶å€™ï¼Œå¦‚æœexecutorå†…å­˜ä¸å¤Ÿï¼Œé‚£ä¹ˆå°±è¦å¾€storageçš„ä½ç½®è¦ç©ºé—´ï¼Œä½¿ç”¨StorageMemoryPool.acquireMemoryè¿›è¡Œï¼ŒmemoryStore.evictBlocksToFreeSpace(Some(blockId), numBytesToFree, memoryMode)ä»£ç è¡¨ç¤ºstorageç©ºé—´åˆ é™¤block</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">def</span><span class="w"> </span><span class="n">dropBlock</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="p">(</span><span class="n">blockId</span><span class="p">:</span><span class="w"> </span><span class="n">BlockId</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">:</span><span class="w"> </span><span class="n">MemoryEntry</span><span class="o">[</span><span class="n">T</span><span class="o">]</span><span class="p">):</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">DeserializedMemoryEntry</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Left</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">SerializedMemoryEntry</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Right</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">val</span><span class="w"> </span><span class="n">newEffectiveStorageLevel</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">blockEvictionHandler</span><span class="p">.</span><span class="na">dropFromMemory</span><span class="p">(</span><span class="n">blockId</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">data</span><span class="p">)(</span><span class="n">entry</span><span class="p">.</span><span class="na">classTag</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newEffectiveStorageLevel</span><span class="p">.</span><span class="na">isValid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// The block is still present in at least one store, so release the lock</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// but don&#39;t delete the block info</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">blockInfoManager</span><span class="p">.</span><span class="na">unlock</span><span class="p">(</span><span class="n">blockId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// The block isn&#39;t present in any store, so delete the block info so that the</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// block can be stored again</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">blockInfoManager</span><span class="p">.</span><span class="na">removeBlock</span><span class="p">(</span><span class="n">blockId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>çœ‹çœ‹è¿™é‡Œçœ‹äº†ä»€ä¹ˆï¼ŒblockEvictionHandler.dropFromMemory(blockId, () =&gt; data)(entry.classTag)å°±æ˜¯åœ¨è¿™é‡Œæ ¹æ®storagelevelæ¥åˆ é™¤blockï¼Œå¦‚æœstorageleveléœ€è¦ç£ç›˜å­˜å‚¨çš„è¯ï¼Œå°±åœ¨è¿™é‡Œå°†å†…å­˜ä»¥è½¬ç§»è‡³diskStoreï¼Œå³diskStore.putBytes(blockId, bytes)</p>
<p>ç„¶åå¼€å§‹ä»memoryStoreåˆ é™¤è¿™ä¸ªblockï¼Œ<code>val blockIsRemoved = memoryStore.remove(blockId)</code>ï¼Œåœ¨é‡Œé¢å®é™…ä¸Šå°±æ˜¯ä½¿ç”¨<code>entries.remove(blockId)</code>ã€‚</p>
<p>ç„¶åè·å–è¿™ä¸ªblockå½“å‰çš„statusï¼Œåˆ¤æ–­çŠ¶æ€tellMasteræ˜¯å¦ä¸ºtrueï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°±å°†ä¿¡æ¯å‘Šè¯‰masteræ›´æ–°ã€‚å…·ä½“æ‰§è¡Œçš„ä»£ç å¦‚BlockManager.tryToReportBlockStatus-&gt;master.updateBlockInfo-&gt;driverEndpoint.askSync<a class="link" href="UpdateBlockInfo.." >Boolean</a>-&gt;åœ¨driverç«¯çš„BlockManagerMasterEndpointæ‰§è¡Œæ›´æ¢å…³äºè¿™ä¸ªblockmanageré‡Œé¢çš„blockIdçš„ä¿¡æ¯æ›´æ–°ä¸€ä¸‹ä¸‹ã€‚</p>
<p>è¿”å›åˆ°<code>MemoryStore.dropBlock</code>çš„ä½ç½®ï¼Œå¦‚æœæ‰€æœ‰çš„blockéƒ½åˆ é™¤ï¼Œé‚£ä¹ˆå°±ä½¿ç”¨blockInfoManager.removeBlock(blickId)ï¼Œä¸å†è®°å½•è¿™ä¸ªblockçš„</p>
<h2 id="æ€»ç»“">æ€»ç»“
</h2><p>å¥½äº†ï¼Œåˆ°äº†è¿™ä¸ªæ—¶å€™ï¼Œå·²ç»çŸ¥é“Sparkä¸­BlockManageræ˜¯æ€ä¹ˆç®¡ç†çš„äº†ï¼Œé‡Œé¢æ¶‰åŠåˆ°å‡ ä¸ªç±»ï¼Œæ¯”å¦‚BlockInfoManagerã€BlockManagerã€BlockManagerMasterã€BlockManagerMasterEndpointç­‰ã€‚å¦‚ä½•æ·±å…¥ç†è§£å®ƒä»¬æœ€å¥½è¿˜æ˜¯æ‰¾ä¸€ä¸ªå­˜å–blockçš„è¿‡ç¨‹ä¾‹å­å»ç†è§£æ¯”è¾ƒå¥½ã€‚</p>
<h2 id="å‚è€ƒ">å‚è€ƒ
</h2><ol>
<li><a class="link" href="https://blog.csdn.net/weixin_41841496/article/details/132372549?spm=1001.2014.3001.5502"  target="_blank" rel="noopener"
    >ã€è¯»æ‡‚é¢ç»ä¸­çš„æºç ã€‘SPARKæºç è§£æâ€”â€”BlockManagerç®¡ç†</a></li>
</ol>

</section>


    <footer class="article-footer">
    

    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/spark%E5%B9%BF%E6%92%AD%E6%9C%BA%E5%88%B6%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0/">
        
        
            <div class="article-image">
                <img src="/p/spark%E5%B9%BF%E6%92%AD%E6%9C%BA%E5%88%B6%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0/grebe-7972183_1280.6dd8a2d7b8cf99148cf7a877d9459ae8_hu10399000877992530385.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Sparkå¹¿æ’­æœºåˆ¶æºç å®ç°"
                        
                        data-hash="md5-bdii17jPmRSM96h32UWa6A==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Sparkå¹¿æ’­æœºåˆ¶æºç å®ç°</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/oom%E9%83%BD%E6%98%AF%E8%B0%81%E7%9A%84%E9%94%85/">
        
        
            <div class="article-image">
                <img src="/p/oom%E9%83%BD%E6%98%AF%E8%B0%81%E7%9A%84%E9%94%85/winter-8433267_1280.1db9e97625db6d61118e6635dc1248b1_hu14689633931296498845.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post OOMéƒ½æ˜¯è°çš„é”…"
                        
                        data-hash="md5-HbnpdiXbbWERjmY13BJIsQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">OOMéƒ½æ˜¯è°çš„é”…</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E8%AF%A6%E8%A7%A3spark%E5%B9%BF%E6%92%AD%E5%8F%98%E9%87%8F/">
        
        
            <div class="article-image">
                <img src="/p/%E8%AF%A6%E8%A7%A3spark%E5%B9%BF%E6%92%AD%E5%8F%98%E9%87%8F/pawel-czerwinski-8uZPynIu-rQ-unsplash.c514d916917173a48a42e0114b469961_hu7626638945853200361.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post è¯¦è§£Sparkå¹¿æ’­å˜é‡"
                        
                        data-hash="md5-xRTZFpFxc6SKQuARS0aZYQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">è¯¦è§£Sparkå¹¿æ’­å˜é‡</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/rdd%E5%92%8Cdataframe%E5%92%8Cdataset%E4%B8%89%E8%80%85%E9%97%B4%E7%9A%84%E5%8C%BA%E5%88%AB/">
        
        
            <div class="article-image">
                <img src="/p/rdd%E5%92%8Cdataframe%E5%92%8Cdataset%E4%B8%89%E8%80%85%E9%97%B4%E7%9A%84%E5%8C%BA%E5%88%AB/trees-8136806_1280.357dd549ed51f498bcbf5425f76e0416_hu9173719500181869714.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post RDDå’ŒDataFrameå’ŒDataSetä¸‰è€…é—´çš„åŒºåˆ«"
                        
                        data-hash="md5-NX3VSe1R9Ji8v1Ql924EFg==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">RDDå’ŒDataFrameå’ŒDataSetä¸‰è€…é—´çš„åŒºåˆ«</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E8%AF%A6%E8%A7%A3joinhints%E7%89%B9%E6%80%A7/">
        
        
            <div class="article-image">
                <img src="/p/%E8%AF%A6%E8%A7%A3joinhints%E7%89%B9%E6%80%A7/pawel-czerwinski-8uZPynIu-rQ-unsplash.c514d916917173a48a42e0114b469961_hu7626638945853200361.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post è¯¦è§£JoinHintsç‰¹æ€§"
                        
                        data-hash="md5-xRTZFpFxc6SKQuARS0aZYQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">è¯¦è§£JoinHintsç‰¹æ€§</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo="sherlock-lin/utterances-comments"
        issue-term="pathname"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    let utterancesLoaded = false;

    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;

        
        utterancesLoaded = true;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        if (!utterancesLoaded) return;
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2022 - 
        
        2025 sherlock-lin
    </section>
    
    <section class="powerby">
        ä½¿ç”¨ <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> æ„å»º <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.27.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv">æœ¬ç«™æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"></span> æ¬¡ Â· </span>
<span id="busuanzi_container_site_uv">æ‚¨æ˜¯æœ¬ç«™ç¬¬ <span id="busuanzi_value_site_uv"></span> ä½è®¿é—®è€…</span>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
